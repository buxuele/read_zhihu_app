{% extends "base.html" %} {% block title %}个人内容推荐 - {{ super() }}{%
endblock %} {% block page_title %}{% endblock %} {% block content %}
<!-- 顶部控制栏 -->
<div
  class="d-flex justify-content-between align-items-center mb-3 top-control-bar"
>
  <div class="pool-stats-inline">
    {% if pagination %} 第 {{ pagination.current_page }} 页，共 {{
    pagination.total_pages }} 页 (总计 {{ pagination.total_items }} 篇) 
    <span class="ms-3">
      每页显示:
      <select id="per-page-select" class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="changePerPage(this.value)">
        <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10条</option>
        <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20条</option>
      </select>
    </span>
    {% endif %}
  </div>
  <div>
    {% if pagination and pagination.has_prev %}
    <a
      href="{{ url_for('index', page=pagination.prev_page, per_page=pagination.per_page) }}"
      class="btn btn-outline-secondary btn-sm me-2"
    >
      上一页
    </a>
    {% endif %}
    <button
      onclick="openAllLinks()"
      class="btn btn-outline-primary btn-sm me-2"
    >
      全部打开
    </button>
    {% if pagination and pagination.has_next %}
    <a
      href="{{ url_for('index', page=pagination.next_page, per_page=pagination.per_page) }}"
      class="btn btn-outline-secondary btn-sm"
    >
      下一页
    </a>
    {% endif %}
  </div>
</div>

<!-- 推荐内容区域 -->
{% if recommendations %} {% for item_data in recommendations %}
<div class="card mb-3 shadow-sm card-custom">
  <div class="card-body">
    <h3 class="card-title h5">
      <span class="item-index">{{ loop.index }}/{{ pagination.per_page }}</span>
      <a
        href="{{ item_data.url }}"
        target="_blank"
        rel="noopener noreferrer"
        class="item-title-link"
      >
        {{ item_data.title }} {% if item_data.type == 'answer' %}
        <span class="badge bg-custom-answer-badge ms-2">回答</span>
        {% elif item_data.type == 'article' %}
        <span class="badge bg-custom-article-badge ms-2">文章</span>
        {% else %}
        <span class="badge bg-secondary ms-2">{{ item_data.type }}</span>
        {% endif %}
      </a>
      <span
        class="text-muted ms-3"
        style="font-size: 0.9em; font-weight: normal"
      >
        作者: {{ item_data.author or '未知作者' }}
      </span>
    </h3>
    {% if item_data.excerpt %}
    <p
      class="card-text text-secondary mb-2"
      style="font-size: 0.95em; line-height: 1.4"
    >
      {{ item_data.excerpt }}
    </p>
    {% endif %}
    <p class="card-text text-muted small mb-0 d-flex align-items-center">
      <span><strong>{{ item_data.upvotes }}</strong> 赞</span>
      <span class="ms-4"
        >发布时间: {{ item_data.created | timestamp_to_datetime_str }}</span
      >

      <!-- 收藏按钮 -->
      <span class="ms-auto">
        <button 
          class="btn btn-sm favorite-btn {% if item_data.is_favorited %}btn-warning{% else %}btn-outline-secondary{% endif %}"
          data-url="{{ item_data.url }}"
          onclick="toggleFavorite(this)"
        >
          {% if item_data.is_favorited %}
            已收藏
          {% else %}
            收藏
          {% endif %}
        </button>
      </span>
    </p>
  </div>
</div>
{% endfor %} {% else %}
<div class="alert alert-info text-center" role="alert">
  <h4>暂无推荐内容</h4>
  <p>请检查数据源或调整筛选标准。</p>
</div>
{% endif %}

<!-- 分页导航 -->
{% if pagination and pagination.total_pages > 1 %}
<nav aria-label="分页导航" class="mt-4">
  <ul class="pagination justify-content-center">
    <!-- 上一页 -->
    {% if pagination.has_prev %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('index', page=pagination.prev_page, per_page=pagination.per_page) }}"
        >上一页</a
      >
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">上一页</span>
    </li>
    {% endif %}

    <!-- 页码按钮 -->
    {% set start_page = [1, pagination.current_page - 2] | max %} {% set
    end_page = [pagination.total_pages, pagination.current_page + 2] | min %}

    <!-- 第一页 -->
    {% if start_page > 1 %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('index', page=1, per_page=pagination.per_page) }}">1</a>
    </li>
    {% if start_page > 2 %}
    <li class="page-item disabled">
      <span class="page-link">...</span>
    </li>
    {% endif %} {% endif %}

    <!-- 中间页码 -->
    {% for page_num in range(start_page, end_page + 1) %} {% if page_num ==
    pagination.current_page %}
    <li class="page-item active">
      <span class="page-link">{{ page_num }}</span>
    </li>
    {% else %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('index', page=page_num, per_page=pagination.per_page) }}"
        >{{ page_num }}</a
      >
    </li>
    {% endif %} {% endfor %}

    <!-- 最后一页 -->
    {% if end_page < pagination.total_pages %} {% if end_page <
    pagination.total_pages - 1 %}
    <li class="page-item disabled">
      <span class="page-link">...</span>
    </li>
    {% endif %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('index', page=pagination.total_pages, per_page=pagination.per_page) }}"
        >{{ pagination.total_pages }}</a
      >
    </li>
    {% endif %}

    <!-- 下一页 -->
    {% if pagination.has_next %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('index', page=pagination.next_page, per_page=pagination.per_page) }}"
        >下一页</a
      >
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">下一页</span>
    </li>
    {% endif %}
  </ul>
</nav>

<!-- 快速跳转 -->
<div class="text-center mt-3">
  <form
    method="GET"
    action="{{ url_for('index') }}"
    class="d-inline-flex align-items-center"
  >
    <label for="page-jump" class="form-label me-2 mb-0">跳转到:</label>
    <input
      type="number"
      id="page-jump"
      name="page"
      class="form-control form-control-sm me-2"
      style="width: 80px"
      min="1"
      max="{{ pagination.total_pages }}"
      value="{{ pagination.current_page }}"
    />
    <button type="submit" class="btn btn-outline-primary btn-sm">跳转</button>
  </form>
</div>
{% endif %}
{% endblock %} 

{% block extra_js %}
<script>
  // 使用base.html的showToast函数
  function toggleFavorite(button) {
    const url = button.dataset.url;
    
    fetch('/api/toggle_favorite', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: url })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // 更新按钮状态
        if (data.is_favorited) {
          button.classList.remove('btn-outline-secondary');
          button.classList.add('btn-warning');
          button.innerHTML = '已收藏';
          showToast('已收藏', 'success');
        } else {
          button.classList.remove('btn-warning');
          button.classList.add('btn-outline-secondary');
          button.innerHTML = '收藏';
          showToast('已取消收藏', 'info');
        }
      } else {
        showToast('操作失败: ' + data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('错误:', error);
      showToast('收藏操作时发生错误', 'danger');
    });
  }

  // 全部打开当前页面的所有链接
  function openAllLinks() {
    const links = document.querySelectorAll('.item-title-link');
    let openedCount = 0;
    
    links.forEach(link => {
      window.open(link.href, '_blank');
      openedCount++;
    });
    
    showToast(`已打开 ${openedCount} 个链接`, 'success');
  }

  // 切换每页显示数量
  function changePerPage(perPage) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('per_page', perPage);
    urlParams.set('page', '1'); // 切换显示数量时回到第一页
    window.location.search = urlParams.toString();
  }
</script>
{% endblock %}
