{"data":[{"id":"42_1753853177.682","type":"feed","offset":42,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1753853177,"updated_time":1753853177,"target":{"id":"1933284243754169146","type":"article","url":"https://api.zhihu.com/articles/1933284243754169146","author":{"id":"f28b384284a6634c4d2bda17c670db42","url":"https://api.zhihu.com/people/f28b384284a6634c4d2bda17c670db42","user_type":"people","url_token":"ge-ge-da-6-55","name":"椰一个","headline":"公号：椰一个，聊聊金钱观，聊聊认知，陪你一起慢慢变好。","avatar_url":"https://pic1.zhimg.com/50/v2-d1dcec9980d09b947e02422a929080a1_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":644,"is_following":false,"is_followed":false},"title":"一个人开始变强的标志","comment_permission":"all","created":1753710895,"updated":1753710895,"voteup_count":5,"voting":0,"comment_count":0,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"把万事做成闭环。 你有没有过这样的经历？ 计划列得满满当当，开头也做得风风火火，但事情做着做着就没了下文。 想法很丰满，结局很骨感。 中间的过程常常不了了之。 比如你定下目标，三个月减肥20斤，头几天还信心满满，过了半个月，就开始想放弃了，再过一个月，彻底忘了自己的目标了。 这种“开了头，没结果”的状态，是大多数人原地踏步的根源。 所谓“闭环”，就是把一件事从起心动念，到最终落地，画成一个完整的圆。 但是…","excerpt_new":"把万事做成闭环。 你有没有过这样的经历？ 计划列得满满当当，开头也做得风风火火，但事情做着做着就没了下文。 想法很丰满，结局很骨感。 中间的过程常常不了了之。 比如你定下目标，三个月减肥20斤，头几天还信心满满，过了半个月，就开始想放弃了，再过一个月，彻底忘了自己的目标了。 这种“开了头，没结果”的状态，是大多数人原地踏步的根源。 所谓“闭环”，就是把一件事从起心动念，到最终落地，画成一个完整的圆。 但是…","preview_type":"default","preview_text":"","content":"\u003cp\u003e\u003c/p\u003e\u003cp data-pid=\"f4J92tr6\"\u003e\u003cb\u003e把万事做成闭环。\u003c/b\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"VhJ5Bme7\"\u003e你有没有过这样的经历？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"QwBmx-Vu\"\u003e计划列得满满当当，开头也做得风风火火，但事情做着做着就没了下文。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Y8wJ1fyl\"\u003e想法很丰满，结局很骨感。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"_sGNLZKZ\"\u003e中间的过程常常不了了之。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Z6v_OdR1\"\u003e比如你定下目标，三个月减肥20斤，头几天还信心满满，过了半个月，就开始想放弃了，再过一个月，彻底忘了自己的目标了。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"bZMKkQz2\"\u003e这种“开了头，没结果”的状态，是大多数人原地踏步的根源。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"vUsdnZQl\"\u003e所谓“闭环”，就是把一件事从起心动念，到最终落地，画成一个完整的圆。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"nlfaQfJf\"\u003e但是我要强调一点，它不是要求你做到完美无缺，而是确保有始有终，形成一个完整的行动链条。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"cd3trEIc\"\u003e闭环的核心，不是过程有多精彩，而是对结果有交代。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"izgrnGK0\"\u003e一、先说说闭环经常断在哪？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"fdDAe2V_\"\u003e第一，追求完美，迟迟不敢动手。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Fd-7BHCe\"\u003e如果你总想着等“万事俱备”，那结果永远停留在“准备”阶段，迈不出第一步。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"arseAmbs\"\u003e没有谁开始的时候就可以把一件复杂的事情考虑的面面俱到，有差错很正常。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"5y4xO1ZY\"\u003e我觉得追求完美，不是说你一开始就不动手，而是在做的过程中不断精进，让事情越来越好。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"JqT4DIKE\"\u003e第二，目标模糊，走着走着就丢了。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"IdD5E_SF\"\u003e没有一个清晰、可量化的终点，行动就像无头苍蝇，稍微遇到干扰就偏离轨道，最终不了了之。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"mIwH6Y5v\"\u003e这种情况也很常见，比如我要成为明星，我要当科学家。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"q09VOhRf\"\u003e这些不能叫目标，充其量算是理想。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"LkFx-ELH\"\u003e因为你的目标太模糊了，没有一个可以具体去做的事情。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"4w-nWQ2z\"\u003e方向不清，努力打折，结局注定不会很好。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"f8bTo9eA\"\u003e第三，畏惧困难，中途轻易放弃。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"9U0lvom2\"\u003e过程中遇到一点阻碍、挫折，就心生退意，觉得“太难了”、“算了”。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"gKNMHlv9\"\u003e就像我开头说的减肥。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"B5tEAcWK\"\u003e有多少人是在减肥的过程中放弃的？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"XWds59rA\"\u003e你放弃一次，就是给退缩多开了一道门。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"324EHqjJ\"\u003e久而久之，你就越来越不自信。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"OLTSccWm\"\u003e会怀疑自己，我能行吗？我能减肥成功吗？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"2QlR3wu3\"\u003e第四，缺乏反馈，动力悄然流失。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"5bZNkpDl\"\u003e整天就埋头苦干却看不到进展，得不到任何回应。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"0u7afQkL\"\u003e如同在黑暗中奔跑，很快热情就耗尽，行动自然停滞。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"-l1xGQ3e\"\u003e没有回响的努力，如同投入深海的石子。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"im5A8blQ\"\u003e你既要低头赶路，也要抬头看路，更要回头反思一下哪些路好走，哪些路不好走。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"RFbnF8d-\"\u003e二、闭环有什么用？让行动创造复利\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"7sCbSys_\"\u003e把事做成闭环，带来的不仅仅是单次的成功，更是一种能力的积累和信心的叠加。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"gxnClhPe\"\u003e 每一次完成闭环，都是一次微小的胜利。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"aBdVbKL9\"\u003e积累真实的经验值。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"zzD3jTYu\"\u003e纸上谈兵终觉浅，绝知此事要躬行。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"11qQJTjP\"\u003e只有真正走完全程，你才知道坑在哪里，路该怎么走。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"7EeIX6z5\"\u003e这些经验，是别人无法替代的宝贵财富。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"OnrvwFxR\"\u003e锻造强大的掌控感。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"bouA2xIm\"\u003e当你能够一次次把想法变成现实，你会真切地感受到：“我能行！” \u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"2Dsu_PLr\"\u003e这种“成事”的掌控感，是内心最强大的底气来源。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"RSVhMtFq\"\u003e它让你在面对更大挑战时，不再本能地退缩。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"KPeTXe0G\"\u003e形成正向的行动惯性。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"MYS5EEjN\"\u003e正如古人云，天下难事，必作于易；天下大事，必作于细。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"vaxuDc8p\"\u003e每一次小小的闭环完成，都在强化“行动-完成”的回路。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"IjI2ulSH\"\u003e这种惯性一旦形成，你会发现自己越来越容易启动，越来越难被中断。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"mx2a9sqF\"\u003e带来清晰的成长轨迹。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"4EmZvh1W\"\u003e闭环的结果，无论成功或暂时失败，都是最真实的反馈。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Nb7jnKge\"\u003e看清结果，才能校准方向。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"AUynDFHn\"\u003e积累闭环，才能丈量成长。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"tvYJpJcg\"\u003e没有闭环，你永远不知道自己走了多远，又该往哪里去。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"2Ex0xBy9\"\u003e三、如何练就闭环力？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"1CNt8b5M\"\u003e第一，起点要轻，先动起来。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"nns4MNfd\"\u003e破除完美魔咒，奉行“完成比完美更重要”。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"vkl6qjaW\"\u003e你千万不要再等待什么最佳时机，它永远不会主动降临。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"eME2FT0a\"\u003e降低启动门槛，哪怕只做5分钟。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"JjOtwblk\"\u003e写文章，先写下第一个句子。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"naqqsvpd\"\u003e想运动，先穿上运动鞋走出门。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"-jLGfukX\"\u003e想减肥，先在家锻炼个半小时。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"J7vHU72p\"\u003e行动是破除焦虑和犹豫最直接的方式。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"4l5n7TZJ\"\u003e先让轮子转起来，再考虑如何让它转得更好。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"6xGElpp6\"\u003e第二，目标要明，锚定终点。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"xqJIEwIn\"\u003e一定把模糊的愿望，变成清晰、可执行、可衡量的目标。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"_oCzzBM9\"\u003e越具体越好。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"bgEJqs4k\"\u003e不要说“我要学好英语”，而是说“我今天要背完30个单词”或“本周完成3篇英语短文阅读”。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"3EmqjmYl\"\u003e目标越具体，行动越有靶心。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"sN0Y1YVQ\"\u003e《孙子兵法》有云，善战者，致人而不致于人。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Of6erTs3\"\u003e明确的目标，就是让你掌握行动的主动权，不被琐事带偏。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"9hhQvkAs\"\u003e经常在一个人安静的时候，问问自己，我最近在做的重要的事情，离最终目标更近了吗？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"RbAryQqc\"\u003e第三，过程要韧，死磕到底。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"eX0olcwX\"\u003e预设困难，拥抱挫折。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"9v5mZ6wA\"\u003e做计划时，就要想到可能遇到的障碍，并提前想好应对预案。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"yPDBvHpw\"\u003e不要等到问题来了，才发现自己什么都没准备。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"jhNdq2e2\"\u003e那自然容易慌张。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"L4CRn-XA\"\u003e多思考思考问题和对策，当困难真的出现时，告诉自己：“这很正常，不过是考验我而已。”\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"kVaszYLe\"\u003e建立即时反馈机制。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"nEI2u6Uq\"\u003e大目标拆解成小里程碑，每完成一个小节点，给自己一点小奖励或积极的心理暗示。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"8K9HOWeZ\"\u003e你看见进度条了，才有持续的动力。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"IqPY_zAF\"\u003e比如一个月减肥了10斤，距离减肥20斤还有一半，但是已经很棒了，效果显著。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"mh9Mpaz2\"\u003e你这时候动力就会很足，信心也会很足。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Y60xe21a\"\u003e培养“无论如何，给个交代”的习惯。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"qLcOvWEv\"\u003e即使最终结果不如预期，也要主动复盘。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"blh2o12p\"\u003e哪里做得好？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"y6wYK1Qu\"\u003e哪里出了问题？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"JcXI6GPw\"\u003e下次如何改进？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"TE1k89Bp\"\u003e有始有终，哪怕是阶段性的终点，也是对自我和承诺的尊重。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"x_s47vGu\"\u003e王阳明说，人须在事上磨。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"0canmrs3\"\u003e每一次磨到闭环，心力便增长一分。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"OdpjWRH0\"\u003e闭环不是一天就能练成的，不要妄想一步登天，一口吃成胖子。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"A_NS6n1V\"\u003e闭环的能力，需要从最小的事情开始刻意练习。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"IxmECnpP\"\u003e比如，答应朋友回复的消息，立刻回复。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"XW-2fFnk\"\u003e比如，计划今天看的10页书，看完再睡。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"xTHtJtzA\"\u003e比如，决定整理桌面，就彻底整理干净。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"g5s4qs-D\"\u003e哪怕只是泡一杯茶，也要完成从烧水到清洗的整个过程。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"RKfQ6xPm\"\u003e在小事上不断练习“启动-执行-完成”的闭环，就是在给大脑安装“成事”的程序。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"cNuHDHK-\"\u003e当这种模式成为本能，再迁移到更复杂、更长远的目标上，你会发现，行动不再那么艰难，结果不再那么遥远。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"03zV6CBs\"\u003e你会清晰地感受到，自己正实实在在地一步步变强。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Hp_DqQpA\"\u003e把万事做成闭环，是普通人脱胎换骨最踏实的阶梯。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"v9u4nOMM\"\u003e它不需要你有惊天动地的才华，只需要你有一份死磕到底的坚持。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"aW81_SKe\"\u003e当你开始给每一件事画上句号，你的人生，自然变得厚重有力。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"xY042OV9\"\u003e我是椰一个，希望你喜欢。\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e","is_labeled":false,"visited_count":220,"favorite_count":19,"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 1933284243754169146}","attached_info":"CsAFCM/msdasjrGktwEQBxoJMjYwOTQzMzQ0IK+CnsQGKAUwAEAqSigKHVRTX1NPVVJDRV9ORUFSTElORV9DT05URU5UX1YyEgEwGAAgADoASkkKH1RTX1NPVVJDRV9aUkVDQUxMX0lURU1DRl9VUFZPVEUSIGRvY190eXBlOiBBcnRpY2xlCmlkOiAyNjA5NDYxMTgKGAAgADoAYiBkMzJjN2QzNzg5NTAyOTljMDQzYzQ2NWRjNWNhYzBjNnITMTkzMzI4NDI0Mzc1NDE2OTE0NqoBCXJlY29tbWVuZMIBIGYyOGIzODQyODRhNjYzNGM0ZDJiZGExN2M2NzBkYjQy8gEKCAwSBk5vcm1hbPIBKAgKEiQxYjMyOGY1MC0zNGQ3LTQ2OTQtYmViMi1mMTI4ZGJiNGI2N2LyAQUICxIBOIICAIgCm9yuzoUzkgIgZjI4YjM4NDI4NGE2NjM0YzRkMmJkYTE3YzY3MGRiNDKaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxl2gIdVFNfU09VUkNFX05FQVJMSU5FX0NPTlRFTlRfVjLoAgP6AgtOT1JNQUxfRkxPV4oDIDFhODQ1NGRiMDhlYTQyYzJiNzZkMGY5ZGQ0NGNlMTFlmgMNCgJ2MhAAGgVvdGhlcqgD3AHYAwD6Ax8SDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFgAQAiAQAkgQGTm9ybWFsmgQBM6AEAKgEALAEALoEAmFpwgQDNDAwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA8AQA+QQAAABAWgijP4EFAAAAAAAAAACJBd+/ys+nJ9M/kgUAmgUDZGZ0ogUDZGZ0sgUBMbkFAAAAAAAAAADQBQDgBQDoBQDwBQiQBgCgBiqoBgGSAi4KCTI2MDk0MzM0NBITMTkzMzI4NDI0Mzc1NDE2OTE0NhgHIgpJTUFHRV9URVhU","action_card":false},{"id":"43_1753853177.14","type":"feed","offset":43,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1753853177,"updated_time":1753853177,"target":{"id":"2433292582","type":"article","url":"https://api.zhihu.com/articles/2433292582","author":{"id":"3b59bb796c1a6bffe03cefd35e5dc5d2","url":"https://api.zhihu.com/people/3b59bb796c1a6bffe03cefd35e5dc5d2","user_type":"people","url_token":"zzpseeker","name":"翟泽鹏","headline":"LLM ✖️ 推荐","avatar_url":"https://picx.zhimg.com/50/v2-b57732e117d3d15cedef53cafd5f484c_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":525,"is_following":false,"is_followed":false},"title":"一文详解 codebook 技术史（从 VAE 到 VQ/RQ-VAE 到 FSQ）","image_url":"https://picx.zhimg.com/v2-385369549ccf0bb045c0bb59287d3e97.jpg?source=7e7ef6e2\u0026needBackground=1","comment_permission":"all","created":1729619362,"updated":1729840300,"voteup_count":961,"voting":0,"comment_count":37,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"VAE：VAE (variational autoencoder，变分自编码器) 是一种强大的生成模型， Encoder 把数据编码到隐空间 [公式] ，其学习条件概率 [公式] ， Decoder 把数据从隐空间中重建回来 [公式] ，其学习另一个条件概率 [公式] 。VAE 额外有一个限制条件是让 [公式] 满足 Gaussian 分布。这样做的好处就是训练结束后可以扔掉 Encoder，直接从这个先验分布上随便采样 [公式] ，然后通过 Decoder 就能生成一个 [公式] 。   VAE 最主…","excerpt_new":"VAE：VAE (variational autoencoder，变分自编码器) 是一种强大的生成模型， Encoder 把数据编码到隐空间 [公式] ，其学习条件概率 [公式] ， Decoder 把数据从隐空间中重建回来 [公式] ，其学习另一个条件概率 [公式] 。VAE 额外有一个限制条件是让 [公式] 满足 Gaussian 分布。这样做的好处就是训练结束后可以扔掉 Encoder，直接从这个先验分布上随便采样 [公式] ，然后通过 Decoder 就能生成一个 [公式] 。   VAE 最主…","preview_type":"default","preview_text":"","content":"\u003ch2\u003eVAE：\u003c/h2\u003e\u003cp data-pid=\"twycwkYJ\"\u003eVAE (variational autoencoder，变分自编码器) 是一种强大的生成模型， Encoder 把数据编码到隐空间 \u003cimg src=\"https://www.zhihu.com/equation?tex=z+%3D+Ecd%28x%29\" alt=\"z = Ecd(x)\" eeimg=\"1\"/\u003e ，其学习条件概率 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_%7B%5Cphi%7D%28z%7Cx%29\" alt=\"p_{\\phi}(z|x)\" eeimg=\"1\"/\u003e ， Decoder 把数据从隐空间中重建回来 \u003cimg src=\"https://www.zhihu.com/equation?tex=x+%3D+Dcd%28z%29\" alt=\"x = Dcd(z)\" eeimg=\"1\"/\u003e ，其学习另一个条件概率  \u003cimg src=\"https://www.zhihu.com/equation?tex=q_%7B%5Ctheta%7D%28x%7Cz%29\" alt=\"q_{\\theta}(x|z)\" eeimg=\"1\"/\u003e 。VAE 额外有一个限制条件是让 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 满足 Gaussian 分布。这样做的好处就是训练结束后可以扔掉 Encoder，直接从这个先验分布上随便采样 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e ，然后通过 Decoder 就能生成一个 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e 。\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-2786fc365ec122101906cbf93e6dee65_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2984\" data-rawheight=\"1498\" data-original-token=\"v2-c92fb73e6a6dd56af049c91ff70b4444\" class=\"origin_image zh-lightbox-thumb\" width=\"2984\" data-original=\"https://pic2.zhimg.com/v2-2786fc365ec122101906cbf93e6dee65_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"3IeAnSI0\"\u003eVAE 最主要的是这个 ELBO ： \u003cimg src=\"https://www.zhihu.com/equation?tex=ELBO%28%5Ctheta%2C+%5Cphi%29+%3D+E_%7Bz+%5Csim+p_%7B%5Cphi%7D%28z%7Cx%29%7D%5B%5Clog+q_%7B%5Ctheta%7D%28x%7Cz%29%5D+-+KL%28p_%7B%5Cphi%7D%28z%7Cx%29+%7C%7C+q%28z%29%29+%5C%5C\" alt=\"ELBO(\\theta, \\phi) = E_{z \\sim p_{\\phi}(z|x)}[\\log q_{\\theta}(x|z)] - KL(p_{\\phi}(z|x) || q(z)) \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"zUHthUNU\"\u003eELBO，即evidence low bound，evidence指的就是 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e ，而 ELBO 表示 evidence 的最小期望。我们要让这个 lower bound 尽可能变大，得到的模型就会更可能产生我们期望看到的 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e 。\u003c/p\u003e\u003cp data-pid=\"FA8Sc4Un\"\u003e为解释 ELBO 是怎么来的，我们一步一步来看。\u003c/p\u003e\u003ch3\u003eK-L散度：\u003c/h3\u003e\u003cp data-pid=\"GU_gIKJ6\"\u003e我们首先讲解 KL 散度，为衡量模型生成的分布与原始分布的相似度，常用的便是 K–L（ Kullback–Leibler ）散度。定义如下，对于两个具有概率密度函数 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_1%28x%29\" alt=\"p_1(x)\" eeimg=\"1\"/\u003e 和 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_2%28x%29\" alt=\"p_2(x)\" eeimg=\"1\"/\u003e 的分布：\u003c/p\u003e\u003cp data-pid=\"Wf6O6r7R\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=KL%5Cleft%28+p_1%28x%29%2C+p_2%28x%29+%5Cright%29+%3D+%5Cint+p_1%28x%29+%5Clog+%5Cfrac%7Bp_1%28x%29%7D%7Bp_2%28x%29%7D+dx++%5C%5C\" alt=\"KL\\left( p_1(x), p_2(x) \\right) = \\int p_1(x) \\log \\frac{p_1(x)}{p_2(x)} dx  \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"phaj0k7m\"\u003eK–L 散度具有两个重要性质：\u003c/p\u003e\u003cp data-pid=\"3Xj0O8O2\"\u003e1. \u003cb\u003e不对称性\u003c/b\u003e：显然，K–L 散度对于 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_1%28x%29\" alt=\"p_1(x)\" eeimg=\"1\"/\u003e 和 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_2%28x%29\" alt=\"p_2(x)\" eeimg=\"1\"/\u003e来说是不对称的。\u003c/p\u003e\u003cp data-pid=\"bDvui1Lb\"\u003e2. \u003cb\u003eGibbs 不等式\u003c/b\u003e：它总是【非负】的，并且当且仅当 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_1%28x%29\" alt=\"p_1(x)\" eeimg=\"1\"/\u003e 和 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_2%28x%29\" alt=\"p_2(x)\" eeimg=\"1\"/\u003e在每一处都相同时才为 0。\u003c/p\u003e\u003cp data-pid=\"4GzaZCPS\"\u003e为了理解这一点，我们可以将 KL 散度分解为两部分：\u003c/p\u003e\u003cp data-pid=\"rwESvd7p\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+K+L%5Cleft%28p_1%28x%29%2C+p_2%28x%29%5Cright%29+%26++%3D%5Cint+p_1%28x%29+%5Clog+p_1%28x%29+d+x-%5Cint+p_1%28x%29+%5Clog+p_2%28x%29+d+x+%5C%5C+%26+%3D-%5Cint+p_1%28x%29+%5Clog+p_2%28x%29+d+x-%5Cleft%28-%5Cint+p_1%28x%29+%5Clog+p_1%28x%29+d+x%5Cright%29%5Cend%7Baligned%7D+%5C%5C\" alt=\"\\begin{aligned} K L\\left(p_1(x), p_2(x)\\right) \u0026amp;  =\\int p_1(x) \\log p_1(x) d x-\\int p_1(x) \\log p_2(x) d x \\\\ \u0026amp; =-\\int p_1(x) \\log p_2(x) d x-\\left(-\\int p_1(x) \\log p_1(x) d x\\right)\\end{aligned} \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"zhsPlEXE\"\u003e第二项带有负号，其对应的是 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_1\" alt=\"p_1\" eeimg=\"1\"/\u003e的信息熵；第一项也带有负号，代表 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_1\" alt=\"p_1\" eeimg=\"1\"/\u003e和 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_2\" alt=\"p_2\" eeimg=\"1\"/\u003e之间的交叉熵。第一项始终不大于每个给定符号下的第二项，这便是 \u003cb\u003eGibbs 不等式\u003c/b\u003e；而 Gibbs 不等式的证明可以使用 \u003cb\u003eJensen 不等式\u003c/b\u003e：\u003c/p\u003e\u003cp data-pid=\"qxF2nke9\"\u003e 若 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cvarphi\" alt=\"\\varphi\" eeimg=\"1\"/\u003e 是凸函数，则有：\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cvarphi%28E%28X%29%29+%5Cleq+E%28%5Cvarphi%28X%29%29\" alt=\"\\varphi(E(X)) \\leq E(\\varphi(X))\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"t2ATA30A\"\u003e设 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cvarphi%28x%29+%3D+%5Clog+x\" alt=\"\\varphi(x) = \\log x\" eeimg=\"1\"/\u003e 由于 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cvarphi%27%27%28x%29+%3D+-1%2Fx%5E2+%5Cleq+0\" alt=\"\\varphi\u0026#39;\u0026#39;(x) = -1/x^2 \\leq 0\" eeimg=\"1\"/\u003e 所以其为凸函数，以及 \u003cimg src=\"https://www.zhihu.com/equation?tex=E%28X%29%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+p_1%28x%29%7D%5B%5Cfrac%7Bp_2%28x%29%7D%7Bp_1%28x%29%7D%5D\" alt=\"E(X)=\\mathbb{E}_{x \\sim p_1(x)}[\\frac{p_2(x)}{p_1(x)}]\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"s4ttZdjU\"\u003e那么：\u003c/p\u003e\u003cp data-pid=\"u9_myKNj\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=+E%28%5Cvarphi%28X%29%29+%3D+%5Cmathbb%7BE%7D_%7Bx+%5Csim+p_1%28x%29%7D%5Blog%5Cfrac%7Bp_2%28x%29%7D%7Bp_1%28x%29%7D%5D+%3D+%5Cint+p_1%28x%29+%5Clog+%5Cfrac%7Bp_2%28x%29%7D%7Bp_1%28x%29%7D+dx+%3D+-KL%5Cleft%28+p_1%28x%29%2C+p_2%28x%29+%5Cright%29+\" alt=\" E(\\varphi(X)) = \\mathbb{E}_{x \\sim p_1(x)}[log\\frac{p_2(x)}{p_1(x)}] = \\int p_1(x) \\log \\frac{p_2(x)}{p_1(x)} dx = -KL\\left( p_1(x), p_2(x) \\right) \" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"n62QA-AH\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cvarphi%28E%28X%29%29+%3D+log%28%5Cmathbb%7BE%7D_%7Bx+%5Csim+p_1%28x%29%7D%5B%5Cfrac%7Bp_1%28x%29%7D%7Bp_2%28x%29%7D%5D%29%3Dlog%5Cint+p_1%28x%29++%5Cfrac%7Bp_2%28x%29%7D%7Bp_1%28x%29%7D+dx%3Dlog%5Cint+p_2%28x%29dx%3Dlog1%3D0\" alt=\"\\varphi(E(X)) = log(\\mathbb{E}_{x \\sim p_1(x)}[\\frac{p_1(x)}{p_2(x)}])=log\\int p_1(x)  \\frac{p_2(x)}{p_1(x)} dx=log\\int p_2(x)dx=log1=0\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"m2UgrI11\"\u003e由 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cvarphi%28E%28X%29%29+%5Cleq+E%28%5Cvarphi%28X%29%29\" alt=\"\\varphi(E(X)) \\leq E(\\varphi(X))\" eeimg=\"1\"/\u003e 可得 \u003cimg src=\"https://www.zhihu.com/equation?tex=KL%5Cleft%28+p_1%28x%29%2C+p_2%28x%29+%5Cright%29%5Cgeq0\" alt=\"KL\\left( p_1(x), p_2(x) \\right)\\geq0\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003ch3\u003eVAE 理论框架（联合概率建模角度）：\u003c/h3\u003e\u003cp data-pid=\"pa8ifr3x\"\u003eVAE 框架可以从多个角度建立，例如\u003ca href=\"https://link.zhihu.com/?target=https%3A//kexue.fm/archives/5343\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e概率分布视角\u003c/a\u003e、\u003ca href=\"https://link.zhihu.com/?target=https%3A//amaires.github.io/VAE/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e贝叶斯视角\u003c/a\u003e 以及 \u003ca href=\"https://link.zhihu.com/?target=https%3A//kexue.fm/archives/5343\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e联合概率视角\u003c/a\u003e，这里我选用联合概率这一简单的方法来阐述：\u003c/p\u003e\u003cp data-pid=\"Mb6-eAqN\"\u003e假设原始数据样本为 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e ，分布为 \u003cimg src=\"https://www.zhihu.com/equation?tex=%7Bp%7D%28x%29\" alt=\"{p}(x)\" eeimg=\"1\"/\u003e ，我们希望借助隐变量 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e （标准正态分布）来建模 \u003cimg src=\"https://www.zhihu.com/equation?tex=%7Bp%7D%28x%29\" alt=\"{p}(x)\" eeimg=\"1\"/\u003e ，因此我们设立 \u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x%29\" alt=\"q(x)\" eeimg=\"1\"/\u003e 来逼近 \u003cimg src=\"https://www.zhihu.com/equation?tex=+p%28x%29\" alt=\" p(x)\" eeimg=\"1\"/\u003e :\u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x%29%3D%5Cint+q%28x+%5Cmid+z%29+q%28z%29+d+z%5C%5C\" alt=\"q(x)=\\int q(x \\mid z) q(z) d z\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"FvFSaz0C\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=q%28z%29\" alt=\"q(z)\" eeimg=\"1\"/\u003e 是标准正态分布， \u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x+%5Cmid+z%29\" alt=\"q(x \\mid z)\" eeimg=\"1\"/\u003e 是我们的生成式模型；此外还需明确的是 \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28x%29\" alt=\"p(x)\" eeimg=\"1\"/\u003e 是 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e 的原始分布， \u003cimg src=\"https://www.zhihu.com/equation?tex=q%28z+%5Cmid+x%29\" alt=\"q(z \\mid x)\" eeimg=\"1\"/\u003e 是encoder生成的 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e ，训练时要让其逼近正态分布。\u003c/p\u003e\u003cp data-pid=\"mfKyJSCH\"\u003e我们直接采用联合建模的角度，原来我们的目的是让 \u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x%29\" alt=\"q(x)\" eeimg=\"1\"/\u003e 来逼近 \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28x%29\" alt=\"p(x)\" eeimg=\"1\"/\u003e ，我们转变下思路变为让 \u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x%2Cz%29\" alt=\"q(x,z)\" eeimg=\"1\"/\u003e 与 \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28x%2Cz%29\" alt=\"p(x,z)\" eeimg=\"1\"/\u003e越相近越好，注意除了\u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x%2Cz%29\" alt=\"q(x,z)\" eeimg=\"1\"/\u003e， \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28x%2Cz%29\" alt=\"p(x,z)\" eeimg=\"1\"/\u003e中也有参数：\u003c/p\u003e\u003cp data-pid=\"A467gp3h\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=K+L%28p%28x%2C+z%29+%5C%7C+q%28x%2C+z%29%29%3D%5Ciint+p%28x%2C+z%29+%5Clog+%5Cfrac%7Bp%28x%2C+z%29%7D%7Bq%28x%2C+z%29%7D+d+z+d+x+%5C%5C\" alt=\"K L(p(x, z) \\| q(x, z))=\\iint p(x, z) \\log \\frac{p(x, z)}{q(x, z)} d z d x \\\\\" eeimg=\"1\"/\u003e KL 散度便是我们的终极目标，我们将从这个 KL 散度推导出最终的 ELBO：\u003c/p\u003e\u003cp data-pid=\"LtdV4HPm\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+K+L%28p%28x%2C+z%29+%5C%7C+q%28x%2C+z%29%29+%26+%3D%5Cint+p%28x%29%5Cleft%5B%5Cint+p%28z+%5Cmid+x%29+%5Clog+%5Cfrac%7Bp%28x%29+p%28z+%5Cmid+x%29%7D%7Bq%28x%2C+z%29%7D+d+z%5Cright%5D+d+x+%5C%5C+%26+%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+p%28x%29%7D%5Cleft%5B%5Cint+p%28z+%5Cmid+x%29+%5Clog+%5Cfrac%7Bp%28x%29+p%28z+%5Cmid+x%29%7D%7Bq%28x%2C+z%29%7D+d+z%5Cright%5D+%5C%5C+%26+%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+p%28x%29%7D%5Cleft%5B%5Cint+p%28z+%5Cmid+x%29+%5Clog+p%28x%29+d+z%5Cright%5D%2B%5Cmathbb%7BE%7D_%7Bx+%5Csim+p%28x%29%7D%5Cleft%5B%5Cint+p%28z+%5Cmid+x%29+%5Clog+%5Cfrac%7Bp%28z+%5Cmid+x%29%7D%7Bq%28x+%5Cmid+z%29+q%28z%29%7D+d+z%5Cright%5D%5Cend%7Baligned%7D+%5C%5C\" alt=\"\\begin{aligned} K L(p(x, z) \\| q(x, z)) \u0026amp; =\\int p(x)\\left[\\int p(z \\mid x) \\log \\frac{p(x) p(z \\mid x)}{q(x, z)} d z\\right] d x \\\\ \u0026amp; =\\mathbb{E}_{x \\sim p(x)}\\left[\\int p(z \\mid x) \\log \\frac{p(x) p(z \\mid x)}{q(x, z)} d z\\right] \\\\ \u0026amp; =\\mathbb{E}_{x \\sim p(x)}\\left[\\int p(z \\mid x) \\log p(x) d z\\right]+\\mathbb{E}_{x \\sim p(x)}\\left[\\int p(z \\mid x) \\log \\frac{p(z \\mid x)}{q(x \\mid z) q(z)} d z\\right]\\end{aligned} \\\\\" eeimg=\"1\"/\u003e这里被我们拆开为两项，第一项： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+%5Cmathbb%7BE%7D_%7Bx+%5Csim+%7Bp%7D%28x%29%7D%5Cleft%5B%5Cint+p%28z+%5Cmid+x%29+%5Clog+%7Bp%7D%28x%29+d+z%5Cright%5D+%26+%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+%7Bp%7D%28x%29%7D%5Cleft%5B%5Clog+%7Bp%7D%28x%29+%5Cint+p%28z+%5Cmid+x%29+d+z%5Cright%5D+%5C%5C+%26+%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+%7Bp%7D%28x%29%7D%5B%5Clog+%7Bp%7D%28x%29%5D+%5C%5C%26+%3D+%E5%B8%B8%E6%95%B0%5Cend%7Baligned%7D+%5C%5C\" alt=\"\\begin{aligned} \\mathbb{E}_{x \\sim {p}(x)}\\left[\\int p(z \\mid x) \\log {p}(x) d z\\right] \u0026amp; =\\mathbb{E}_{x \\sim {p}(x)}\\left[\\log {p}(x) \\int p(z \\mid x) d z\\right] \\\\ \u0026amp; =\\mathbb{E}_{x \\sim {p}(x)}[\\log {p}(x)] \\\\\u0026amp; = 常数\\end{aligned} \\\\\" eeimg=\"1\"/\u003e 无论 \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28x%29\" alt=\"p(x)\" eeimg=\"1\"/\u003e 是什么，它一定是确定的，故第一项是常数\u003c/p\u003e\u003cp data-pid=\"MfKdWMik\"\u003e第二项： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+%5Cmathcal%7BL%7D+%26+%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+%7Bp%7D%28x%29%7D%5Cleft%5B%5Cint+p%28z+%5Cmid+x%29+%5Clog+%5Cfrac%7Bp%28z+%5Cmid+x%29%7D%7Bq%28x+%5Cmid+z%29+q%28z%29%7D+d+z%5Cright%5D+%5C%5C+%26+%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+%7Bp%7D%28x%29%7D%5Cleft%5B-%5Cint+p%28z+%5Cmid+x%29+%5Clog+q%28x+%5Cmid+z%29+d+z%2B%5Cint+p%28z+%5Cmid+x%29+%5Clog+%5Cfrac%7Bp%28z+%5Cmid+x%29%7D%7Bq%28z%29%7D+d+z%5Cright%5D+%5C%5C%26+%3D%5Cmathbb%7BE%7D_%7Bx+%5Csim+%7Bp%7D%28x%29%7D%5Cleft%5B%5Cmathbb%7BE%7D_%7Bz+%5Csim+p%28z+%5Cmid+x%29%7D%5B-%5Clog+q%28x+%5Cmid+z%29%5D%2BK+L%28p%28z+%5Cmid+x%29+%5C%7C+q%28z%29%29%5Cright%5D+%5C%5C+%26+%3D+%5Cmathbb%7BE%7D_%7Bz+%5Csim+p%28z+%5Cmid+x%29%7D%5B-ELBO%5D%5Cend%7Baligned%7D++%5C%5C\" alt=\"\\begin{aligned} \\mathcal{L} \u0026amp; =\\mathbb{E}_{x \\sim {p}(x)}\\left[\\int p(z \\mid x) \\log \\frac{p(z \\mid x)}{q(x \\mid z) q(z)} d z\\right] \\\\ \u0026amp; =\\mathbb{E}_{x \\sim {p}(x)}\\left[-\\int p(z \\mid x) \\log q(x \\mid z) d z+\\int p(z \\mid x) \\log \\frac{p(z \\mid x)}{q(z)} d z\\right] \\\\\u0026amp; =\\mathbb{E}_{x \\sim {p}(x)}\\left[\\mathbb{E}_{z \\sim p(z \\mid x)}[-\\log q(x \\mid z)]+K L(p(z \\mid x) \\| q(z))\\right] \\\\ \u0026amp; = \\mathbb{E}_{z \\sim p(z \\mid x)}[-ELBO]\\end{aligned}  \\\\\" eeimg=\"1\"/\u003e 因此我们很快便得到了最终的 ELBO，注意多了个负号。\u003c/p\u003e\u003ch3\u003eELBO：\u003c/h3\u003e\u003cp data-pid=\"sg3WLleD\"\u003eELBO 有两项，分别为： \u003cimg src=\"https://www.zhihu.com/equation?tex=E_%7Bz+%5Csim+p_%7B%5Cphi%7D%28z%7Cx%29%7D%5B%5Clog+q_%7B%5Ctheta%7D%28x%7Cz%29%5D\" alt=\"E_{z \\sim p_{\\phi}(z|x)}[\\log q_{\\theta}(x|z)]\" eeimg=\"1\"/\u003e 以及 \u003cimg src=\"https://www.zhihu.com/equation?tex=-+KL%28p_%7B%5Cphi%7D%28z%7Cx%29+%7C%7C+q%28z%29%29\" alt=\"- KL(p_{\\phi}(z|x) || q(z))\" eeimg=\"1\"/\u003e ，这两部分可以理解为【\u003cb\u003e重构误差项】\u003c/b\u003e以及【\u003cb\u003eKL散度项】：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"JywNRBhE\"\u003e重构误差项：\u003cimg src=\"https://www.zhihu.com/equation?tex=E_%7Bz+%5Csim+p_%7B%5Cphi%7D%28z%7Cx%29%7D%5B%5Clog+q_%7B%5Ctheta%7D%28x%7Cz%29%5D\" alt=\"E_{z \\sim p_{\\phi}(z|x)}[\\log q_{\\theta}(x|z)]\" eeimg=\"1\"/\u003e这部分度量了模型生成数据的质量，即解码器 \u003cimg src=\"https://www.zhihu.com/equation?tex=D_%5Ctheta\" alt=\"D_\\theta\" eeimg=\"1\"/\u003e 使用从编码器 \u003cimg src=\"https://www.zhihu.com/equation?tex=E_%5Cphi\" alt=\"E_\\phi\" eeimg=\"1\"/\u003e 采样的 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 来重构输入 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e 的准确性，这是负对数似然，表明给定潜在变量 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 后，重构原来的 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e 的概率有多大。目标是最大化这部分期望值，即希望模型能生成与输入 x 尽可能接近的数据。\u003c/p\u003e\u003cp data-pid=\"xBMnUTW2\"\u003eKL散度项：\u003cimg src=\"https://www.zhihu.com/equation?tex=-+KL%28p_%7B%5Cphi%7D%28z%7Cx%29+%7C%7C+q%28z%29%29\" alt=\"- KL(p_{\\phi}(z|x) || q(z))\" eeimg=\"1\"/\u003e是后验分布 \u003cimg src=\"https://www.zhihu.com/equation?tex=p_%5Cphi%28z+%5Cmid+x%29\" alt=\"p_\\phi(z \\mid x)\" eeimg=\"1\"/\u003e 和先验分布 \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28z%29\" alt=\"p(z)\" eeimg=\"1\"/\u003e 之间的负K–L 散度，以此衡量编码器的输出分布与标准正态分布的差异。目标是最小化KL散度，确保潜在变量 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 尽可能接近正态分布。\u003c/p\u003e\u003cp data-pid=\"xAuTeurz\"\u003e至此我们推导出了VAE的损失函数，了解了ELBO的原理。\u003c/p\u003e\u003ch2\u003eVQ-VAE：\u003c/h2\u003e\u003cp data-pid=\"o1cqrZcO\"\u003epaper：\u003ca href=\"https://link.zhihu.com/?target=https%3A//arxiv.org/abs/1711.00937\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eNeural Discrete Representation Learning\u003c/a\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-47060ecb6dffbffb199be1b1356efec1_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"1810\" data-rawheight=\"566\" data-original-token=\"v2-e938421ca0b48da0b768ea4abac4a810\" class=\"origin_image zh-lightbox-thumb\" width=\"1810\" data-original=\"https://picx.zhimg.com/v2-47060ecb6dffbffb199be1b1356efec1_r.jpg\"/\u003e\u003cfigcaption\u003epaper：Neural Discrete Representation Learning\u003c/figcaption\u003e\u003c/figure\u003e\u003ch3\u003e背景：\u003c/h3\u003e\u003cp data-pid=\"C64eNSwQ\"\u003eVAE中的隐变量 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 的每一维都是一个连续值， 而VQ-VAE 中 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 的每一维都是离散的整数，这些整数便可 index 到已训练好的 codebook（码本，本质上就是一批 embedding）。这样做符合自然界模态的特点，例如语言本质上就是由很多字符组成，每个字符都可以是用数字索引到字符库里的某个字符，NLP中可以理解为token_id索引到vocab里的某个token，所以VQ-VAE可以理解为 【\u003cb\u003e图像tokenization\u003c/b\u003e】 的过程，事实上这种思想可以借鉴引用到很多领域，例如广告推荐里将广告用一串索引表示。\u003c/p\u003e\u003cp data-pid=\"vBBu_8BT\"\u003e文章还指出，VAE 存在\u003cb\u003e后验坍塌（Posterior Collapse）\u003c/b\u003e的问题，这一般是由散度消失（KL-Vanishinig）导致的，因此该问题也称为KL-vanishing。简单来说就是解码器太强，模型的 \u003cb\u003e潜在空间（latent space）无效化\u003c/b\u003e，即编码器 \u003cimg src=\"https://www.zhihu.com/equation?tex=q_%5Cphi%28z+%5Cmid+x%29\" alt=\"q_\\phi(z \\mid x)\" eeimg=\"1\"/\u003e 退化为与先验 \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28z%29%3DN%280%2CI%29\" alt=\"p(z)=N(0,I)\" eeimg=\"1\"/\u003e 相同的分布，ELBO里的KL散度项为0，而忽略了输入数据的信息。\u003c/p\u003e\u003ch3\u003e方法：\u003c/h3\u003e\u003cp data-pid=\"3AOXoMf1\"\u003e将隐变量 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 离散化的关键操作是VQ, 即 vector quatization。\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-6f582127c21767504633a85e95614b9f_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"1796\" data-rawheight=\"776\" data-original-token=\"v2-bb889976a4aa9ccb127444f9531d9508\" class=\"origin_image zh-lightbox-thumb\" width=\"1796\" data-original=\"https://pic2.zhimg.com/v2-6f582127c21767504633a85e95614b9f_r.jpg\"/\u003e\u003cfigcaption\u003e图1. VQ-VAE 流程图\u003c/figcaption\u003e\u003c/figure\u003e\u003col\u003e\u003cli data-pid=\"Ddkbo6qQ\"\u003e图像 \u003cimg src=\"https://www.zhihu.com/equation?tex=x\" alt=\"x\" eeimg=\"1\"/\u003e 输入至 encoder 中得到 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e :  \u003cimg src=\"https://www.zhihu.com/equation?tex=z_e%3De+n+c+o+d+e+r%28x%29\" alt=\"z_e=e n c o d e r(x)\" eeimg=\"1\"/\u003e \u003c/li\u003e\u003cli data-pid=\"ODs66qaN\"\u003ecodebook 是一个K*D 的 table（紫色方块）： \u003cimg src=\"https://www.zhihu.com/equation?tex=E%3D%5Cleft%5Be_1%2C+e_2%2C+%5Cldots%2C+e_K%5Cright%5D\" alt=\"E=\\left[e_1, e_2, \\ldots, e_K\\right]\" eeimg=\"1\"/\u003e \u003c/li\u003e\u003cli data-pid=\"wLYBp5A6\"\u003e将\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e中每一维都映射为 codebook 中K个embedding之一 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_q%28x%29%3De_k%2C+%5Cquad+where+%5Cquad+k%3D%5Coperatorname%7Bargmin%7D_j%5Cleft%5C%7Cz_e%28x%29-e_j%5Cright%5C%7C_2\" alt=\"z_q(x)=e_k, \\quad where \\quad k=\\operatorname{argmin}_j\\left\\|z_e(x)-e_j\\right\\|_2\" eeimg=\"1\"/\u003e \u003c/li\u003e\u003cli data-pid=\"ewkCKo6S\"\u003e全部替换后图中绿色的\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e变为紫色的\u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e，然后进行重构\u003c/li\u003e\u003c/ol\u003e\u003cp data-pid=\"QE7IKj2m\"\u003e从\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e到\u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e的变化可以理解为聚类，如图中右子图所示，由于变化后的embedding位于codebook内，当然就可以只用整数来表示。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e训练： \u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"0xND5CnK\"\u003e\u003cb\u003eELBO 损失项：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"AYh-9Gwb\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=ELBO%28%5Ctheta%2C+%5Cphi%29+%3D+E_%7Bz+%5Csim+q_%7B%5Cphi%7D%28z%7Cx%29%7D%5B%5Clog+p_%7B%5Ctheta%7D%28x%7Cz%29%5D+-+KL%28q_%7B%5Cphi%7D%28z%7Cx%29+%7C%7C+p%28z%29%29+%5C%5C\" alt=\"ELBO(\\theta, \\phi) = E_{z \\sim q_{\\phi}(z|x)}[\\log p_{\\theta}(x|z)] - KL(q_{\\phi}(z|x) || p(z)) \\\\\" eeimg=\"1\"/\u003e 我们先看原有的 ELBO ，这里p和q互换以与图示对应，q代表encoder，p代表decoder；\u003c/p\u003e\u003cp data-pid=\"C9uZ5FaS\"\u003e这里后验分布 \u003cimg src=\"https://www.zhihu.com/equation?tex=q%28z%7Cx%29\" alt=\"q(z|x)\" eeimg=\"1\"/\u003e 里都是one-hot向量，如下所示：\u003c/p\u003e\u003cp data-pid=\"ANomBaAY\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=q%28z%3Dk+%5Cmid+x%29%3D+%5Cbegin%7Bcases%7D1+%26+%5Ctext+%7B+for+%7D+%5Cmathrm%7Bk%7D%3D%5Coperatorname%7Bargmin%7D_j%5Cleft%5C%7Cz_e%28x%29-e_j%5Cright%5C%7C_2%2C+%5C%5C+0+%26+%5Ctext+%7B+otherwise+%7D%5Cend%7Bcases%7D%5C%5C\" alt=\"q(z=k \\mid x)= \\begin{cases}1 \u0026amp; \\text { for } \\mathrm{k}=\\operatorname{argmin}_j\\left\\|z_e(x)-e_j\\right\\|_2, \\\\ 0 \u0026amp; \\text { otherwise }\\end{cases}\\\\\" eeimg=\"1\"/\u003e 而非之前VAE里的正态分布，由此 \u003cimg src=\"https://www.zhihu.com/equation?tex=q_%7B%5Cphi%7D%28z%7Cx%29\" alt=\"q_{\\phi}(z|x)\" eeimg=\"1\"/\u003e 预估的每一维都是codebook里每个embedding的概率；我们假设采样的先验分布 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 是均匀分布，则每一维对于某个embedding选取概率有 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cfrac%7B1%7D%7BK%7D\" alt=\"\\frac{1}{K}\" eeimg=\"1\"/\u003e ，则有：\u003c/p\u003e\u003cp data-pid=\"-Nq7Kxb8\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=KL%28q_%7B%5Cphi%7D%28z%7Cx%29+%7C%7C+p%28z%29%29%3D%5Cint+q_%7B%5Cphi%7D%28z%7Cx%29+log+%5Cfrac%7Bq_%7B%5Cphi%7D%28z%7Cx%29%7D%7Bp%28z%29%7Ddz%3D1+%5Ccdot+%5Clog+%5Cleft%28%5Cfrac%7B1%7D%7B%5Cfrac%7B1%7D%7BK%7D%7D%5Cright%29%2B%28K-1%29+%5Ctimes+0+%5Ccdot+%5Clog+%5Cleft%28%5Cfrac%7B0%7D%7B%5Cfrac%7B1%7D%7BK%7D%7D%5Cright%29%3D%5Clog+K+%5C%5C\" alt=\"KL(q_{\\phi}(z|x) || p(z))=\\int q_{\\phi}(z|x) log \\frac{q_{\\phi}(z|x)}{p(z)}dz=1 \\cdot \\log \\left(\\frac{1}{\\frac{1}{K}}\\right)+(K-1) \\times 0 \\cdot \\log \\left(\\frac{0}{\\frac{1}{K}}\\right)=\\log K \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"mjmvGKKX\"\u003e第一项表示one-hot中为1对应的那一维对KL散度的贡献，第二项代表其他维的贡献。\u003c/p\u003e\u003cp data-pid=\"kt9SGYvH\"\u003e因此 ELBO 中第二项可以忽略，只有重构损失项。\u003c/p\u003e\u003cp data-pid=\"76knrMFJ\"\u003e那我们再看第一项损失，可以简单写为： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cleft%5C%7Cx-%5Coperatorname%7Bdecoder%7D%5Cleft%28z_q%5Cright%29%5Cright%5C%7C_2%5E2\" alt=\"\\left\\|x-\\operatorname{decoder}\\left(z_q\\right)\\right\\|_2^2\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"m9ZQYIKo\"\u003e然而 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e 包含了argmin，这个操作是没有梯度的，无法更新 encoder；VQ-VAE 使用了一个很精巧也很直接的方法，称为 \u003cb\u003eStraight-Through Estimator\u003c/b\u003e，称为“\u003ca href=\"https://link.zhihu.com/?target=https%3A//papers.cool/arxiv/1308.3432\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e直通估计\u003c/a\u003e”。其思想是在前向传播的时候可以任意变量（可以不可导），而反向传播的时候，直接 \u003cb\u003e跳过 \u003c/b\u003e这个不可导的操作。对应图1中红色箭头，表明跳过 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cnabla_%7B%5Cmathrm%7Bz%7D%7D+%5Cmathrm%7BL%7D\" alt=\"\\nabla_{\\mathrm{z}} \\mathrm{L}\" eeimg=\"1\"/\u003e 的操作。\u003c/p\u003e\u003cp data-pid=\"GKl0hzOf\"\u003e根据这个思想，我们设计的目标函数是 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cleft%5C%7Cx-%5Coperatorname%7Bdecoder%7D%5Cleft%28z_e%2B%5Coperatorname%7Bsg%7D%5Cleft%5Bz_q-z_e%5Cright%5D%5Cright%29%5Cright%5C%7C_2%5E2+%5C%5C\" alt=\"\\left\\|x-\\operatorname{decoder}\\left(z_e+\\operatorname{sg}\\left[z_q-z_e\\right]\\right)\\right\\|_2^2 \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"K6QEz6ji\"\u003esg 代表阻止梯度回传\u003c/p\u003e\u003cp data-pid=\"N4mOcFxM\"\u003e\u003cb\u003ecodebook 损失项： \u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"UrcBLKTh\"\u003e为使得 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e 与 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e尽量接近，设置损失： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cleft%5C%7Cz_e-z_q%5Cright%5C%7C_2%5E2\" alt=\"\\left\\|z_e-z_q\\right\\|_2^2\" eeimg=\"1\"/\u003e ；\u003c/p\u003e\u003cp data-pid=\"Jk66WBoZ\"\u003e这里我们理解下：\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e是编码器得到的，\u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e是\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e离得最近的embedding，两者都有可训练的参数；因此在实际训练时，codebook相对自由宽松，没什么限制条件，而编码器生成的\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e要保证重建效果，我们更希望\u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e主要靠近\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e，并且因为 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cleft%5C%7Cz_e-z_q%5Cright%5C%7C_2%5E2\" alt=\"\\left\\|z_e-z_q\\right\\|_2^2\" eeimg=\"1\"/\u003e 的梯度等于\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e以及\u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e梯度之和，故可拆解为：\u003c/p\u003e\u003cp data-pid=\"jT3O_Weh\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cleft%5C%7Cs+g%5Cleft%5Bz_e%5Cright%5D-z_q%5Cright%5C%7C_2%5E2%2B%5Cleft%5C%7Cz_e-s+g%5Bz_q%5D%5Cright%5C%7C_2%5E2+%5C%5C\" alt=\"\\left\\|s g\\left[z_e\\right]-z_q\\right\\|_2^2+\\left\\|z_e-s g[z_q]\\right\\|_2^2 \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"3B680yvt\"\u003e第一项可以理解为\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e不变，\u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e主要靠近\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e，第二项相反，由此我们可以给第二项设置一个相对较小的权重，来达到更希望\u003cimg src=\"https://www.zhihu.com/equation?tex=z_q\" alt=\"z_q\" eeimg=\"1\"/\u003e主要靠近\u003cimg src=\"https://www.zhihu.com/equation?tex=z_e\" alt=\"z_e\" eeimg=\"1\"/\u003e的效果。\u003c/p\u003e\u003cp data-pid=\"uqvJW3DQ\"\u003e\u003cb\u003e整体损失项：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"1vFI8mkX\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BL%7D+%3D+%5Cleft%5C%7Cx-%5Coperatorname%7Bdecoder%7D%5Cleft%28z_e%2B%5Coperatorname%7Bsg%7D%5Cleft%5Bz_q-z_e%5Cright%5D%5Cright%29%5Cright%5C%7C_2%5E2++%2B+%5Cleft%5C%7Cs+g%5Cleft%5Bz_e%5Cright%5D-z_q%5Cright%5C%7C_2%5E2%2B%5Cbeta%5Cleft%5C%7Cz_e-s+g%5Bz_q%5D%5Cright%5C%7C_2%5E2+%5C%5C\" alt=\"\\mathcal{L} = \\left\\|x-\\operatorname{decoder}\\left(z_e+\\operatorname{sg}\\left[z_q-z_e\\right]\\right)\\right\\|_2^2  + \\left\\|s g\\left[z_e\\right]-z_q\\right\\|_2^2+\\beta\\left\\|z_e-s g[z_q]\\right\\|_2^2 \\\\\" eeimg=\"1\"/\u003e 文中指出，实验发现 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbeta\" alt=\"\\beta\" eeimg=\"1\"/\u003e 设置[0,1]均具有鲁棒性，故使用 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbeta%3D%5Cfrac%7B1%7D%7B4%7D\" alt=\"\\beta=\\frac{1}{4}\" eeimg=\"1\"/\u003e ，还可以使用滑动平均的方式更新，下面阐述。\u003c/p\u003e\u003cp data-pid=\"EqAVbWd3\"\u003e\u003cb\u003e滑动平均方法：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"SYyx86Mn\"\u003e具体来说使用 指数移动平均（EMA）来更新 codebook ： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5ClVert+sg%5Bz_e%28x%29%5D+-+e+%5CrVert_2%5E2.\" alt=\"\\lVert sg[z_e(x)] - e \\rVert_2^2.\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"Gwt02lfs\"\u003e设 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_%7Bi%2C1%7D%2C+z_%7Bi%2C2%7D%2C+%5Cldots%2C+z_%7Bi%2Cn_i%7D\" alt=\"z_{i,1}, z_{i,2}, \\ldots, z_{i,n_i}\" eeimg=\"1\"/\u003e 为编码器输出中最接近词典项 \u003cimg src=\"https://www.zhihu.com/equation?tex=e_i\" alt=\"e_i\" eeimg=\"1\"/\u003e 的一组 \u003cimg src=\"https://www.zhihu.com/equation?tex=n_i\" alt=\"n_i\" eeimg=\"1\"/\u003e 个元素，那么可以将损失写为：\u003c/p\u003e\u003cp data-pid=\"_7SFDTe3\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csum_%7Bj%3D1%7D%5E%7Bn_i%7D+%5ClVert+z_%7Bi%2Cj%7D+-+e_i+%5CrVert_2%5E2.%5C%5C\" alt=\"\\sum_{j=1}^{n_i} \\lVert z_{i,j} - e_i \\rVert_2^2.\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"8sE0ZVVV\"\u003e理论上可以求得 \u003cimg src=\"https://www.zhihu.com/equation?tex=e_i\" alt=\"e_i\" eeimg=\"1\"/\u003e 的最优值，可以通过封闭形式的解求得，即该集合中所有元素的平均值： \u003cimg src=\"https://www.zhihu.com/equation?tex=e_i+%3D+%5Cfrac%7B1%7D%7Bn_i%7D+%5Csum_%7Bj%3D1%7D%5E%7Bn_i%7D+z_%7Bi%2Cj%7D.%5C%5C\" alt=\"e_i = \\frac{1}{n_i} \\sum_{j=1}^{n_i} z_{i,j}.\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"k04R6rUd\"\u003e这种更新方法通常用于 K-Means 等算法。然而，当处理小批量（minibatches）时，无法直接使用上述更新方式。因此，我们可以采用指数移动平均，作为该更新的在线版本： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+N_i%5E%7B%28t%29%7D+%26+%3A%3DN_i%5E%7B%28t-1%29%7D+%2A+%5Cgamma%2Bn_i%5E%7B%28t%29%7D%281-%5Cgamma%29+%5C%5C+m_i%5E%7B%28t%29%7D+%26+%3A%3Dm_i%5E%7B%28t-1%29%7D+%2A+%5Cgamma%2B%5Csum_j+z_%7Bi%2C+j%7D%5E%7B%28t%29%7D%281-%5Cgamma%29+%5C%5C+e_i%5E%7B%28t%29%7D+%26+%3A%3D%5Cfrac%7Bm_i%5E%7B%28t%29%7D%7D%7BN_i%5E%7B%28t%29%7D%7D%5Cend%7Baligned%7D+%5C%5C\" alt=\"\\begin{aligned} N_i^{(t)} \u0026amp; :=N_i^{(t-1)} * \\gamma+n_i^{(t)}(1-\\gamma) \\\\ m_i^{(t)} \u0026amp; :=m_i^{(t-1)} * \\gamma+\\sum_j z_{i, j}^{(t)}(1-\\gamma) \\\\ e_i^{(t)} \u0026amp; :=\\frac{m_i^{(t)}}{N_i^{(t)}}\\end{aligned} \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"-aC8c_ya\"\u003e其中， \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cgamma\" alt=\"\\gamma\" eeimg=\"1\"/\u003e 的取值范围在 0 到 1 之间，论文发现 0.99 是一个不错的选择。\u003c/p\u003e\u003ch3\u003e应用：\u003c/h3\u003e\u003cp data-pid=\"730eQkGG\"\u003e按照之前 VAE 的逻辑，使用时去掉encoder，在正态分布里采样即可生成图片；那么VQ-VAE呢？其假设先验分布为均匀分布，然而并没有直接在均匀分布里采样，而是使用 \u003cb\u003ePixelCNN\u003c/b\u003e 来学习编码的分布（这里非常奇怪，在issue一节讨论），即学习 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_q%28x%29\" alt=\"z_q(x)\" eeimg=\"1\"/\u003e 。\u003c/p\u003e\u003cp data-pid=\"rvxK2x5x\"\u003e简单介绍下，PixelCNN 是一种采用自回归方式逐像素从左上角生成的图像生成模型，其中使用了mask conv操作，可以类比 GPT，使用 mask self-attention 操作。\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-c2d1e86942837ccf29d5278319fbdab4_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"662\" data-rawheight=\"205\" data-original-token=\"v2-aab19695a9db79dba5cf5c1b87978cba\" class=\"origin_image zh-lightbox-thumb\" width=\"662\" data-original=\"https://pica.zhimg.com/v2-c2d1e86942837ccf29d5278319fbdab4_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"SVvOVxU5\"\u003e所以最后我们通过 PixelCNN 来随机生成 \u003cimg src=\"https://www.zhihu.com/equation?tex=z_q%28x%29\" alt=\"z_q(x)\" eeimg=\"1\"/\u003e，然后再用VQ-VAE的 Decoder 来生成最后的图片。\u003c/p\u003e\u003ch3\u003eIssue：\u003c/h3\u003e\u003cp data-pid=\"nNdOxxVX\"\u003e\u003cb\u003eVQ-VAE 到底是不是 VAE ？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"hMW56gpg\"\u003eVAE 的核心是encoder学习一个先验分布，最后只需要从这个先验分布里采样就可以用来生成，然而VQ-VAE事实上并不行，其假设先验分布为均匀分布，但并不能从均匀分布里采样解码得到真实图像，这就说明这就\u003cb\u003e不过只是一个AE 类模型\u003c/b\u003e。\u003c/p\u003e\u003cp data-pid=\"kmVZ00k4\"\u003e那么问题出在哪了？回顾 VQ-VAE 的设计，发现并没有类似 VAE 里的 KL散度loss 来迫使先验分布逼近均匀分布。你可能会问假设分布是均匀分布，KL散度是一个常数呀，上面不是还推导了？那么我们再回顾一下：\u003c/p\u003e\u003cp data-pid=\"qr_w0Bsf\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=KL%28q_%7B%5Cphi%7D%28z%7Cx%29+%7C%7C+p%28z%29%29%3D%5Clog+K+%5C%5C\" alt=\"KL(q_{\\phi}(z|x) || p(z))=\\log K \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"VEgfHbCV\"\u003eKL散度是常数，那么这一项就不会优化，也就不存在要让 \u003cimg src=\"https://www.zhihu.com/equation?tex=q_%7B%5Cphi%7D%28z%7Cx%29\" alt=\"q_{\\phi}(z|x)\" eeimg=\"1\"/\u003e 更逼近 \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28z%29\" alt=\"p(z)\" eeimg=\"1\"/\u003e 的说法，也就是 \u003cimg src=\"https://www.zhihu.com/equation?tex=q_%7B%5Cphi%7D%28z%7Cx%29\" alt=\"q_{\\phi}(z|x)\" eeimg=\"1\"/\u003e 不会被更新，其生成的分布根本不可控。\u003c/p\u003e\u003cp data-pid=\"En_77mMO\"\u003e那么继续深究，这一项为何会是常数？原因就在于 \u003cimg src=\"https://www.zhihu.com/equation?tex=q_%7B%5Cphi%7D%28z%7Cx%29\" alt=\"q_{\\phi}(z|x)\" eeimg=\"1\"/\u003e 始终是一个one-hot分布，无论怎么优化都是如此，而one-hot分布和均匀分布的 KL散度 始终是 logK，因此 ELBO里 的这一项毫无意义。\u003c/p\u003e\u003cp data-pid=\"XpEuHfxR\"\u003e其实本质上VQ-VAE 做的是【\u003cb\u003e图像 tokenization\u003c/b\u003e】的工作，生成模型部分交给自回归模型 PixelCNN 去负责了。\u003c/p\u003e\u003cblockquote data-pid=\"8DWjMGRE\"\u003e此外：苏神在 \u003ca href=\"https://link.zhihu.com/?target=https%3A//spaces.ac.cn/archives/6760/comment-page-2%23comments\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e博客\u003c/a\u003e 评论里还指出 VQ-VAE里边从均匀分布采样离散的code直接传入decoder，生成结果也不至于差得完全不可看，还是勉强能看的，比纯AE要好点，但要保证质量，还是得 pixelcnn。\u003c/blockquote\u003e\u003cp data-pid=\"D90BdTVM\"\u003e\u003cb\u003eVQ-VAE 的核心贡献？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"TWMxmQpA\"\u003e核心贡献不在于其提出了一种新的 VAE 架构，而在于提供了一个序列压缩技术。正如上所说，其本质是一个利用codebook 做图像 tokenization 的工作，然而这种 codebook 的思想不仅可以应用于图像，音频、视频甚至短视频、广告都是可以的，所以我们才看到VQ-VAE的思想应用于各个领域，这才是VQ-VAE的魅力所在。\u003c/p\u003e\u003ch3\u003eVQ-VAE-2：\u003c/h3\u003e\u003cp data-pid=\"TA9jJi55\"\u003e论文：\u003ca href=\"https://link.zhihu.com/?target=https%3A//arxiv.org/pdf/1906.00446\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://\u003c/span\u003e\u003cspan class=\"visible\"\u003earxiv.org/pdf/1906.0044\u003c/span\u003e\u003cspan class=\"invisible\"\u003e6\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-9dbfac884baa83c2f223afef877a15f1_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1598\" data-rawheight=\"908\" data-original-token=\"v2-307241cd2bd9d96a50772304dad5c591\" class=\"origin_image zh-lightbox-thumb\" width=\"1598\" data-original=\"https://picx.zhimg.com/v2-9dbfac884baa83c2f223afef877a15f1_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"RXmvpdKp\"\u003e主要变化就是把 VQ-VAE 的 encoder 和 decoder 都进行了分层, bottom层对local feature进行建模，top层采取全局自注意力机制。\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-0f1497620138f5957f565973846d091c_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1614\" data-rawheight=\"820\" data-original-token=\"v2-66eacf02d107d06f8aef65ab5b5afb6b\" class=\"origin_image zh-lightbox-thumb\" width=\"1614\" data-original=\"https://pic3.zhimg.com/v2-0f1497620138f5957f565973846d091c_r.jpg\"/\u003e\u003c/figure\u003e\u003ch2\u003eRQ-VAE：\u003c/h2\u003e\u003cp data-pid=\"8LjeetQ3\"\u003epaper：\u003ca href=\"https://link.zhihu.com/?target=https%3A//arxiv.org/pdf/2203.01941\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://\u003c/span\u003e\u003cspan class=\"visible\"\u003earxiv.org/pdf/2203.0194\u003c/span\u003e\u003cspan class=\"invisible\"\u003e1\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-3ac8bbd6e225e771f3ab5a26a00d0746_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"1724\" data-rawheight=\"560\" data-original-token=\"v2-4a583abd72bdab4320e5dbf25993c4ac\" class=\"origin_image zh-lightbox-thumb\" width=\"1724\" data-original=\"https://pic1.zhimg.com/v2-3ac8bbd6e225e771f3ab5a26a00d0746_r.jpg\"/\u003e\u003cfigcaption\u003epaper：https://arxiv.org/pdf/2203.01941\u003c/figcaption\u003e\u003c/figure\u003e\u003ch3\u003e背景：\u003c/h3\u003e\u003cp data-pid=\"Phha0tks\"\u003eVQ-VAE 的序列长度较长，需要大量的codebook，这势必会导致\u003ci\u003ecodebook collapse（码本摊缩）\u003c/i\u003e问题，使得VQ-VAE的训练很不稳定；而 RQ-VAE 则采取一种 \u003ci\u003eresidual quantization（残差量化）\u003c/i\u003e的新方法，通过D轮迭代，将feature map表示为D个堆叠的离散编码，可以进一步减小feature map（可以理解为经过encoder后的表示）的spatial resolution，例如从原始图像的256*256变为8*8。这样 \u003cb\u003e进一步增加下采样因子 \u003c/b\u003e减少分辨率，使得 AR 模型能够减少计算成本、提高图像生成速度，并更好地学习codebook中各向量之间的长依赖关系。\u003c/p\u003e\u003ch3\u003e方法：\u003c/h3\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-68a25d23f527b7ce60cd9df0109a52eb_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1550\" data-rawheight=\"954\" data-original-token=\"v2-85e1da6cb79dd8ff0b6ab1b2edd67d6b\" class=\"origin_image zh-lightbox-thumb\" width=\"1550\" data-original=\"https://pic4.zhimg.com/v2-68a25d23f527b7ce60cd9df0109a52eb_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"wGQSH4X_\"\u003e\u003cb\u003eRQ v.s. VQ：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"CjPYq5Ka\"\u003eVQ：\u003c/p\u003e\u003cp data-pid=\"WfCD2i-E\"\u003e假设codebook表示为 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BC%7D\" alt=\"\\mathcal{C}\" eeimg=\"1\"/\u003e ，对于向量 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bz%7D\" alt=\"\\mathbf{z}\" eeimg=\"1\"/\u003e ，其映射为近邻向量的操作表示为： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BQ%7D%28%5Cmathbf%7Bz%7D+%3B+%5Cmathcal%7BC%7D%29%3D%5Cunderset%7Bk+%5Cin%5BK%5D%7D%7B%5Carg+%5Cmin+%7D%5C%7C%5Cmathbf%7Bz%7D-%5Cmathbf%7Be%7D%28k%29%5C%7C_2%5E2+%5C%5C\" alt=\"\\mathcal{Q}(\\mathbf{z} ; \\mathcal{C})=\\underset{k \\in[K]}{\\arg \\min }\\|\\mathbf{z}-\\mathbf{e}(k)\\|_2^2 \\\\\" eeimg=\"1\"/\u003e 给定图片输入为 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BX%7D+%5Cin+%5Cmathbb%7BR%7D%5E%7BH_o+%5Ctimes+W_o+%5Ctimes+3%7D\" alt=\"\\mathbf{X} \\in \\mathbb{R}^{H_o \\times W_o \\times 3}\" eeimg=\"1\"/\u003e ，提取的 feature map 为： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BZ%7D%3DE%28%5Cmathbf%7BX%7D%29+%5Cin+%5Cmathbb%7BR%7D%5E%7BH+%5Ctimes+W+%5Ctimes+n_z%7D\" alt=\"\\mathbf{Z}=E(\\mathbf{X}) \\in \\mathbb{R}^{H \\times W \\times n_z}\" eeimg=\"1\"/\u003e （ \u003cimg src=\"https://www.zhihu.com/equation?tex=%28H%2C+W%29%3D%5Cleft%28H_o+%2F+f%2C+W_o+%2F+f%5Cright%29\" alt=\"(H, W)=\\left(H_o / f, W_o / f\\right)\" eeimg=\"1\"/\u003e ），通过映射后得到的code map为： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BM%7D_%7Bh+w%7D%3D%5Cmathcal%7BQ%7D%5Cleft%28%5Cmathbf%7BZ%7D_%7Bh+w%7D+%3B+%5Cmathcal%7BC%7D%5Cright%29\" alt=\"\\mathbf{M}_{h w}=\\mathcal{Q}\\left(\\mathbf{Z}_{h w} ; \\mathcal{C}\\right)\" eeimg=\"1\"/\u003e ，其中 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BZ%7D_%7Bh+w%7D+%5Cin+%5Cmathbb%7BR%7D%5E%7Bn_z%7D\" alt=\"\\mathbf{Z}_{h w} \\in \\mathbb{R}^{n_z}\" eeimg=\"1\"/\u003e 是feature map中(h,w)位置上的向量。\u003c/p\u003e\u003cp data-pid=\"8gL6wJYi\"\u003e假设 codebook 大小为 K，那么整个feature map为 \u003cimg src=\"https://www.zhihu.com/equation?tex=H+W+%5Clog+_2+K\" alt=\"H W \\log _2 K\" eeimg=\"1\"/\u003e 个 bit，根据\u003ci\u003erate-distortion theory（率失真理论）\u003c/i\u003e，H和W每缩小一半，K都要增加到 \u003cimg src=\"https://www.zhihu.com/equation?tex=K%5E4\" alt=\"K^4\" eeimg=\"1\"/\u003e ，因此说VQ-VAE需要大量的codebook。\u003c/p\u003e\u003cp data-pid=\"BcHJGDFB\"\u003eRQ：\u003c/p\u003e\u003cp data-pid=\"ACnM1jG6\"\u003e在RQ里，定义新的映射为近邻向量的操作：\u003c/p\u003e\u003cp data-pid=\"T9T07pJ9\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BR+Q%7D%28%5Cmathbf%7Bz%7D+%3B+%5Cmathcal%7BC%7D%2C+D%29%3D%5Cleft%28k_1%2C+%5Ccdots%2C+k_D%5Cright%29+%5Cin%5BK%5D%5ED+%5C%5C\" alt=\"\\mathcal{R Q}(\\mathbf{z} ; \\mathcal{C}, D)=\\left(k_1, \\cdots, k_D\\right) \\in[K]^D \\\\\" eeimg=\"1\"/\u003e可以看到并非之前单一的数字，而是一个元组，那么每一位的k如何选择？首先初始化残差 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Br%7D_0%3D%5Cmathbf%7Bz%7D\" alt=\"\\mathbf{r}_0=\\mathbf{z}\" eeimg=\"1\"/\u003e ，然后按照如下方法计算： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbegin%7Baligned%7D+k_d+%26+%3D%5Cmathcal%7BQ%7D%5Cleft%28%5Cmathbf%7Br%7D_%7Bd-1%7D+%3B+%5Cmathcal%7BC%7D%5Cright%29+%5C%5C+%5Cmathbf%7Br%7D_d+%26+%3D%5Cmathbf%7Br%7D_%7Bd-1%7D-%5Cmathbf%7Be%7D%5Cleft%28k_d%5Cright%29%5Cend%7Baligned%7D+%5C%5C\" alt=\"\\begin{aligned} k_d \u0026amp; =\\mathcal{Q}\\left(\\mathbf{r}_{d-1} ; \\mathcal{C}\\right) \\\\ \\mathbf{r}_d \u0026amp; =\\mathbf{r}_{d-1}-\\mathbf{e}\\left(k_d\\right)\\end{aligned} \\\\\" eeimg=\"1\"/\u003e可以这么理解，我要模拟 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bz%7D\" alt=\"\\mathbf{z}\" eeimg=\"1\"/\u003e，但是我模拟的 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Be%7D%5Cleft%28k_1%5Cright%29\" alt=\"\\mathbf{e}\\left(k_1\\right)\" eeimg=\"1\"/\u003e 肯定和 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bz%7D\" alt=\"\\mathbf{z}\" eeimg=\"1\"/\u003e 有差距，我用 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Br%7D_%7B1%7D+%3D+%5Cmathbf%7Br%7D_%7B0%7D-%5Cmathbf%7Be%7D%5Cleft%28k_1%5Cright%29%3D%5Cmathbf%7Bz%7D-%5Cmathbf%7Be%7D%5Cleft%28k_1%5Cright%29\" alt=\"\\mathbf{r}_{1} = \\mathbf{r}_{0}-\\mathbf{e}\\left(k_1\\right)=\\mathbf{z}-\\mathbf{e}\\left(k_1\\right)\" eeimg=\"1\"/\u003e 表示出来这两者的差，然后我继续模拟 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Br%7D_%7B1%7D\" alt=\"\\mathbf{r}_{1}\" eeimg=\"1\"/\u003e ，但是我模拟的 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Be%7D%5Cleft%28k_2%5Cright%29\" alt=\"\\mathbf{e}\\left(k_2\\right)\" eeimg=\"1\"/\u003e 肯定又和\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Br%7D_%7B1%7D\" alt=\"\\mathbf{r}_{1}\" eeimg=\"1\"/\u003e有差距，我用\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Br%7D_%7B2%7D\" alt=\"\\mathbf{r}_{2}\" eeimg=\"1\"/\u003e表示出来...... 因此每个 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Br%7D\" alt=\"\\mathbf{r}\" eeimg=\"1\"/\u003e 逐步相加，理论上和要模拟的 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bz%7D\" alt=\"\\mathbf{z}\" eeimg=\"1\"/\u003e 越来越逼近。\u003c/p\u003e\u003cp data-pid=\"ZwZa1HJZ\"\u003e可以看出VQ将空间分为K个簇，而RQ将空间分为 \u003cimg src=\"https://www.zhihu.com/equation?tex=K%5ED\" alt=\"K^D\" eeimg=\"1\"/\u003e 个簇，来实现更精确的量化。\u003c/p\u003e\u003cp data-pid=\"BRVCTVV_\"\u003e\u003cb\u003e共享codebook机制：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"FTYZIjHn\"\u003e虽然我们可以为每一层深度 d 分别构建一个码本，但在每个量化深度上使用的是单个共享码本。共享码本在构建 RQ 近似向量 z 时有两个优势：\u003c/p\u003e\u003col\u003e\u003cli data-pid=\"0BndT-H8\"\u003e使用单独的码本需要广泛的超参数搜索，以确定每一层的码本大小，而共享码本只需确定总码本大小 K。\u003c/li\u003e\u003c/ol\u003e\u003cp data-pid=\"jCDC1ARS\"\u003e2. 共享码本使得所有的 embedding 在每一层量化时都可用。因此，每一层都可以使用相同的 embedding，以最大化其效用。\u003c/p\u003e\u003cp data-pid=\"5pT2Ri0L\"\u003e\u003cb\u003eRQ-Transformer：\u003c/b\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-9c41422b57af4b8485ca82a6f83cd9bc_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2302\" data-rawheight=\"998\" data-original-token=\"v2-b3f09bcb270a5740c10ad4e585cffcd7\" class=\"origin_image zh-lightbox-thumb\" width=\"2302\" data-original=\"https://pic1.zhimg.com/v2-9c41422b57af4b8485ca82a6f83cd9bc_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"4uPpcR8G\"\u003e可以看出编码得到的 feature map 输入给 Transformer 来作为自回归任务的输入，整个 RQ-Transformer 分为Spatial Transformer和 Depth Transformer 两部分。\u003c/p\u003e\u003cp data-pid=\"oDzZaKxQ\"\u003e\u003cb\u003e输入处理：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"-IH-Zrit\"\u003eRQ-VAE 提取的代码映射 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BM%7D+%5Cin+%5BK%5D%5E%7BH+%5Ctimes+W+%5Ctimes+D%7D\" alt=\"\\mathbf{M} \\in [K]^{H \\times W \\times D}\" eeimg=\"1\"/\u003e 会按照 栅格扫描顺序（raster-scan order）重新排列为二维数组 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BS%7D+%5Cin+%5BK%5D%5E%7BT+%5Ctimes+D%7D\" alt=\"\\mathbf{S} \\in [K]^{T \\times D}\" eeimg=\"1\"/\u003e ，其中 \u003cimg src=\"https://www.zhihu.com/equation?tex=T+%3D+H+%5Ctimes+W\" alt=\"T = H \\times W\" eeimg=\"1\"/\u003e 。  每一行 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BS%7D_t\" alt=\"\\mathbf{S}_t\" eeimg=\"1\"/\u003e 包含 D 个代码：\u003c/p\u003e\u003cp data-pid=\"U0Xrk6cX\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BS%7D_t+%3D+%28%5Cmathbf%7BS%7D_%7Bt1%7D%2C+%5Ccdots%2C+%5Cmathbf%7BS%7D_%7BtD%7D%29+%5Cin+%5BK%5D%5ED%2C+%5Cquad+t+%5Cin+%5BT%5D+%5C%5C\" alt=\"\\mathbf{S}_t = (\\mathbf{S}_{t1}, \\cdots, \\mathbf{S}_{tD}) \\in [K]^D, \\quad t \\in [T] \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"3ikUpRkD\"\u003e自回归建模总公式为：\u003c/p\u003e\u003cp data-pid=\"qEaEGuXv\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=p%28%5Cmathbf%7BS%7D%29+%3D+%5Cprod_%7Bt%3D1%7D%5E%7BT%7D+%5Cprod_%7Bd%3D1%7D%5E%7BD%7D+p%28%5Cmathbf%7BS%7D_%7Btd%7D+%5Cmid+%5Cmathbf%7BS%7D_%7B%3Ct%2Cd%7D%2C+%5Cmathbf%7BS%7D_%7Bt%2C%3Cd%7D%29%5C%5C\" alt=\"p(\\mathbf{S}) = \\prod_{t=1}^{T} \\prod_{d=1}^{D} p(\\mathbf{S}_{td} \\mid \\mathbf{S}_{\u0026lt;t,d}, \\mathbf{S}_{t,\u0026lt;d})\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"C3X12aCB\"\u003e\u003cb\u003e建模动机：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"k7sCy16N\"\u003e直接将 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BS%7D\" alt=\"\\mathbf{S}\" eeimg=\"1\"/\u003e 展开为长度 TD 的序列并输入传统 Transformer 的方法存在不足，无法利用导 RQ-VAE 降低后的长度 T的优势。此外，这种直接展开会增加计算成本。由此设计为 Spatial Transformer和 Depth Transformer 两部分。\u003c/p\u003e\u003cp data-pid=\"lq6QeLnM\"\u003e\u003cb\u003e空间 Transformer（Spatial Transformer）\u003c/b\u003e：  \u003c/p\u003e\u003cp data-pid=\"1Q_OljrD\"\u003e首先空间 Transformer的输入为每个位置上的 feature（各个残差项之和），并加上位置编码（PE），如下：\u003c/p\u003e\u003cp data-pid=\"iPhUelqK\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bu%7D_t+%3D+%5Ctext%7BPE%7D_T%28t%29+%2B+%5Csum_%7Bd%3D1%7D%5E%7BD%7D+%5Cmathbf%7Be%7D%28%5Cmathbf%7BS%7D_%7Bt-1%2C+d%7D%29%2C+%5Cquad+%5Ctext%7Bfor+%7D+t+%3E+1.+%5C%5C\" alt=\"\\mathbf{u}_t = \\text{PE}_T(t) + \\sum_{d=1}^{D} \\mathbf{e}(\\mathbf{S}_{t-1, d}), \\quad \\text{for } t \u0026gt; 1. \\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"DskOdT2n\"\u003e整个 Spatial Transformer 表示为：  \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bh%7D_t+%3D+%5Ctext%7BSpatialTransformer%7D%28%5Cmathbf%7Bu%7D_1%2C+%5Ccdots%2C+%5Cmathbf%7Bu%7D_t%29.%5C%5C\" alt=\"\\mathbf{h}_t = \\text{SpatialTransformer}(\\mathbf{u}_1, \\cdots, \\mathbf{u}_t).\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"9Cvc5Q8L\"\u003e\u003cb\u003e深度 Transformer (Depth Transformer)：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"R4HbVMWE\"\u003e深度 Transformer 的任务是在给定位置 t 自回归地预测 D 个残差项code，即 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BS%7D_%7Bt1%7D%2C+%5Ccdots%2C+%5Cmathbf%7BS%7D_%7BtD%7D\" alt=\"\\mathbf{S}_{t1}, \\cdots, \\mathbf{S}_{tD}\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"BnJGFAwN\"\u003e在深度 d 和位置 t 时，Transformer 的输入 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D_%7Btd%7D\" alt=\"\\mathbf{v}_{td}\" eeimg=\"1\"/\u003e 被定义为\u003cb\u003e之前深度的嵌入之和\u003c/b\u003e：\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bv%7D_%7Btd%7D+%3D+%5Ctext%7BPE%7D_D%28d%29+%2B+%5Csum_%7Bd%27%3D1%7D%5E%7Bd-1%7D+%5Cmathbf%7Be%7D%28%5Cmathbf%7BS%7D_%7Btd%27%7D%29%2C+%5Cquad+d+%3E+1.%5C%5C\" alt=\"\\mathbf{v}_{td} = \\text{PE}_D(d) + \\sum_{d\u0026#39;=1}^{d-1} \\mathbf{e}(\\mathbf{S}_{td\u0026#39;}), \\quad d \u0026gt; 1.\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"s5do85eC\"\u003e每个深度的预测基于之前所有深度的估计，使得每一层的估计更加精细。\u003c/p\u003e\u003cp data-pid=\"pM9WcEVh\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Ctext%7BPE%7D_D%28d%29\" alt=\"\\text{PE}_D(d)\" eeimg=\"1\"/\u003e 是深度 d 的位置嵌入，且在所有位置 t 上共享。  \u003c/p\u003e\u003cp data-pid=\"0PwV3pbB\"\u003e整个 Depth Transformer 表示为：  \u003c/p\u003e\u003cp data-pid=\"95i-a1vI\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7Bp%7D_%7Btd%7D+%3D+%5Ctext%7BDepthTransformer%7D%28%5Cmathbf%7Bv%7D_%7Bt1%7D%2C+%5Ccdots%2C+%5Cmathbf%7Bv%7D_%7Btd%7D%29.%5C%5C\" alt=\"\\mathbf{p}_{td} = \\text{DepthTransformer}(\\mathbf{v}_{t1}, \\cdots, \\mathbf{v}_{td}).\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003ch3\u003e训练： \u003c/h3\u003e\u003cp data-pid=\"F2oIcgLB\"\u003eRQ-VAE 的训练损失函数 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BL%7D\" alt=\"\\mathcal{L}\" eeimg=\"1\"/\u003e 包含两部分： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BL%7D+%3D+%5Cmathcal%7BL%7D_%7B%5Ctext%7Brecon%7D%7D+%2B+%5Cbeta+%5Cmathcal%7BL%7D_%7B%5Ctext%7Bcommit%7D%7D+\" alt=\"\\mathcal{L} = \\mathcal{L}_{\\text{recon}} + \\beta \\mathcal{L}_{\\text{commit}} \" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"QZ-wYjj-\"\u003e\u003cb\u003e重构损失（Reconstruction Loss）\u003c/b\u003e： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BL%7D_%7B%5Ctext%7Brecon%7D%7D+%3D+%5ClVert+%5Cmathbf%7BX%7D+-+%5Chat%7B%5Cmathbf%7BX%7D%7D+%5CrVert_2%5E2\" alt=\"\\mathcal{L}_{\\text{recon}} = \\lVert \\mathbf{X} - \\hat{\\mathbf{X}} \\rVert_2^2\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"838mzIi1\"\u003e这个损失度量的是输入 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BX%7D\" alt=\"\\mathbf{X}\" eeimg=\"1\"/\u003e 和重构结果 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Chat%7B%5Cmathbf%7BX%7D%7D\" alt=\"\\hat{\\mathbf{X}}\" eeimg=\"1\"/\u003e 之间的欧氏距离，用于确保重构后的样本尽可能接近原始输入。这里同样会采用 Straight-Through Estimator。\u003c/p\u003e\u003cp data-pid=\"uElhhQ15\"\u003e\u003cb\u003e承诺损失（Commitment Loss）\u003c/b\u003e： \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BL%7D_%7B%5Ctext%7Bcommit%7D%7D+%3D+%5Csum_%7Bd%3D1%7D%5E%7BD%7D+%5ClVert+%5Cmathbf%7BZ%7D+-+%5Ctext%7Bsg%7D+%5Cleft%5B+%5Chat%7B%5Cmathbf%7BZ%7D%7D%5E%7B%28d%29%7D+%5Cright%5D+%5CrVert_2%5E2\" alt=\"\\mathcal{L}_{\\text{commit}} = \\sum_{d=1}^{D} \\lVert \\mathbf{Z} - \\text{sg} \\left[ \\hat{\\mathbf{Z}}^{(d)} \\right] \\rVert_2^2\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"d1ZvTsAv\"\u003e（sg[·] 是 stop-gradient 操作符，用于在反向传播时阻止梯度的传递），该损失的作用是最小化每个维度 d 上的量化误差，从而鼓励编码器的输出 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BZ%7D\" alt=\"\\mathbf{Z}\" eeimg=\"1\"/\u003e 更接近量化后的值 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Chat%7B%5Cmathbf%7BZ%7D%7D%5E%7B%28d%29%7D\" alt=\"\\hat{\\mathbf{Z}}^{(d)}\" eeimg=\"1\"/\u003e 。\u003c/p\u003e\u003cp data-pid=\"23L0Z4ih\"\u003e论文内提及codebook会采用聚类特征的\u003cb\u003e指数滑动平均\u003c/b\u003e来更新，从而提升模型的训练效果和稳定性。\u003c/p\u003e\u003cp data-pid=\"icYBu_Hz\"\u003eRQ-VAE 同时还采用了\u003cb\u003e对抗训练\u003c/b\u003e（Adversarial Training ）以提高重构图像的感知质量。采用了基于 patch 的对抗损失和感知损失。\u003c/p\u003e\u003cp data-pid=\"uAB04k3l\"\u003e\u003cb\u003e负对数似然损失 (Negative Log-Likelihood, NLL)\u003c/b\u003e：\u003c/p\u003e\u003cp data-pid=\"lykjEH3-\"\u003e用于训练 RQ-Transformer：\u003c/p\u003e\u003cp data-pid=\"mxiLNIE1\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathcal%7BL%7D_%7BAR%7D+%3D+%5Cmathbb%7BE%7D_%7BS%2C+t%2C+d%7D+%5Cleft%5B+-%5Clog+p%28%5Cmathbf%7BS%7D_%7Btd%7D+%5Cmid+%5Cmathbf%7BS%7D_%7B%3Ct%2Cd%7D%2C+%5Cmathbf%7BS%7D_%7Bt%2C%3Cd%7D%29+%5Cright%5D.%5C%5C\" alt=\"\\mathcal{L}_{AR} = \\mathbb{E}_{S, t, d} \\left[ -\\log p(\\mathbf{S}_{td} \\mid \\mathbf{S}_{\u0026lt;t,d}, \\mathbf{S}_{t,\u0026lt;d}) \\right].\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003ch3\u003eT\u003cb\u003erick：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"gTTwYRte\"\u003e\u003cb\u003e曝光偏差 (Exposure Bias)：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"hm9LTcbZ\"\u003e曝光偏差是自回归（AR）模型中的常见问题。在训练和推断阶段，由于预测错误的累积，模型性能会下降。尤其是在 RQ-Transformer 中，随着深度 D 的增加，量化特征向量的估计变得更加困难，误差也会累积。\u003c/p\u003e\u003cp data-pid=\"7MGqTcAF\"\u003e论文采用了软标签 (Soft Labeling) 和 随机采样 (Stochastic Sampling)策略：\u003c/p\u003e\u003cp data-pid=\"Zw_vmTv3\"\u003e\u003cb\u003e软标签（Soft Labeling）：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"VZELijLd\"\u003e基于 RQ-VAE 中代码嵌入之间的几何关系，定义了一个温度参数 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Ctau+%3E+0\" alt=\"\\tau \u0026gt; 0\" eeimg=\"1\"/\u003e 控制的类别分布：     \u003cimg src=\"https://www.zhihu.com/equation?tex=Q_%7B%5Ctau%7D%28k+%5Cmid+%5Cmathbf%7Bz%7D%29+%5Cpropto+e%5E%7B-%5Cfrac%7B%5C%7C%5Cmathbf%7Bz%7D+-+%5Cmathbf%7Be%7D%28k%29%5C%7C_2%5E2%7D%7B%5Ctau%7D%7D%2C+%5Cquad+k+%5Cin+%5BK%5D.%5C%5C\" alt=\"Q_{\\tau}(k \\mid \\mathbf{z}) \\propto e^{-\\frac{\\|\\mathbf{z} - \\mathbf{e}(k)\\|_2^2}{\\tau}}, \\quad k \\in [K].\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003cp data-pid=\"9uDJKd1V\"\u003e当 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Ctau+%5Cto+0\" alt=\"\\tau \\to 0\" eeimg=\"1\"/\u003e 时，分布 \u003cimg src=\"https://www.zhihu.com/equation?tex=Q_%7B%5Ctau%7D\" alt=\"Q_{\\tau}\" eeimg=\"1\"/\u003e 会收缩为一个 one-hot 分布：  \u003cimg src=\"https://www.zhihu.com/equation?tex=Q_0%28k+%5Cmid+%5Cmathbf%7Bz%7D%29+%3D+1%5Bk+%3D+Q%28%5Cmathbf%7Bz%7D%3B+C%29%5D.\" alt=\"Q_0(k \\mid \\mathbf{z}) = 1[k = Q(\\mathbf{z}; C)].\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"5kzJi6e2\"\u003e软标签的作用：\u003c/p\u003e\u003cp data-pid=\"xgNxUTyH\"\u003e利用嵌入之间的几何距离，为目标代码的监督引入了软标签分布;  在位置 \u003cimg src=\"https://www.zhihu.com/equation?tex=t\" alt=\"t\" eeimg=\"1\"/\u003e 和深度 \u003cimg src=\"https://www.zhihu.com/equation?tex=d\" alt=\"d\" eeimg=\"1\"/\u003e 上，假设特征向量为 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BZ%7D_t\" alt=\"\\mathbf{Z}_t\" eeimg=\"1\"/\u003e ，并令残差向量为 \u003cimg src=\"https://www.zhihu.com/equation?tex=r_%7Bt%2C+d-1%7D\" alt=\"r_{t, d-1}\" eeimg=\"1\"/\u003e 。负对数似然（NLL）损失使用了该软分布作为监督。\u003c/p\u003e\u003cp data-pid=\"J-dgjISO\"\u003e区别于 one-hot 标签，该监督机制使用了软化后的分布 \u003cimg src=\"https://www.zhihu.com/equation?tex=Q_%7B%5Ctau%7D%28%5Ccdot+%5Cmid+r_%7Bt%2Cd-1%7D%29\" alt=\"Q_{\\tau}(\\cdot \\mid r_{t,d-1})\" eeimg=\"1\"/\u003e 。\u003c/p\u003e\u003cp data-pid=\"PMs19-pt\"\u003e\u003cb\u003e随机采样（Stochastic Sampling）：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"Nt6_IsVb\"\u003e在原始的 RQ-VAE 中，代码选择是确定性的。然而，这里通过从软分布 \u003cimg src=\"https://www.zhihu.com/equation?tex=Q_%7B%5Ctau%7D%28%5Ccdot+%5Cmid+r_%7Bt%2Cd-1%7D%29\" alt=\"Q_{\\tau}(\\cdot \\mid r_{t,d-1})\" eeimg=\"1\"/\u003e 中进行采样来选择代码 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmathbf%7BS%7D_%7Btd%7D\" alt=\"\\mathbf{S}_{td}\" eeimg=\"1\"/\u003e 。  当 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Ctau+%5Cto+0\" alt=\"\\tau \\to 0\" eeimg=\"1\"/\u003e 时，随机采样等价于原始确定性代码选择。\u003c/p\u003e\u003cp data-pid=\"VVLHQFlw\"\u003e优势：随机采样为特征映射提供了不同的代码组合，从而缓解了训练和推断中的不一致性。\u003c/p\u003e\u003ch2\u003eFSQ：\u003c/h2\u003e\u003cp data-pid=\"YY3Fw9em\"\u003epaper：\u003ca href=\"https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2309.15505\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eFinite Scalar Quantization: VQ-VAE Made Simple\u003c/a\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-f146b33878365d9ab4a8d27ffe6af96f_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1098\" data-rawheight=\"288\" data-original-token=\"v2-3d8b87b970cdba8ae51c71e256964b33\" class=\"origin_image zh-lightbox-thumb\" width=\"1098\" data-original=\"https://pic2.zhimg.com/v2-f146b33878365d9ab4a8d27ffe6af96f_r.jpg\"/\u003e\u003c/figure\u003e\u003ch3\u003e\u003cb\u003e方法：\u003c/b\u003e\u003c/h3\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-02f6ebdffdd1545cfacedd3bcc0bfa47_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1588\" data-rawheight=\"622\" data-original-token=\"v2-3b36a34803116927f19ddd95612b2e8a\" class=\"origin_image zh-lightbox-thumb\" width=\"1588\" data-original=\"https://picx.zhimg.com/v2-02f6ebdffdd1545cfacedd3bcc0bfa47_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"n-sE4vgh\"\u003e论文提出使用 FSQ（Finite Scalar Quantization） 来替代 VQ-VAE中的“VQ”，其离散化思路非常简单，就是“四舍五入”。如上图所示，假设最后要把x映射为d维（图中d=3），我们把z的每一维用L个value表示（图中L=3），然后将z的每一维的L个value四舍五入（图中则变化为正方体的边线所在顶点处），由此便离散化了。\u003c/p\u003e\u003cp data-pid=\"QEy4WAE-\"\u003e还有个区别图式中便是VQ里量化后的 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Chat%7Bz%7D\" alt=\"\\hat{z}\" eeimg=\"1\"/\u003e 会用一个单独的数字代替，表示codebook里的索引；而FSQ里会用L个数字组成的元组（例如(-1,0,1)）来替代，也表示索引，整体codebook数量为L^d，图里为9。\u003c/p\u003e\u003cp data-pid=\"zIn3lcoy\"\u003e方案对比如下：\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-c63c592d630959636f500b506644ed17_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1470\" data-rawheight=\"502\" data-original-token=\"v2-4727c22af773b8965480306ec53f79b5\" class=\"origin_image zh-lightbox-thumb\" width=\"1470\" data-original=\"https://pic4.zhimg.com/v2-c63c592d630959636f500b506644ed17_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"pVcuVshF\"\u003e具体来说给定一个 \u003cimg src=\"https://www.zhihu.com/equation?tex=d\" alt=\"d\" eeimg=\"1\"/\u003e -维表示 \u003cimg src=\"https://www.zhihu.com/equation?tex=z+%5Cin+%5Cmathbb%7BR%7D%5Ed\" alt=\"z \\in \\mathbb{R}^d\" eeimg=\"1\"/\u003e ，我们的目标是将 \u003cimg src=\"https://www.zhihu.com/equation?tex=z\" alt=\"z\" eeimg=\"1\"/\u003e 量化为有限的码字集。为此，我们首先应用一个边界函数 \u003cimg src=\"https://www.zhihu.com/equation?tex=f\" alt=\"f\" eeimg=\"1\"/\u003e ，然后将结果\u003cb\u003e四舍五入为整数\u003c/b\u003e。我们选择 \u003cimg src=\"https://www.zhihu.com/equation?tex=f\" alt=\"f\" eeimg=\"1\"/\u003e 使得 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Chat%7Bz%7D+%3D+%5Ctext%7Bround%7D%28f%28z%29%29\" alt=\"\\hat{z} = \\text{round}(f(z))\" eeimg=\"1\"/\u003e 取得 \u003cimg src=\"https://www.zhihu.com/equation?tex=L\" alt=\"L\" eeimg=\"1\"/\u003e 个唯一值之一（例如， \u003cimg src=\"https://www.zhihu.com/equation?tex=f+%3A+z+%5Cmapsto+%5Cleft%5Clfloor+L+%2F+2+%5Cright%5Crfloor+%5Ctanh%28z%29\" alt=\"f : z \\mapsto \\left\\lfloor L / 2 \\right\\rfloor \\tanh(z)\" eeimg=\"1\"/\u003e ），上图的右子图可视化了这个转化，由于tanh取值范围为(-1，1)，由此z的范围是 \u003cimg src=\"https://www.zhihu.com/equation?tex=%28-%5Clfloor+L+%2F+2+%5Crfloor%2C%5Clfloor+L+%2F+2+%5Crfloor%29\" alt=\"(-\\lfloor L / 2 \\rfloor,\\lfloor L / 2 \\rfloor)\" eeimg=\"1\"/\u003e ，故四舍五入后便是L个取值，图中L=5，则有-2,-1,0,1,2这5个取值。\u003c/p\u003e\u003cp data-pid=\"Wp9fJbhS\"\u003e由此，我们得到 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Chat%7Bz%7D+%5Cin+C\" alt=\"\\hat{z} \\in C\" eeimg=\"1\"/\u003e ，其中 \u003cimg src=\"https://www.zhihu.com/equation?tex=C\" alt=\"C\" eeimg=\"1\"/\u003e 便是码本，且 \u003cimg src=\"https://www.zhihu.com/equation?tex=%7CC%7C+%3D+L%5Ed\" alt=\"|C| = L^d\" eeimg=\"1\"/\u003e 。\u003c/p\u003e\u003cp data-pid=\"4qgltnM8\"\u003e为了在整个四舍五入操作中传播梯度，使用了前述 STE（直通估计） 技巧 ，通过以下方式轻松实现“停止梯度（sg）”操作：\u003c/p\u003e\u003cp data-pid=\"AFnHXALn\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Ctext%7Bround%7D_%7B%5Ctext%7Bste%7D%7D%3A+x+%5Cmapsto+x+%2B+%5Ctext%7Bsg%7D%28%5Ctext%7Bround%7D%28x%29+-+x%29%5C%5C\" alt=\"\\text{round}_{\\text{ste}}: x \\mapsto x + \\text{sg}(\\text{round}(x) - x)\\\\\" eeimg=\"1\"/\u003e\u003c/p\u003e\u003ch3\u003e实验：\u003c/h3\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-d4660b9c3c6da74e2d901293ad05d8b2_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1668\" data-rawheight=\"992\" data-original-token=\"v2-214aef32bab9237ccf8e50660c6cf828\" class=\"origin_image zh-lightbox-thumb\" width=\"1668\" data-original=\"https://pic1.zhimg.com/v2-d4660b9c3c6da74e2d901293ad05d8b2_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"e0xvY7EW\"\u003e从图中可以看到，编码表大小2^10是一个分界点，在2^10左右时，FSQ与VQ的效果接近；超过2^10时，FSQ占优，反之小于2^10时，VQ占优。文中建议 \u003cimg src=\"https://www.zhihu.com/equation?tex=L%5Cgeq5\" alt=\"L\\geq5\" eeimg=\"1\"/\u003e ，并且d是个位数，相比之下VQ-VAE中d是三位数。\u003c/p\u003e\u003ch2\u003e引用：\u003c/h2\u003e\u003cp data-pid=\"UeklmOUE\"\u003e\u003ca href=\"https://zhuanlan.zhihu.com/p/91434658\" class=\"internal\" target=\"_blank\"\u003eElijha：VQ-VAE解读\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"8Mo6FP3X\"\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//amaires.github.io/VAE/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eVariational Autoencoders\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"zKwE_0-j\"\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//spaces.ac.cn/archives/5343\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e变分自编码器（二）：从贝叶斯观点出发 - 科学空间|Scientific Spaces\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"P6AMZedw\"\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//spaces.ac.cn/archives/6760\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eVQ-VAE的简明介绍：量子化自编码器 - 科学空间|Scientific Spaces\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"cOPfEZ9h\"\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.spaces.ac.cn/archives/9826\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e简单得令人尴尬的FSQ：“四舍五入”超越了VQ-VAE - 科学空间|Scientific Spaces\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e","is_labeled":false,"visited_count":29371,"thumbnails":["https://picx.zhimg.com/v2-385369549ccf0bb045c0bb59287d3e97.jpg?source=7e7ef6e2\u0026needBackground=1","https://pica.zhimg.com/50/v2-23b1df4e942d818b575ddd34e9904f4f_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-1cf1bec14dbe0af8dcd48090b44d6bbf_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-7470acf25e90deeec294f1b7a8091902_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-a4733c659558e35b1739882a5a577bd7_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-a055cce1e58c4117a5f81af820787af7_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-7acd4bd4da98bcc73327fac6106a83a5_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-50415ead6fb21af1c962579b3a1c18dc_720w.jpg?source=b6762063"],"favorite_count":1822,"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 2433292582}","attached_info":"CqELCM/msdasjrGktwEQBxoJMjQ5NTA5MjQ4IKLL37gGKMEHMCVAK0owCgZJdGVtQ0YSIGRvY190eXBlOiBBcnRpY2xlCmlkOiAyNTMwMDk1ODEKGAAgADoAYiBkMzJjN2QzNzg5NTAyOTljMDQzYzQ2NWRjNWNhYzBjNnIKMjQzMzI5MjU4MoIBX2h0dHBzOi8vcGljeC56aGltZy5jb20vdjItMzg1MzY5NTQ5Y2NmMGJiMDQ1YzBiYjU5Mjg3ZDNlOTcuanBnP3NvdXJjZT03ZTdlZjZlMiZuZWVkQmFja2dyb3VuZD0xqgEJcmVjb21tZW5kwgEgM2I1OWJiNzk2YzFhNmJmZmUwM2NlZmQzNWU1ZGM1ZDLyAQoIDBIGTm9ybWFs8gEoCAoSJDMwNzQ0MTgzLTRlODAtNDEzNy1hMDhmLTk1ZDkzZTZmNDRiY/IBBQgLEgE4ggIAiAKb3K7OhTOSAiAzYjU5YmI3OTZjMWE2YmZmZTAzY2VmZDM1ZTVkYzVkMpoCAMoCFlNob3JJbnRlcmVzdFdlaWdodFJ1bGXKAhVVc2VyTGNuRXhpdFdlaWdodFJ1bGXKAhRDb250ZW50QWdlV2VpZ2h0UnVsZcoCF1Rlc3RlZEFuZFdvcmtXZWlnaHRSdWxl2gIGSXRlbUNG6AID+gILTk9STUFMX0ZMT1eKAyAxYTg0NTRkYjA4ZWE0MmMyYjc2ZDBmOWRkNDRjZTExZZoDDQoCdjIQABoFb3RoZXKoA7vlAdgDAOoDFXRleHRBbGxTaXRlTXZJdGVtQ0ZWMvoDsQUSDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFOi0IAhCoFxjaCyIjdjItYzkyZmI3M2U2YTZkZDU2YWYwNDljOTFmZjcwYjQ0NDQ6LQgCEJIOGLYEIiN2Mi1lOTM4NDIxY2EwYjQ4ZGEwYjc2OGVhNGFiYWM0YTgxMDotCAIQhA4YiAYiI3YyLWJiODg5OTc2YTRhYTljY2IxMjc0NDRmOTUzMWQ5NTA4Oi0IAhCWBRjNASIjdjItYWFiMTk2OTVhOWRiNzlkYmE1Y2Y1YzFiODc5NzhjYmE6LQgCEL4MGIwHIiN2Mi0zMDcyNDFjZDJiZDlkOTZhNTA3NzIzMDRkYWQ1YzU5MTotCAIQzgwYtAYiI3YyLTY2ZWFjZjAyZDEwN2QwNmY4YWVmNjVhYjViNWFmYjZiOi0IAhC8DRiwBCIjdjItNGE1ODNhYmQ3MmJkYWI0MzIwZTVkYmYyNTk5M2M0YWM6LQgCEI4MGLoHIiN2Mi04NWUxZGE2Y2I3OWRkOGZmMGI2YWIxYjJlZGQ2N2Q2YjotCAQQ/hEY5gciI3YyLWIzZjA5YmNiMjcwYTU3NDBjMTBhZDRlNTg1Y2ZmY2Q3Oi0IAhDKCBigAiIjdjItM2Q4Yjg3Yjk3MGNkYmE4YWU1MWM3MWUyNTY5NjRiMzM6LQgCELQMGO4EIiN2Mi0zYjM2YTM0ODAzMTE2OTI3ZjE5ZGRkOTU2MTJiMmU4YTotCAIQvgsY9gMiI3YyLTQ3MjdjMjJhZjc3M2I4OTY1NDgwMzA2ZWM1M2Y3OWI1Oi0IAhCEDRjgByIjdjItMjE0YWVmMzJiYWI5MjM3Y2NmOGU1MDY2MGM2Y2Y4Mjg6LQgCEKALGO4EIiN2Mi0zODUzNjk1NDljY2YwYmIwNDVjMGJiNTkyODdkM2U5N4AEAIgEAJIEBk5vcm1hbJoEATOgBACoBACwBAC6BAZtYW51YWzCBAMxNzDIBADSBA/mjqjojZDlt7Lmm7TmlrDYBADwBAD5BAAAACB8/pA/gQUAAAAAAAAAAIkF37/Kz6cn0z+SBQCaBQNkZnSiBQNkZnSyBQExuQUAAAAAAAAAANAFAOAFAOgFAPAFCJAGAKAGK6gGA5ICJQoJMjQ5NTA5MjQ4EgoyNDMzMjkyNTgyGAciCklNQUdFX1RFWFQ=","action_card":false},{"id":"44_1753853177.290","type":"feed","offset":44,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1753853177,"updated_time":1753853177,"target":{"id":"1932190018148995798","type":"answer","url":"https://api.zhihu.com/answers/1932190018148995798","author":{"id":"d038e13b49b7411d468e414412ef054a","url":"https://api.zhihu.com/people/d038e13b49b7411d468e414412ef054a","user_type":"people","url_token":"wen-yi-zai-dao-7","name":"鞭临天下","headline":"用爱发电，爱看不看，随时停更。","avatar_url":"https://pic1.zhimg.com/50/v2-9c3886256908fe75077aa82eca4c0d76_l.jpg?source=b6762063","is_org":false,"gender":1,"badge":[{"type":"super_activity","description":"知势榜社科人文领域影响力榜答主"}],"followers_count":19934,"is_following":false,"is_followed":false},"created_time":1753449998,"updated_time":1753453651,"voteup_count":1555,"thanks_count":103,"comment_count":128,"is_copyable":false,"question":{"id":"28506685","type":"question","url":"https://api.zhihu.com/questions/28506685","author":{"id":"94ce573b2790a55890aa2c0d3dfb45f2","url":"https://api.zhihu.com/people/94ce573b2790a55890aa2c0d3dfb45f2","user_type":"people","url_token":"li-fei-26-75-57","name":"李飞","headline":"挫男","avatar_url":"https://pic1.zhimg.com/50/3421b6246e36013aae407e0e7390ffe9_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":1,"is_following":false,"is_followed":false},"title":"中国开始落后于西方世界是什么时候？","created":1425431491,"answer_count":0,"follower_count":0,"comment_count":51,"bound_topic_ids":[284,12230,16450,36133,157316],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"excerpt":"一六五一年，霍布斯在一场英国内战的废墟之上，写下了他最著名的政治哲学著作利维坦。 那是一个激荡动荡的年代，国王被斩首、议会军取得胜利、旧的教会权威彻底瓦解，一切政治秩序濒临崩塌。 在这样的语境中，霍布斯提出了一个令人不安却无法回避的问题： 当人类社会陷入暴力循环、人人自危的状态时，我们该如何重建秩序？国家，又究竟是什么？在书中，霍布斯的回答令人震惊，也令人清醒。他不相信德性，也不相信神恩。他想象了…","excerpt_new":"一六五一年，霍布斯在一场英国内战的废墟之上，写下了他最著名的政治哲学著作利维坦。 那是一个激荡动荡的年代，国王被斩首、议会军取得胜利、旧的教会权威彻底瓦解，一切政治秩序濒临崩塌。 在这样的语境中，霍布斯提出了一个令人不安却无法回避的问题： 当人类社会陷入暴力循环、人人自危的状态时，我们该如何重建秩序？国家，又究竟是什么？在书中，霍布斯的回答令人震惊，也令人清醒。他不相信德性，也不相信神恩。他想象了…","preview_type":"default","preview_text":"","reshipment_settings":"disallowed","content":"\u003cp data-pid=\"6lX43-S-\"\u003e一六五一年，霍布斯在一场英国内战的废墟之上，写下了他最著名的政治哲学著作利维坦。\u003c/p\u003e\u003cp data-pid=\"ct4btlGm\"\u003e那是一个激荡动荡的年代，国王被斩首、议会军取得胜利、旧的教会权威彻底瓦解，一切政治秩序濒临崩塌。\u003c/p\u003e\u003cp data-pid=\"j7TeQSsz\"\u003e在这样的语境中，霍布斯提出了一个令人不安却无法回避的问题：\u003cb\u003e当人类社会陷入暴力循环、人人自危的状态时，我们该如何重建秩序？国家，又究竟是什么？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"aGqGSOHw\"\u003e在书中，霍布斯的回答令人震惊，也令人清醒。他不相信德性，也不相信神恩。他想象了一头怪物，庞大无比、冷酷无情，由千千万万个人民的身体组成，头部是戴着王冠的君主，手持利剑与权杖。它站在山巅，俯视芸芸众生。\u003c/p\u003e\u003cp data-pid=\"ZXxuFFCU\"\u003e\u003cb\u003e这个怪物就是国家，是我们为了摆脱自然状态中人与人之间的战争而建造出的庞大暴力机器。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"k-JBugbY\"\u003e霍布斯的国家理论建立在对人性的彻底不信任之上。他笔下的自然状态，并非桃花源式的田园牧歌，而是充满恐惧、暴力与相互猎杀的丛林。人在缺乏权威与规则时，其本性就是狼。其生活，是孤独的、贫穷的、污秽的、野蛮的、短暂的。\u003cb\u003e这种世界不是任何人想要的，哪怕最强大的人，也无法保证自身的安全。在这种危机四伏的处境中，人类为求生存，不得不放弃部分自由，将自身的权利交托给一个共同的权力中心，用它来约束所有人，包括自己。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"mltodkAU\"\u003e这个权力中心就是利维坦。\u003c/p\u003e\u003cp data-pid=\"FrkLm97V\"\u003e它是怪物，但它也是秩序的源泉。它不是仁慈的父亲，而是理性的产物。它不是情感寄托，而是制度逻辑的极端体现。\u003c/p\u003e\u003cp data-pid=\"CI-YPEY5\"\u003e\u003cb\u003e国家的本质，在霍布斯这里首次被赤裸地揭示出来：它不是传统意义上的德性延续，也不是宗教神授的权威，它是人类为了逃避混乱和暴力而共同建构的制度怪物，是一种服从换取秩序的契约。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"NiSB62VT\"\u003e这个思想之所以震撼，不只是因为它提出了国家的冷酷真相，更因为它开启了一个新的传统：\u003cb\u003e国家不是由神创造的，不是不可置疑的存在，而是一个可以被构建、被监督、被限制的工具。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"gTWo1gVw\"\u003e从霍布斯开始，西方现代政治哲学真正迈出了第一步。\u003c/p\u003e\u003cp data-pid=\"n6GhgqdP\"\u003e\u003cb\u003e他揭示了国家的唯物基础，而后继的思想家则是开始用各种手段逐步将这头怪物关进了铁笼子。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"6m5LZjAv\"\u003e洛克强调自然权利不可剥夺，孟德斯鸠提出三权分立，卢梭则是提出主权在民、社会契约，哈贝马斯重建公共理性。\u003c/p\u003e\u003cp data-pid=\"jTHEHUfI\"\u003e他们不断推动国家从一种超越万物的意志存在，转向一种被设计、可质疑、讲规则的公共结构。\u003cb\u003e这时候国家的神圣性被解构，国家的本质被还原为一种人为制度，一台规则运行的机器。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"vungrO4G\"\u003e这台机器不属于任何家族、王朝或信仰，它的目的不是统治，而是维持秩序。不是塑造道德，而是保护权利。\u003cb\u003e人们认识到，它不是人的延伸，而是理性的结果。它不是目的本身，而是手段。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"Mm_MJRti\"\u003e就在霍布斯写下利维坦这书的同一历史节点上，中国也站在了另一场剧变的门口。\u003c/p\u003e\u003cp data-pid=\"zwGK48NJ\"\u003e一六四四年，明亡，崇祯自缢煤山，李自成入主北京旋即被击退，清军趁势入关，一场改朝换代就此展开。\u003c/p\u003e\u003cp data-pid=\"uOk2SQnv\"\u003e\u003cb\u003e这种巨大的政治震荡本可以成为中国重新思考国家与权力结构的契机，但历史并未从此转向。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"jb1Jkwks\"\u003e那个年代思想界最具批判意识的士人，如黄宗羲、顾炎武、王夫之，虽然也对君主专制提出深刻质疑，也呼唤政治改革，却最终仍未能构建出一种类似霍布斯国家机器的制度图景。他们批判昏君，却寄望于明君。他们主张变法，却未能跳脱仁政圣王的传统伦理结构。\u003c/p\u003e\u003cp data-pid=\"N-uIzG5A\"\u003e他们想象的，是一个更好的家国，而非一个制度化的国家。\u003c/p\u003e\u003cp data-pid=\"hbvnD2EO\"\u003e\u003cb\u003e于是，利维坦未能在中国出现。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"UivqXGxm\"\u003e\u003cb\u003e我们没有构建自己的怪物，也没有设计制度去驾驭它。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"_wuVdJlT\"\u003e这不是偶然，而是文化结构的深层决定。\u003c/p\u003e\u003cp data-pid=\"_-KLxpbt\"\u003e中国传统的国家观根植于宗法伦理体系：君主被视为天之子，官员被称作父母官，百姓则是子民。国家的结构与家庭之间没有清晰边界。政治是家庭的延伸，是君为臣纲、父为子纲的社会化投射。\u003c/p\u003e\u003cp data-pid=\"0GrKbLGY\"\u003e在这样的逻辑下，国家不是功能性的治理工具，而是一种情感共同体、伦理道德的永恒容器。\u003c/p\u003e\u003cp data-pid=\"iTy2Vpsb\"\u003e在传统中国，权力从来不是制度性的，而是人格化的；治理不是程序性的，而是德性化的。\u003c/p\u003e\u003cp data-pid=\"wC22PJaF\"\u003e\u003cb\u003e这套思维延续至今，依然深刻影响着我们对国家的认知。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"fJiwOR5Q\"\u003e我们习惯于将国家拟人化，赋予它感情、品格和责任。我们说国家不会忘记你，国家要保护你，国家需要有担当。这些表达背后是一种将国家视为人的心理结构，像父亲那样照顾我们，像母亲那样包容我们，像英雄那样拯救我们。\u003c/p\u003e\u003cp data-pid=\"ImZrh-2a\"\u003e\u003cb\u003e但其实国家不是人。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"CPsUo99x\"\u003e它没有情绪，也没有德性。它不会哭，也不会笑。它做决策不是出于爱与恨，而是基于预算、规则、政令、效率与利益。它的目标不是感动你，而是运作你，它不是父亲，也不是朋友，而是一个结构。\u003c/p\u003e\u003cp data-pid=\"R1ZieZN1\"\u003e\u003cb\u003e我们还会把国家看作家庭。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"mEMiYQRp\"\u003e称官员为父母官，要讲忠诚、讲孝道、讲感恩。于是公共事务被纳入亲情伦理结构，质疑变成不忠，批评成了不孝。这种家庭化的国家观念，使得现代制度难以生根，问责机制难以建立。\u003cb\u003e我们更倾向于期望清官，而不是建设制度；更信赖人的德行，而不是权力的制衡。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"1XR0smT0\"\u003e\u003cb\u003e更深层的，是我们将国家神圣化，使其成为一种不容置疑的信仰。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"lmmhduiH\"\u003e国家被看作至高无上的存在，不可讨论、不可批评、不可触碰。一旦国家成为信仰，它就变成压倒一切的绝对。现实中的一切问题就难以提出，制度缺陷无法被纠正，公共监督也失去可能。\u003c/p\u003e\u003cp data-pid=\"JGpjZy4d\"\u003e\u003cb\u003e这种神圣化的国家观，使我们远离了现代政治的基本原则。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"ItFU2g5X\"\u003e现代国家应当是人造的，是工具性的，是为了实现秩序、保障权利而存在的机制。它必须可质疑、可设计、可批判，不能是宗教化的、道德化的、人格化的。它不是一个用来信仰的对象，而是一台必须不断调整、监督和限制的机器。\u003c/p\u003e\u003cp data-pid=\"vVBaGBv7\"\u003e说到底，导致我们真正落后于世界的，从来不是技术，不是资本，不是工业化的起步时间，而是对国家本质的认知。\u003c/p\u003e\u003cp data-pid=\"KOem1eny\"\u003e我们迟到了三百多年。\u003c/p\u003e\u003cp data-pid=\"6NEJFRiQ\"\u003e\u003cb\u003e我们没有在思想上经历那场与利维坦共舞的启蒙，我们至今也没有真正构建起那套科学冷静、理性、规则至上的制度观。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"YSPWVz2T\"\u003e即便今天中国在经济建设和国家能力方面取得了巨大成就，公众对于国家的理解依然停留在一种被情感包裹、伦理浸染、人格化塑形的状态之中。我们距离真正的现代国家意识，还有很长的路要走。\u003c/p\u003e\u003cp data-pid=\"vfXkxUhF\"\u003e毕竟，国家不需要我们爱它，但它必须可以被质疑。\u003c/p\u003e\u003cp data-pid=\"TwsuRxEw\"\u003e它不是靠情感运作的共同体，而是靠规则运行的机制。它冷冰冰，但可预测。它没有温度，但有边界。它不是奇迹的载体，而是秩序的容器。它的伟大，不在于像父亲一样宽容，而在于像机器一样稳定。\u003c/p\u003e\u003cp data-pid=\"7hKf-BaS\"\u003e\u003cb\u003e这才是霍布斯真正的先知性。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"w27Y3ibm\"\u003e他不是国家的设计师，而是国家真相的揭示者。他承认国家是怪物，却也相信人类可以驯服它。只要我们足够理性、足够清醒、足够诚实，就可以与怪物共处。\u003c/p\u003e\u003cp data-pid=\"AM62BtGh\"\u003e我们只有在未来某一天，真正承认国家的本质，不再用情感去理解它，而用规则去驾驭它，我们普罗大众才可能完成现代意义上的自我启蒙。那个时刻，才是我们真正理解国家的开始。\u003cb\u003e不是去崇拜利维坦，也不是去畏惧它，而是保持清醒，和它共处，把它关进制度的牢笼里，然后继续生活。\u003c/b\u003e\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":40852,"favorite_count":1291,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1932190018148995798}","attached_info":"CpgGCM/msdasjrGktwEQBBoJNzM4ODU5MDExII6MjsQGKJMMMIABQCxKMAobVFNfU09VUkNFX0JBU0lDX0lORk9fUkVDQUxMEgEwGAAgADoKeyJyYXciOiIifUorChZUU19TT1VSQ0VfRkVFRFJFX01TX1YyEgEwGAAgADoKeyJyYXciOiIifUo/CipUU19TT1VSQ0VfWlJFQ0FMTF9GRUVEUkVfTkVXQklFX0hPVVJMWV9SVU0SATAYACAAOgp7InJhdyI6IiJ9WgczNTg1NTI4YiBkMzJjN2QzNzg5NTAyOTljMDQzYzQ2NWRjNWNhYzBjNnITMTkzMjE5MDAxODE0ODk5NTc5OIoBCDI4NTA2Njg1qgEJcmVjb21tZW5kwgEgZDAzOGUxM2I0OWI3NDExZDQ2OGU0MTQ0MTJlZjA1NGHyAQoIDBIGTm9ybWFs8gEoCAoSJGVlMDM1MjM4LTBhMzYtNDc3ZS1iOGYxLWNlOTI5YjNmMGJjYvIBBQgLEgE4ggIAiAKb3K7OhTOSAiBkMDM4ZTEzYjQ5Yjc0MTFkNDY4ZTQxNDQxMmVmMDU0YZoCAMoCFlNob3JJbnRlcmVzdFdlaWdodFJ1bGXKAhVVc2VyTGNuRXhpdFdlaWdodFJ1bGXaAhtUU19TT1VSQ0VfQkFTSUNfSU5GT19SRUNBTEzoAgT6AgtOT1JNQUxfRkxPV4oDIDFhODQ1NGRiMDhlYTQyYzJiNzZkMGY5ZGQ0NGNlMTFlmgMNCgJ2MhAAGgVvdGhlcqgDlL8C2AMA6gMRYmFzaWNfaW5mb19yZWNhbGz6Ax8SDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFgAQAiAQAkgQGTm9ybWFsmgQBNKAEAKgEALAEALoEBm1hbnVhbMIEAzE3MMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAAK3inT+BBQAAAAAAAAAAiQXfv8rPpyfTP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AUIkAYAoAYsqAYAkgIuCgk3Mzg4NTkwMTESEzE5MzIxOTAwMTgxNDg5OTU3OTgYBCIKSU1BR0VfVEVYVA==","action_card":false},{"id":"45_1753853177.177","type":"feed","offset":45,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1753853177,"updated_time":1753853177,"target":{"id":"1932935480099476591","type":"answer","url":"https://api.zhihu.com/answers/1932935480099476591","author":{"id":"5efb9d2518ec96186c1069a5ab02f99a","url":"https://api.zhihu.com/people/5efb9d2518ec96186c1069a5ab02f99a","user_type":"people","url_token":"41-42-2-83-18","name":"老六","headline":"略懂略懂，我知道你想问啥，问啥就付费咨询，拒绝白嫖","avatar_url":"https://pic1.zhimg.com/50/v2-f0e2242493291ceb6b4bec357d0c7858_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":1090,"is_following":false,"is_followed":false},"created_time":1753627730,"updated_time":1753644175,"voteup_count":134,"thanks_count":7,"comment_count":16,"is_copyable":true,"question":{"id":"640908231","type":"question","url":"https://api.zhihu.com/questions/640908231","author":{"id":"960e679c67e3cb5adf2022ff05d277fc","url":"https://api.zhihu.com/people/960e679c67e3cb5adf2022ff05d277fc","user_type":"people","url_token":"wang-fu-65-47","name":"向乐乐杨阔步","headline":"","avatar_url":"https://picx.zhimg.com/50/v2-7e6559049df2991662f1e521ad2e0898_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":0,"is_following":false,"is_followed":false},"title":"通过身份证能查到多少信息？","created":1706045235,"answer_count":0,"follower_count":0,"comment_count":0,"bound_topic_ids":[2512,5674],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"excerpt":"我只说能查到的 具体怎么查的自己琢磨 个人户籍、全家户籍、网逃记录、犯罪记录、社保、名下宽带、通话记录、名下车、名下房 名下银行卡-银行卡流水、支付宝流水、名下微信-微信流水、名下企业、三网基站定位（有误差） 配偶、出入境信息、名下护照号、边境控制（限制出入境）、微信好友提取 身份证使用轨迹（飞机、高铁、酒店）、开房同住人、快递地址、外卖地址订单 车辆移动轨迹 其中有部分警察无权查阅，只有有办案需要时才…","excerpt_new":"我只说能查到的 具体怎么查的自己琢磨 个人户籍、全家户籍、网逃记录、犯罪记录、社保、名下宽带、通话记录、名下车、名下房 名下银行卡-银行卡流水、支付宝流水、名下微信-微信流水、名下企业、三网基站定位（有误差） 配偶、出入境信息、名下护照号、边境控制（限制出入境）、微信好友提取 身份证使用轨迹（飞机、高铁、酒店）、开房同住人、快递地址、外卖地址订单 车辆移动轨迹 其中有部分警察无权查阅，只有有办案需要时才…","preview_type":"default","preview_text":"","reshipment_settings":"allowed","content":"\u003cp data-pid=\"a1wQcqUo\"\u003e我只说能查到的\u003c/p\u003e\u003cp data-pid=\"fRerV5e0\"\u003e具体怎么查的自己琢磨\u003c/p\u003e\u003cp data-pid=\"QRQ9n2Z5\"\u003e个人户籍、全家户籍、网逃记录、犯罪记录、社保、名下宽带、通话记录、名下车、名下房\u003c/p\u003e\u003cp data-pid=\"BPTvKvmS\"\u003e名下银行卡-银行卡流水、支付宝流水、名下微信-微信流水、名下企业、三网基站定位（有误差）\u003c/p\u003e\u003cp data-pid=\"0w7vCbOZ\"\u003e配偶、出入境信息、名下护照号、边境控制（限制出入境）、微信好友提取\u003c/p\u003e\u003cp data-pid=\"aG7ZJPET\"\u003e身份证使用轨迹（飞机、高铁、酒店）、开房同住人、快递地址、外卖地址订单\u003c/p\u003e\u003cp data-pid=\"r2TN1lgy\"\u003e车辆移动轨迹\u003c/p\u003e\u003cp data-pid=\"0mW4AvVF\"\u003e其中有部分警察无权查阅，只有有办案需要时才能申请调阅。\u003c/p\u003e\u003cp data-pid=\"-EaLJ5Vx\"\u003e重点是，还有某些地下渠道卖出来的来源也是内部人士，别信什么社工库这那的，一群什么都不懂的骗子的惯用伎俩罢了。\u003c/p\u003e\u003cp data-pid=\"fYZPGdox\"\u003e之前有个知友私我说有人声称社工库可以查这个查那个被骗几百，各位心里有小九九的当心。\u003c/p\u003e\u003cp data-pid=\"M_UquI5Z\"\u003e\u003cb\u003e还有什么需要的直接戳下面，只要我懂的，随便问。\u003c/b\u003e\u003c/p\u003e\u003ca data-draft-node=\"block\" data-draft-type=\"ad-link-card\" data-ad-id=\"fee_5efb9d2518ec96186c1069a5ab02f99a\"\u003e\u003c/a\u003e\u003cp\u003e\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":14589,"favorite_count":193,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1932935480099476591}","attached_info":"CuIFCM/msdasjrGktwEQBBoJNzM5MTUyNTI0INL4mMQGKIYBMBBALUooCh1UU19TT1VSQ0VfTkVBUkxJTkVfQ09OVEVOVF9WMhIBMBgAIAA6AEpPChxUU19TT1VSQ0VfSE9UX0NST1NTX1JFQUxUSU1FEilob3RfcmVjYWxsX3JlYWx0aW1lX3Q6bm9ybWFsOjIwMjUtMDctMzA6OBgAIAA6AFoJMTA0NzAxOTc4YiBkMzJjN2QzNzg5NTAyOTljMDQzYzQ2NWRjNWNhYzBjNnITMTkzMjkzNTQ4MDA5OTQ3NjU5MYoBCTY0MDkwODIzMaoBCXJlY29tbWVuZMIBIDVlZmI5ZDI1MThlYzk2MTg2YzEwNjlhNWFiMDJmOTlh8gEKCAwSBk5vcm1hbPIBKAgKEiRiM2ZlZGNiZC02ZDMwLTRiMTQtYjkyNi04YjZmMjE3MmI2MGbyAQUICxIBOIICAIgCm9yuzoUzkgIgNWVmYjlkMjUxOGVjOTYxODZjMTA2OWE1YWIwMmY5OWGaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxl2gIdVFNfU09VUkNFX05FQVJMSU5FX0NPTlRFTlRfVjLoAgL6AgtOT1JNQUxfRkxPV4oDIDFhODQ1NGRiMDhlYTQyYzJiNzZkMGY5ZGQ0NGNlMTFlmgMNCgJ2MhAAGgVvdGhlcqgD/XHYAwD6Ax8SDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFgAQAiAQAkgQGTm9ybWFsmgQBMqAEAKgEALAEALoEBm1hbnVhbMIEAzE3MMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAoIgFrT+BBQAAAAAAAAAAiQXfv8rPpyfTP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AUIkAYAoAYtqAYAkgIuCgk3MzkxNTI1MjQSEzE5MzI5MzU0ODAwOTk0NzY1OTEYBCIKSU1BR0VfVEVYVA==","action_card":false},{"id":"46_1753853177.550","type":"feed","offset":46,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1753853177,"updated_time":1753853177,"target":{"id":"1933880173058581854","type":"answer","url":"https://api.zhihu.com/answers/1933880173058581854","author":{"id":"fd3512e8ba59806df50e0297d32cbe39","url":"https://api.zhihu.com/people/fd3512e8ba59806df50e0297d32cbe39","user_type":"people","url_token":"67-73-95-56-28","name":"是希音吖","headline":"横冲直撞，肆意生长","avatar_url":"https://pic1.zhimg.com/50/v2-687e4a7f49772b59d9f18725f19ce4f5_l.jpg?source=b6762063","is_org":false,"gender":0,"followers_count":108,"is_following":false,"is_followed":false},"created_time":1753852963,"updated_time":1753852963,"voteup_count":0,"thanks_count":0,"comment_count":0,"is_copyable":true,"question":{"id":"506872980","type":"question","url":"https://api.zhihu.com/questions/506872980","author":{"id":"48a4cc9149e78f9fd38ad82345e23609","url":"https://api.zhihu.com/people/48a4cc9149e78f9fd38ad82345e23609","user_type":"people","url_token":"da-you-ke-wei-81-94","name":"大有可为","headline":"","avatar_url":"https://pica.zhimg.com/50/v2-d3e6056ba5f8b8163c27ddfcb602c9a6_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":1,"is_following":false,"is_followed":false},"title":"把“人性”讲得最通透的一句话是？","created":1639806563,"answer_count":0,"follower_count":0,"comment_count":16,"bound_topic_ids":[994,4621,24048],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"excerpt":"1、不必对人性抱有太大希望，但也不必对人性伤心透顶，人性，总归是趋利避害的，见识别人的恶，不要忘了守护好自己的善。这是个杀熟的世界如果熟人不害你， 其他人，其实很难下手。 2、武大郎为什么在生命的最后一刻，还期盼着潘金莲回心转意 ?就是因为弱者以为人人都有良心，而事实上，对方有没有良心取决的是你是否值得 ? 3、聪明人和智者最大的区别是什么?聪明人是解决一个又一个的问题，而智者是避免一个又一个的问题。 4、…","excerpt_new":"1、不必对人性抱有太大希望，但也不必对人性伤心透顶，人性，总归是趋利避害的，见识别人的恶，不要忘了守护好自己的善。这是个杀熟的世界如果熟人不害你， 其他人，其实很难下手。 2、武大郎为什么在生命的最后一刻，还期盼着潘金莲回心转意 ?就是因为弱者以为人人都有良心，而事实上，对方有没有良心取决的是你是否值得 ? 3、聪明人和智者最大的区别是什么?聪明人是解决一个又一个的问题，而智者是避免一个又一个的问题。 4、…","preview_type":"default","preview_text":"","reshipment_settings":"allowed","content":"\u003cp data-pid=\"hDFbMFHN\"\u003e1、不必对人性抱有太大希望，但也不必对人性伤心透顶，人性，总归是趋利避害的，见识别人的恶，不要忘了守护好自己的善。这是个杀熟的世界如果熟人不害你， 其他人，其实很难下手。\u003c/p\u003e\u003cp data-pid=\"8E4QcIK8\"\u003e2、武大郎为什么在生命的最后一刻，还期盼着潘金莲回心转意 ?就是因为弱者以为人人都有良心，而事实上，对方有没有良心取决的是你是否值得 ?\u003c/p\u003e\u003cp data-pid=\"gqhK9abd\"\u003e3、聪明人和智者最大的区别是什么?聪明人是解决一个又一个的问题，而智者是避免一个又一个的问题。\u003c/p\u003e\u003cp data-pid=\"2AmvHz_l\"\u003e4、如何秒懂最根本的人性，不用听课，不用看书，去看看动物世界就知道了。而动物与人最根本的区别是动物知足不知耻，人类不知耻不知足。\u003c/p\u003e\u003cp data-pid=\"vRWP-ROZ\"\u003e5、在家的时候，纯洁和天真是可爱的表现纯洁和天真的人必然是第但一旦来到社会，一个牺牲品\u003c/p\u003e\u003cp data-pid=\"qJCrd_OJ\"\u003e6、上天从不同情和保护弱者，他只战队那些，能平衡好各方利益的操控者\u003c/p\u003e\u003cp data-pid=\"OwS9jL0e\"\u003e7、为什么要对这个世界祛魅?因为:你畏惧的大多数人，都得罪得起你担心的大部分事都不会发生。你强忍着不说出口的那些话，即时说出来了，也不过如此\u003c/p\u003e\u003cp data-pid=\"BJ9fOGfs\"\u003e8、几乎所有人在即将离开这个世界的最后一刻，后悔的都是我没做过什么，而非我做了什么。\u003c/p\u003e\u003cp data-pid=\"yS4fLLdQ\"\u003e9、家庭的核心不是感情，而是经济。贫贱夫妻百事哀，大难临头各自飞。是无数过来人总结的真相和精髓。\u003c/p\u003e\u003cp data-pid=\"IydTdxsU\"\u003e婚姻的本质，就是利益捆绑，为的是，结合后双方的利益都能增值。所以，智者认真搞事业，用自己的身价博的家人的青睐和满意。愚者拼命强调感情，用道德绑架宣示主权\u003c/p\u003e\u003cp data-pid=\"iV7DoGF-\"\u003e10、什么最容易泯灭一个人的善良?两个字 --贫穷。一个人在家徒四壁，前途无望的时候， 看什么都是偏激的、 否定的、凶残的。但一旦他变得富裕了，你就会发现他会突然变得宽容、随和、慈眉善目，人淡如菊的气质不修自成。\u003c/p\u003e\u003cp data-pid=\"QA_7jxPH\"\u003e11、社会资源永远有限，好东西要靠抢，只有弱者才坐等分配\u003c/p\u003e\u003cp data-pid=\"s2yduLlS\"\u003e12、检验一个人的思想是否成熟，其实看的就是他能不能包容两种甚至两种以上截然相反的观点，且还能维持正常行事的能力\u003c/p\u003e\u003cp data-pid=\"zVWX3DmG\"\u003e13、你最要小心的就是那些整天在嘴上挂着仁义道德的人。张口要利他，闭口要付出。但内心盘算的一定是收割和利益。记住，一个人内心越缺什么，就会越刻意找是什么?\u003c/p\u003e\u003cp data-pid=\"Pkn7__y6\"\u003e14、思维不在一个维度，微笑就好。 三观不在一个层次， 转身就好。 你什么时候见过一只狮子和狗争。\u003c/p\u003e\u003cp data-pid=\"vbPALCtw\"\u003e15、人生最好的老师不是你的建议、规劝和管教。而是南墙、 棺材、是吃了才能让他真正成长的大坑和大亏\u003c/p\u003e\u003cp data-pid=\"3Ghueb1G\"\u003e16、这世上最无可救药的不是没文化的人，他们掌握了一大堆漂而是死读书的那批人。亮的书面原则，自诩博学，试图让这个多维多变的现实世界迁就。甚至硬套这些原则，有知识无智慧，对这个世界的破坏力最大\u003c/p\u003e\u003cp data-pid=\"4TmrHm1M\"\u003e17、什么是弱者思维，就是一旦遇到他不理解的复杂局面，就会习惯性的退回到自己的思维舒适区，去分析别人的道德和品德。\u003c/p\u003e\u003cp data-pid=\"xQ_VDEaG\"\u003e18、这个世界没有什么东西是你的，你只不过是那个暂时保管的人，即使是生命，也可以随时被收走，所以不必过于执着\u003c/p\u003e\u003cp data-pid=\"cbtvwlCf\"\u003e19、决定一个人前途和命运的表面上看是能力、努力、机遇。实际上，是看他和谁形成了利益共同体。我们平时看到的那些风光人物，基本上都是某利益团队的代表\u003c/p\u003e\u003cp data-pid=\"X5zPXF8a\"\u003e20、自己所谓受到的委屈或不公，很大程度上是自己对于对方的价值不够。\u003c/p\u003e\u003cp data-pid=\"c3NJGPlq\"\u003e\u003cb\u003e写作费脑，码字不易，欢迎点赞、评论和关注，就当是给我的最大鼓励。\u003c/b\u003e\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":1,"favorite_count":0,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1933880173058581854}","attached_info":"CvoFCM/msdasjrGktwEQBBoJNzM5NTk5MzQxIKPYpsQGKAAwAEAuSiQKGVRTX1NPVVJDRV9XQVJNX1VQX05PUk1BTDESATAYACAAOgBKKAodVFNfU09VUkNFX1dBUk1VUF9QUkVUUkFJTl9JMkkSATAYACAAOgBaCDc0OTIwMjE5YiBkMzJjN2QzNzg5NTAyOTljMDQzYzQ2NWRjNWNhYzBjNnITMTkzMzg4MDE3MzA1ODU4MTg1NIoBCTUwNjg3Mjk4MKoBCXJlY29tbWVuZMIBIGZkMzUxMmU4YmE1OTgwNmRmNTBlMDI5N2QzMmNiZTM58gEKCAwSBk5vcm1hbPIBKAgKEiRjZjE1NTFlNi1mMDYzLTRlZDUtODE5MS1mZjcxNTkyNGYwN2byAQUICxIBOIICAIgCm9yuzoUzkgIgZmQzNTEyZThiYTU5ODA2ZGY1MGUwMjk3ZDMyY2JlMzmaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxlygIaQ29udGVudFdhcm1VcElzb2xhdGlvblJ1bGXKAhhDb250ZW50V2FybVVwQnJlYWtJblJ1bGXaAhlUU19TT1VSQ0VfV0FSTV9VUF9OT1JNQUwx6AIA+gILTk9STUFMX0ZMT1eKAyAxYTg0NTRkYjA4ZWE0MmMyYjc2ZDBmOWRkNDRjZTExZZoDDQoCdjIQABoFb3RoZXKoAwHYAwDqAxNwcmV0cmFpbl9pMmlfcmVjYWxs+gMfEgxVTktOT1dOX01PREUgACoNTk9fSU1BR0VfTU9ERYAEAIgEAJIEBk5vcm1hbJoEATOgBACoBACwBAC6BAJhacIEAzQwMMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAwB/Dqz+BBQAAAAAAAAAAiQXfv8rPpyfTP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AUIkAYAoAYuqAYBkgIuCgk3Mzk1OTkzNDESEzE5MzM4ODAxNzMwNTg1ODE4NTQYBCIKSU1BR0VfVEVYVA==","action_card":false},{"id":"47_1753853177.804","type":"feed","offset":47,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1753853177,"updated_time":1753853177,"target":{"id":"1933339191103718717","type":"article","url":"https://api.zhihu.com/articles/1933339191103718717","author":{"id":"ec44bdcdde1c9685971d5345134d8274","url":"https://api.zhihu.com/people/ec44bdcdde1c9685971d5345134d8274","user_type":"people","url_token":"Du_Kevin","name":"Kevin","headline":"","avatar_url":"https://picx.zhimg.com/50/v2-24aeabebd617c6189ff578b09127a040_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":14,"is_following":false,"is_followed":false},"title":"大型广告系统架构设计与实现","comment_permission":"all","created":1753723993,"updated":1753724081,"voteup_count":16,"voting":0,"comment_count":2,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"业务背景： 在数字化平台发展过程中，随着用户规模持续扩大与行为数据的不断积累，流量与数据逐渐成为平台最具价值的资产之一。为了进一步提升用户生命周期价值、加强平台的运营能力，同时打造自主可控的商业化基础设施，公司决定自研一套高性能、可扩展的广告投放系统。该系统面向多个业务应用场景，支撑启动页广告、信息流、弹窗等多种形式的广告内容投放，提供用户级定向、智能推荐、频次控制、投放监控等一整套完整能力，全…","excerpt_new":"业务背景： 在数字化平台发展过程中，随着用户规模持续扩大与行为数据的不断积累，流量与数据逐渐成为平台最具价值的资产之一。为了进一步提升用户生命周期价值、加强平台的运营能力，同时打造自主可控的商业化基础设施，公司决定自研一套高性能、可扩展的广告投放系统。该系统面向多个业务应用场景，支撑启动页广告、信息流、弹窗等多种形式的广告内容投放，提供用户级定向、智能推荐、频次控制、投放监控等一整套完整能力，全…","preview_type":"default","preview_text":"","content":"\u003ch2\u003e\u003cb\u003e业务背景：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"ysEL3A7B\"\u003e 在数字化平台发展过程中，随着用户规模持续扩大与行为数据的不断积累，流量与数据逐渐成为平台最具价值的资产之一。为了进一步提升用户生命周期价值、加强平台的运营能力，同时打造自主可控的商业化基础设施，公司决定自研一套高性能、可扩展的广告投放系统。该系统面向多个业务应用场景，支撑启动页广告、信息流、弹窗等多种形式的广告内容投放，提供用户级定向、智能推荐、频次控制、投放监控等一整套完整能力，全面打通“用户—数据—内容—价值”的闭环，成为平台商业变现能力的重要支撑模块。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e二、构建广告系统的动因分析\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e1. 私域流量运营与变现诉求\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"C6Oi8el8\"\u003e拥有海量实名可识别用户，具备高频使用、长期绑定等特征；\u003c/li\u003e\u003cli data-pid=\"Q4IeAqys\"\u003e原有平台以服务为主，流量变现能力薄弱；\u003c/li\u003e\u003cli data-pid=\"ifgtbs_K\"\u003e自建广告系统可实现首页Banner、弹窗、信息流等多入口广告投放，提升整体营收能力。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e2. 构建智能定向与标签体系\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"0uOx3mJh\"\u003e平台沉淀了丰富的用户行为数据，包括设备类型、操作系统、地域、兴趣偏好等；\u003c/li\u003e\u003cli data-pid=\"fa-XLz1n\"\u003e具备构建用户画像与人群标签的技术基础；\u003c/li\u003e\u003cli data-pid=\"zN0ldEg1\"\u003e可支持精准定向、多维交叉组合、实时人群匹配，增强投放效果。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e3. 实现合规可控的广告体系\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"gNFV7OGB\"\u003e面对日益严格的广告监管与数据保护法规，自研系统可保证数据在链路内可控；\u003c/li\u003e\u003cli data-pid=\"1-IrUTWl\"\u003e支持素材审核、频控限流、日志留存等合规能力；\u003c/li\u003e\u003cli data-pid=\"IyBV6WBq\"\u003e避免使用第三方平台造成的用户数据外泄或隐私风险。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e4. 补齐平台商业化能力短板\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"pVzJpwEP\"\u003e公司已有较为完整的中台与基础设施能力（如用户中台、数据中台、支付平台等）；\u003c/li\u003e\u003cli data-pid=\"QP_oH_KB\"\u003e广告系统作为商业化组件，可与中台系统无缝集成；\u003c/li\u003e\u003cli data-pid=\"QuIPD3rE\"\u003e具备使用 Netty、Kafka、ClickHouse、Redis 等高性能技术栈支撑工程落地的能力。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e5. 行业趋势推动与市场对标压力\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"P_p31Zdr\"\u003e越来越多互联网平台、垂直行业产品、公共服务应用开始建设自有广告系统；\u003c/li\u003e\u003cli data-pid=\"03IWtJTe\"\u003e自建系统成为增强平台营收能力、提升技术护城河的重要方式；\u003c/li\u003e\u003cli data-pid=\"25LVCyac\"\u003e广告系统作为“低侵扰、强变现”的能力模块，可长期持续优化与扩展。\u003c/li\u003e\u003c/ul\u003e\u003ch2\u003e\u003cb\u003e广告系统要求：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"IsHJ92l7\"\u003e 第一：支持超高业务流量。当前平台系统极限可支持超过10W/S(QPS)的请求,实际使用过程中至少承受超过5W/S(QPS)的请求,同时也具有快速扩容能力；\u003c/p\u003e\u003cp data-pid=\"ryeFTlPx\"\u003e 第二：支持超低延迟。广告服务对于请求时间非常敏感，平均内部响应耗时控制在20ms以下,120ms超时率≤0.05%,远低于流量平台2%的阈值；\u003c/p\u003e\u003cp data-pid=\"uQiNGOcd\"\u003e 第三：监控告警。可监控和告警实时流量、接口耗时、超时率、数据存储等各项数据。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e整体架构\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e业务架构图\u003c/b\u003e\u003c/h3\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-470514b08b3497f3aef9e35b1df64fca_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1432\" data-rawheight=\"1307\" data-original-token=\"v2-86930b52c2d3387720e77ccab58687bb\" class=\"origin_image zh-lightbox-thumb\" width=\"1432\" data-original=\"https://pic3.zhimg.com/v2-470514b08b3497f3aef9e35b1df64fca_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003ek8s架构图：\u003c/b\u003e\u003c/h3\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-646ae52e350ea35a496573bfd146b7a9_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2688\" data-rawheight=\"1766\" data-original-token=\"v2-50bb6eed3eae3aece1105d4385530ad1\" class=\"origin_image zh-lightbox-thumb\" width=\"2688\" data-original=\"https://pic2.zhimg.com/v2-646ae52e350ea35a496573bfd146b7a9_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e集群架构\u003c/b\u003e\u003c/h3\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-fdbad6ed5e18b42d156c195ea90b63a0_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1838\" data-rawheight=\"1712\" data-original-token=\"v2-5790648522d2c854547bc553a6cae08c\" class=\"origin_image zh-lightbox-thumb\" width=\"1838\" data-original=\"https://pic1.zhimg.com/v2-fdbad6ed5e18b42d156c195ea90b63a0_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e整体业务流程图\u003c/b\u003e\u003c/h3\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-9a543a2e6fa91e1cd84e165d714f76f6_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2613\" data-rawheight=\"4040\" data-original-token=\"v2-bffcac99d6dde3482d1178345a88e533\" class=\"origin_image zh-lightbox-thumb\" width=\"2613\" data-original=\"https://pica.zhimg.com/v2-9a543a2e6fa91e1cd84e165d714f76f6_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e功能设计\u003c/b\u003e\u003c/h2\u003e\u003ch2\u003e\u003cb\u003e广告高并发服务器\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"0DqJUEMe\"\u003e 广告系统对服务端性能和稳定性的要求极高，尤其是在面对海量请求、高并发压力以及复杂业务逻辑时。Netty作为一个高性能的异步事件驱动网络应用框架，是很多大型互联网广告系统的首选技术方案。下面从多个维度详细分析为什么选择Netty作为广告系统的Server。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e1. 高并发性能，满足海量请求的挑战\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"zdD9H8hz\"\u003e广告系统往往每天处理亿级甚至更高数量级的请求，单机QPS（每秒查询率）需求极大。Netty基于Java NIO实现，采用Reactor多路复用机制，避免了传统阻塞IO模型中每连接一个线程的资源浪费。\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"lhwWBDjY\"\u003e\u003cb\u003e事件驱动架构\u003c/b\u003e：Netty通过事件循环（EventLoop）来调度和处理网络事件，线程数固定且复用，极大减少线程切换和上下文切换开销。\u003c/li\u003e\u003cli data-pid=\"dV3yeKiS\"\u003e\u003cb\u003e非阻塞IO\u003c/b\u003e：请求处理不依赖阻塞等待，响应速度快，延迟低。\u003c/li\u003e\u003cli data-pid=\"te3GYExp\"\u003e\u003cb\u003e高吞吐量\u003c/b\u003e：通过零拷贝和直接内存访问优化，减少数据在内核和用户空间的复制次数，提高传输效率。\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"Ior5-xLV\"\u003e这让广告系统能在有限硬件资源下支持数十万甚至百万级并发连接。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e2. 低延迟设计，提升广告响应速度\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"vvG7FlnV\"\u003e广告投放系统对响应时延非常敏感，延迟越低用户体验越好，广告匹配速度越快带来的收益越大。Netty在设计上非常注重减少延迟：\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"qkZ9h85Y\"\u003e\u003cb\u003e零拷贝技术\u003c/b\u003e：减少数据拷贝次数，降低CPU和内存负担。\u003c/li\u003e\u003cli data-pid=\"3-9IMD31\"\u003e\u003cb\u003e高效内存管理\u003c/b\u003e：通过ByteBuf池化管理，避免频繁分配和回收，降低GC压力。\u003c/li\u003e\u003cli data-pid=\"mNV_Kawp\"\u003e\u003cb\u003e支持异步非阻塞处理\u003c/b\u003e：避免请求线程阻塞，提高资源利用率，保证请求能快速响应。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e3. 灵活的协议支持和扩展性\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"_b7kxMI8\"\u003e广告系统业务复杂，需要处理多种协议和自定义通信格式。Netty天生支持多协议：\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"boeGO4Ha\"\u003eTCP、UDP、HTTP/HTTPS、HTTP2、WebSocket等多种协议；\u003c/li\u003e\u003cli data-pid=\"Y3mqJYe4\"\u003e支持自定义协议编解码器，方便与业务层结合，实现广告请求的精准解析与构建；\u003c/li\u003e\u003cli data-pid=\"mGT6hEVn\"\u003e灵活的Pipeline机制，业务逻辑可以模块化拆分，便于维护和扩展。\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"nMZZJEtz\"\u003e这保证了系统未来迭代过程中，可以平滑升级通信协议，兼容更多业务场景。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-c5b5b8319f3b06355b2446fd9b3448f6_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1018\" data-rawheight=\"866\" data-original-token=\"v2-c2b37403df754fd9e77a7d8acf9fc3fa\" class=\"origin_image zh-lightbox-thumb\" width=\"1018\" data-original=\"https://pica.zhimg.com/v2-c5b5b8319f3b06355b2446fd9b3448f6_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e广告定向检索\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e背景说明\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"ZaEaNuHg\"\u003e在广告系统中，为了实现高性能、可扩展的多维度定向过滤，我们使用 \u003cb\u003eRoaringBitmap + Redis\u003c/b\u003e 来构建广告计划的倒排索引，加速广告筛选过程。\u003c/p\u003e\u003cp data-pid=\"4eUtCyYW\"\u003eRoaringBitmap 特别适用于：\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"MruUzr6B\"\u003e高基数、大范围 ID 集合管理（如上万个广告计划）；\u003c/li\u003e\u003cli data-pid=\"zqBNkGAj\"\u003eRoaringBitmap采用分块压缩技术，能够在保证高速访问的同时，极大节省存储空间\u003c/li\u003e\u003cli data-pid=\"M2wrRokv\"\u003e广告定向过滤的本质是多个条件集合的交集、并集等集合运算。RoaringBitmap针对这些操作进行了深度优化，能够以亚毫秒的速度完成千万级数据的集合计算，极大提升了广告匹配的实时性\u003c/li\u003e\u003cli data-pid=\"xppVdgoo\"\u003e占RoaringBitmap序列化后的数据体积小，便于存储和网络传输，适合分布式系统中缓存和索引的同步更新。新增或修改广告计划，只需更新相关的位图索引，极大简化了维护成本。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e各定向维度设计\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"3kmvl4B0\"\u003e广告过滤链路主要围绕多个定向维度进行快速判断，典型流程如下：\u003c/p\u003e\u003ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003cth\u003e维度\u003c/th\u003e\u003cth\u003e描述\u003c/th\u003e\u003cth\u003e实现方式\u003c/th\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e地域定向\u003c/td\u003e\u003ctd\u003e城市/省份/国家等\u003c/td\u003e\u003ctd\u003e基于IP解析与城市码匹配\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e时段定向\u003c/td\u003e\u003ctd\u003e一周内具体小时段\u003c/td\u003e\u003ctd\u003eBitSet 位图（168位）\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e人群标签定向\u003c/td\u003e\u003ctd\u003e兴趣、年龄、性别、职业、设备、行为等标签\u003c/td\u003e\u003ctd\u003eRoaringBitmap 标签交集判断\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e预算与频控\u003c/td\u003e\u003ctd\u003e用户点击上限、投放节奏等\u003c/td\u003e\u003ctd\u003eRedis bitmap + 分时 pacing\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e黑白名单\u003c/td\u003e\u003ctd\u003e用户/设备/渠道等黑白名单\u003c/td\u003e\u003ctd\u003e布隆过滤器 + 缓存命中判断\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e定向代码demo：\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e添加到指定维度的RoaringBitmap中\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003efunction\u003c/span\u003e \u003cspan class=\"nf\"\u003esyncSingleDimension\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edimensionType\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionValue\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlanId\u003c/span\u003e\u003cspan class=\"o\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eredisKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;rb:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionType\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionValue\u003c/span\u003e\n    \n    \u003cspan class=\"c1\"\u003e// 读取 Redis 中的 Base64 编码的 Bitmap\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003ebase64\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRedis\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eredisKey\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ebase64\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBase64\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edecode\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebase64\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRoaringBitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edeserialize\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eRoaringBitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n    \n    \u003cspan class=\"c1\"\u003e// 将广告计划ID加入 Bitmap\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eadPlanId\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n    \n    \u003cspan class=\"c1\"\u003e// 序列化并 Base64 编码写回 Redis\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eencoded\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBase64\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eencode\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eserialize\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eRedis\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eredisKey\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eencoded\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e从维度中移除广告计划\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003efunction\u003c/span\u003e \u003cspan class=\"nf\"\u003eremoveAdPlanFromDimension\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edimensionType\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionValue\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlanId\u003c/span\u003e\u003cspan class=\"o\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eredisKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;rb:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionType\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionValue\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eencoded\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRedis\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eredisKey\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n    \n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eencoded\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n    \n    \u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRoaringBitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edeserialize\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBase64\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edecode\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eencoded\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eremove\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eadPlanId\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eRedis\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eredisKey\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBase64\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eencode\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eserialize\u003c/span\u003e\u003cspan class=\"o\"\u003e()))\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e筛选出符合定向要求的计划\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003efunction\u003c/span\u003e \u003cspan class=\"nf\"\u003efilterAdPlansByDimensions\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edimensions\u003c/span\u003e\u003cspan class=\"o\"\u003e):\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003edimensions\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eempty\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eempty\u003c/span\u003e \u003cspan class=\"n\"\u003eset\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eredisKeys\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edimensionType\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionValue\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003edimensions\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eredisKeys\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eappend\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;rb:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionType\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edimensionValue\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ebase64Bitmaps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRedis\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emultiGet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eredisKeys\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eany\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ebase64Bitmaps\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 有维度无匹配，直接无广告计划\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eempty\u003c/span\u003e \u003cspan class=\"n\"\u003eset\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ebase64\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ebase64Bitmaps\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRoaringBitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edeserialize\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBase64\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edecode\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebase64\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eand\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 求交集\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eempt\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e黑名单过滤（Blacklist）\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e需求背景\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"nc1HSYTB\"\u003e黑名单：不允许某类用户或设备看到某些广告；\u003c/li\u003e\u003cli data-pid=\"JPf-htN6\"\u003e白名单：仅允许某些 ID 命中的广告计划被投放。\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003eKey设计\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"FSlSEPF5\"\u003e\u003ccode\u003erb:blacklist:{userId}\u003c/code\u003e → bitmap of adPlanIds（该用户禁看的广告）\u003c/li\u003e\u003cli data-pid=\"t3maEdbH\"\u003e\u003ccode\u003erb:whitelist:{userId}\u003c/code\u003e → bitmap of adPlanIds（该用户可看的广告）\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003e操作系统定向（OS）\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e需求背景\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"W9nzS-37\"\u003e广告主可选择投放给 Android 或 iOS 用户；\u003c/li\u003e\u003cli data-pid=\"WYlfRRz2\"\u003e系统需根据设备类型快速过滤。\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003eKey设计\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"vveK8lJ-\"\u003e\u003ccode\u003erb:os:android\u003c/code\u003e\u003c/li\u003e\u003cli data-pid=\"u8VtSvvl\"\u003e\u003ccode\u003erb:os:ios\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003eB端写入示例\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003esyncSingleDimension\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;os\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;android\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlanId\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003eC端过滤示例\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003e函数\u003c/span\u003e \u003cspan class=\"nf\"\u003efilterAdPlansByConditions\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e维度Key列表\u003c/span\u003e\u003cspan class=\"o\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e如果维度Key列表为空\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e返回空集合\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e定义变量\u003c/span\u003e \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e空\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e对于每一个维度Key\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003e维度Key列表\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e从Redis中读取Base64编码的位图数据\u003c/span\u003e\n\u003cspan class=\"nl\"\u003e\n\u003c/span\u003e\u003cspan class=\"nl\"\u003e        如果数据为空:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e跳过当前维度\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e将Base64数据解码为字节数组\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e反序列化为RoaringBitmap对象\u003c/span\u003e\u003cspan class=\"err\"\u003e，\u003c/span\u003e\u003cspan class=\"n\"\u003e记为\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentBitmap\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e如果\u003c/span\u003e \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003e为\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e将\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003e赋值给\u003c/span\u003e \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e否则\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003e与\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003e做交集运算\u003c/span\u003e\u003cspan class=\"err\"\u003e（\u003c/span\u003e\u003cspan class=\"n\"\u003eAND\u003c/span\u003e\u003cspan class=\"err\"\u003e）\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e如果\u003c/span\u003e \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003e仍为\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e返回空集合\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e将\u003c/span\u003e \u003cspan class=\"n\"\u003eresultBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003e中的所有值收集为广告计划ID集合\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e返回该集合\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e广告位定向（Ad Slot）\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e需求背景\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"ie584IFj\"\u003e广告主选择将计划绑定到具体的广告位，例如首页Banner；\u003c/li\u003e\u003cli data-pid=\"s4bbH3dW\"\u003e系统需根据请求中广告位 ID 做过滤。\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003eRedis Key\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"xbhftqDc\"\u003e\u003ccode\u003erb:slot:homepage_banner\u003c/code\u003e\u003c/li\u003e\u003cli data-pid=\"y6hcP87X\"\u003e\u003ccode\u003erb:slot:launch_popup\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003e示例\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003esyncSingleDimension\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;slot\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;homepage_banner\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlanId\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003efilterAdPlansByConditions\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;slot:homepage_banner\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e));\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e地域定向\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e 需求背景\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"qOmqGu2O\"\u003e\u003cb\u003eIP库构建与更新：\u003c/b\u003e 上线初期采用静态IP库，后续通过定期从权威第三方数据源同步并更新，确保IP地址归属地信息的实时性和准确性。\u003c/li\u003e\u003cli data-pid=\"2jbKzIaW\"\u003e\u003cb\u003eIP解析与缓存：\u003c/b\u003e 广告请求中的用户IP通过IP库解析为\u003ccode\u003ecityId\u003c/code\u003e。为提高效率，解析结果会进行多级缓存（如本地缓存、分布式缓存），减少重复计算。\u003c/li\u003e\u003cli data-pid=\"jqK1u-yT\"\u003e\u003cb\u003e高性能索引：\u003c/b\u003e 采用RoaringBitmap对\u003ccode\u003ecityId\u003c/code\u003e进行索引，实现亚毫秒级的地域集合运算，满足高并发查询需求。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003e地域定向Bitmap\u003c/span\u003e\u003cspan class=\"err\"\u003e：\u003c/span\u003e\n\u003cspan class=\"n\"\u003ecityId\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003e101\u003c/span\u003e \u003cspan class=\"err\"\u003e→\u003c/span\u003e \u003cspan class=\"n\"\u003eRoaringBitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplanIds\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003e12\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e56\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e89\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ecityId\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003e201\u003c/span\u003e \u003cspan class=\"err\"\u003e→\u003c/span\u003e \u003cspan class=\"n\"\u003eRoaringBitmap\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplanIds\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003e13\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e22\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e77\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"KmYf4CzN\"\u003e后续使用RoaringBitmap来做交并集计算。\u003c/p\u003e\u003cp data-pid=\"hI-DXxAx\"\u003e地域定向RoaringBitmap格式，后面的数字是具体的广告 \u003c/p\u003e\u003ch3\u003e\u003cb\u003eKey设计\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"tt7Lso2S\"\u003e\u003ccode\u003egeo:region:{cityId} -\u0026gt; {101,102,105}\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e时段定向\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e   一、业务背景：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"XVyx-JDC\"\u003e 该模块用于支持广告系统中的时段定向投放，实现“在一周的某些具体时段内，允许指定广告计划投放”的功能。 核心思路是将 星期 + 小时 映射为唯一的时段索引（0~167），并使用高效压缩结构 RoaringBitmap 来存储每个时段下允许投放的广告计划ID集合，支持快速匹配与高效扩展。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e二、设计思路\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"CIfQjqQP\"\u003e使用 \u003cb\u003eBitSet\u003c/b\u003e 表示每周 7 天 × 每天 24 小时 = 168 个小时的时间投放控制位。\u003c/li\u003e\u003cli data-pid=\"2WJHqxE1\"\u003e每个广告计划维护一个 168 位的 BitSet，表示哪些时间可投。\u003c/li\u003e\u003cli data-pid=\"chtNnzr-\"\u003e使用 Redis 存储广告计划的时间投放位图，Key 为计划ID，Value 为 Base64 编码的 BitSet。\u003c/li\u003e\u003cli data-pid=\"LSvR7qdy\"\u003e投放时只需取出当前小时在一周中对应的 BitSet index，批量与操作过滤可投计划。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e三、BitSet 编码规则\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003eBitSet 长度: 168 位\n索引计算方式:\n  index = (dayOfWeek - 1) * 24 + hourOfDay\n  dayOfWeek: 周一=1，周日=7\n  hourOfDay: 0~23\n例如：周二 10 点  -\u0026gt; index = (2-1)*24 + 10 = 34\n public static final int HOURS_PER_WEEK = 7 * 24;\n\n    /**\n     * 创建 BitSet 表示的投放时段（小时范围）\n     * 例如：周二8-11点 =\u0026gt; weekDays = [2], hours = [8,9,10,11]\n     */\n    public static BitSet buildBitSet(List\u0026lt;Integer\u0026gt; weekDays, List\u0026lt;Integer\u0026gt; hours) {\n        BitSet bitSet = new BitSet(HOURS_PER_WEEK);\n        for (Integer day : weekDays) {\n            for (Integer hour : hours) {\n                int index = day * 24 + hour;\n                if (index \u0026gt;= 0 \u0026amp;\u0026amp; index \u0026lt; HOURS_PER_WEEK) {\n                    bitSet.set(index);\n                }\n            }\n        }\n        return bitSet;\n    }\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e四、数据结构设计\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003eRedis Key 设计：\u003c/b\u003e\u003c/h3\u003e\u003ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003cth\u003eKey 格式\u003c/th\u003e\u003cth\u003e类型\u003c/th\u003e\u003cth\u003eValue 示例\u003c/th\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003ead:plan:timeslot:{planId}\u003c/td\u003e\u003ctd\u003eString\u003c/td\u003e\u003ctd\u003eBase64 编码后的 BitSet\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003ch3\u003e\u003cb\u003eBitSet 存储样例（Base64）：\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003eKey: ad:plan:timeslot:1001  \nValue: AQIDBA==   // 实际为 BitSet 的序列化后 Base64 编码\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e五、代码实现\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e工具类\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTimeSlotBitSetUtil\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kd\"\u003efinal\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eBIT_SIZE\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e7\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e24\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eBitSet\u003c/span\u003e \u003cspan class=\"nf\"\u003eparseSlotToBitSet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSet\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eslotIndices\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eBitSet\u003c/span\u003e \u003cspan class=\"n\"\u003ebitSet\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eBitSet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBIT_SIZE\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eInteger\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eslotIndices\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBIT_SIZE\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebitSet\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebitSet\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e六、投放时间配置入口示例（运营后台）\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"1jpDj-JN\"\u003e将投放时间转换为 BitSet 索引：\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"ZbXupXTW\"\u003e周五 8 点 → index = (5 - 1) * 24 + 8 = 104\u003c/li\u003e\u003cli data-pid=\"ClH_TRDa\"\u003e周二 16 点 → index = (2 - 1) * 24 + 16 = 40\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"JDoAuyL1\"\u003e示例：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003eSet\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimeSlots\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSet\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e40\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e104\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 支持多时段\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eBitSet\u003c/span\u003e \u003cspan class=\"n\"\u003ebitSet\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSlotBitSetUtil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eparseSlotToBitSet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etimeSlots\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003eencoded\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSlotBitSetUtil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eencodeBitSet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebitSet\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eredisTemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;ad:plan:timeslot:1001\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eencoded\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e七、总结优势\u003c/b\u003e\u003c/h3\u003e\u003ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003cth\u003e项目\u003c/th\u003e\u003cth\u003e说明\u003c/th\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e存储结构\u003c/td\u003e\u003ctd\u003e168 位位图，结构紧凑，Base64 编码后仅几十字节\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e查询效率\u003c/td\u003e\u003ctd\u003e批量使用 multiGet，结合 BitSet 判断，性能高\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e工具解耦\u003c/td\u003e\u003ctd\u003eBitSet处理逻辑集中于工具类，业务层关注投放过滤\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e使用示例\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003eTimeSlotRoaringIndex\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSlotRoaringIndex\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 计划 1001：周一20点-22点\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eaddPlanToTimeSlot\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1001\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDayOfWeek\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eMONDAY\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e20\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e22\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 查询当前可投计划\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eZonedDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003enow\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eZonedDateTime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003enow\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eZoneId\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Asia/Shanghai\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e));\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRoaringBitmap\u003c/span\u003e \u003cspan class=\"n\"\u003eplans\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetPlansAtTime\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enow\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e频次控制\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e  业务背景\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"tXLzIWO7\"\u003e在广告投放过程中，如果某个广告对同一用户重复展示次数过多，容易造成：\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"7mos4qsd\"\u003e\u003cb\u003e用户体验下降\u003c/b\u003e：频繁看到相同广告，导致用户产生厌烦甚至反感\u003c/li\u003e\u003cli data-pid=\"SEr7hX25\"\u003e\u003cb\u003e预算浪费\u003c/b\u003e：广告主为已触达用户持续付费，却未产生新增转化\u003c/li\u003e\u003cli data-pid=\"A6dOYjw7\"\u003e\u003cb\u003e心理疲劳效应\u003c/b\u003e：CTR（点击率）与CVR（转化率）通常在高频曝光下持续下滑\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"OeprwWH_\"\u003e因此，\u003cb\u003e对广告展示或点击设置频控上限\u003c/b\u003e，已成为广告平台提升投放效果与用户体验的基本能力。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e频次Key结构:\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e  \u003cspan class=\"s\"\u003e\u0026#34;frequency_\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlanId\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;_\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efrequencyType\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;_\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003euuid\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e具体实现：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"75kkNeuN\"\u003e该方法用于在广告投放过程中，\u003cb\u003e根据点击频次上限（FrequencyCap）过滤掉超出限制的广告计划\u003c/b\u003e，防止单个用户在一定时间内重复点击某广告计划过多次，影响投放效果与体验。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e函数 matchFrequencyClick(adPlans):\n\n    如果 adPlans 非空:\n        构造 Redis Key 列表 = 每个广告计划的 frequencyClickKey\n\n        从 Redis 批量获取这些 key 的点击数值列表\n\n        将 key 列表与 value 列表合并成 map：key -\u0026gt; 已点击次数\n\n        遍历所有 adPlans，筛选出符合频次要求的广告计划：\n            条件是：map 中该 key 对应的值 \u0026lt; adPlan.frequencyNum（频次上限）\n\n        返回筛选后的广告计划数组\n\n    否则：\n        返回空数组或原数组\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e均匀投放\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e1：业务背景\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"VKqPCEje\"\u003e在广告投放中，常见的计划预算策略包括：\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"bzY_LwLV\"\u003e\u003cb\u003e抢量投放\u003c/b\u003e：计划一开启，尽可能快速抢占曝光/点击；\u003c/li\u003e\u003cli data-pid=\"HmjdL8pK\"\u003e\u003cb\u003e均匀投放\u003c/b\u003e：希望将预算\u003cb\u003e合理平滑分配到全天各时段\u003c/b\u003e，控制成本并提升转化。\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"XZIl8Siv\"\u003e\u003cb\u003e本模块解决的问题\u003c/b\u003e是第二种 —— 在 CPC（按点击计费）模式下，根据投放剩余分钟数动态计算“当前小时应该投放多少点击”，并作为频控、节奏控制的依据。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003chr/\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e2：核心设计思想\u003c/b\u003e\u003c/h3\u003e\u003ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003cth\u003e核心点\u003c/th\u003e\u003cth\u003e说明\u003c/th\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e动态分配点击\u003c/td\u003e\u003ctd\u003e每分钟刷新，根据预算剩余/时间剩余计算hourClick\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e基于 Redis 实时统计\u003c/td\u003e\u003ctd\u003e从 Redis 获取“当前已投点击”，不依赖Database\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e热补偿机制\u003c/td\u003e\u003ctd\u003e当前小时点击已经消耗部分需“加回”预算，避免重复限制\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e每分钟调度刷新\u003c/td\u003e\u003ctd\u003e保证计划状态“准实时”反映，适配用户流量波动\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e与投放线程解耦\u003c/td\u003e\u003ctd\u003e单独线程或定时任务负责刷新，不影响主链路性能\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003ch3\u003e\u003cb\u003e3：关键方法汇总\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e3.1 cpc均匀投放点击计算\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e函数 calculateClick(adPlan):\n\n    如果 adPlan 配置了每日点击预算:\n        已点击 = 从 Redis 获取 \u0026#34;当日已点击数\u0026#34;\n        剩余点击数 = 日预算 - 已点击\n    否则:\n        已点击 = 从 Redis 获取 \u0026#34;总点击数\u0026#34;\n        剩余点击数 = 总预算 - 已点击\n\n    当前小时已投放点击数 = 从 Redis 获取 \u0026#34;当前小时已投放数\u0026#34;\n    剩余点击数 += 当前小时已投放数（加回去，防止重复统计）\n\n    如果 剩余点击数 \u0026gt; 0 且 广告剩余分钟数 \u0026gt; 0:\n        剩余小时数 = 向上取整(剩余分钟数 / 60)\n        每小时应投放点击数 = 剩余点击数 / 剩余小时数\n    否则:\n        每小时应投放点击数 = 0\n\n    设置 adPlan.hourClick = 每小时应投放点击数\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e3.4 调度器设置\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e组件 UniformDeliveryScheduler:\n\n  每隔 N 秒执行一次:\n\n      调用 deliveryService.calculate()\n          -\u0026gt; 遍历所有处于投放状态的广告计划\n          -\u0026gt; 对每个广告计划执行 calculateClickData(adPlan)\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e量级控制\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e一、功能目标\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"0xMhXrT4\"\u003e本模块的核心目的是在广告投放流程中，实现对 CPC（按点击付费）广告计划的\u003cb\u003e日点击上限控制\u003c/b\u003e。通过实时查询广告计划当天已消耗的点击次数，判断是否超过预设的点击上限，从而过滤掉点击数\u0026amp;预算达到或超过上限的广告计划，防止超额投放，保障广告主预算的合理使用。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e二、业务背景\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"D5_N0b3J\"\u003e广告系统中，广告主通常会给广告计划设置\u003cb\u003e每日点击上限\u003c/b\u003e（或者预算），以限制广告计划每天的最大点击量，避免点击费用超出预算。\u003c/li\u003e\u003cli data-pid=\"a9YP6pkg\"\u003e当广告请求到达广告系统时，系统需要在竞价环节之前快速校验广告计划的当前点击数，判断其是否还允许继续投放。\u003c/li\u003e\u003cli data-pid=\"c4WQQnAl\"\u003e由于广告请求量大，点击数据存在 Redis 中，并采用批量读取方式以保证高性能。\u003c/li\u003e\u003cli data-pid=\"YlKLzzUj\"\u003e该机制保障了广告预算的合理控制，防止无效点击或过度曝光造成的资源浪费。\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003e核心代码\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003e函数\u003c/span\u003e \u003cspan class=\"nf\"\u003ematchDailyClickLimit\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eadPlans\u003c/span\u003e\u003cspan class=\"o\"\u003e):\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e如果\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlans\u003c/span\u003e \u003cspan class=\"n\"\u003e非空\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edayClickKeys\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e提取每个计划的\u003c/span\u003e \u003cspan class=\"n\"\u003eRedis\u003c/span\u003e \u003cspan class=\"n\"\u003e日点击统计\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edayClickValues\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e批量从\u003c/span\u003e \u003cspan class=\"n\"\u003eRedis\u003c/span\u003e \u003cspan class=\"n\"\u003e查询这些\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"n\"\u003e的当前值\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edayClickMap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e将\u003c/span\u003e \u003cspan class=\"n\"\u003ekeys\u003c/span\u003e \u003cspan class=\"n\"\u003e和\u003c/span\u003e \u003cspan class=\"n\"\u003evalues\u003c/span\u003e \u003cspan class=\"n\"\u003e合并为一个\u003c/span\u003e \u003cspan class=\"n\"\u003eMap\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eadPlans\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e对每个\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlan\u003c/span\u003e \u003cspan class=\"n\"\u003e执行以下过滤逻辑\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e如果日点击预算\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003e0\u003c/span\u003e \u003cspan class=\"n\"\u003e或\u003c/span\u003e \u003cspan class=\"n\"\u003e单次点击价格\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e保留该计划\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e否则\u003c/span\u003e\u003cspan class=\"err\"\u003e，\u003c/span\u003e\u003cspan class=\"n\"\u003e如果该计划为\u003c/span\u003e \u003cspan class=\"n\"\u003eCPC\u003c/span\u003e \u003cspan class=\"n\"\u003e模式\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e当前点击次数\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e设置的每日点击上限\u003c/span\u003e\n                    \u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e保留\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e否则\u003c/span\u003e\n                    \u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e过滤\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e返回过滤后的\u003c/span\u003e \u003cspan class=\"n\"\u003eadPlans\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e人群画像定向\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e    为什么要用Hbase？\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"hiHmHToo\"\u003e   HBase是列式存储，能按需存储列，不存在固定列结构，天然支持稀疏列和灵活的Schema，非常适合多维度标签画像数据的存储，广告人群画像通常包含亿级甚至百亿级用户的数据，且每个用户会有多维度、多类型的标签和行为数据，广告画像的主体数据往往是\u003cb\u003e大规模冷数据+准实时更新\u003c/b\u003eHBase天生支持水平扩展，自动分区，适合海量数据扩容，Hbase多数时不适合做实时用户画像的检索和抉择，但我方并未使用Redis或者Caffine来做热点画像存储。并且时延能够满足媒体需求，同时，其他兄弟部门也在公用Hbase人群画像库，共享技术生态，避免重复搭建和维护多套大数据存储系统，节省运维成本和风险。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e1. 设计思路\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cul\u003e\u003cli data-pid=\"1PR-pGq6\"\u003e\u003cb\u003eRowKey设计\u003c/b\u003e：以\u003ccode\u003euserId\u003c/code\u003e作为RowKey，唯一定位单个用户画像。\u003c/li\u003e\u003c/ul\u003e\u003cli data-pid=\"FsvsBx_c\"\u003e\u003cb\u003e列族设计\u003c/b\u003e：定义一个或多个列簇，如\u003ccode\u003einfo\u003c/code\u003e，存储用户画像标签。\u003c/li\u003e\u003cli data-pid=\"3QESOnoL\"\u003e\u003cb\u003e列限定符（Qualifier）设计\u003c/b\u003e：每个画像标签作为一个列，如年龄、性别、兴趣爱好等。\u003c/li\u003e\u003cli data-pid=\"acfwRlRc\"\u003e\u003cb\u003e数据特点\u003c/b\u003e：\u003c/li\u003e\u003cul\u003e\u003cli data-pid=\"2pYrDluD\"\u003e多维度，标签稀疏，不同用户标签不完全相同。\u003c/li\u003e\u003cli data-pid=\"sN6bNo0B\"\u003e支持标签的动态扩展，方便新增或修改标签。\u003c/li\u003e\u003cli data-pid=\"4Es4Mpgy\"\u003e支持多版本数据，方便用户画像更新和历史分析。\u003c/li\u003e\u003c/ul\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003e2. 查询流程\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"satP1NzM\"\u003e根据userId快速定位RowKey。\u003c/li\u003e\u003cli data-pid=\"u60OoUMk\"\u003e读取该用户所有画像标签，进行画像判断或定向过滤。\u003c/li\u003e\u003c/ul\u003e\u003ch2\u003e\u003cb\u003e存储设计\u003c/b\u003e\u003c/h2\u003e\u003ch2\u003e\u003cb\u003eClickhouse设计\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e物化视图设计：\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003eCREATE MATERIALIZED VIEW ad_event_agg_mv\nENGINE = AggregatingMergeTree()\nPARTITION BY toYYYYMM(server_time)\nORDER BY (day, advertiser_id, campaign_id, creative_id)\nAS\nSELECT\n    toDate(server_time) AS day,\n    advertiser_id,\n    campaign_id,\n    creative_id,\n    countState() AS event_count_state,\n    countIfState(event_type = \u0026#39;StandExpo\u0026#39;) AS standexpo_count_state,\n    countIfState(event_type = \u0026#39;PutExpo\u0026#39;) AS putexpo_count_state,\n    countIfState(event_type = \u0026#39;PutClick\u0026#39;) AS putclick_count_state,\n    sumState(price) AS total_cost_state\nFROM ad_event_detail\nGROUP BY\n    day,\n    advertiser_id,\n    campaign_id,\n    creative_id;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e广告明细表设计：\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003eCREATE TABLE ad_event_detail\n(\n    -- 时间字段\n    server_time DateTime,             -- 服务端接收时间（主时间维度）\n    event_time DateTime,              -- 事件发生时间（上游字段，可以用 ALIAS）\n    -- 业务维度\n    advertiser_id String,             -- 广告主ID\n    campaign_id String,               -- 广告计划ID（对应你物化视图里的 adplan_id）\n    media_id String,                  -- 媒体ID\n    ad_slot_id String,                -- 广告位ID\n    creative_id String,               -- 创意ID\n    device_id String,                 -- 设备ID，用户唯一标识\n    city_id UInt32,                   -- 城市ID（原 IP 解析）\n    -- 操作系统类型，枚举类型\n    os_type Enum8(\u0026#39;ios\u0026#39; = 1, \u0026#39;android\u0026#39; = 2, \u0026#39;windows\u0026#39; = 3, \u0026#39;macos\u0026#39; = 4, \u0026#39;other\u0026#39; = 5),\n    -- 事件类型，明确枚举\n    event_type Enum8(\u0026#39;StandExpo\u0026#39; = 1, \u0026#39;PutExpo\u0026#39; = 2, \u0026#39;PutClick\u0026#39; = 3),\n    -- 请求唯一ID，用于去重或追踪\n    request_id String,\n    -- 扩展字段，灵活存储业务自定义字段\n    extend1 String,\n    extend2 String,\n    -- 页面视图编码，用于业务分析不同页面的效果\n    view_code String,\n    -- 价格、消耗，单位可根据业务调整\n    price Float64 DEFAULT 0,\n    -- 用户画像维度，可选保留或拆分成数组\n    gender LowCardinality(String),\n    age LowCardinality(String),\n    -- 唯一键，用于重复数据去重，通常拼接业务关键字段或使用唯一 request_id\n    uniq_key String,\n    -- 版本字段，辅助去重时保留最新数据\n    version UInt64 DEFAULT toUnixTimestamp(server_time)\n)\nENGINE = ReplacingMergeTree(version)\nPARTITION BY toYYYYMM(server_time)\nORDER BY (\n    advertiser_id,\n    campaign_id,\n    media_id,\n    ad_slot_id,\n    creative_id,\n    server_time\n);\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"HCcizEjS\"\u003e 物化视图聚合表引擎采用\u003ca href=\"https://link.zhihu.com/?target=https%3A//clickhouse.com/docs/zh/engines/table-engines/mergetree-family/aggregatingmergetree\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eAggregatingMergeTree\u003c/a\u003e，此引擎用于存储和查询预计算的聚合数据。适合高效地存储大规模的聚合结果，一般用于针对明细表的聚合表。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e索引设计\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003eINDEX idx_server_time server_time TYPE minmax GRANULARITY 8192,\nINDEX idx_event_type  event_type  TYPE minmax GRANULARITY 8192,\nINDEX idx_advertiser_id advertiser_id TYPE set(0) GRANULARITY 8192,\nINDEX idx_campaign_id campaign_id TYPE set(0) GRANULARITY 8192,\nINDEX idx_creative_id creative_id TYPE set(0) GRANULARITY 8192\n\nSETTINGS index_granularity =8192;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"y0XBBSD_\"\u003eserver_time 和 event_type 用 minmax 索引适合范围过滤。advertiser_id、campaign_id、creative_id 这类字符串主维度字段用 set 索引，对精确过滤效果好，且开销相对小。索引不会替代排序键，但能有效辅助过滤。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003eHbase表设计\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003eRowkey设计\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"UgimvOYJ\"\u003e 因广告标准化要求，\u003cb\u003e设备号都是基于MD5格式(32位)进行传输\u003c/b\u003e，因为MD5生成的哈希值(通常是32个字符的16进制字符串)可以将数据均匀分布到HBase的Region中，\u003cb\u003e避免了热点问题\u003c/b\u003e。因为MD5是32字节的16进制字符串，它的哈希值在理论上是非常随机的，这可以有效地避免数据倾斜。而且在大并发情况下，不需要对Rowkey做二次计算，故\u003cb\u003eHbase表的Rowkey设计遵从选择MD5作为Rowkey设计方案\u003c/b\u003e，同时，因每一个设备号都伴随着数据类型参数，所以，Hbase表通过类型做表的区分(OAID、IMEI、IDFA)作为区分不同表的依据。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-d5ad59fd7b82276ba570af17eedcd671_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1542\" data-rawheight=\"396\" data-original-token=\"v2-1e41439b4f6dce232e0012f0e57a7366\" class=\"origin_image zh-lightbox-thumb\" width=\"1542\" data-original=\"https://pic4.zhimg.com/v2-d5ad59fd7b82276ba570af17eedcd671_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003eRegion大小设计\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"A0-TY56v\"\u003e 在Hbase中，分区是基本的存储单元，当数据量较大时，HBase 会\u003cb\u003e自动(**\u003c/b\u003e默认情况下，当一个 Region 达到 10GB 的大小)将数据分成多个 Region\u003cb\u003e，每个 Region 存储数据的一部分。每个 Region 会映射到一个 RegionServer 上进行管理。合理地分配和管理 Region 可以帮助提高性能、避免热点问题以及实现更好的负载均衡,每个 Region 包含一个连续的行范围(startRowKey，endRowKey)。一般来说，\u003c/b\u003eRegion** 的大小应控制在 \u003cb\u003e10GB 到 20GB\u003c/b\u003e 之间(这个不强求，根据自己系统的实际需要来判断)，如果 Region 大小过小（例如 \u0026lt; 1GB），会导致过多的 Region 会占用过多的资源（比如内存、文件句柄等），增加 RegionServer 的负担，如果 Region 太大，会导致负载不均衡，某些 Region 可能会成为瓶颈，造成负载集中，写入数据到过大的 Region 时可能会增加延迟，影响系统的吞吐量，如果单个 Region 的数据太多，可能导致 RegionServer 内存压力增大，影响性能。\u003c/p\u003e\u003cp data-pid=\"0R_xUNwL\"\u003e用户的的Hbase相关Region设计如下：\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-011e3ec79d543482e4baf1fc018257c3_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"3138\" data-rawheight=\"1656\" data-original-token=\"v2-eeba682377eba17e5cc91eea1934452c\" class=\"origin_image zh-lightbox-thumb\" width=\"3138\" data-original=\"https://picx.zhimg.com/v2-011e3ec79d543482e4baf1fc018257c3_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003eRedis设计\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e异步操作\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"lK_5Sp_a\"\u003e 因广告系统中有大量Key需要被增量记录次数，同时此操作不应该影响主业务线程逻辑，故采用异步操作来进行增量添加，Spring Data框架中提供了\u003ca href=\"https://link.zhihu.com/?target=https%3A//docs.spring.io/spring-data/redis/reference/api/java/org/springframework/data/redis/core/ReactiveStringRedisTemplate.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eReactiveStringRedisTemplate\u003c/a\u003e 来进行异步操作，异步操作不会阻塞调用线程，可以提高系统的并发性能，尤其是在需要大量 Redis 操作的应用中：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * 异步增量添加数据\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e *\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * @param key           Redis的Key\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * @param increaseValue 要增量的值\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eincrementAsync\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eincreaseValue\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ereactiveStringRedisTemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eincrement\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eincreaseValue\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e批处理\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e批量获取：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"25Sd3D36\"\u003e 如以下代码所示：通过传入Key的列表对象，获取Value的列表(\u003cb\u003eValue的顺序和Key的顺序是一致的，如果Key不存在，那么获取的Value值为null\u003c/b\u003e)，\u003c/p\u003e\u003cp data-pid=\"hdeJvOYF\"\u003e这段代码的主要功能是将两个列表 keyList 和 valueList 根据索引位置合并成一个 Map，其中 keyList 中的元素作为键，valueList 中的元素作为值。代码首先检查两个列表的大小是否一致，然后使用 Stream.iterate() 创建一个索引流，接着通过 Collectors.toMap() 收集成 Map。如果两个列表大小不一致，则抛出一个异常来避免错误。这种方法适合于\u003cb\u003e两个列表长度相同的情况\u003c/b\u003e，并且能够高效地将两个列表合并为一个映射。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"N7QxLJKJ\"\u003e\u003cb\u003e批量Set：\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"mamkbSer\"\u003e Spring Data框架中提供了multiSet，传入的是一个Map对象，Key就是Redis的Key，Value则是此Redis的实际值。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * 批量设置Redis数据\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e *\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * @param redisMap Redis的键值对Map，其中Key为Redis的Key，Value为Redis的具体值\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003emultiSetAsync\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMap\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eredisMap\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estringRedisTemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eopsForValue\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003emultiSet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eredisMap\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"QBNAotbS\"\u003e 总结：虽然redis是一个基于内存的缓存神器，操作速度奇快，但是单次操作超快也架不住数以千万甚至亿级的操作，此时如果还是用迭代的单条操作可能带来灾难性的后果，所以除了单条操作外，建议在\u003cb\u003e不影响主进程业务\u003c/b\u003e的情况下，应当尽可能的使用异步处理，同时，在具体实现中尽量使用批量操作，以减少与中间件中的RPC次数(尽管是内网)。\u003c/p\u003e\u003ch2\u003e\u003cb\u003eKafka设计\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"1S5D4OxE\"\u003e 在广告系统中，\u003cb\u003eKafka\u003c/b\u003e帮助系统解耦多个业务模块，提供松耦合的架构，广告系统系统通常需要高吞吐量、低延迟的系统来保证广告实时性和精准性。Kafka 支持大规模并发数据流，并能保证消息的快速消费。Kafka支持将广告数据流从实时系统传递到数据仓库（如HDFS、Hive、ClickHouse），并为数据仓库提供增量数据同步的能力。\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"a8KlaXIc\"\u003e在线系统： 在实时广告竞价、流量分析等过程中，Kafka 作为缓冲区暂时存储传入的数据，流处理引擎可以后续进行消费。\u003c/li\u003e\u003cli data-pid=\"hi9VvjDg\"\u003e离线系统： Kafka 可以将历史广告数据传送到离线系统用于批量数据处理（如广告效果分析、用户行为建模等）。\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-61660559a8ac4f6e550d55667a253ffa_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2218\" data-rawheight=\"1132\" data-original-token=\"v2-c4657bf3bc48c0e1f9c5f973bdca8668\" class=\"origin_image zh-lightbox-thumb\" width=\"2218\" data-original=\"https://pic1.zhimg.com/v2-61660559a8ac4f6e550d55667a253ffa_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e分区设置\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"qZClknE-\"\u003e Kafka的吞吐量主要依赖于\u003cb\u003e分区数和消费者\u003c/b\u003e的并发能力，每个分区只能被一个消费者在同一个消费者组中消费。因此，消费者的数量不能超过分区的数量，kafka分区和节点数成倍数关系，这样分区分布的会比较均衡，因为广告消费者系统(离线项目)已知有6个节点，故kafka的节点数设置为12或者24。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e生产者配置\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"nt\"\u003eproducer\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ebootstrapServers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#bootstrapServers: placeholder.kafka.example.com\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消息key的序列化方式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ekeySerializerClass\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eorg.apache.kafka.common.serialization.StringSerializer\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消息值的序列化方式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003evalueSerializerClass\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eorg.apache.kafka.common.serialization.StringSerializer\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#接收回执\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eacks\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer用于缓存的内存大小(字节)(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ebufferMemory\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e33554432\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer发送消息的重试次数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eretries\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer发送消息的每个批次到指定分区的最大发送字节数(字节)(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ebatchSize\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e16384\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer发送消息的每个请求的最大发送字节数(字节)(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003erequestSize\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1048576\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer底层TCP的发送缓冲区(字节)(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003esendBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e131072\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer底层连接的最大空闲时间(毫秒)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003econnectionsIdle\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e540000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer每个请求的最长等待时间(毫秒)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eblockTime\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e30000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer一个connection可以发送的最大请求数(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003econnectionFlight\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer消息延迟发送的等待时间(毫秒)(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003elinger\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer消息压缩类型 压缩速度snappy\u0026lt;gzip 批量发送下有效节省带宽和磁盘空间 (吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ecompression\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003egzip\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#producer实例个数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003einstances\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e消费者配置\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"nt\"\u003econsumer\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003erealLabelEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ebootstrapServers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eplaceholder.kafka.example.com\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消费者订阅的topic列表,分割\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003etopic\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eexample_topic\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消费组ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003egroupId\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eexample_group\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消息key的序列化⽅式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ekeyDeserializerClass\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eorg.apache.kafka.common.serialization.StringDeserializer\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消息值的序列化⽅式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003evalueDeserializerClass\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eorg.apache.kafka.common.serialization.StringDeserializer\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer底层连接的最⼤空闲时间(毫秒)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#connectionsIdle: 540000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#fetch时最⼩拉取的字节数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003efetchMinBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#fetch时每个分区最⼤拉取的字节数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003epartitionMaxFetch\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1048576\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#fetch时每个分区最⼤拉取记录数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003epollRecords\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer底层TCP的接收缓冲区(字节)(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ereceiveBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e131072\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer底层TCP的请求超时时间(毫秒)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003erequestTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e30000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#web session过期时间(毫秒)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003esessionTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e25000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer业务实例\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003einstances\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#是否异步接收数据，默认异步，设成false的话为同步\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003easync\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer线程池配置 (新增)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003epool\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ecoreSize\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eofflineLabelEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ebootstrapServers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eplaceholder.kafka.example.com\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消费者订阅的topic列表,分割\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003etopic\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eexample_topic\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消费组ID\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003egroupId\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eexample_group\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消息key的序列化方式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ekeyDeserializerClass\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eorg.apache.kafka.common.serialization.StringDeserializer\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#消息值的序列化方式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003evalueDeserializerClass\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eorg.apache.kafka.common.serialization.StringDeserializer\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#fetch时每个分区最大拉取的字节数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003epartitionMaxFetch\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1048576\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#fetch时每个分区最大拉取记录数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003epollRecords\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer底层TCP的接收缓冲区(字节)(吞吐量参数)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ereceiveBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e131072\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer底层TCP的请求超时时间(毫秒)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003erequestTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e30000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#web session过期时间(毫秒)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003esessionTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e25000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer业务实例\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003einstances\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#是否异步接收数据，默认异步，设成false的话为同步\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003easync\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#consumer线程池配置 (新增)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003epool\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ecoreSize\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003emaxSize\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"yR2EWDBM\"\u003e 以上为kafka的生产者和消费者的基础配置，其中kafka传输全部基于JSON，并且全部为异步执行，\u003cb\u003eKafka\u003c/b\u003e帮助系统解耦多个业务模块，提供松耦合的架构，\u003c/p\u003e\u003ch2\u003e\u003cb\u003eCaffeine缓存设计\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"ZDN21B34\"\u003e\u003cb\u003e广告系统\u003c/b\u003e 中，除了将不可变字段存储在 \u003cb\u003eCaffeine\u003c/b\u003e 中以减少对 \u003cb\u003eRedis\u003c/b\u003e 的访问频率外，还需要对签名验证等操作进行优化。可以将 \u003cb\u003e签名验证\u003c/b\u003e 和 \u003cb\u003e规则判断\u003c/b\u003e 也结合到 Caffeine 中，以进一步提高系统性能和降低延迟。\u003c/p\u003e\u003cp data-pid=\"BcSoslfg\"\u003e部分对接的媒体需要检验secret+当前时间的组合作为此次Request是否valid的标志，而secret属于在初始化媒体信息时候就会带有的字段，不会改变，所以将其放入本地缓存中，通过与currentTime做组合，来判断本地请求是否合法； \u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eLocalCacheComponent\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecache\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCaffeine\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003enewBuilder\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//写入或者更新10分钟后，缓存过期并失效，根据具体情况设置即可\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eexpireAfterWrite\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 初始的缓存空间大小\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einitialCapacity\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e500\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 缓存的最大条数，通过 Window TinyLfu算法控制整个缓存大小\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emaximumSize\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e5000\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//打开数据收集功能\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003erecordStats\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ebuild\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"nf\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 首先尝试从一级缓存中获取\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecache\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetIfPresent\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 一级缓存未命中，从二级缓存中获取\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003eRBucket\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebucket\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eredissonClient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetBucket\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eStringCodec\u003c/span\u003e\u003cspan class=\"o\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebucket\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edebug\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;从redis获取值\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 如果二级缓存中有值，则将其放入一级缓存中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecache\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eput\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edebug\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;从本地获取值\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e\u003cb\u003e广告系统遇到的挑战\u003c/b\u003e\u003c/h2\u003e\u003ch2\u003e\u003cb\u003eOOM导致业务处理宕机\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003eNetty设置水位\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"kreBO1_u\"\u003e Netty本身是基于出站入站的事件驱动的框架，业务整体流程如下：\u003cb\u003e业务handler -\u0026gt; write -\u0026gt; ChannelOutboundBuffer -\u0026gt; flush -\u0026gt; SO_SEND_BUF -\u0026gt; 网卡*\u003c/b\u003e*，**当网络出现阻塞或者Netty服务端负载(QPS)很高的时候，服务端接收速度和处理速度越来越慢，或者直白点说，出站速度跟不上入站速度， 会出现什么情况？？\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"Bqcj66fQ\"\u003eTCP的滑动窗口不断缩小，以减少网络数据的发送，直到为0；\u003c/li\u003e\u003cli data-pid=\"jtJTf-8i\"\u003eNetty服务端有大量频繁的写操作，不断写入到ChannelOutboundBuffer(出站缓冲区)中；\u003c/li\u003e\u003cli data-pid=\"eBknVcsp\"\u003e但ChannelOutboundBuffer中的数据flush不到SO_SEND_BUF中，导致ChannelOutboundBuffer中的数据不断堆积，最终撑爆ChannelOutboundBuffer，导致内存溢出而宕机。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"nd\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003erun\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eWriteBufferWaterMark\u003c/span\u003e \u003cspan class=\"n\"\u003ewriteBufferWaterMark\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eWriteBufferWaterMark\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e1024\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e1024\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e1024\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e2\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eServerBootstrap\u003c/span\u003e \u003cspan class=\"n\"\u003ebootstrap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eServerBootstrap\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebootstrap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egroup\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBOSS_GROUP\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWORKER_GROUP\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echannel\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNioServerSocketChannel\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echildHandler\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003ePMPServerInitializer\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCONNECT_TIMEOUT_MILLIS\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e1000\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSO_BACKLOG\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e10000\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSO_RCVBUF\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e1024\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e1024\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eALLOCATOR\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePooledByteBufAllocator\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eDEFAULT\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eRCVBUF_ALLOCATOR\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eAdaptiveRecvByteBufAllocator\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eDEFAULT\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eWRITE_BUFFER_WATER_MARK\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewriteBufferWaterMark\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echildOption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eTCP_NODELAY\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echildOption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSO_LINGER\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e    \n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echildOption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSO_KEEPALIVE\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echildOption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSO_SNDBUF\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e1024\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e1024\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e2\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eChannel\u003c/span\u003e \u003cspan class=\"n\"\u003ech\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebootstrap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ebind\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eport\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esync\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003echannel\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;PMP Server at port:{}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eport\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//等待服务端关闭socket\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003ech\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ecloseFuture\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003esync\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eerror\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;exception:{}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"o\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003efinally\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eBOSS_GROUP\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eshutdownGracefully\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eWORKER_GROUP\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eshutdownGracefully\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"Abp3fm29\"\u003e Netty中的高低水位是通过\u003cb\u003eChannelOption.WRITE_BUFFER_WATER_MARK\u003c/b\u003e来设置的WRITE_BUFFER_WATER_MARK是一个WriteBufferWaterMark对象，它包含两个属性low和high，分别表示低水位和高水位；\u003c/p\u003e\u003cp data-pid=\"IqwoHMoS\"\u003e推荐做法：\u003cb\u003e每次调用channl.write(msg)方法首先调用channel.isWritable()判断是否可写\u003c/b\u003e；如下所示：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * 回写Netty响应\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e *\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * @param ctx     Netty Channel上下文\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * @param content Http Response内容\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * @param status  http响应状态\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ewriteResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelHandlerContext\u003c/span\u003e \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHttpResponseStatus\u003c/span\u003e \u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eByteBuf\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecopiedBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCharsetUtil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eUTF_8\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eFullHttpResponse\u003c/span\u003e \u003cspan class=\"n\"\u003ehttpResponse\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDefaultFullHttpResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpVersion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eHTTP_1_1\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehttpResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eheaders\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Content-Length\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ereadableBytes\u003c/span\u003e\u003cspan class=\"o\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehttpResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eheaders\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Content-Type\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;text/plain\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehttpResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eheaders\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Connection\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;keep-alive\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \n    \u003cspan class=\"c1\"\u003e//当前Channel是否可写\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echannel\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eisWritable\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echannel\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003ewriteAndFlush\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehttpResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"LISb4iIH\"\u003e 补充：Netty 是一个事件驱动的 I/O 框架，设计的核心是高效地处理异步 I/O 操作，它使用了多个工作线程（worker threads）来处理客户端请求和响应，虽然 Netty 在配置 WorkerGroup 线程池数量方面提供了一定的调整能力，对于高并发的环境，平衡出站和入站的\u0026#34;\u003cb\u003e平衡速率\u003c/b\u003e\u0026#34;仍然是关键。过高的入站速率会导致 Netty 的 IO 线程饱和，从而引发性能瓶颈。而在这种情况下，单纯调整 Netty 本身的配置（如增加工作线程池或调整缓冲区大小等）只是部分解决方案，\u003cb\u003e更重要的是保证业务处理逻辑(BusinessHandler)的高效性,所以\u003c/b\u003e存储与检索、关键业务节点的处理，都是影响系统性能的主要瓶颈。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e添加引用计数器\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"BagAhRSp\"\u003e Netty使用\u003cb\u003e引用计数器\u003c/b\u003e来管理对象（\u003ca href=\"https://link.zhihu.com/?target=https%3A//netty.io/4.1/api/io/netty/buffer/ByteBuf.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eByteBuf\u003c/a\u003e）的生命周期，确保内存得到有效释放并防止内存泄漏。引用计数的核心思想是：一个对象被分配后，只有在没有引用时才会被回收，我们在大批量广告投放的时候，系统报出以下错误：\u003c/p\u003e\u003cp data-pid=\"r973XAE9\"\u003eLEAK: ByteBuf.release() was not called before it\u0026#39;s garbage-collected\u003c/p\u003e\u003cp data-pid=\"Y1MATJQo\"\u003e 这意味着 ByteBuf 在生命周期结束后未正确调用 release() 方法释放内存，导致 Netty 检测到内存泄漏，所以应显示调用引用计数器的release方法来将对象直接进行回收（当引用计数器为0的时候），Netty 提供的简化引用计数操作的工具类：\u003ca href=\"https://link.zhihu.com/?target=https%3A//netty.io/4.1/api/index.html%3Fio/netty/util/ReferenceCountUtil.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eReferenceCountUtil\u003c/a\u003e ， 主要用于管理和释放基于引用计数的对象（如 ByteBuf）。它在正常和异常场景下都可以有效地防止内存泄漏，如果处理完成后不需要将消息传递给下一个 ChannelHandler，需要手动释放它，故在所有业务流程结束后，调用释放方法，直接回收即可。\u003c/p\u003e\u003cp data-pid=\"J6DKkjZR\"\u003e\u003cb\u003eReferenceCountUtil使用Example：\u003c/b\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"nd\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003echannelRead\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelHandlerContext\u003c/span\u003e \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eObject\u003c/span\u003e \u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(!(\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e \u003cspan class=\"k\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"n\"\u003eFullHttpRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eFullHttpRequest\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFullHttpRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003emethodName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emethod\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpMethod\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePOST\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eequals\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emethodName\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epostHandler\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewriteResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;Request method \u0026#39;GET\u0026#39; not supported\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHttpResponseStatus\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eBAD_REQUEST\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eReferenceCountUtil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esafeRelease\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"ZgRW2wX9\"\u003e Netty 使用了 \u003cb\u003eCAS\u003c/b\u003e 操作来更新引用计数（自旋锁进行decrease操作）。这种方式在底层硬件支持下避免了传统锁的开销。同时确保了内存泄漏的问题。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e动静分离：\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e为什么要动静分离？\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"vLoPe6la\"\u003e 实时系统通常要求低延迟、较高的吞吐量，因此在资源分配上可能需要更多的 CPU、内存、网络带宽等，以处理实时流量和并发请求，而\u003cb\u003e离线系统一般用于处理批量数据\u003c/b\u003e，动静分离后，可以根据不同的任务优化资源的分配，确保系统整体的高效运行。例如，实时系统使用高效的内存和缓存管理，而离线批处理系统可以使用更强大的计算集群来处理数据分析任务，将两者分开，使得每个系统专注于自己的任务，降低系统复杂度，不需要担心彼此对性能的干扰。实时系统的低延迟要求与批处理的复杂计算可以并行运行，不互相制约。\u003c/p\u003e\u003ch2\u003e\u003cb\u003eprotobuf加解密消耗CPU时钟过高；\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e流式解析\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"TS26jw2r\"\u003e 对于大的Protobuf消息体，如果你不需要一次性解析整个消息，而是希望逐步处理，可以使用流式解析，这样Protobuf会\u003cb\u003e按需解析\u003c/b\u003e数据，而不是将所有内容加载到内存中，这种方式在处理较大数据时特别有效，可以节省内存并提高效率。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e优化ByteBuf和内存管理\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"HOIfmdQY\"\u003e 使用 Netty进行数据传输，可以考虑直接使用ByteBuf来包装Protobuf数据，避免额外的内存分配和复制。ByteBuf提供了更高效的内存管理方式，减少了内存分配和 GC 压力。\u003c/p\u003e\u003cp data-pid=\"mNV0XAzZ\"\u003e\u003cb\u003e改造后的代码：\u003c/b\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003eByteBuf\u003c/span\u003e \u003cspan class=\"n\"\u003ebyteBuf\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eUnpooled\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ewrappedBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003econtent\u003c/span\u003e\u003cspan class=\"o\"\u003e());\u003c/span\u003e\n\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eByteBufUtil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetBytes\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteBuf\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eCodedInputStream\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCodedInputStream\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003enewInstance\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRequest\u003c/span\u003e \u003cspan class=\"n\"\u003eRequest\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eparseFrom\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e\u003cb\u003eNetty海量长连接；\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e设置长连接\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"SJvRA0r5\"\u003e Netty 提供了 ChannelOption.SO_KEEPALIVE，用于开启 TCP 的 SO_KEEPALIVE 选项。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003ebootstrap\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echildOption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelOption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSO_KEEPALIVE\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e心跳包设置\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e读写设置\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"c1\"\u003e//IdleStateHandler 与客户端链接后，根据超出配置的时间自动触发userEventTriggered，以下参数分别是读超时、写超时、读写空闲\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003epipeline\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eaddLast\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;idle\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eIdleStateHandler\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSECONDS\u003c/span\u003e\u003cspan class=\"o\"\u003e));\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"NkyzShb0\"\u003e 如果idle（如客户端由于网络原因导致到服务器的心跳无法送达），则服务器会主动断开连接，释放资源。判断连接是否idle是通过定时任务完成的，但是Netty可能维 持数百万级别的长连接，对每个连接去定义一个定时任务是不可行的，所以如何提升I/O超时调度的效率呢？Netty根据时间轮(Timing Wheel)开发了\u003ca href=\"https://link.zhihu.com/?target=https%3A//netty.io/4.1/api/io/netty/util/HashedWheelTimer.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eHashedWheelTimer\u003c/a\u003e工具类，用来优化I/O超时调度(本质上是延迟任务）；之所以采用时间轮(Timing Wheel)的结构还有一个很重要的原因是I/O超时这种类型的任务对时效性不需要非常精准。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"nd\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003euserEventTriggered\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eChannelHandlerContext\u003c/span\u003e \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eObject\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"kd\"\u003ethrows\u003c/span\u003e \u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e \u003cspan class=\"k\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"n\"\u003eIdleStateEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003echannel\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eclose\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efireUserEventTriggered\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e\u003cb\u003eHttp Response丢包：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"_td4tD8T\"\u003e 如果 HTTP 响应体（Response Body）过大，超过了单个 TCP 包的大小限制，Netty 会将响应体拆分成多个数据包进行发送。如果这些数据包没有正确地组装在客户端或服务器端，可能会出现响应丢包或无法完整接收的情况。排除掉IO阻塞问题，那么问题肯定出在服务器的tcp配置上面\u003c/p\u003e\u003cp data-pid=\"sp7bOF2s\"\u003ecat /proc/sys/net/ipv4/tcp_mem\u003c/p\u003e\u003cp data-pid=\"jCQgO-G5\"\u003e 查看 Linux 系统中 \u003cb\u003eTCP 内存缓冲区，那么得出结果：首个是\u003c/b\u003eTCP 内存缓冲区的最小值，中间的是TCP 内存缓冲区的默认值，最后一个是TCP 内存缓冲区的最大值。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-24676999dcf229e06c3b29641ca45e6c_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1556\" data-rawheight=\"272\" data-original-token=\"v2-733b9ebec32140722dc0844ce1c20109\" class=\"origin_image zh-lightbox-thumb\" width=\"1556\" data-original=\"https://pic3.zhimg.com/v2-24676999dcf229e06c3b29641ca45e6c_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整HttpObjectAggregator大小:\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"rYvQWo1U\"\u003e http服务器把HttpObjectAggregator放入pipeline里，HttpObjectAggregator会把多个消息转换为一个单一的FullHttpRequest或是FullHttpResponse，通过构造参数定义http传输聚合包的大小，根据评估，广告系统的大小调整为\u003cb\u003e(1024 * 1024 * 64)\u003c/b\u003e，单位：字节；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整操作系统写缓冲区大小:\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"hESJGeT8\"\u003e 首先使用命令来看下，操作系统内核读写缓冲区大小：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e#这是一个系统全局参数，其单位是页(1页等于4096字节)，表示所有TCP的buffer配置。有三个值：\n#第一个值buffer值的下限，\n#第二个值表示内存压力模式开始对buffer应于压力的上限；\n#第三个值内存使用的上限，超过时，可能会丢弃报文\ncat /proc/sys/net/ipv4/tcp_mem\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-caa4fc3e3729051af490340ca6cbea4d_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1568\" data-rawheight=\"80\" data-original-token=\"v2-caa4fc3e3729051af490340ca6cbea4d\" class=\"origin_image zh-lightbox-thumb\" width=\"1568\" data-original=\"https://pic2.zhimg.com/v2-caa4fc3e3729051af490340ca6cbea4d_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"cEDD_IZ3\"\u003e 注意：当我们在编程中对连接设置了\u003cb\u003eSO_SNDBUF、SO_RCVBUF\u003c/b\u003e，将会使Linux内核不再对这样的连接执行自动调整功能！！！Netty提供的\u003ca href=\"https://link.zhihu.com/?target=https%3A//netty.io/4.1/api/io/netty/channel/ChannelOption.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eChannelOption\u003c/a\u003e提供了对底层网络参数的精细化控制，可以帮助开发者根据具体场景调优应用的网络性能，其中ChannelOption.SO_RCVBUF 和 ChannelOption.SO_SNDBUF可以直接设置 TCP 的接收和发送缓冲区大小，以映射操作系统底层tcp参数。更灵活的方式是可以动态调整缓冲区的大小，这时候就体现出 ByteBuf 的优势，Netty 提供的 ByteBuf 是可以支持动态调整容量的，而且提供了开箱即用的工具，例如可动态调整容量的接收缓冲区分配器 \u003ca href=\"https://link.zhihu.com/?target=https%3A//netty.io/4.1/api/io/netty/channel/AdaptiveRecvByteBufAllocator.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eAdaptiveRecvByteBufAllocator\u003c/a\u003e。\u003c/p\u003e\u003ch2\u003e\u003cb\u003eHbase集群CPU使用率特别高；\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003eGet改成批处理：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"m2COymR-\"\u003e HBase分别提供了单条get以及批量get的API接口，使用批量get接口可以减少客户端到RegionServer之间的RPC连接数，提高读取性能。另外需要注意的是，\u003cb\u003e批量get请求要么成功返回所有请求数据，要么抛出异常。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"MSxkJlCG\"\u003e\u003cb\u003e以下是Hbase批量获取实例的demo：\u003c/b\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"n\"\u003efunction\u003c/span\u003e \u003cspan class=\"nf\"\u003egetColumnValues\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etableName\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erowKeys\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecolumnNames\u003c/span\u003e\u003cspan class=\"o\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresults\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eempty\u003c/span\u003e \u003cspan class=\"n\"\u003emap\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// Map\u0026lt;String, Map\u0026lt;String, Tuple\u0026lt;String, Long\u0026gt;\u0026gt;\u0026gt;\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nl\"\u003e\n\u003c/span\u003e\u003cspan class=\"nl\"\u003e    try:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efamily\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDEFAULT_FAMILY\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecolumnBytes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ecolumnName\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ecolumnNames\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecolumnBytes\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoBytes\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolumnName\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etableName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003echeckNamespace\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etableName\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etable\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egetTable\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etableName\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003emultiGet\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003erowKey\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003erowKeys\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eget\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eGet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoBytes\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erowKey\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ecolumnByte\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ecolumnBytes\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eaddColumn\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoBytes\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efamily\u003c/span\u003e\u003cspan class=\"o\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ecolumnByte\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003emultiGet\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ehTableResults\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emultiGet\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ehTableResults\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003enot\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ehTableResults\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003enot\u003c/span\u003e \u003cspan class=\"n\"\u003eempty\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003erowResult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eempty\u003c/span\u003e \u003cspan class=\"n\"\u003emap\u003c/span\u003e \u003cspan class=\"c1\"\u003e// Map\u0026lt;String, Tuple\u0026lt;String, Long\u0026gt;\u0026gt;\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ecell\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003elistCells\u003c/span\u003e\u003cspan class=\"o\"\u003e():\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytesToString\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecell\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetValue\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytesToString\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecell\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetQualifier\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ets\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecell\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetTimestamp\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003erowResult\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003erowKeyStr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytesToString\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetRow\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eresults\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003erowKeyStr\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erowResult\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"n\"\u003eIOException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elog\u003c/span\u003e \u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"n\"\u003ewith\u003c/span\u003e \u003cspan class=\"n\"\u003etableName\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erowKeys\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecolumnNames\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e \u003cspan class=\"n\"\u003eexception\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;getColumnValues数据失败\u0026#34;\u003c/span\u003e\n\u003cspan class=\"nl\"\u003e\n\u003c/span\u003e\u003cspan class=\"nl\"\u003e    finally:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresults\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e注意点：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"q9yW4L_4\"\u003e Hbase的批量操作可以提高效率，但一次请求太多的行可能会导致内存或网络负载过高。可以将批量Get请求分批执行，每次处理一定数量的行同时，Hbase是支持动态列的数据库，默认是查询所有列操作，故以上方法提供了List columnNames 来查询\u003cb\u003e有限的列\u003c/b\u003e，因为在HBase中，\u003cb\u003e列数理论上是**\u003c/b\u003e无限的**，但是在实际应用中，列数过多会对性能和存储产生负面影响以减少数据的传输量。减少滞后性。 \u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整MemStore大小：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"26AFAlJy\"\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//hbase.apache.org/2.4/devapidocs/org/apache/hadoop/hbase/regionserver/MemStore.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eMemStore\u003c/a\u003e是存储数据的内存区域，负责缓存写入的数据，直到这些数据被刷写到磁盘上的HFile。当数据被写入HBase时，首先会被写入到 MemStore 中，然后在 MemStore达到一定大小后(\u003cb\u003ehbase.regionserver.memstore.flush.size，默认128\u003c/b\u003eMB\u003cb\u003e)，数据会被刷写到磁盘上。调整 MemStore 的配置对于优化写入性能、内存使用和系统吞吐量非常重要。，根据实际负载进行调整。如果你的写入负载很高，可以考虑增大此值以减少刷写次数，减少磁盘I/O的压力。\u003c/b\u003ehbase.regionserver.global.memstore.upperLimit 默认0.4\u003cb\u003e，设置 MemStore 占用内存的上限百分比。如果 MemStore 使用的内存超过此值，RegionServer 会触发\u003c/b\u003e flush 操作，将 MemStore 中的数据刷写到磁盘；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e异步写入：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"bGgXPH4I\"\u003e Hbase提供了\u003ca href=\"https://link.zhihu.com/?target=https%3A//hbase.apache.org/2.0/devapidocs/org/apache/hadoop/hbase/client/AsyncBufferedMutator.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eAsyncBufferedMutator\u003c/a\u003e异步写入的功能，它允许客户端在不阻塞的情况下执行Put、Delete等写操作。通过使用异步写入，应用程序可以显著提高写入吞吐量，尤其是在写入超高频次的业务场景下；同时Hbase提供了插入数据的批处理API，可以与异步操作结合使用。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整BlockCache大小\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"TvkkU8h4\"\u003e BlockCache读缓存，每一个Region Server只会有一个读缓存，把读到的数据都放到内存中的，另外：BlockCache的大小必须是内存页大小的整数倍(\u003cb\u003e目前常用页面大小4KB\u003c/b\u003e)。默认值0.2（即20%的堆内存），增加此值可以提高读取性能，尤其是在读取热点数据时。通常，如果你的系统有大量的读取请求且数据访问存在热点（即某些数据频繁访问），可以增大BlockCache的大小。\u003c/p\u003e\u003cp data-pid=\"-6uQFg-C\"\u003e高读负载系统：如果你的应用有较高的读取负载，尤其是热点数据（频繁访问的列或行），可以增大 BlockCache 的大小。通过\u003cb\u003ehfile.block.cache.size\u003c/b\u003e。当然，如果频繁读取的数据，可以使用数据预加载在\u003ca href=\"https://link.zhihu.com/?target=https%3A//zh.wikipedia.org/zh-cn/Memcached\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eMemCached\u003c/a\u003e或者Redis中。\u003c/p\u003e\u003ch2\u003e\u003cb\u003eClickhouse实时写入条数实在太多：\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003e存储告急：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"onChCZek\"\u003e\u003cb\u003eClickHouse将默认使用\u003c/b\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/LZ4\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003eLZ4压缩模式\u003c/a\u003e，\u003cb\u003e压缩比\u003c/b\u003e也更多取决于数据列的排序，由于广告属于高度重复的数据，并且属于超高频次频繁的写入，使用ZSTD或LZ4等高效压缩算法，压缩比和速度都能达到一个较好的平衡。压缩比越高，存储空间的占用越小。同时，排序字段 (ORDER BY) 决定了数据在磁盘上的存储顺序。相似值存储在一起可以大幅提高压缩效率。将\u003cb\u003e高基数字段\u003c/b\u003e（重复率较低的字段）放在排序字段的后面，\u003cb\u003e低基数字段优先排序\u003c/b\u003e。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整排序(order by)\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003eORDER BY (\n    server_time,         -- 按天\n    advertiser_id,\t     -- 首筛维度，必须靠前\n    plan_id,             -- 广告主下的具体投放，次筛\n    media_id,            -- 媒体渠道（高维聚合常用）\n    ad_slot_id,          -- 广告位（媒体维度下钻）\n    geo_id,              -- 地域维度（可视化筛选多）\n    target_type_id,      -- 定向维度（用于聚合）\n    event_time,          -- 时段分析、时间排序\n    request_id           -- 唯一ID（做点查用，可建Bloom）\n)\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e内存顶不住\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e优化jvm\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"n\"\u003eJAVA_OPTS\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;-Xms8192m -Xmx8192m \n\u003c/span\u003e\u003cspan class=\"s2\"\u003e-XX:+UnlockExperimentalVMOptions \n\u003c/span\u003e\u003cspan class=\"s2\"\u003e-XX:+UseCGroupMemoryLimitForHeap \n\u003c/span\u003e\u003cspan class=\"s2\"\u003e-XX:MaxRAMFraction=2 \n\u003c/span\u003e\u003cspan class=\"s2\"\u003e-XX:MetaspaceSize=512m \n\u003c/span\u003e\u003cspan class=\"s2\"\u003e-XX:MaxMetaspaceSize=8192m \n\u003c/span\u003e\u003cspan class=\"s2\"\u003e-XX:+HeapDumpOnOutOfMemoryError \n\u003c/span\u003e\u003cspan class=\"s2\"\u003e-XX:HeapDumpPath=/app/logs/dumpfile\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"64xE6mev\"\u003e通过设置 JVM 的启动参数，主要配置了堆内存、元空间和其他内存管理的参数，例：\u003c/p\u003e\u003cp data-pid=\"Q803rCJt\"\u003e设置\u003cb\u003eXms8192m\u003c/b\u003e  ：则JVM 初始堆内存为 8GB（8192 MB）。这意味着 JVM 在启动时会分配 8GB 的内存给堆(ps：广告系统的机器内存大小就是8GB)；\u003c/p\u003e\u003cp data-pid=\"f4hqKzeg\"\u003e设置\u003cb\u003eXmx8192m\u003c/b\u003e  ：则JVM 最大堆内存为 8GB。这意味着 JVM 允许的最大堆内存限制为 8GB；\u003c/p\u003e\u003cp data-pid=\"vLBNFgp6\"\u003e\u003cb\u003eMaxRAMFraction\u003c/b\u003e ：是 JVM 的一个内存管理选项，控制 JVM 最大堆内存的分配比例。默认情况下，JVM 可能会根据总内存大小来计算堆内存的大小。\u003c/p\u003e\u003cp data-pid=\"vYRB7G1p\"\u003e\u003cb\u003eMetaspaceSize\u003c/b\u003e ：Metaspace是用于存储类的元数据的区域，在JDK 8以后，JVM将类的元数据从永久代(PermGen)移到了 \u003c/p\u003e\u003cp data-pid=\"HI3_GSOO\"\u003eMetaspace中，Metaspace默认是动态扩展的，但可以通过，-XX:MetaspaceSize 来控制初始分配大小，这里设置了Metaspace 的初始大小为512MB。\u003c/p\u003e\u003cp data-pid=\"ue_twbDW\"\u003e\u003cb\u003eMaxMetaspaceSize\u003c/b\u003e : 这个参数指定 Metaspace 区域的最大大小为 8GB（8192MB）。当 JVM 加载类的数量和大小超出这个限制时，JVM 会抛出OutOfMemoryError 异常，表示类元数据存储区域已满。\u003c/p\u003e\u003cp data-pid=\"WRgcLqoD\"\u003e总结：通过调整最大堆内存，优化内存的使用并提高稳定性，尤其是应对高负载和内存溢出等问题。\u003c/p\u003e\u003ch3\u003e\u003cb\u003eKafka离线项目消费者速度跟不上生产者速度：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"-8hx6KJr\"\u003e 由于广告系统上报时并发量太大，kafka生产者发送消息的速率过高，\u003cb\u003e消费者的消费能力跟不上\u003c/b\u003e，会导致积压和延迟。生产者和消费者之间的速率差异可能会导致队列越来越大，最终可能导致消费者的内存溢出或系统崩溃，常见问题如下图所示：\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-fd338db7c6e56198948d0b14d27491aa_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1462\" data-rawheight=\"608\" data-original-token=\"v2-4d8c80e09008a83438ae19118aa07e93\" class=\"origin_image zh-lightbox-thumb\" width=\"1462\" data-original=\"https://pica.zhimg.com/v2-fd338db7c6e56198948d0b14d27491aa_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整Kafka fetch最⼤拉取记录数和最大字节数：\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"yZSUqXXr\"\u003e 在 Kafka 中，调整消费者（Consumer）拉取每个分区的最大记录数，主要是通过 max.poll.records（表示每次拉取时最多能拉取多少条记录，\u003cb\u003e默认是500\u003c/b\u003e） 参数进行配置，因为广告埋点应用场景需要处理更大的批量数据，可以调整这个值，同时根据每次拉取的最大字节数(\u003cb\u003efetch.max.bytes\u003c/b\u003e)。如果消息体比较大，可能会设置一个较小的 max.poll.records 来限制每次获取的记录数量，如下图所示，广告系统层面，根据Kafka本身配置(8C16G，1T磁盘)，将每次拉取次数改为\u003cb\u003e1000条\u003c/b\u003e，拉取最大字节数为1048576(说白了，就是1MB)，使用者可根据自己本身数据结构的差异，数据量级的大小，数据写入频次的高低调整这两个参数。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"c\"\u003e#fetch时每个分区最大拉取的字节数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003epartitionMaxFetch\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1048576\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"c\"\u003e#fetch时每个分区最大拉取记录数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003epollRecords\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e调整*离线项目*线程池大小：\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\n\n\n\n\n\n\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kd\"\u003efinal\u003c/span\u003e \u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e \u003cspan class=\"n\"\u003eTASK_EXECUTOR\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 核心线程数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003e50\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 最大线程数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003e100\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 多长时间把非核心空闲线程交还操作系统\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eTimeUnit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eMINUTES\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 阻塞队列，队列长度\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eLinkedBlockingQueue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003e10000\u003c/span\u003e\u003cspan class=\"o\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 设置线程名\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003enamedThreadFactory\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 拒绝策略，当提交任务数超过最大线程数+队列之和时触发\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eThreadPoolExecutor\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eCallerRunsPolicy\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"err\"\u003e​\u003c/span\u003e\n\u003cspan class=\"n\"\u003eTASK_EXECUTOR\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esubmit\u003c/span\u003e\u003cspan class=\"o\"\u003e(()\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ehandleEventList\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebatch\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eerror\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;【离线】事件处理失败, 列表大小：{}   events:{}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebatch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esize\u003c/span\u003e\u003cspan class=\"o\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eJSONUtil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eobj2Json\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e});\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"L42UxPwd\"\u003e 如上代码所示，构建了一个自定义的线程池，\u003cb\u003ecorePoolSize 和 maximumPoolSize 的设置需要根据系统的实际需求来调整\u003c/b\u003e。过多的线程可能导致上下文切换过于频繁，过少的线程可能导致任务处理延迟。使用 LinkedBlockingQueue 存放待处理的任务，队列的最大长度为 10000。如果线程池中的线程都在工作，任务会先进入这个队列，等待线程空闲后再执行，当队列已满，且线程数已达到 maximumPoolSize，新的任务将按照指定的拒绝策略处理采用 CallerRunsPolicy 拒绝策略，表示当线程池已满时，将由调用者线程执行该任务，而不是丢弃任务(为了保证数据的完整性)。当线程池中的线程超过corePoolSize，并且这些线程在 keepAliveTime 指定的时间内没有被重新使用，它们将被销毁。即，非核心线程会在空闲 1 分钟后被回收。线程池线程池执行任务时，通过submit方法，将任务被提交到线程池进行异步处理。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整ClickHouse批量插入的队列：\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003eKafka消息碎片化问题：\u003c/b\u003e\u003c/h3\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-5c65943835227eb1a493789e1280bec3_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2683\" data-rawheight=\"1280\" data-original-token=\"v2-711dfdbb11cc38a67a58725c2190ac99\" class=\"origin_image zh-lightbox-thumb\" width=\"2683\" data-original=\"https://pic2.zhimg.com/v2-5c65943835227eb1a493789e1280bec3_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e升级Kafka client版本\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-xml\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dependency\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;groupId\u0026gt;\u003c/span\u003eorg.apache.kafka\u003cspan class=\"nt\"\u003e\u0026lt;/groupId\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;artifactId\u0026gt;\u003c/span\u003ekafka-clients\u003cspan class=\"nt\"\u003e\u0026lt;/artifactId\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;version\u0026gt;\u003c/span\u003e2.2.0\u003cspan class=\"nt\"\u003e\u0026lt;/version\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/dependency\u0026gt;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"eNlDSplZ\"\u003e 在Kafka Clients 2.2.0中，生产者的批量处理机制得到了优化。生产者将多个小消息打包成更大的批次进行发送，这有助于减少由于发送多个小消息而造成的碎片化问题。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e配置参数修改：\u003c/b\u003e\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"nt\"\u003ebatchSize\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e32768\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003elinger\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ecompression\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003egzip\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003e批次大小配置\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"CG9LDbxz\"\u003e 可以通过配置\u003cb\u003ebatch.size\u003c/b\u003e来设置生产者每次批量发送的消息大小。通过合理增加batchSize，可以将多个小消息合并成一个更大的批次，避免过多的小碎片。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e生产者等待批量数据的时间\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"1VX0-o23\"\u003e 当设置linger.ms，来增加消息批量化的机会(间隔)，进一步减少碎片化。关于batchSize和Linger的参考内容：\u003ca href=\"https://link.zhihu.com/?target=https%3A//learn.conduktor.io/kafka/kafka-producer-batching/\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://\u003c/span\u003e\u003cspan class=\"visible\"\u003elearn.conduktor.io/kafk\u003c/span\u003e\u003cspan class=\"invisible\"\u003ea/kafka-producer-batching/\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e压缩类型配置\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"LL33XuYj\"\u003e 生产者可以通过compression来设置压缩类型，支持gzip、snappy、lz4等。\u003cb\u003e压缩速度snappy适当的压缩不仅可以减少磁盘空间占用，还能在网络传输时减少碎片。\u003c/b\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e离线项目重启会丢数据：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"HMLIMQL2\"\u003e 在Kubernetes (K8s) 环境中，\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.cnblogs.com/erlou96/p/13753824.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e@PreDestroy\u003c/a\u003e 可以与Kubernetes 提供的 \u003cb\u003e生命周期钩子\u003c/b\u003e（Lifecycle Hooks）一起使用，以确保在容器被关闭或重新启动时执行一些清理工作。这些钩子通常用于处理容器的退出操作，比如优雅关闭（Graceful Shutdown）、停止服务、释放资源等。\u003c/p\u003e\u003cp data-pid=\"k5aazUqS\"\u003eKubernetes 提供了以下两种主要的生命周期钩子：\u003c/p\u003e\u003col\u003e\u003cli data-pid=\"B5A_D94z\"\u003epreStop \u003cb\u003eHook\u003c/b\u003e：容器停止前执行的钩子。\u003c/li\u003e\u003cli data-pid=\"XRm6cez2\"\u003epostStart \u003cb\u003eHook\u003c/b\u003e：容器启动后的钩子。\u003c/li\u003e\u003c/ol\u003e\u003ch3\u003e\u003cb\u003e@PreDestroy 与 Kubernetes preStop Hook 的结合\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"X0D45NLH\"\u003e @PreDestroy 是 Spring 的 Bean 生命周期回调方法，而 Kubernetes 的 preStop 钩子是 Kubernetes 为容器生命周期提供的钩子。这两个机制是独立的，但可以协同工作，实现更细粒度的生命周期控制。\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"6GgYdPm7\"\u003ePreDestroy：确保在 Spring Bean 销毁时执行清理工作，如释放资源、停止线程等。\u003c/li\u003e\u003cli data-pid=\"f-c4t5N_\"\u003epreStop：确保在容器被终止之前执行清理工作，如停止后台进程、关闭数据库连接等。\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"L48I8vxB\"\u003e在 Kubernetes 中，当容器被终止时，preStop 钩子会被触发，Kubernetes 会等待钩子完成后再终止容器。这时，可以将 Spring 的 @PreDestroy 与 Kubernetes 的 preStop 配合使用，确保容器终止时有充足的时间进行清理工作。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e1.**如何结合使用 @PreDestroy 和 Kubernetes preStop Hook**\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e步骤：\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"8x_SdSAx\"\u003e在 Spring 应用中使用 @PreDestroy 注解进行资源清理。\u003c/li\u003e\u003cli data-pid=\"0g5LDEgn\"\u003e配置 Kubernetes 的 preStop 钩子，调用一个脚本或自定义的清理命令，确保容器停止前执行额外的操作。\u003c/li\u003e\u003cli data-pid=\"Ic9QVogn\"\u003eKubernetes 会在收到终止信号时，首先调用 preStop 钩子，然后\u003cb\u003e等待钩子完成后才终止容器\u003c/b\u003e。\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"Awe_ZWNf\"\u003e 在广告系统中，由于离线项目可能有重启的必要，并且实时消费数据量极大，如果处理不当，则会造成大量数据丢失，故在每个具体的消费者类中添加一个cleanup方法，上面标注PreDestroy注解，同时定义一个\u003cb\u003eAtomicBoolean(flag)\u003c/b\u003e变量，一旦触发cleanup方法，则将flag置为false，同时将剩余资源的队列(BlockingQueue对象)一次性一次性取出(drainTo方法)，放入具体的消费方法中，同时发送钉钉通知，告知用户已经优雅关闭完成。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"nd\"\u003e@PreDestroy\u003c/span\u003e\n\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ecleanup\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;【离线】优雅停机开始\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 暂停消费\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eflag\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eset\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 提交剩余队列\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eJSONObject\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebatch\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003equeue\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edrainTo\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebatch\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 至少尝试取出一个元素，或者直到队列空\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003ebatch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eisEmpty\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ehandleEventList\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebatch\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eerror\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;【离线】事件处理失败, events:{}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eJSONObject\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003etoJSONString\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebatch\u003c/span\u003e\u003cspan class=\"o\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 等待5秒\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003edingTalkMsgSend\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emsgSend\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=a6ddf9e618f5654836f2acac40bd74f0892b4072442769fc9a4ce14add4c21f0\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;优雅停机 已完成\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einfo\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;【离线】优雅停机结束\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e跨地域机房网络请求消耗大：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"_6m55K5s\"\u003e 跨地域机房网络请求消耗大通常是由于网络延迟、带宽限制和数据传输的跨地理位置引起的。这种情况常见于不同地区的数据中心之间进行频繁的网络请求时，通过公共互联网传输，可能会面临较高的延迟，尤其是涉及到长距离传输时。\u003c/p\u003e\u003cp data-pid=\"073DhzQv\"\u003e因广告平台请求数据被动对接方，且媒体对于延迟极高，虽然可以采用gzip压缩、Cassandra或TIDB等支持跨地域数据复制的分布式数据库，根据实际需求增加带宽，或者通过流量控制机制（如流量限速、负载均衡），但均不能解决延迟较高问题，具调研，媒体方广告机房在华南、华北、华东均有机房，其中，华东与华南请求量最大，我方服务器部署在华北北京机房，从华南请求跨地域打来就有20—60ms延迟，同时还要处理内部业务逻辑，故将机房分开部署至华东杭州、华南河源，分开部署后，超时率下降至0.1%以下。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003eNetty worker Group线程组不够，需要调整：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"DQWV3Ivp\"\u003e Netty线程模型采用“服务端监听线程”和“IO线程”分离的方式，与多线程Reactor模型类似。BossGroup负责事件的connect、accept，负责接收和连接服务，负责创建NioServerSocketChannel，并将服务转到其他的EventLoop上面；Worker Group负责事件的read，将client的请求进行解码、处理，并且处理后续事件(自定义业务handler)，并且处理队列中的任务。如果我们在实例化 NioEventLoopGroup 时, 如果指定线程池大小, 则nThreads就是指定的值, 反之是\u003cb\u003e处理器核心数\u003c/b\u003e \u003cb\u003e*\u003c/b\u003e \u003cb\u003e2\u003c/b\u003e （Runtime.getRuntime().availableProcessors() * 2）， 如果你知道你的应用会有很多并发连接并且每个连接会处理大量数据，你可能需要为 workerGroup 分配更多的线程，以避免瓶颈，从而提高处理能力；\u003c/p\u003e\u003cp data-pid=\"EiCgWxPf\"\u003e具体demo：广告系统使用500个线程数来处理业务线程代码。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * 绑定端口号\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eport\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * bossGroup\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kd\"\u003efinal\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eBIZ_BOSS_THREAD_SIZE\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRuntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetRuntime\u003c/span\u003e\u003cspan class=\"o\"\u003e().\u003c/span\u003e\u003cspan class=\"na\"\u003eavailableProcessors\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e2\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e * workerGroup\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003cspan class=\"kd\"\u003eprotected\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kd\"\u003efinal\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eBIZ_WORKER_THREAD_SIZE\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e500\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kd\"\u003efinal\u003c/span\u003e \u003cspan class=\"n\"\u003eEventLoopGroup\u003c/span\u003e \u003cspan class=\"n\"\u003eBOSS_GROUP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNioEventLoopGroup\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBIZ_BOSS_THREAD_SIZE\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kd\"\u003efinal\u003c/span\u003e \u003cspan class=\"n\"\u003eEventLoopGroup\u003c/span\u003e \u003cspan class=\"n\"\u003eWORKER_GROUP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNioEventLoopGroup\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBIZ_WORKER_THREAD_SIZE\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e结果\u003c/b\u003e\u003c/h2\u003e\u003ch2\u003e\u003cb\u003e单机能支撑的QPS\u003c/b\u003e\u003c/h2\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-7273b779c9c40e0b571cff1930e6ab34_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"832\" data-rawheight=\"206\" data-original-token=\"v2-d1846885fae83ee5321f3d934df25c94\" class=\"origin_image zh-lightbox-thumb\" width=\"832\" data-original=\"https://pica.zhimg.com/v2-7273b779c9c40e0b571cff1930e6ab34_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e内部业务处理时长采样(单位：ms)\u003c/b\u003e\u003c/h2\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-411250dfef01d48c8261344b85e8ffd3_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2316\" data-rawheight=\"1870\" data-original-token=\"v2-e16cb878ba78989e5e97efcb6545f7f4\" class=\"origin_image zh-lightbox-thumb\" width=\"2316\" data-original=\"https://pic4.zhimg.com/v2-411250dfef01d48c8261344b85e8ffd3_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e采样数据:\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"SWe_00KY\"\u003e以下内容为连续压测五分钟的平均响应时长数据曲线图\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-061453841f36c733a614a9e535f25c46_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"832\" data-rawheight=\"472\" data-original-token=\"v2-5b1ea2a1902665edcb6423d18faa233b\" class=\"origin_image zh-lightbox-thumb\" width=\"832\" data-original=\"https://pic3.zhimg.com/v2-061453841f36c733a614a9e535f25c46_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e日常服务器参数指标(已稳定)；\u003c/b\u003e\u003c/h2\u003e\u003ch3\u003e\u003cb\u003eCPU\u0026amp;内存\u0026amp;网络传输\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"oovtH_07\"\u003e ps：以下服务器属于测试服务器\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-e03cd2101348222de4d72473f8c73750_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"832\" data-rawheight=\"482\" data-original-token=\"v2-9b281fef658c64231afcd9a08422fb33\" class=\"origin_image zh-lightbox-thumb\" width=\"832\" data-original=\"https://pica.zhimg.com/v2-e03cd2101348222de4d72473f8c73750_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e\u003cb\u003e打开文件数\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e为什么要专注打开文件数这个指标？\u003c/b\u003e\u003c/h3\u003e\u003ch3\u003e\u003cb\u003e1.**支持高并发连接**\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"lWzC2CSC\"\u003e\u003cb\u003e每个网络连接都会占用一个文件描述符，默认限制可能会导致高并发服务器（对应广告系统的话就是Netty）无法处理超过限制数量的连接。\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"UyNxo4Si\"\u003e\u003cb\u003e增加文件描述符限制，允许服务支持更多并发连接，避免 \u0026#34;Too many open files\u0026#34; 错误。\u003c/b\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003e2. 提升系统稳定性\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"5AOMqX-H\"\u003e\u003cb\u003e文件描述符不足时，应用可能崩溃或拒绝新连接（服务端返回504 Gateway Timeout）。\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"Y-xe7WLi\"\u003e\u003cb\u003e增大限制可以避免因描述符耗尽导致的服务不可用。\u003c/b\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e\u003cb\u003e3. 支持资源密集型任务\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"8KYHPG_t\"\u003e\u003cb\u003e大规模文件读写（广告系统日志处理会将请求内容打印，每秒写入文件大小可以达到GB级别）会打开许多文件，同时占用大量文件描述符。\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"aqt7fHa-\"\u003e\u003cb\u003e修改限制后，应用程序可以安全地处理更多文件操作。\u003c/b\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-aad11bfd9796a299f1d16bb4d039622b_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"980\" data-rawheight=\"408\" data-original-token=\"v2-8ecfe22865bb281697803a54e486a858\" class=\"origin_image zh-lightbox-thumb\" width=\"980\" data-original=\"https://pic4.zhimg.com/v2-aad11bfd9796a299f1d16bb4d039622b_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"w4xxdj2d\"\u003e 增加文件描述符数量有助于提高并发能力，可以确保应用程序在处理大量并发连接时不会遇到文件描述符耗尽的问题，同时打开大量文件描述符，可能会增加内核的调度开销，导致性能问题。在调高文件描述符限制时，应该进行负载测试，确保没有过度使用系统资源(尤其是内存)，确保没有过度使用系统资源。\u003c/p\u003e\u003ch3\u003e\u003cb\u003e调整服务器Linux打开文件数大小\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"Njx6f9Ru\"\u003e查看Linux打开文件数大小：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003e# 查看当前进程的最大文件描述符数\nulimit -n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-1db2caadd9d225f1f643eeb16087b3b1_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1100\" data-rawheight=\"222\" data-original-token=\"v2-68eccdfe0a381f61f690f46a4683bb3d\" class=\"origin_image zh-lightbox-thumb\" width=\"1100\" data-original=\"https://pic4.zhimg.com/v2-1db2caadd9d225f1f643eeb16087b3b1_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003eclickhouse每秒峰值写入条数：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"Q5z22fKH\"\u003e 如下图峰值时，鼠标点位移动的的位置的每秒写入速度为242万每秒，最高时大概为270万每秒写入。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-e1c7f30bc229952b6d828b3ecb59545b_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1544\" data-rawheight=\"678\" data-original-token=\"v2-0fd9c7452e972d6e3d9d2aead9b36779\" class=\"origin_image zh-lightbox-thumb\" width=\"1544\" data-original=\"https://pic2.zhimg.com/v2-e1c7f30bc229952b6d828b3ecb59545b_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003eclickhouse日常写入：\u003c/b\u003e\u003c/h2\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-84bdf439e9b6dbf1830f8297ee797d06_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2094\" data-rawheight=\"1279\" data-original-token=\"v2-20c159c0f28ce0536148711030de44f3\" class=\"origin_image zh-lightbox-thumb\" width=\"2094\" data-original=\"https://pic3.zhimg.com/v2-84bdf439e9b6dbf1830f8297ee797d06_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e\u003cb\u003e总结：\u003c/b\u003e\u003c/h2\u003e\u003cp data-pid=\"qiP-aers\"\u003e 文中提到的技术以及拆分方案，很多技术点，都可以提升吞吐量及性能指标，列举如下：\u003c/p\u003e\u003ch3\u003e\u003cb\u003eIO多路复用\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"lsbvnaTT\"\u003e 管理更多的连接；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e线程池技术\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"giMMxSWT\"\u003e 挖掘多核cpu的潜力；\u003c/p\u003e\u003ch3\u003e\u003cb\u003ezero-copy\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"so-56883\"\u003e 减少用户态和内核态交互次数。如Linux中sendfile系统接口；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e磁盘顺序写\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"MIb6rgXR\"\u003e 降低寻址开销。消息队列或数据库日志，都会采用此技术；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e更好的协议\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"jp3LFAQG\"\u003e 网络传输上减少开支，如：自定义(物联网中使用较多)或二进制传输协议；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e分区\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"wcvyhnJ5\"\u003e 在存储系统中，分库分表都算分区；而微服务中，设计服务无状态，本身也可以理解为分区；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e批量传输\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"QLUYGwF3\"\u003e 典型数据库batch技术。很多中间件也可以使用，如消息队列、NoSql中；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e索引技术\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"rXrtdqMu\"\u003e 这里不是特指数据库的索引技术。而是我们设计切合业务场景的索引，提供使用率。例：kafka文件的存储，采用hack的索引技巧、clickhouse的索引，降低磁盘使用率等；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e空间换时间\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"LBukln5P\"\u003e 其实分区、索引技术、缓存技术都可归为这类。例如：我们使用倒排索引存储数据、使用多份数据多份节点提供服务等；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e网络连接的选型\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"43sZfCuq\"\u003e 长连接、短连接，可靠、非可靠协议等；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e拆包粘包\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"i-lAvH31\"\u003e batch、协议选型于此有些关系；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e高性能分布式锁\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"U3Hsi3dj\"\u003e 并发编程中，锁不可避免。尽量使用高性能的分布式锁，能cas乐观锁(注意锁膨胀)，尽量避免悲观锁；如果业务允许，尽量异步锁，不要同步阻塞锁，影响主线程执行效率，同时要减少锁竞争；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e柔性事务代替刚性事务\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"HMWXa1Ok\"\u003e 有些异常或者故障，试图通过重试是恢复不了的；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e最终一致性\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"Vxyzz2dW\"\u003e 如果业务场景允许，尽量保证数据最终一致性；\u003c/p\u003e\u003ch3\u003e\u003cb\u003e非核心业务异步化\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"P1IS79xg\"\u003e 把某些任务转化为另外一个队列(消息队列)，消费端可以批量、多消费者处理；\u003c/p\u003e\u003ch3\u003e\u003cb\u003edirect IO\u003c/b\u003e\u003c/h3\u003e\u003cp data-pid=\"ji52Yy3n\"\u003e 例如数据库等构建缓存机制的应用程序，直接使用directIO，放弃操作系统提供的缓存；\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"OUlL8pVc\"\u003e注：脱离业务场景，很多只能是纸上谈兵。但不了解手段，遇到场景也会懵逼。客户端请求形成的超级队列，后端如何分而治之、分散逐个击破，才是整体思想。在此过程中，我也沉淀了些许的经验和知识，这些宝贵的经验将在今后其他项目研发和迭代的过程中发挥重要的作用。系统架构设计和性能优化是一项持续的任务，随着业务的发展和技术的进步，我也将不断探索新的优化手段。它需要我们不断地发现问题，寻找解决方案，反复试验和优化。同时，性能优化也不是孤立的，它需要我们与业务、产品、开发等多个团队紧密合作，共同推动项目的进展。受限于篇幅及笔者的个人能力有限，本文仅通过若干实例分享了在高并发系统架构和服务性能优化方面取得的一些微小成果。如读者发现文章内有错误也请及时与我联系，我会虚心接受笔误或能力不足造成的错误，性能优化的重要性不仅仅体现在提高系统性能，降低资源使用上，更重要的是，它可以提升用户体验，支持业务的快速发展，实现公司的降本增效目标。笔者希望这篇文章能够对读者有所启发，无论是在处理类似的性能问题，还是在面临其他的技术挑战，都能从我们的经验中找到一些启示和灵感。\u003c/p\u003e","is_labeled":false,"visited_count":332,"thumbnails":["https://picx.zhimg.com/50/v2-972d2668e05d7f195197d948c7d58f76_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-13443f8cdd429425065f0e08472a59b2_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-c938fdc0d7bf4c54a23fcf946a879454_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-b4faa98340a15b6f96690cc95600bd8d_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-4554dabfe233bdafd78c5935291024a5_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-a0d7a34d93345639840fbbe2887e253a_720w.jpg?source=b6762063","https://pica.zhimg.com/50/v2-9cfe1b3ca4bf91d7314b6e09fbcff5ab_720w.jpg?source=b6762063","https://pica.zhimg.com/50/v2-23cb0d04a21db05d167d82cea52da504_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-8c64984d6a09a64d64fa330bc508e05f_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-fad07cd674fe22880a53fb99e5901a41_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-0254e641c74f497464dec203ce76bfc9_720w.jpg?source=b6762063"],"favorite_count":18,"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 1933339191103718717}","attached_info":"CpgNCM/msdasjrGktwEQBxoJMjYwOTQ3ODI0INnonsQGKBAwAkAvSiMKGFRTX1NPVVJDRV9XQVJNX1VQX0JPT1NUMhIBMBgAIAA6AEovCiRUU19TT1VSQ0VfV0FSTVVQX1RXT1RPV0VSX0VYUFYyX1RFWFQSATAYACAAOgBiIGQzMmM3ZDM3ODk1MDI5OWMwNDNjNDY1ZGM1Y2FjMGM2chMxOTMzMzM5MTkxMTAzNzE4NzE3qgEJcmVjb21tZW5kwgEgZWM0NGJkY2RkZTFjOTY4NTk3MWQ1MzQ1MTM0ZDgyNzTyAQoIDBIGTm9ybWFs8gEoCAoSJDhkNTI5MDU5LTJmYTAtNDM4OS1iYWJhLTQyMThlZDgwZGE2ZvIBBQgLEgE4ggIAiAKb3K7OhTOSAiBlYzQ0YmRjZGRlMWM5Njg1OTcxZDUzNDUxMzRkODI3NJoCAMoCFlNob3JJbnRlcmVzdFdlaWdodFJ1bGXKAhVVc2VyTGNuRXhpdFdlaWdodFJ1bGXKAhxCYXllc0ZpcnN0TGV2ZWxJc29sYXRpb25SdWxl2gIYVFNfU09VUkNFX1dBUk1fVVBfQk9PU1Qy6AID+gILTk9STUFMX0ZMT1eKAyAxYTg0NTRkYjA4ZWE0MmMyYjc2ZDBmOWRkNDRjZTExZZoDDQoCdjIQABoFb3RoZXKoA8wC2AMA6gMuY29udGVudFdhcm11cFR3b1Rvd2VyVHZwVGV4dEJvb3N0RXhwVjJSZWNhbGxlcvoDygcSDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFOi0IBBCYCxibCiIjdjItODY5MzBiNTJjMmQzMzg3NzIwZTc3Y2NhYjU4Njg3YmI6LQgCEIAVGOYNIiN2Mi01MGJiNmVlZDNlYWUzYWVjZTExMDVkNDM4NTUzMGFkMTotCAIQrg4YsA0iI3YyLTU3OTA2NDg1MjJkMmM4NTQ1NDdiYzU1M2E2Y2FlMDhjOi0IAxC1FBjIHyIjdjItYmZmY2FjOTlkNmRkZTM0ODJkMTE3ODM0NWE4OGU1MzM6LQgCEPoHGOIGIiN2Mi1jMmIzNzQwM2RmNzU0ZmQ5ZTc3YTdkOGFjZjlmYzNmYTotCAMQhgwYjAMiI3YyLTFlNDE0MzliNGY2ZGNlMjMyZTAwMTJmMGU1N2E3MzY2Oi0IAhDCGBj4DCIjdjItZWViYTY4MjM3N2ViYTE3ZTVjYzkxZWVhMTkzNDQ1MmM6LQgCEKoRGOwIIiN2Mi1jNDY1N2JmM2JjNDhjMGUxZjljNWY5NzNiZGNhODY2ODotCAIQlAwYkAIiI3YyLTczM2I5ZWJlYzMyMTQwNzIyZGMwODQ0Y2UxYzIwMTA5OiwIAxCgDBhQIiN2Mi1jYWE0ZmMzZTM3MjkwNTFhZjQ5MDM0MGNhNmNiZWE0ZDotCAIQtgsY4AQiI3YyLTRkOGM4MGUwOTAwOGE4MzQzOGFlMTkxMThhYTA3ZTkzOi0IAhD7FBiACiIjdjItNzExZGZkYmIxMWNjMzhhNjdhNTg3MjVjMjE5MGFjOTk6LQgCEMAGGM4BIiN2Mi1kMTg0Njg4NWZhZTgzZWU1MzIxZjNkOTM0ZGYyNWM5NDotCAIQjBIYzg4iI3YyLWUxNmNiODc4YmE3ODk4OWU1ZTk3ZWZjYjY1NDVmN2Y0Oi0IAhDABhjYAyIjdjItNWIxZWEyYTE5MDI2NjVlZGNiNjQyM2QxOGZhYTIzM2I6LQgDEMAGGOIDIiN2Mi05YjI4MWZlZjY1OGM2NDIzMWFmY2Q5YTA4NDIyZmIzMzotCAIQ1AcYmAMiI3YyLThlY2ZlMjI4NjViYjI4MTY5NzgwM2E1NGU0ODZhODU4Oi0IAhDMCBjeASIjdjItNjhlY2NkZmUwYTM4MWY2MWY2OTBmNDZhNDY4M2JiM2Q6LQgCEIgMGKYFIiN2Mi0wZmQ5Yzc0NTJlOTcyZDZlM2Q5ZDJhZWFkOWIzNjc3OTotCAIQrhAY/wkiI3YyLTIwYzE1OWMwZjI4Y2UwNTM2MTQ4NzExMDMwZGU0NGYzgAQAiAQAkgQGTm9ybWFsmgQBM6AEAKgEALAEALoEAmFpwgQDNDAwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA8AQA+QQAAABgVk6GP4EFAAAAAAAAAACJBd+/ys+nJ9M/kgUAmgUDZGZ0ogUDZGZ0sgUBMbkFAAAAAAAAAADQBQDgBQDoBQDwBQiQBgCgBi+oBgCSAi4KCTI2MDk0NzgyNBITMTkzMzMzOTE5MTEwMzcxODcxNxgHIgpJTUFHRV9URVhU","action_card":false}],"paging":{"is_end":false,"is_start":false,"next":"https://www.zhihu.com/api/v3/feed/topstory/recommend?action=down\u0026ad_interval=-10\u0026after_id=47\u0026desktop=true\u0026end_offset=47\u0026page_number=9\u0026session_token=d32c7d378950299c043c465dc5cac0c6","previous":"https://www.zhihu.com/api/v3/feed/topstory/recommend?action=pull\u0026ad_interval=-10\u0026before_id=47\u0026desktop=true\u0026end_offset=47\u0026page_number=9\u0026session_token=d32c7d378950299c043c465dc5cac0c6","totals":0},"fresh_text":"推荐已更新"}
