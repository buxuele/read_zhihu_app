{"data":[{"id":"96_1750899350.518","type":"feed","offset":96,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1750899350,"updated_time":1750899350,"target":{"id":"1913045114252694366","type":"answer","url":"https://api.zhihu.com/answers/1913045114252694366","author":{"id":"edb921f53534fb9ca75bd3d8412e43ac","url":"https://api.zhihu.com/people/edb921f53534fb9ca75bd3d8412e43ac","user_type":"people","url_token":"nancy-8-85","name":"Nancy","headline":"在知乎胡说八道的小女子","avatar_url":"https://picx.zhimg.com/50/v2-27d349c6b199ca1ae2833fa8fa5a9ec5_l.jpg?source=b6762063","is_org":false,"gender":0,"followers_count":419,"is_following":false,"is_followed":false},"created_time":1748885497,"updated_time":1748893651,"voteup_count":20,"thanks_count":0,"comment_count":42,"is_copyable":true,"question":{"id":"265114039","type":"question","url":"https://api.zhihu.com/questions/265114039","author":{"id":"3c04c22ecffad98c2535c80e44ff4376","url":"https://api.zhihu.com/people/3c04c22ecffad98c2535c80e44ff4376","user_type":"people","url_token":"shu-shu-68-97","name":"叶竹","headline":"否极泰来","avatar_url":"https://pic1.zhimg.com/50/v2-0f6a00419a363d9e0610717d48268572_l.jpg?source=b6762063","is_org":false,"gender":0,"followers_count":3361,"is_following":false,"is_followed":false},"title":"真实的硅谷是怎么样的？","created":1515118796,"answer_count":0,"follower_count":0,"comment_count":6,"bound_topic_ids":[54,99,520,2143,5231],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"thumbnail":"https://picx.zhimg.com/50/v2-29c79a09e77c92ad3a76fa97f9b8d5e2_720w.jpg?source=b6762063","excerpt":"本人来美两年，目前在旧金山，硅谷以前是什么样我不知道，现在的硅谷要不是有些高科技企业，真的连农村都不如 大部分人工资不高（税后都是7000，租一个单间2800刀，还得养车，生活费啥的～几乎所剩无几，失业就流浪街头）生活成本真的是非常高，还孤单无聊压力大，完全没有生活（白人圈子融不进，自己人又相互打压），只有牛马，毒品随处可买，所以在硅谷的那些看起来高大上光艳亮丽的北清才子，大部分不是飞叶，就是酒鬼，自私…","excerpt_new":"本人来美两年，目前在旧金山，硅谷以前是什么样我不知道，现在的硅谷要不是有些高科技企业，真的连农村都不如 大部分人工资不高（税后都是7000，租一个单间2800刀，还得养车，生活费啥的～几乎所剩无几，失业就流浪街头）生活成本真的是非常高，还孤单无聊压力大，完全没有生活（白人圈子融不进，自己人又相互打压），只有牛马，毒品随处可买，所以在硅谷的那些看起来高大上光艳亮丽的北清才子，大部分不是飞叶，就是酒鬼，自私…","preview_type":"default","preview_text":"","reshipment_settings":"allowed","content":"\u003cp data-pid=\"0f-KvMZJ\"\u003e本人来美两年，目前在旧金山，硅谷以前是什么样我不知道，现在的硅谷要不是有些高科技企业，真的连农村都不如\u003c/p\u003e\u003cp data-pid=\"otWv6Y4y\"\u003e大部分人工资不高（税后都是7000，租一个单间2800刀，还得养车，生活费啥的～几乎所剩无几，失业就流浪街头）生活成本真的是非常高，还孤单无聊压力大，完全没有生活（白人圈子融不进，自己人又相互打压），只有牛马，毒品随处可买，所以在硅谷的那些看起来高大上光艳亮丽的北清才子，大部分不是飞叶，就是酒鬼，自私自利，乱性～性格极端，中国经济不好在美国时骂中国～美国经济不好时也在美国骂中国～就跟前段时间上热搜那个哈佛女人一副尿性～怪中国不该跟美国硬刚～劝那些天天想着被搬运的妹子，还是国内找，这边不但不安全，整个环境非常差……千万不要听硅谷飞叶子自私男的谎言…………\u003c/p\u003e\u003cp data-pid=\"bPUGqzZO\"\u003e这是在硅谷吃的一碗麻辣烫70刀\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-29c79a09e77c92ad3a76fa97f9b8d5e2_1440w.jpg\" data-rawwidth=\"4080\" data-rawheight=\"3060\" data-size=\"normal\" data-original-token=\"v2-29c79a09e77c92ad3a76fa97f9b8d5e2\" data-default-watermark-src=\"https://pic4.zhimg.com/v2-627d7cb6fa7febcab6b1e7afce0de375_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"4080\" data-original=\"https://pic1.zhimg.com/v2-29c79a09e77c92ad3a76fa97f9b8d5e2_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"ZRCjG9td\"\u003e就这么三片牛肉\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-09015bbe5499c09f9336cab4291c1ba1_1440w.jpg\" data-rawwidth=\"1080\" data-rawheight=\"1920\" data-size=\"normal\" data-original-token=\"v2-09015bbe5499c09f9336cab4291c1ba1\" data-default-watermark-src=\"https://pic4.zhimg.com/v2-039177e5e8b6362f85762a899d649e03_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1080\" data-original=\"https://picx.zhimg.com/v2-09015bbe5499c09f9336cab4291c1ba1_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"Y2WJulTP\"\u003e现在的硅谷已经不是以前的硅谷～目前这边很多人都是进退两难～必竟当初出来时发了毒誓的～\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":4170,"thumbnails":["https://pica.zhimg.com/50/v2-29c79a09e77c92ad3a76fa97f9b8d5e2_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-565681ab903a3a84f045905b4bd453d5_720w.jpg?source=b6762063"],"favorite_count":10,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1913045114252694366}","attached_info":"CvwGCNDLncen1eXbsgEQBBoJNzMwMjg5MzU0IPm/98EGKBQwKkBgSigKHVRTX1NPVVJDRV9JTlRFUkVTVF9XT1JEX01FUkdFEgEwGAAgADoAWggyMDQ3NjkxOGIgZjNmMmRmNDZkM2M3NmEzMzMyZTU3OTZkMTkxOWExNTByEzE5MTMwNDUxMTQyNTI2OTQzNjaKAQkyNjUxMTQwMzmqAQlyZWNvbW1lbmTCASBlZGI5MjFmNTM1MzRmYjljYTc1YmQzZDg0MTJlNDNhY/IBCggMEgZOb3JtYWzyASgIChIkMWZlYzIxNWYtY2I5NS00MjRhLWE0ODYtZmMyNWNhZWFhOWIy8gEGCAsSAjE3ggIAiAL6t+/N+jKSAiBlZGI5MjFmNTM1MzRmYjljYTc1YmQzZDg0MTJlNDNhY5oCAMoCFlNob3JJbnRlcmVzdFdlaWdodFJ1bGXKAhZBY3Rpb25TaG9ySW50ZXJlc3RSdWxlygIbSW50ZXJhY3Rpb25TaG9ySW50ZXJlc3RSdWxlygIYUGVyaW9kSW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxlygIUQ29udGVudEFnZVdlaWdodFJ1bGXaAh1UU19TT1VSQ0VfSU5URVJFU1RfV09SRF9NRVJHRegCAvoCC05PUk1BTF9GTE9XigMgNGIwYThiYjZlYzMyNGI5Mjk1MTJmODA1ZWM1Y2E1NTiaAw0KAnYyEAAaBW90aGVyqAPKINgDAOoDIkludGVyZXN0V29yZE1lcmdlVjFOZXdQb29sUmVjYWxsZXL6A30SDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFOi0IBBDwHxj0FyIjdjItMjljNzlhMDllNzdjOTJhZDNhNzZmYTk3ZjliOGQ1ZTI6LQgEELgIGIAPIiN2Mi0wOTAxNWJiZTU0OTljMDlmOTMzNmNhYjQyOTFjMWJhMYAEAIgEAJIEBk5vcm1hbJoEATKgBACoBACwBAC6BAZtYW51YWzCBAMxNzDIBADSBA/mjqjojZDlt7Lmm7TmlrDYBADwBAD5BAAAAEC9oMY/gQUAAAAAAAAAAIkFT6NgMPmC0j+SBQCaBQNkZnSiBQNkZnSyBQExuQUAAAAAAAAAANAFAOAFAOgFAPAFEZAGAKAGZagGAZICLgoJNzMwMjg5MzU0EhMxOTEzMDQ1MTE0MjUyNjk0MzY2GAQiCklNQUdFX1RFWFQ=","action_card":false},{"id":"97_1750899350.195","type":"feed","offset":97,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1750899350,"updated_time":1750899350,"target":{"id":"1921206855365035577","type":"article","url":"https://api.zhihu.com/articles/1921206855365035577","author":{"id":"05cd5b470d6c37d7fc9a415899329467","url":"https://api.zhihu.com/people/05cd5b470d6c37d7fc9a415899329467","user_type":"people","url_token":"qing-yang-69-68-23","name":"清扬","headline":"一个正在准备考研的菜狗","avatar_url":"https://picx.zhimg.com/50/v2-03ace7f25b4379b8378fa4b6ef4c1be0_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":2,"is_following":false,"is_followed":false},"title":"C++ WorkFlow网络框架中的poller源码3w字分析","comment_permission":"all","created":1750831519,"updated":1750831870,"voteup_count":0,"voting":0,"comment_count":0,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"Workflow源码分析~前排提示，作者也是才刚学Workflow，整理了一下思路，欢迎大佬指正~ WorkFlow框架结构按照我的理解，我将workflow分为四层第一层：实现了poller对网络，定时等I/O多路复用，handler等线程池资源第二层：Comm系列类将对应资源包装，对外提供接口=================== kernel=====================第三层：SubTask定义了任务执行的基本单位，通过继承Comm获得底层资源调度接口，包装为完整任务=================== …","excerpt_new":"Workflow源码分析~前排提示，作者也是才刚学Workflow，整理了一下思路，欢迎大佬指正~ WorkFlow框架结构按照我的理解，我将workflow分为四层第一层：实现了poller对网络，定时等I/O多路复用，handler等线程池资源第二层：Comm系列类将对应资源包装，对外提供接口=================== kernel=====================第三层：SubTask定义了任务执行的基本单位，通过继承Comm获得底层资源调度接口，包装为完整任务=================== …","preview_type":"default","preview_text":"","content":"\u003ch3\u003eWorkflow源码分析~\u003c/h3\u003e\u003cp data-pid=\"X3FAnZg-\"\u003e前排提示，作者也是才刚学Workflow，整理了一下思路，欢迎大佬指正~\u003c/p\u003e\u003ch3\u003eWorkFlow框架结构\u003c/h3\u003e\u003ch3\u003e按照我的理解，我将workflow分为四层\u003c/h3\u003e\u003ch3\u003e第一层：实现了poller对网络，定时等I/O多路复用，handler等线程池资源\u003c/h3\u003e\u003ch3\u003e第二层：Comm系列类将对应资源包装，对外提供接口\u003c/h3\u003e\u003cp data-pid=\"sO-Yk7W5\"\u003e===================\u003cb\u003ekernel\u003c/b\u003e=====================\u003c/p\u003e\u003ch3\u003e第三层：SubTask定义了任务执行的基本单位，通过继承Comm获得底层资源调度接口，包装为完整任务\u003c/h3\u003e\u003cp data-pid=\"dfKpyPb_\"\u003e===================\u003cb\u003eInterface\u003c/b\u003e===================\u003c/p\u003e\u003ch3\u003e第四层：用户使用workflow流定义任务的执行规则\u003c/h3\u003e\u003cp data-pid=\"omcRXXAZ\"\u003e====================\u003cb\u003euser\u003c/b\u003e======================\u003c/p\u003e\u003ch3\u003e有关第四层的一些说明，请看这个链接\u003ca href=\"https://zhuanlan.zhihu.com/p/1920492996291429871\" class=\"internal\" target=\"_blank\"\u003eC++ Workflow网络框架中的Workflow源码分析 - 知乎\u003c/a\u003e\u003c/h3\u003e\u003cp data-pid=\"EJPe7lxH\"\u003e今天来讲讲底层poller的实现\u003c/p\u003e\u003cp data-pid=\"kUIKYk6W\"\u003e因为作者是在linux下编程，所以\u003cb\u003e只讲epoll的部分实现\u003c/b\u003e\u003c/p\u003e\u003ch3\u003ePoller对外暴露的接口有这些\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"c1\"\u003e//用到poller_params\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nf\"\u003epoller_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_params\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//用到poller_data\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_data\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_mod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_data\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//用到poller_t\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_start\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_del\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_set_timeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_add_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003etimespec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003etimer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                     \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_del_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etimer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_stop\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_destroy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"KKCIeIIX\"\u003e主要信息交互依靠三种结构体，我们一个个分析\u003c/p\u003e\u003ch3\u003epoller_create\u003c/h3\u003e\u003cp data-pid=\"VIudMi0_\"\u003e这个函数目的是为了创建一个poller_t资源\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nf\"\u003epoller_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_params\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//    分配一个指针数组 nodes_buf，用来存放每个被监视文件描述符对应的内部节点指针\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e//    大小为 params-\u0026gt;max_open_files，表示最多同时监视多少个 fd\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003enodes_buf\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ecalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enodes_buf\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epoller\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enodes_buf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enodes_buf\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nf\"\u003e__poller_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003enodes_buf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_params\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//此处就是 epoll_create(1);\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epfd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_create_pfd\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epfd\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//此处创建一个timer_fd,并添加进epoll,同时绑定到poller_t的参数中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_create_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//初始锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epthread_mutex_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//绑定nodess\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003enodes_buf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//等会告诉你怎么用\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//创建时间任务所需的红黑树和队列\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_tree\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erb_node\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_last\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//宏初始化链表\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003eINIT_LIST_HEAD\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eINIT_LIST_HEAD\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eno_timeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estopped\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//...创建失败的资源释放处理\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e\u003cb\u003enodes\u003c/b\u003e是什么？\u003c/h3\u003e\u003cp data-pid=\"HV2AYVsZ\"\u003e其实\u003cb\u003enodes就是一个维护指针的一维数组\u003c/b\u003e，\u003cb\u003e通过文件描述符fd直接映射到不同event事件结构的指针上\u003c/b\u003e。\u003cb\u003e为什么要用void*\u003ci\u003e？这其实是\u003c/i\u003eC语言实现多态的一种方式，这里最终指向的是一个\u003c/b\u003e__poller_node**结构。\u003c/p\u003e\u003ch3\u003epoller_t怎么维护timer_fd的？\u003c/h3\u003e\u003cp data-pid=\"X7jRTJTp\"\u003epoller通过维护\u003cb\u003e一个红黑树和一个队列共同维护定时事件\u003c/b\u003e，一个普通队列维护一个非定时事件，具体实现马上就讲\u003c/p\u003e\u003ch3\u003econtext和callback是什么？\u003c/h3\u003e\u003cp data-pid=\"dnhlG4Jk\"\u003e这个后面讲，主要是和Comm等类交互用的\u003c/p\u003e\u003cp data-pid=\"HyvGba_Y\"\u003e下面是结构体信息\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_params\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//create初始化的信息\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003epfd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimerfd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estopped\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003erb_root\u003c/span\u003e \u003cspan class=\"n\"\u003etimeo_tree\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003erb_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003erb_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etree_last\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"n\"\u003eno_timeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epthread_mutex_t\u003c/span\u003e \u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//暂未见到\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003epthread_t\u003c/span\u003e \u003cspan class=\"n\"\u003etid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003epipe_rd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003epipe_wr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ePOLLER_BUFSIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"sARiJaQz\"\u003e在讲解计时io前，我先讲一下workflow对于双向链表的设计\u003c/p\u003e\u003ch3\u003estruct list_head\u003c/h3\u003e\u003cp data-pid=\"mNSCYbQC\"\u003eworkflow对于双向链表的设计很有意思\u003c/p\u003e\u003cp data-pid=\"WH-qLHkt\"\u003e我们常用的\u003cb\u003e容器list，去存储数据，这种是非侵入式的设计\u003c/b\u003e，意思是你的数据的内容不需要被改变，但需要一个具体的对象来管理\u003c/p\u003e\u003cp data-pid=\"by7aa0o2\"\u003eworkflow的\u003cb\u003e双向链表的设计是侵入式\u003c/b\u003e的，写在数据结构中。\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eprev\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"1yhtT-eh\"\u003e这个结构体记录了它的前驱节点和后继节点\u003c/p\u003e\u003cp data-pid=\"NwmA5qFX\"\u003e下面这个宏能\u003cb\u003e通过指向链表元素的指针反推出结构体的指针\u003c/b\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"cp\"\u003e#define list_entry(ptr, type, member) \\\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e    ((type *)((char *)(ptr)-(unsigned long)(\u0026amp;((type *)0)-\u0026gt;member)))\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"NJzKO_AR\"\u003e举个例子\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003emy_node\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e         \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e  \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003emy_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n   \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e42\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n   \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eplist\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//参数分别是  1.指向链表的指针 2.该链表的类信息 3.该类链表成员函数的成员名\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003emy_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003erecovered\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elist_entry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplist\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003emy_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"s-WIXu7O\"\u003e原理\u003c/p\u003e\u003cp data-pid=\"lrSdgWC7\"\u003eunsigned long（\u0026amp;((type *)0)-\u0026gt;member)这是计算类成员在类中的偏移值\u003c/p\u003e\u003cp data-pid=\"kK6EgF12\"\u003e通过指向该成员的指针地址，减去偏移值，再进行强转就可以得到类的结构体指针\u003c/p\u003e\u003cp data-pid=\"wEimwtsE\"\u003e其他用法后面遇到了再讲\u003c/p\u003e\u003ch3\u003epoller_timer\u003c/h3\u003e\u003cp data-pid=\"rS7T_Q19\"\u003e有关timer的操作有三个\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"c1\"\u003e//给已注册的 I/O 句柄强加一个超时机制。\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_set_timeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//新加一个只做时间触发的“定时器”任务\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_add_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003etimespec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003etimer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                     \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//取消并清理一个定时器任务\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_del_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etimer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003epoller_add_timer\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_add_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003etimespec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003etimer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                     \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//非法数值\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etv_nsec\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etv_nsec\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1000000000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEINVAL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ememset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_data\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoperation\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePD_OP_TIMER\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ein_rbtree\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eremoved\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etv_sec\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//记录初始时间并在此基础上增加超时时间\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003eclock_gettime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCLOCK_MONOTONIC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_sec\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etv_sec\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_nsec\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etv_nsec\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_nsec\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1000000000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_nsec\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1000000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_sec\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etimer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epthread_mutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etv_sec\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e//超时任务\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003e__poller_insert_node\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"c1\"\u003e//非超时任务\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003elist_add_tail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eno_timeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003epthread_mutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"6fS3oFu1\"\u003e链表加入操作\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003elist_add_tail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                 \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__list_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eprev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"9xESHPIx\"\u003e节点插入操作\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_insert_node\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                                 \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 1) 找到链表的尾部节点（timeo_list 存的是按插入顺序的链表）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elist_entry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                     \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elist_empty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 2a) 如果链表现在是空的，直接把 node 加到链表头\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003elist_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 并把 end 重置为红黑树中最小的节点（tree_first）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erb_entry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__timeout_cmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 2b) 如果 node 的超时时间不早于当前链表尾（即较晚到期），\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"c1\"\u003e//     直接加到链表尾，链表保持 FIFO 顺序\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003elist_add_tail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 链表更新完毕，无需改 timerfd\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 2c) node 要比链表尾更早到期，插入红黑树（按超时排序）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003e__poller_tree_insert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 如果插入后它不是最早到期的节点，就不需要改 timerfd\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003erb\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 如果它成了最早到期的节点，就将链表头作为 end\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elist_entry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                         \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 3) 最后，如果这是早于当前最早的节点，\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e//    就调用 __poller_set_timerfd 调整底层 timerfd 的超时时刻\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003e__timeout_cmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e__poller_set_timerfd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimerfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                             \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"Ksyc4AeB\"\u003e这里就可以看明白poller_t为什么维护三个跟定时有关的操作了\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"jhscEXeJ\"\u003etimer_list 如果当前任务的时间大于timer_list最后一个节点，则将其加入到队列末尾\u003c/li\u003e\u003cli data-pid=\"4qY3R-ti\"\u003e不晚于timer_list队列最后一个节点就加入到红黑树中\u003c/li\u003e\u003cli data-pid=\"PidsP6Wk\"\u003e如果早于当前node节点，直接将该事件注册到epoll中\u003c/li\u003e\u003cli data-pid=\"fHpM2BGM\"\u003e非定时任务进入no_timer队列\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"2jK8XnWf\"\u003e\u003cb\u003e多了一个timer_list是为了优化一下红黑树的效率\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"o2I9rN-m\"\u003e\u003cb\u003e一个poller_t的timer_fd一定是注册的最早触发节点的时间\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"6UAiuMG9\"\u003e这里也有提到__poller_node\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e               \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 本次操作的状态：如 PD_OP_CONNECT、PD_OP_READ、PD_OP_TIMER 等\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e               \u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 如果 I/O 操作失败，记录 errno\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_data\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 用户在 poller_add()/add_timer() 时传入的业务数据\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                                \u003cspan class=\"c1\"\u003e// 包括 operation 类型、fd、SSL 上下文、用户 context 指针 等\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#pragma pack(1)\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eunion\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 用于“超时链表”——后插追加\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003erb_node\u003c/span\u003e    \u003cspan class=\"n\"\u003erb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// 用于“超时红黑树”——提前插入\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#pragma pack()\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e              \u003cspan class=\"n\"\u003ein_rbtree\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 标记当前节点是否已插入到红黑树中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e              \u003cspan class=\"n\"\u003eremoved\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 标记是否已经被移除（防止重复删除）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e               \u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// poller_wait() 返回的就绪事件掩码：POLLIN/POLLOUT/TIMEOUT\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003etimespec\u003c/span\u003e   \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 这个节点的绝对触发时刻（用于超时排序和 timerfd 编程）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 用于临时链接就绪结果，poller_poll 后会把它们串成一个列表\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"CaK5QOeS\"\u003e这里的这里的红黑树也是侵入式的，有关成员具体怎么用,以及传入参数中的context后面再说\u003c/p\u003e\u003ch3\u003epoller_del_timer\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_del\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"37pZtpHX\"\u003e这个函数就不多介绍了，无非是在链表中从链表删除，在红黑树中从红黑树删除\u003c/p\u003e\u003ch3\u003epoller_set_timeout\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_set_timeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"wH0geqg6\"\u003e也没有什么好介绍的，无非是前面poller_add需要构造一个poller_node再加入，现在是根据fd查找到对应的poller_node再加入\u003c/p\u003e\u003ch3\u003e不过需要注意的是poller_set_timeout是针对超时任务，poller_add_timer 是针对定时任务，前者fd\u0026gt;0，后者fd=-1，后面会有提到\u003c/h3\u003e\u003ch3\u003e题外话\u003c/h3\u003e\u003cp data-pid=\"FrlYaT6r\"\u003e有关定时器的实现除了使用timer_fd外，还可以通过懒堆和哈希表实现，不过最终解决方案是多层时间轮，这个插入和查询删除都是O(1)的，感兴趣的可以去学学\u003c/p\u003e\u003ch3\u003epoller调度\u003c/h3\u003e\u003ch3\u003e前面有关定时的操作都是一些开胃小菜，接下来看看poller是怎么调度这些注册的任务的\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_start\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epthread_t\u003c/span\u003e \u003cspan class=\"n\"\u003etid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epthread_mutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//创建管道\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_open_pipe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//后台开一个线程池，将__poller_thread_routine加入到线程池中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epthread_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_thread_routine\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estopped\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epipe_wr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epipe_rd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epthread_mutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estopped\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"OL4LthHK\"\u003e可以看到，这里是\u003cb\u003e启动了一个线程\u003c/b\u003e去执行\u003cb\u003e__poller_thread_routine()\u003c/b\u003e这个核心函数，同时你可能好奇__poller_open_pipe(poller)在干什么？我等等介绍，我们先来看\u003cb\u003epoller_thread_routine()\u003c/b\u003e这个函数\u003c/p\u003e\u003ch3\u003epoller_thread_routine()\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nf\"\u003e__poller_thread_routine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__poller_event_t\u003c/span\u003e \u003cspan class=\"n\"\u003eevents\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ePOLLER_EVENTS_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"n\"\u003etime_node\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ehas_pipe_event\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003enevents\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e__poller_set_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//选出最早时间点的node加入到epoll的timerfd事件中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//在linux下等价于epoll_wait，其他操作系统类似\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 获取当前epoll中的就绪事件数量，并写入event中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003enevents\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_wait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevents\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePOLLER_EVENTS_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eclock_gettime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCLOCK_MONOTONIC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etime_node\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//获取当前时间\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003ehas_pipe_event\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//pipe事件flag\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003enevents\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//获取当前epoll中的就绪事件的data也就是并转成__poller_node\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_event_data\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eevents\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//epoll的特殊处理,如果是timerfd任务，(void*)data 为0，管道事件为1\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//为1说明有管道事件\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ehas_pipe_event\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//根据事件的不同operation调用不同的事件处理,reactor模型\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoperation\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_READ\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_read\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_WRITE\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_write\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_LISTEN\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_listen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_CONNECT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_connect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_RECVFROM\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_recvfrom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_SSL_ACCEPT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_ssl_accept\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_SSL_CONNECT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_ssl_connect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_SSL_SHUTDOWN\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_ssl_shutdown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_EVENT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_event\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nl\"\u003ePD_OP_NOTIFY\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e__poller_handle_notify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//管道事件处理\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_pipe_event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_pipe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//定时任务处理\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003e__poller_handle_timeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etime_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e这个函数中，可以分为\u003cb\u003e三类事件\u003c/b\u003e\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"_r3-Jd1e\"\u003e\u003cb\u003etimerfd定时事件\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"lZexdPzh\"\u003e\u003cb\u003epipe管道事件\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"L49d_2C5\"\u003e\u003cb\u003ereactor事务驱动事件\u003c/b\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e定时事件\u003c/h3\u003e\u003ch3\u003e__poller_set_timer\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"n\"\u003etatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_set_timer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003etimespec\u003c/span\u003e \u003cspan class=\"n\"\u003eabstime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//比较队列首部和红黑树第一个节点哪个节点的超时时间最小用哪个\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003epthread_mutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003elist_empty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elist_entry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efirst\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erb_entry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003e__timeout_cmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eabstime\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eabstime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_sec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eabstime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_nsec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//得到最小的超时事时间后，将这个超时时间利用timerfd注册到epoll中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003e__poller_set_timerfd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimerfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eabstime\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epthread_mutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"E7eY5GKr\"\u003e在每次循环开始时设置，\u003cb\u003e将当前最早的一次事件的超时时间通过timerfd注册到epoll中\u003c/b\u003e\u003c/p\u003e\u003ch3\u003e__poller_handle_timeout\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_handle_timeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etime_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                                    \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003elist_head\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eLIST_HEAD\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epthread_mutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elist_for_each_safe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//... 遍历链表，将超过当前时间的事件加入到tmp队列中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etree_first\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//... 遍历红黑树，将超过当前时间的事件加入到tmp队列中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epthread_mutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003elist_for_each_safe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etimeo_list\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elist_entry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e//fd\u0026gt;0的任务记为超时任务，fd\u0026lt;0的任务记为定时任务\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eETIMEDOUT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_ERROR\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//某个任务超时了，标记为错误\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_FINISHED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//某个定时任务到期了，执行对应逻辑\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"zxFn6TgY\"\u003e红黑树和队列都是有序的，将所有超时任务从队列中弹出然后加入到pos队列中，然后\u003cb\u003e根据fd的值区分超时和定时任务\u003c/b\u003e，并设置对应的状态，最后通过回调反交给上一层\u003c/p\u003e\u003ch3\u003e这里值得注意的是,poller是怎么组织超时事件并且转交给上层的\u003c/h3\u003e\u003cp data-pid=\"xlfGCZ8M\"\u003e你可能会疑惑这个句话的意思\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"9b7AJUZt\"\u003e为什么要free node的res?node的res是什么？\u003c/p\u003e\u003cp data-pid=\"nKBgUI2n\"\u003e来看一下__poller_node的结构\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_node\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_data\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#pragma pack(1)\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eunion\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003elist_head\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003erb_node\u003c/span\u003e \u003cspan class=\"n\"\u003erb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#pragma pack()\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ein_rbtree\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003eremoved\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etimespec\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"hd9SlKMN\"\u003e这里\u003ccode\u003e#pragma pack(n)\u003c/code\u003e表示使用n字节对齐，\u003ccode\u003epack()\u003c/code\u003e是结束标志，了解下就好\u003c/p\u003e\u003ch3\u003e我们关心的是\u003ccode\u003eres\u003c/code\u003e，这是一个指向同类\u003ccode\u003e__poller_node\u003c/code\u003e的指针，有什么用呢，为什么要\u003ccode\u003efree\u003c/code\u003e，在什么时候会用到？\u003c/h3\u003e\u003cp data-pid=\"j6rWXnt0\"\u003e\u003ccode\u003eres\u003c/code\u003e 是用来承载「\u003cb\u003e操作结果\u003c/b\u003e」的临时 \u003ccode\u003e__poller_node\u003c/code\u003e 实例。\u003c/p\u003e\u003cp data-pid=\"7po4YGr0\"\u003e对于那些一次 I/O 调用可能产生\u003cb\u003e多次\u003c/b\u003e用户回调的操作（消息拼接、\u003ccode\u003eaccept\u003c/code\u003e、\u003ccode\u003erecvfrom\u003c/code\u003e、\u003ccode\u003eeventfd\u003c/code\u003e、\u003ccode\u003enotify\u003c/code\u003e），框架先给 \u003ccode\u003eres\u003c/code\u003e 分配一个结果节点，每次把它当成 \u003ccode\u003epoller_result\u003c/code\u003e 回调给用户，然后再 \u003ccode\u003emalloc\u003c/code\u003e 新的 \u003ccode\u003enode-\u0026gt;res\u003c/code\u003e，直到全部数据或事件处理完毕。\u003c/p\u003e\u003cp data-pid=\"Vi0RaDi7\"\u003e前面提到了，有一个函数是\u003ccode\u003epoller_set_timeout\u003c/code\u003e,用于给某个fd事件设置超时时间，\u003ccode\u003eres\u003c/code\u003e对上层是透明的，所以避免资源泄漏的情况，这里需要\u003ccode\u003efree\u003c/code\u003e保证资源的回收，具体\u003ccode\u003eres\u003c/code\u003e的操作后面会讲到\u003c/p\u003e\u003cp data-pid=\"HsSmKvXC\"\u003e我们接下来看这个函数\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"2DkWNNLI\"\u003e这干了什么？poller的callback指的什么？context又是什么？\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eCommunicator\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_poller\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_threads\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_params\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e     \u003cspan class=\"o\"\u003e=\u003c/span\u003e   \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003esysconf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_SC_OPEN_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e           \u003cspan class=\"o\"\u003e=\u003c/span\u003e   \u003cspan class=\"n\"\u003eCommunicator\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"c1\"\u003e//这里传递了回调信息\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgqueue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emsgqueue_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e16\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//这里传递了context信息\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003empoller\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003empoller_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_threads\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003empoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003empoller_start\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003empoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003empoller_destroy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003empoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003emsgqueue_destroy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//poller真正执行的回调，意思是将信息加入到一个msgqueue_t中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eCommunicator\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emsgqueue_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emsgqueue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emsgqueue_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emsgqueue_put\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emsgqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"jWwrWMeu\"\u003e可以看到，\u003ccode\u003eCommunicator\u003c/code\u003e这个类管理了\u003ccode\u003epoller\u003c/code\u003e的创建，并提供了\u003ccode\u003ecallback\u003c/code\u003e和\u003ccode\u003econtext\u003c/code\u003e信息\u003c/p\u003e\u003cblockquote data-pid=\"LEDQyw5R\"\u003e context目的\u003c/blockquote\u003e\u003cp data-pid=\"5HnWrZvE\"\u003e按照我的理解，\u003ccode\u003econtext\u003c/code\u003e是上下文的意思，这里指的是处理回调信息的结构体，是\u003cb\u003e为了可扩展和修改考虑的\u003c/b\u003e，如果框架后面\u003cb\u003e需要切换处理数据的结构体\u003c/b\u003e，可以修改\u003ccode\u003eCommunicator\u003c/code\u003e传入的\u003ccode\u003econtext\u003c/code\u003e即可，不需要关心底层poller的实现，\u003cb\u003e实现了解耦\u003c/b\u003e\u003c/p\u003e\u003cblockquote data-pid=\"hyQ_7Uio\"\u003e mpoller\u003c/blockquote\u003e\u003cp data-pid=\"uiVwgWRt\"\u003e这里出现的\u003ccode\u003empoller\u003c/code\u003e看名字可以看出来，是一个管理多个\u003ccode\u003epoller\u003c/code\u003e的结构体，怎么做的后面具体会讲\u003c/p\u003e\u003cblockquote data-pid=\"BuR2PigB\"\u003e msgqueue_t\u003c/blockquote\u003e\u003cp data-pid=\"Ml21iLtm\"\u003e\u003cb\u003e\u003ccode\u003emsgqueue_t\u003c/code\u003e是一个消息队列，可以看出来，底层事件触发后，\u003ccode\u003epoller_t\u003c/code\u003e执行回调，将结果加入到\u003ccode\u003emsgqueue_t\u003c/code\u003e中，这里透露一下，\u003ccode\u003emsgqueue_t\u003c/code\u003e其实是用来配合线程池的，这里就相当于生产者生产数据，线程池会读取这个\u003ccode\u003emsgqueue_t\u003c/code\u003e进行对应的处理，这样就实现了异步处理的方式，\u003ccode\u003epoller_t\u003c/code\u003e只负责将消息转交给上层，对于消息如何处理并不关心。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"dsNQexP1\"\u003e\u003ccode\u003emsgqueue_t\u003c/code\u003e和传统的消息队列不一样，一般的消费队列是单个链表实现的，区别是有锁无锁。无锁还行，但是有锁可能会产生消费者和生产者都去锁这个消费队列，造成消费者和生产者的锁竞争。\u003cb\u003e\u003ccode\u003emsgqueue_t\u003c/code\u003e是通过两个队列进行实现的，分为生产者和消费者队列\u003c/b\u003e，当生产者消费完了它的队列，会去交换生产者队列，将空队列给生产者，这样有效避免了锁竞争。具体实现如果后面有时间会说下线程池的实现顺便说下这个(又挖坑了)\u003c/p\u003e\u003ch3\u003e管道事件\u003c/h3\u003e\u003cp data-pid=\"7ea14NuN\"\u003e前面在创建poller_t时候提到了\u003ccode\u003e__poller_open_pipe\u003c/code\u003e函数没讲，现在来看看\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_open_pipe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003epipefd\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epipe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epipefd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_add_fd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epipefd\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eEPOLLIN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epipe_rd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epipefd\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epipe_wr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epipefd\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epipefd\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epipefd\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//linux下创建epoll_event，并加入到epoll中进行监听\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_add_fd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                                  \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eepoll_event\u003c/span\u003e \u003cspan class=\"n\"\u003eev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eevents\u003c/span\u003e     \u003cspan class=\"o\"\u003e=\u003c/span\u003e   \u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e       \u003cspan class=\"o\"\u003e=\u003c/span\u003e   \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e   \u003cspan class=\"n\"\u003edata\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eepoll_ctl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEPOLL_CTL_ADD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eev\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"Hc3U2SLu\"\u003e这里介绍一下\u003cb\u003epipe\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"xWmyJTNu\"\u003e\u003cb\u003epipe是linux系统的一种通信方式\u003c/b\u003e，我们知道linux对于资源使用fd进行标识，你往往可以\u003cb\u003e通过一个fd确定一个资源\u003c/b\u003e，所以fd也可以称为一个资源的句柄,资源的句柄是保存到操作系统中的，所以不同进程之间如果知道某个fd具体代表了什么资源，就可以根据fd进行资源的处理。\u003cb\u003epipe会创建两个资源，一个是pipe[0]读端，一个是pipe[1]写端\u003c/b\u003e。你可以通过\u003cb\u003e写端fd指向的资源往里面写\u003c/b\u003e，\u003cb\u003e然后通过读端fd拿到这个资源进行读\u003c/b\u003e，这样就实现了通信，且这是\u003cb\u003e发生在内存中\u003c/b\u003e的，一般内存中的文件会在/dev/temfs下。\u003c/p\u003e\u003cp data-pid=\"F4R0IlLG\"\u003e补充：\u003cb\u003epipe是匿名管道\u003c/b\u003e，这意味着\u003cb\u003e你只知道fd,但是不可以通过其他标识找到这个fd\u003c/b\u003e,这也意味着\u003cb\u003e你只能在同一个程序中,（因为fork可以知道父进程信息,写时复制原理）拿到这个fd并且知道这个fd是什么意思\u003c/b\u003e，当然，你也可以\u003cb\u003e通过将fd写入某个文件，另一个进程读取文件获取这个fd，也可以进行通信，但是这就涉及到了磁盘io\u003c/b\u003e，所以解决这个问题，\u003cb\u003e可以通过有名称的pipe\u003c/b\u003e，原理就是\u003cb\u003e给某个资源描述如加一个别名\u003c/b\u003e,因为fd是随机分配不知道具体值，可以通过一个具体的描述信息，同样也是\u003cb\u003e在/dev/temfs下保存\u003c/b\u003e，这是内存中的，\u003cb\u003e别的进程就可以根据这个别名找到这个fd并进行资源的交互\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"WE3k0wOl\"\u003e通过我的一顿瞎扯相信你已经明白了工作原理，就是\u003cb\u003e注册\u003ccode\u003epipe[0]\u003c/code\u003e(读端)到\u003ccode\u003eepoll\u003c/code\u003e\u003c/b\u003e嘛，到时候进程内有什么通知就会使用\u003ccode\u003epipe[1]\u003c/code\u003e进行写入通知，然后我就可以在epoll_wait中拿出来，那具体干什么呢？有啥用？\u003c/p\u003e\u003cp data-pid=\"zKIolfeB\"\u003e我们来看在epoll_wait中对于管道事件的处理函数\u003c/p\u003e\u003ch3\u003e__poller_handle_pipe\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_handle_pipe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estop\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epipe_rd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePOLLER_BUFSIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estop\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003estop\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"QgOZXZEf\"\u003e只看读端肯定是弄不明白逻辑的，我们再来看看一个写端\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003epoller_del\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estopped\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emax_open_files\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e?\u003c/span\u003e \u003cspan class=\"nl\"\u003eEBADF\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEMFILE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epthread_mutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//从poller_t的红黑树和链表中删除\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ein_rbtree\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e__poller_tree_erase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elist_del\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//从epoll中删除\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003e__poller_del_fd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_DELETED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//标记为删除\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003estopped\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estopped\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003estopped\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eremoved\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//========重点在这=========\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"c1\"\u003e//将node的地址写入管道中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epipe_wr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eENOENT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epthread_mutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estopped\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-!\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e可以看出来，这里的删除只是将\u003ccode\u003enode从poller\u003c/code\u003e管理的资源中移除，但是并没有释放资源，而是通过管道写入事件，让\u003ccode\u003eepoll_wait\u003c/code\u003e结束后进行\u003ccode\u003e__poller_handle_pipe\u003c/code\u003e处理，进行资源的释放。\u003c/h3\u003e\u003cblockquote data-pid=\"FviHPKSh\"\u003e 如果你写过相关的epoll的网络框架，相信你也踩过这种资源释放的坑，\u003cb\u003e这里非常值得注意\u003c/b\u003e。\u003c/blockquote\u003e\u003ch3\u003e举个例子，上层需要关闭某个fd的监听，但是此时这个fd同时在接收数据，wf是多线程框架，意味着这个\u003ccode\u003epoller_del\u003c/code\u003e是在不同线程执行，这个函数只是将它从\u003ccode\u003eepoll\u003c/code\u003e中移除了，相当于取消监听，但是这个fd资源可能已经被接收，在\u003ccode\u003e__poller_thread_routine\u003c/code\u003e中的for循环中进行相关的逻辑处理，如果你此时释放了资源，那么正在处理资源突发被释放掉了，这就会导致访问野指针的问题，喜提一个Segment fault~\u003c/h3\u003e\u003ch3\u003e如果加入管道事件会怎么样？这里的问题是，操作删除的线程和\u003ccode\u003eepoll\u003c/code\u003e线程并不是同一个线程，那我把它两放到同一个线程不就好了吗？对啊，wf的设计就是这么巧妙，通过管道通知\u003ccode\u003eepoll\u003c/code\u003e进行资源回收的处理，这不就在同一个线程中处理且有先后顺序了吗？就这样在for循环结束后调用\u003ccode\u003e__poller_handle_pipe\u003c/code\u003e统一进行资源的回收！\u003c/h3\u003e\u003cp data-pid=\"A7IyBWpW\"\u003e这里说明一下，上层使用的资源和\u003ccode\u003epoller_t\u003c/code\u003e中的资源是两码事，\u003ccode\u003epoller_t\u003c/code\u003e的职责是将接收到的数据转发给上层，上层进行整合。poller_t中的res是poller_t是正在接收的数据,可能是网络io，也可能是文件读写，正在接收，但没有接受完的一种状态。\u003c/p\u003e\u003ch3\u003e事件驱动\u003c/h3\u003e\u003cp data-pid=\"HCAeJNfd\"\u003e分析完了定时事件和管道事件，我们来看看核心的事件驱动\u003c/p\u003e\u003cp data-pid=\"NWJKvsau\"\u003e事件的种类非常多\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"c1\"\u003e//tcp\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_read\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003e__poller_handle_write\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//server\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_listen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//connect\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_connect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//udp\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_recvfrom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//ssl\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_ssl_accept\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003e__poller_handle_ssl_connect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003e__poller_handle_ssl_shutdown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//一些上层设计\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_event\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003e__poller_handle_notify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"8-GWG04N\"\u003e主要讲常见的tcp处理\u003c/p\u003e\u003ch3\u003e__poller_handle_read\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_handle_read\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                                 \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"n\"\u003enleft\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003essl\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e//正常从内核协议栈缓冲区读\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//将数据写入poller_t的缓冲区中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePOLLER_BUFSIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eEAGAIN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"c1\"\u003e//ssl加密读\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSSL_read\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003essl\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePOLLER_BUFSIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_handle_ssl_error\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//将数据从poller_t的buf中转移到poller_node_t对应的缓冲区中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enleft\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_append_message\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                \u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eremoved\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_remove_node\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//读完处理\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_FINISHED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_ERROR\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"QE0R5voT\"\u003e上面函数只是将从\u003ccode\u003epoller_buf\u003c/code\u003e中接收数据，然后转交给\u003ccode\u003epoller_node\u003c/code\u003e,核心函数是\u003ccode\u003e__poller_append_message\u003c/code\u003e，我们先来看这个函数再来解释\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_append_message\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                                   \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                                   \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epoller_message_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 一次新的帧信息：创建用户消息对象 + 结果节点\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 给一次完整消息的回调结果分配一个新节点\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 调用用户提供的 create_message()，生成一个空的可 append 对象\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003emsg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_message\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e          \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 继续复用上次分配的 res\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 调用用户的 append() 接口，把 buf[0..*n) 追加到 msg 中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 返回 \u0026gt;0 表示“一条完整消息”已经拼装完毕,= 0表示没有解析完成，\u0026lt; 0表示错误\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 填充结果节点的通用字段\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_SUCCESS\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 回调给业务：payload 在 res-\u0026gt;data 中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 清理，下一次新消息再重新创建\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e          \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"rT6luH8R\"\u003e这里又多出了几个没见过的\u003ccode\u003epoller_message_t\u003c/code\u003e,\u003ccode\u003epoller_data\u003c/code\u003e\u003c/p\u003e\u003cp data-pid=\"QINBT3Yu\"\u003e先看看\u003ccode\u003e__poller_message\u003c/code\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__poller_message\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_message_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"fvEY_kUL\"\u003e这里\u003ccode\u003eappend\u003c/code\u003e可以理解为类似虚函数的c的实现方式，也是运行时通过指针绑定对应的函数，因为是c文件，所以没有虚函数\u003c/p\u003e\u003cp data-pid=\"nP8I-VuD\"\u003e\u003ccode\u003edata[0]\u003c/code\u003e在编译时，\u003ccode\u003esizeof(struct __poller_message)\u003c/code\u003e 并不会算上 \u003ccode\u003edata\u003c/code\u003e 的长度，只包含到 \u003ccode\u003eappend\u003c/code\u003e 指针为止。实际上它相当于告诉编译器：这后面还会紧跟一段「用户自定义长度」的数据。\u003c/p\u003e\u003cp data-pid=\"NkuOTW4V\"\u003e例如\u003ccode\u003estruct __poller_message *m =malloc(sizeof(*m) + extra);\u003c/code\u003e，这样 \u003ccode\u003em-\u0026gt;data[0]\u003c/code\u003e、\u003ccode\u003em-\u0026gt;data[1]\u003c/code\u003e … \u003ccode\u003em-\u0026gt;data[N-1]\u003c/code\u003e 都是合法的\u003c/p\u003e\u003cp data-pid=\"cE0FXaSe\"\u003e关于\u003ccode\u003epoller_data\u003c/code\u003e,由用户定义\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_data\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//...state\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eoperation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//iov是一个数组，每个节点存放一个指针和指针大小，一种离散的链式缓冲区设计,操作系统支持\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSSL\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003essl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//用户实现的方法，只对应一种模式\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eunion\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epoller_message_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_message\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epartial_written\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eaccept\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esocklen_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003erecvfrom\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esocklen_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                          \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enotify\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//用户回调执行的数据结构载体\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eunion\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//读\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003epoller_message_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//写\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eiovec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite_iov\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//事件\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"Qnv7Udiu\"\u003e来个具体的append理解一下\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eHttpMessage\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehttp_parser_append_message\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecur_size\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecur_size\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esize_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEMSGSIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"nf\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEBADMSG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//这是个状态机函数，用于解析http请求\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ehttp_parser_append_message\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                               \u003cspan class=\"n\"\u003ehttp_parser_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//...\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003ememcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgbuf\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgsize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//这里是复制\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e//...\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e__parse_message_header\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgbuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgsize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//...    \n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e__parse_chunk\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgbuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emsgsize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//...\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eparser\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecomplete\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"lPTUdYZk\"\u003e可以看到，ret返回值有三种状态,同时\u003cb\u003e\u003ccode\u003epoller_t的buf\u003c/code\u003e是通过\u003ccode\u003ememcpy\u003c/code\u003e进行传递的\u003c/b\u003e，进行了再一次的拷贝到解析器中\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"ZAuriuSZ\"\u003e\u003ccode\u003eret \u0026lt; 0\u003c/code\u003e 帧解析错误\u003c/li\u003e\u003cli data-pid=\"VQGqIp2j\"\u003e\u003ccode\u003eret = 0\u003c/code\u003e 帧解析成功但没有解析完\u003c/li\u003e\u003cli data-pid=\"IfaZ4nKx\"\u003e\u003ccode\u003eret = 1\u003c/code\u003e 帧解析完毕\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003eres是什么？\u003c/h3\u003e\u003cp data-pid=\"7W8SOVBC\"\u003e可以看出来，poller_node并不是真正接收数据的，而是创建了一个res去接收数据，所以说\u003c/p\u003e\u003ch3\u003e在读事件中node是元数据存储，res是真正保存相关信息的节点，对于多次io,res的信息是不完整的，一旦信息完整就会发给上层，并且从node中移除。\u003c/h3\u003e\u003cp data-pid=\"E9I7IKHN\"\u003e看到这相比你已经搞懂为什么要\u003cb\u003e\u003ccode\u003efree(node-\u0026gt;res)\u003c/code\u003e\u003c/b\u003e了吧,因为数据还没有完全处理完呀,但是又分配了内存,任务终止只能丢弃了！\u003c/p\u003e\u003cp data-pid=\"mjlDNgai\"\u003e明白了这些，\u003ccode\u003e__poller_append_message\u003c/code\u003e想必就容易理解了\u003c/p\u003e\u003cp data-pid=\"fboPFtPU\"\u003e\u003ccode\u003e__poller_append_message\u003c/code\u003e中流程如下\u003c/p\u003e\u003col\u003e\u003cli data-pid=\"HOa7r4_4\"\u003e如果这是一个新的帧信息，分配\u003ccode\u003eres\u003c/code\u003e并根据\u003ccode\u003enode-\u0026gt;data\u003c/code\u003e函数创建\u003ccode\u003emessage\u003c/code\u003e。\u003c/li\u003e\u003cli data-pid=\"c1GUGutx\"\u003e\u003ccode\u003eres\u003c/code\u003e调用\u003ccode\u003eappend\u003c/code\u003e方法，将\u003ccode\u003epoller_t\u003c/code\u003e缓冲区的信息读进\u003ccode\u003emessage\u003c/code\u003e\u003c/li\u003e\u003c/ol\u003e\u003cul\u003e\u003cli data-pid=\"FAmq7KaX\"\u003e\u003cb\u003e结果返回0\u003c/b\u003e表示该帧没有解析完，保留res，等待下一次读时间\u003c/li\u003e\u003c/ul\u003e\u003col\u003e\u003cli data-pid=\"dHe0zyZN\"\u003e\u003cb\u003e结果返回1\u003c/b\u003e表示该帧解析完毕，调用对应的回调处理，同时将\u003cb\u003e\u003ccode\u003enode-\u0026gt;res\u003c/code\u003e\u003c/b\u003e置空\u003c/li\u003e\u003c/ol\u003e\u003ch3\u003e__poller_handle_read\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003e__poller_handle_write\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__poller_node\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                                  \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// iov 指向还未写完的 iovec 数组\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiovec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite_iov\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 累计本次调用写入的总字节数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 本次 writev 或 SSL_write 返回的写入字节数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"n\"\u003enleft\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 本次调用最多提交给 writev 的 iovec 段数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果 writev 失败，ret 用来记录返回值\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 只要还有未写完的 iovec，就继续尝试写\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003essl\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 非 SSL 情况，直接用 writev 批量写\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// writev 最多一次提交 IOV_MAX 段\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eIOV_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eIOV_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 调用 writev，把前 iovcnt 段数据写到 socket\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ewritev\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// EAGAIN：非阻塞 socket 暂时写满，返回 0 表示“稍后再试”\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"c1\"\u003e// 其它错误：返回 -1 表示“写失败”\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eerrno\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eEAGAIN\u003c/span\u003e \u003cspan class=\"o\"\u003e?\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// SSL 情况\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 累加本次实际写入的总字节数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003enleft\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 根据 nleft 把写入的字节从 iov 数组中“消费”掉\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 当前这一段 iov 完全写出\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003enleft\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                   \u003cspan class=\"c1\"\u003e// 扣除已写长度\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_base\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_base\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// 移动基址到末尾\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                                 \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                         \u003cspan class=\"c1\"\u003e// 长度清零\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                                    \u003cspan class=\"c1\"\u003e// 跳到下一个 iov\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                     \u003cspan class=\"c1\"\u003e// 未写段数减一\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 只写了当前段的一部分\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e                \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_base\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_base\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003enleft\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e  \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003enleft\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 本次写入字节已全部消耗，退出循环\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 更新 node 中的 write_iov 为下次要写的起点\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite_iov\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 如果还有未写完的数据，且本次没有遇到写失败\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 如果这次一字节都没写，则直接返回，等待可写事件\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 调用用户可选的“部分写入”回调，返回 \u0026gt;=0 表示由用户处理剩余逻辑\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epartial_written\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 到这里，要么 iovcnt==0（全部写完），要么写失败（ret\u0026lt;0）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 先把这个 node 从 epoll/定时器中移除\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e__poller_remove_node\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 根据剩余 iovcnt 判断最终状态\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiovcnt\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_FINISHED\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 成功完成\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eerrno\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePR_ST_ERROR\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 写出错\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 最后一次把 node 本身作为结果回调给用户\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"yOI6XUmH\"\u003e\u003cb\u003ewf框架的写逻辑是使用的\u003ccode\u003eiovec\u003c/code\u003e\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"nQ8H-Dkd\"\u003e在linux下iovec是这样的\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-text\"\u003estruct iovec\n  {\n    void *iov_base; /* Pointer to data.  */\n    size_t iov_len; /* Length of data.  */\n  };\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"T2f24IXn\"\u003e注释简单明了，维护了一个指针开始信息，一个长度信息，\u003ccode\u003enode-\u0026gt;data\u003c/code\u003e维护了一个iovec数组。\u003c/p\u003e\u003ch3\u003e为什么要使用iovec？\u003c/h3\u003e\u003cul\u003e\u003cli data-pid=\"GjaSzfqo\"\u003e 如果\u003ccode\u003ewritev\u003c/code\u003e，你要输出两段数据，就得两次 \u003ccode\u003ewrite(fd, buf1, len1)\u003c/code\u003e、\u003ccode\u003ewrite(fd, buf2, len2)\u003c/code\u003e，每次都要进内核、出内核。用 \u003ccode\u003eiovec iov[2] = {{buf1,len1},{buf2,len2}}; writev(fd, iov, 2);\u003c/code\u003e 只需一次系统调用，把两段数据连续写出去。\u003cbr/\u003e \u003c/li\u003e\u003cli data-pid=\"DhXXuiZS\"\u003e\u003cb\u003e\u003ccode\u003ehttp_append_out_body_nocopy\u003c/code\u003e\u003c/b\u003e的实现就是将buf挂到iovec上，这样可以有效的避免\u003cb\u003ememcpy\u003c/b\u003e。\u003cbr/\u003e \u003c/li\u003e\u003c/ul\u003e\u003ch3\u003e到此为止，poller_t的内容就讲的差不多啦\u003c/h3\u003e\u003cp data-pid=\"b4DSjoPv\"\u003e最后介绍一个东西\u003c/p\u003e\u003ch3\u003empoller_t\u003c/h3\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-cpp\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003e__mpoller\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003enodes_buf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003enthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003empoller_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003epoller_data\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                              \u003cspan class=\"n\"\u003empoller_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003empoller\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003empoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003enthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003epoller_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003empoller\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epoller\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"3iV-ZHvW\"\u003e可以看到，\u003ccode\u003empoller_t\u003c/code\u003e就比\u003ccode\u003epoller_t\u003c/code\u003e多了个\u003ccode\u003enthreads\u003c/code\u003e信息而已\u003c/p\u003e\u003cp data-pid=\"o00iVruc\"\u003e前面提到的Commicator就说明了，其实上层是创建的一个\u003ccode\u003empoller_t\u003c/code\u003e而不是\u003ccode\u003epoller_t\u003c/code\u003e,有什么好处呢？\u003cb\u003e其实这可以算作一种经典的负载均衡做法\u003c/b\u003e哦！\u003c/p\u003e\u003cp data-pid=\"auyOWPzq\"\u003e比如说我\u003cb\u003e\u003ccode\u003empoller_t\u003c/code\u003e\u003c/b\u003e创建了8个\u003cb\u003e\u003ccode\u003epoller_t\u003c/code\u003e\u003c/b\u003e,看add函数，是不是就是对\u003cb\u003efd%8\u003c/b\u003e,找到对应的\u003ccode\u003epoller_t\u003c/code\u003e再加进去? fd是不是默认可以认为是一个增加的指？相当于我创建8个事件,就会\u003cb\u003e按顺序依次加入\u003c/b\u003e到\u003ccode\u003epoller_t\u003c/code\u003e中啦，这就实现了负载均衡\u003c/p\u003e\u003ch2\u003e总结\u003c/h2\u003e\u003cul\u003e\u003cli data-pid=\"LZo-W1xj\"\u003e\u003cb\u003e\u003ccode\u003epoller_t\u003c/code\u003e内部有三种事件，定时事件，管道事件，任务事件,其中管道事件是为了防止多线程资源的生命周期问题\u003c/b\u003e。\u003c/li\u003e\u003cli data-pid=\"9hZheQW5\"\u003e\u003cb\u003e定时事件的实现依靠的是\u003ccode\u003etimerfd\u003c/code\u003e记录最早超时任务加入到\u003ccode\u003eepoll\u003c/code\u003e中，定时任务的管理使用队列和红黑树配合实现\u003c/b\u003e。\u003c/li\u003e\u003cli data-pid=\"ImUm1h1i\"\u003e\u003cb\u003e\u003ccode\u003epoller_t\u003c/code\u003e中存储注册的上下文和回调函数以及\u003ccode\u003efd\u003c/code\u003e对应的资源，\u003ccode\u003epoller_t\u003c/code\u003e中存储用户资源的结构是\u003ccode\u003epoller_node\u003c/code\u003e,存储了用户注册的函数和数据\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"wbpb3umA\"\u003e\u003cb\u003e任务完成会调用\u003ccode\u003epoller_t\u003c/code\u003e的回调发送\u003ccode\u003epoller_node\u003c/code\u003e给上层，回调是\u003ccode\u003eCommunictor\u003c/code\u003e这个类注册的，将数据加入到消息队列中再由它转交给线程池处理。\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"ogjfkDTH\"\u003e\u003cb\u003e在读任务中,\u003ccode\u003epoller_node\u003c/code\u003e会在堆上开辟一个\u003ccode\u003eres\u003c/code\u003e，用来存储不完整的数据帧信息，当数据完整后再将\u003ccode\u003eres\u003c/code\u003e节点转发给上层，\u003ccode\u003epoller_node\u003c/code\u003e本身负责管理元数据。\u003c/b\u003e\u003c/li\u003e\u003cli data-pid=\"Jln2WSRJ\"\u003e\u003cb\u003e在写事件中\u003ccode\u003epoller_t\u003c/code\u003e使用\u003ccode\u003eiovc\u003c/code\u003e进行数据的转发\u003c/b\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"LZltAZog\"\u003e​   \u003c/p\u003e\u003cblockquote data-pid=\"vR0QghCF\"\u003e 创作不易，看到这了，点个赞再走吧~\u003c/blockquote\u003e","is_labeled":false,"visited_count":85,"favorite_count":9,"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 1921206855365035577}","attached_info":"CtMFCNDLncen1eXbsgEQBxoJMjU5NTM1MjE4IJ+j7sIGKAAwAEBhSiMKGFRTX1NPVVJDRV9XQVJNX1VQX0JPT1NUMhIBMBgAIAA6AEopCh5UU19TT1VSQ0VfV0FSTV9VUF9JVEVNQ0ZfQ0IyQ0YSATAYACAAOgBiIGYzZjJkZjQ2ZDNjNzZhMzMzMmU1Nzk2ZDE5MTlhMTUwchMxOTIxMjA2ODU1MzY1MDM1NTc3qgEJcmVjb21tZW5kwgEgMDVjZDViNDcwZDZjMzdkN2ZjOWE0MTU4OTkzMjk0NjfyAQoIDBIGTm9ybWFs8gEoCAoSJGE4NDhhN2FiLWVhM2EtNDc0MC1hZWQzLTRjN2FhYThhMjZlY/IBBggLEgIxN4ICAIgC+rfvzfoykgIgMDVjZDViNDcwZDZjMzdkN2ZjOWE0MTU4OTkzMjk0NjeaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIYUGVyaW9kSW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxl2gIYVFNfU09VUkNFX1dBUk1fVVBfQk9PU1Qy6AID+gILTk9STUFMX0ZMT1eKAyA0YjBhOGJiNmVjMzI0YjkyOTUxMmY4MDVlYzVjYTU1OJoDDQoCdjIQABoFb3RoZXKoA1XYAwDqAx9jb250ZW50V2FybXVwQm9vc3RDQjJDRlJlY2FsbGVy+gMfEgxVTktOT1dOX01PREUgACoNTk9fSU1BR0VfTU9ERYAEAIgEAJIEBk5vcm1hbJoEATOgBACoBACwBAC6BAJhacIEAzQwMMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAQCV5iz+BBQAAAAAAAAAAiQVPo2Aw+YLSP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AURkAYAoAZmqAYDkgIuCgkyNTk1MzUyMTgSEzE5MjEyMDY4NTUzNjUwMzU1NzcYByIKSU1BR0VfVEVYVA==","action_card":false},{"id":"98_1750899350.694","type":"feed","offset":98,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1750899350,"updated_time":1750899350,"target":{"id":"1918383283701540579","type":"article","url":"https://api.zhihu.com/articles/1918383283701540579","author":{"id":"c1e665bc433aafead3e62e7bb938a8d7","url":"https://api.zhihu.com/people/c1e665bc433aafead3e62e7bb938a8d7","user_type":"people","url_token":"zhang-yong-hui-92-6","name":"十三学长","headline":"换个姿势，带你看世界，野生自媒体文痞","avatar_url":"https://pic1.zhimg.com/50/v2-afcc916244713a2c005f387cb3f7f492_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":3505,"is_following":false,"is_followed":false},"title":"十个小故事说透了我们的一生","comment_permission":"all","created":1750158245,"updated":1750158245,"voteup_count":442,"voting":0,"comment_count":35,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"故事1，有一个人买了一箱梨，由于天气太热了，有的梨都坏掉了，他觉得扔掉了很可惜，就每天挑坏梨吃，最后吃了一箱烂梨。 有人对此事做了一副对联，上联是，放着好的吃烂的，下联是，吃了烂的烂好的。横批，永远吃烂的。 这个故事告诉我们，我们的人生就像是在吃梨，如果只盯着烂的人和事不放，每天去想自己过去的痛苦和现在的忧伤，痛苦的只会是自己。 故事2，有一个人去拜菩萨，拜完后对菩萨说，我也想当菩萨，没想到菩萨说，…","excerpt_new":"故事1，有一个人买了一箱梨，由于天气太热了，有的梨都坏掉了，他觉得扔掉了很可惜，就每天挑坏梨吃，最后吃了一箱烂梨。 有人对此事做了一副对联，上联是，放着好的吃烂的，下联是，吃了烂的烂好的。横批，永远吃烂的。 这个故事告诉我们，我们的人生就像是在吃梨，如果只盯着烂的人和事不放，每天去想自己过去的痛苦和现在的忧伤，痛苦的只会是自己。 故事2，有一个人去拜菩萨，拜完后对菩萨说，我也想当菩萨，没想到菩萨说，…","preview_type":"default","preview_text":"","content":"\u003cp data-pid=\"RNDwqk2l\"\u003e故事1，有一个人买了一箱梨，由于天气太热了，有的梨都坏掉了，他觉得扔掉了很可惜，就每天挑坏梨吃，最后吃了一箱烂梨。\u003c/p\u003e\u003cp data-pid=\"U5La2CPB\"\u003e有人对此事做了一副对联，上联是，放着好的吃烂的，下联是，吃了烂的烂好的。横批，永远吃烂的。\u003c/p\u003e\u003cp data-pid=\"O92v9gXr\"\u003e这个故事告诉我们，我们的人生就像是在吃梨，如果只盯着烂的人和事不放，每天去想自己过去的痛苦和现在的忧伤，痛苦的只会是自己。\u003c/p\u003e\u003cp data-pid=\"MQ3C2yth\"\u003e故事2，有一个人去拜菩萨，拜完后对菩萨说，我也想当菩萨，没想到菩萨说，行啊。\u003c/p\u003e\u003cp data-pid=\"ACsJDsga\"\u003e但是我有一个条件，无论你遇到什么事，都得和我一样，不许开口说话。\u003c/p\u003e\u003cp data-pid=\"bm3nNev4\"\u003e这人就说，这有什么？于是两个人换了角色。\u003c/p\u003e\u003cp data-pid=\"hW7Gqo-a\"\u003e这一天，大殿里来了一个有钱人，磕完头，钱包掉了，那个人想提醒他，可是一想，我不能开口。\u003c/p\u003e\u003cp data-pid=\"2loaxiJZ\"\u003e紧接着又来了一个穷人，穷人求菩萨赐给他钱财，救救他病重的孩子。\u003c/p\u003e\u003cp data-pid=\"LqxvW5WJ\"\u003e这一磕头，就看到了地上的钱袋子。穷人想，这是菩萨显灵了，那人想说，这不是菩萨显灵，那钱是前面那个富人落下的，但是他不能开口。\u003c/p\u003e\u003cp data-pid=\"4Tr4Onfa\"\u003e过了一会儿，又来了一个渔夫，求菩萨保佑他平安出海，没有风暴。\u003c/p\u003e\u003cp data-pid=\"5Dsbcr00\"\u003e正当这个渔夫拜完之后要走的时候，被这个前来找钱的富人拦住了。富人怀疑渔夫拿了他的钱，两个人就纠缠在一起，准备动手。\u003c/p\u003e\u003cp data-pid=\"jjMyhG_P\"\u003e这个人再也看不下去了，他大喊一声住手，然后就把这个真相告诉了富人。得到真相之后，大家都走了。\u003c/p\u003e\u003cp data-pid=\"10_oCClN\"\u003e这个时候，菩萨对他说，你以为你开了口就是主持公道了吗？\u003c/p\u003e\u003cp data-pid=\"LjX9S0S8\"\u003e因为你开口说话，穷人的救命钱没了，富人的行善机缘没了，渔夫出海，正好赶上风暴，性命没了，你这是造孽。\u003c/p\u003e\u003cp data-pid=\"YAoFHYsL\"\u003e如果你不开口，穷人的孩子有救了，富人积了德，渔夫因为富人的纠缠没办法按时出海，就躲过了风暴，至今还活着呢。\u003c/p\u003e\u003cp data-pid=\"ZIeaotge\"\u003e这个故事告诉我们，沉默是金，静观其便是一种能力，学会闭嘴更是一种智慧。\u003c/p\u003e\u003cp data-pid=\"xeniFTgP\"\u003e故事3，小鸡问母亲，能不能别下蛋，带我出去玩？\u003c/p\u003e\u003cp data-pid=\"jz-WKB5W\"\u003e母鸡说，不行，我要工作。\u003c/p\u003e\u003cp data-pid=\"41IKqwd8\"\u003e小鸡说，可你已经下了那么多蛋了。\u003c/p\u003e\u003cp data-pid=\"mVIuwcfV\"\u003e母鸡意味深长的跟小鸡说，一天一个蛋，菜刀靠边站。一月不下蛋，高压锅里见。\u003c/p\u003e\u003cp data-pid=\"7MRFA1VC\"\u003e这个故事告诉我们，存在是因为你创造了价值，淘汰是因为你失去了价值，过去的价值不代表未来，所以，每一天都要努力。\u003c/p\u003e\u003cp data-pid=\"tbnyWUI_\"\u003e故事4，一只蝎子想去河对岸，向青蛙请求说，我想过河，但不会游泳，你能背我过河吗？\u003c/p\u003e\u003cp data-pid=\"QC3r3dWY\"\u003e青蛙回应说，不行啊，你有一个毒勾子，到时你蛰我咋办？\u003c/p\u003e\u003cp data-pid=\"a6MuriGs\"\u003e蝎子听后大笑着说，如果我蛰你，你死了，那我也活不了啊。\u003c/p\u003e\u003cp data-pid=\"4fkNvmzM\"\u003e青蛙一想，觉得有理，就背着蝎子向对岸游去。当游道河中央时，青蛙突然感到背部一阵剧烈的疼痛，身体开始麻木。\u003c/p\u003e\u003cp data-pid=\"unT3M1eB\"\u003e青蛙吃力地问蝎子，难道你想自杀吗？蝎子惊慌回应，我不是故意的，我蛰你完全是出于下意识，说完，他们都沉入了河底。\u003c/p\u003e\u003cp data-pid=\"KeZEPifL\"\u003e这个故事告诉我们，要远离身边有恶习的人，在帮助别人之前要认清对方。\u003c/p\u003e\u003cp data-pid=\"dDEKaqjU\"\u003e恶习难改，盲目的善良很可能会让自己陷入绝境。\u003c/p\u003e\u003cp data-pid=\"Z4YMVKYN\"\u003e故事5，一只骆驼历经艰辛穿越了沙漠，一只苍蝇趴在骆驼背上，不费一点力气也过了沙漠。\u003c/p\u003e\u003cp data-pid=\"hoDtAoEM\"\u003e苍蝇讥笑道，骆驼，谢谢你辛苦把我驮过来，再见。\u003c/p\u003e\u003cp data-pid=\"tQqRiGqE\"\u003e骆驼看了苍蝇一眼说，你在我身上的时候，我根本不知道，你走了也没必要跟我打招呼，你根本没什么分量。\u003c/p\u003e\u003cp data-pid=\"F0LVcU5U\"\u003e这个故事告诉我们，要正确认识自己，不要把自己看得过重。\u003c/p\u003e\u003cp data-pid=\"FI_JgzcU\"\u003e在这个世界上，每个人都很重要，但离了谁，地球都照样转动。\u003c/p\u003e\u003cp data-pid=\"CTaGQWcr\"\u003e故事6，古时候，有个老板开了一家当铺。\u003c/p\u003e\u003cp data-pid=\"T1YzlH3i\"\u003e有一天，一个邻居来当铺要拿回当的棉被和棉衣，却不肯付赎金。\u003c/p\u003e\u003cp data-pid=\"7iaEF87x\"\u003e当铺老板想了一下，跟邻居说，是不是快过年了，家里没有御寒的东西，那这些衣物、棉被就拿回去应急吧。邻居没做声，拿了东西便走。\u003c/p\u003e\u003cp data-pid=\"9WJHlq41\"\u003e没想到第二天，邻居竟死在了另外一家当铺里。原来，邻居欠了钱无力偿还，打算去当铺索要东西，如果不给，就喝药死在店里，讹一笔钱留给家人。另一家当铺老板因不肯吃亏，便赔了一大笔钱。\u003c/p\u003e\u003cp data-pid=\"TJ2ToFBX\"\u003e这个故事告诉我们，不管什么时候，都要留一点余地。给别人让步，不是怯懦，也不是退缩，而是宽厚他人，更是解脱自我。\u003c/p\u003e\u003cp data-pid=\"RXWBq75H\"\u003e故事7，有一条饥饿的蛇，爬进了一家木材店寻找食物，当他路过地上的锯子的时候，身体被割伤了一点，他愤怒地转过身去，一口就咬住了锯子，结果锯子丝毫无损，他却把自己的嘴也弄伤了。\u003c/p\u003e\u003cp data-pid=\"bWJztsfF\"\u003e蛇更加的愤怒了，红着眼睛冲上去。用力的把锯子都缠住，想要把锯子给勒死。最后他用尽了全身的力气，也没有伤害到锯子，反倒是自己被锯死了。\u003c/p\u003e\u003cp data-pid=\"aZ21KPY8\"\u003e这个故事告诉我们，蛇到死都没有弄明白，害死他的并不是锯子，而是自己失控的情绪。\u003c/p\u003e\u003cp data-pid=\"ho6FicCN\"\u003e弱者易怒如虎，强者平静似水，控制不住自己情绪的人，最终只会害人害己。\u003c/p\u003e\u003cp data-pid=\"xC5njY-O\"\u003e故事8，苏轼和佛印，两人经常一起参禅打坐，佛印老实，老被苏轼欺负，苏轼有时候占了便宜很高兴，就回家和苏小妹炫耀。\u003c/p\u003e\u003cp data-pid=\"qL2UQOke\"\u003e有一天，两人又在一起打坐。\u003c/p\u003e\u003cp data-pid=\"PvYTE63m\"\u003e苏轼问，你看看我像什么呀？\u003c/p\u003e\u003cp data-pid=\"vzcXaxrS\"\u003e佛印说，我看你像尊佛。\u003c/p\u003e\u003cp data-pid=\"As4_LOcS\"\u003e苏轼听后大笑，对佛印说，你知道我看你坐在那，像什么吗？好像一滩牛粪啊。\u003c/p\u003e\u003cp data-pid=\"zu82PtBw\"\u003e这一次，佛印又吃了哑巴亏。\u003c/p\u003e\u003cp data-pid=\"K98Azq7y\"\u003e苏轼回家后，就在苏小妹面前炫耀这件事，苏小妹听后冷笑一下，对哥哥说，就你这悟性，还参禅呢。\u003c/p\u003e\u003cp data-pid=\"AZn9mKCQ\"\u003e你知道参禅的人最讲究的是什么吗？就是见心见性。你心中有，眼中就有。\u003c/p\u003e\u003cp data-pid=\"6DEdrViq\"\u003e佛印说你看着像尊佛，那说明啊，他的心中有尊佛。你说佛印像牛粪，想想你的心里有什么吧。\u003c/p\u003e\u003cp data-pid=\"0DdS0phW\"\u003e这个故事告诉我们，你的内心决定了你看待事情的态度，和是否能看清事实的真相。\u003c/p\u003e\u003cp data-pid=\"XMAncRBE\"\u003e故事9，有一个财主把三块大小不一样的西瓜摆在一个年轻人跟前。\u003c/p\u003e\u003cp data-pid=\"wcVQhSF8\"\u003e问他，如果三块西瓜代表不同程度的利益，你会选择哪一块？\u003c/p\u003e\u003cp data-pid=\"FYAjf96J\"\u003e年轻人想都没想，伸手就拿了最大的那块，大口吃起来，再看财主，他直接选了最小的那块，三下五除二就吃完了。\u003c/p\u003e\u003cp data-pid=\"fFUMkKs5\"\u003e正当年轻人还啃着大块西瓜时，财主已经开始吃第二块了。\u003c/p\u003e\u003cp data-pid=\"BytPax2p\"\u003e这会儿年轻人后知后觉，财主每次拿的西瓜虽小，但吃完一块接第二块，最后吃到嘴里的总量，比年轻人的多多了。\u003c/p\u003e\u003cp data-pid=\"Mk4fgR0N\"\u003e这个故事告诉我们，只有学会舍弃眼前的利益，才能获得更多的长远利益。\u003c/p\u003e\u003cp data-pid=\"I7l_1XI7\"\u003e最后一个故事，说有两个秀才一起去赶考，路上遇到一支出殡的队伍，当看到那一口黑乎乎的棺材，其中一个秀才心里咯噔一下，凉了半截，心想，完了，真倒霉，赶考的日子居然遇到棺材。\u003c/p\u003e\u003cp data-pid=\"vBIL4TiU\"\u003e于是啊，他的情绪一落千丈。\u003c/p\u003e\u003cp data-pid=\"-j5nadKR\"\u003e进考场后，那个黑乎乎的棺材呢，在他的脑海里一直挥之不去，文思顿时枯竭，最终名落孙山。\u003c/p\u003e\u003cp data-pid=\"157_r3Hv\"\u003e另一个秀才在看到棺材后，一开始心里也咯噔一下，但转念一想，棺材，棺材，不就是既有官又有财吗？这是好兆头呀，看来啊，我今天要交鸿运了。\u003c/p\u003e\u003cp data-pid=\"m294zuel\"\u003e于是呢，心里十分兴奋，到考场后，文思如泉涌，果然一举考中。回到家里后，两个秀才都说，那个棺材真的好灵。\u003c/p\u003e\u003cp data-pid=\"njQZAIBL\"\u003e所以说，很多时候事情是一样的，同样一件事情本身没有对错，你可以看成是好事，也可以看成是坏事，人生也是如此。\u003c/p\u003e\u003cp data-pid=\"aEO6xm2g\"\u003e有什么样的心态，就会有什么样的人生。有什么样的想法，就会有什么样的生活。\u003c/p\u003e\u003cp data-pid=\"m1LC2hf0\"\u003e心态决定命运，听我的，每天开心一点，别每天看手机看到头痛，有时间去读读这本书。\u003c/p\u003e\u003cp data-pid=\"jqkrj4oF\"\u003e《小故事大智慧》，这本书汇集了古今中外700多个有意思的小故事，涵盖了人生的方方面面，每个故事背后，都有引人深思的哲理和解释。\u003c/p\u003e\u003cp data-pid=\"EDzA_9q7\"\u003e无论是自己看，还是记一些故事讲给孩子听，都是一本能够让我们少走弯路，启迪智慧的好书。\u003c/p\u003e","is_labeled":false,"visited_count":46075,"favorite_count":888,"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 1918383283701540579}","attached_info":"CtcGCNDLncen1eXbsgEQBxoJMjU5MjA1Nzg4IKWXxcIGKLoDMCNAYkp3ChxUU19TT1VSQ0VfSE9UX0NST1NTX1JFQUxUSU1FElFob3RfcmVjYWxsX3JlYWx0aW1lX3Q6bm9ybWFsOjIwMjUtMDYtMjY6bWFsZTptaWRkbGV5b3VuZ3N0ZXI65LiA57q/5Z+O5biCOm1vbnRobHkYACAAOgBiIGYzZjJkZjQ2ZDNjNzZhMzMzMmU1Nzk2ZDE5MTlhMTUwchMxOTE4MzgzMjgzNzAxNTQwNTc5qgEJcmVjb21tZW5kwgEgYzFlNjY1YmM0MzNhYWZlYWQzZTYyZTdiYjkzOGE4ZDfyAQoIDBIGTm9ybWFs8gEoCAoSJDQzNzE5ZTljLTM0NGEtNGRmOC1iNWFiLTE1N2U5MjI2MDE4NPIBBggLEgIxN4ICAIgC+rfvzfoykgIgYzFlNjY1YmM0MzNhYWZlYWQzZTYyZTdiYjkzOGE4ZDeaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIWQWN0aW9uU2hvckludGVyZXN0UnVsZcoCG0ludGVyYWN0aW9uU2hvckludGVyZXN0UnVsZcoCFlJldmlzaXRWYWx1ZVdlaWdodFJ1bGXKAhhQZXJpb2RJbnRlcmVzdFdlaWdodFJ1bGXKAhVVc2VyTGNuRXhpdFdlaWdodFJ1bGXaAhxUU19TT1VSQ0VfSE9UX0NST1NTX1JFQUxUSU1F6AIC+gILTk9STUFMX0ZMT1eKAyA0YjBhOGJiNmVjMzI0YjkyOTUxMmY4MDVlYzVjYTU1OJoDDQoCdjIQABoFb3RoZXKoA/vnAtgDAOoDH2hvdENyb3NzUmVhbFRpbWVDb250ZW50UmVjYWxsZXL6Ax8SDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFgAQAiAQAkgQGTm9ybWFsmgQBMqAEAKgEALAEALoEBm1hbnVhbMIEAzE3MMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAA4LnjwT+BBQAAAAAAAAAAiQVPo2Aw+YLSP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AURkAYAoAZnqAYAkgIuCgkyNTkyMDU3ODgSEzE5MTgzODMyODM3MDE1NDA1NzkYByIKSU1BR0VfVEVYVA==","action_card":false},{"id":"99_1750899350.743","type":"feed","offset":99,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1750899350,"updated_time":1750899350,"target":{"id":"1919536855063454866","type":"answer","url":"https://api.zhihu.com/answers/1919536855063454866","author":{"id":"caa0dadfd0f88d8ad0596aede7841675","url":"https://api.zhihu.com/people/caa0dadfd0f88d8ad0596aede7841675","user_type":"people","url_token":"liu-lin-57-66","name":"吾牧之","headline":"","avatar_url":"https://pic1.zhimg.com/50/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":16022,"is_following":false,"is_followed":false},"created_time":1750433249,"updated_time":1750433957,"voteup_count":351,"thanks_count":10,"comment_count":20,"is_copyable":false,"question":{"id":"12302042645","type":"question","url":"https://api.zhihu.com/questions/12302042645","author":{"id":"e754c12930e2a2fbcee7098a0b4cfbc7","url":"https://api.zhihu.com/people/e754c12930e2a2fbcee7098a0b4cfbc7","user_type":"people","url_token":"qu-fu-ren-san-46","name":"薛定谔的猫","headline":"养猫大户","avatar_url":"https://picx.zhimg.com/50/v2-65ac6736e1d8335b7d1d0f638cb03ee4_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":3,"is_following":false,"is_followed":false},"title":"《红楼梦》里贾府作为开国功臣没犯过大错为什么才三四代人就衰败成这样？","created":1739594534,"answer_count":0,"follower_count":0,"comment_count":5,"bound_topic_ids":[7246,19544,315276,156311,86198],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"thumbnail":"https://pica.zhimg.com/50/v2-ee126e5a07132bb18ca0b182e11e18ad_720w.jpg?source=b6762063","excerpt":"我看高赞说的是因为贾家的后人没本事 然而，这个和当时的情况不同，对于封建社会的勋贵家庭 没本事是最不足道的缺点，甚至在某种程度上还是优点 至于什么皇帝不养闲人，云云，那就是胡扯了 世爵世职摆明了就是代代恩养，有本事的自然要养着，没本事的养着才体现出皇恩浩荡，才能激励文武大臣为朝廷卖命，才能构建坚实的皇权基础 设若因为子孙平庸，躺平就要剥夺爵位，那么这个世职还有什么意义么？（当然你也不能太傻了，考封都…","excerpt_new":"我看高赞说的是因为贾家的后人没本事 然而，这个和当时的情况不同，对于封建社会的勋贵家庭 没本事是最不足道的缺点，甚至在某种程度上还是优点 至于什么皇帝不养闲人，云云，那就是胡扯了 世爵世职摆明了就是代代恩养，有本事的自然要养着，没本事的养着才体现出皇恩浩荡，才能激励文武大臣为朝廷卖命，才能构建坚实的皇权基础 设若因为子孙平庸，躺平就要剥夺爵位，那么这个世职还有什么意义么？（当然你也不能太傻了，考封都…","preview_type":"default","preview_text":"","reshipment_settings":"disallowed","content":"\u003cp data-pid=\"Uyyt6a20\"\u003e我看高赞说的是因为贾家的后人没本事\u003c/p\u003e\u003cp data-pid=\"DsUfMF6U\"\u003e然而，这个和当时的情况不同，对于封建社会的勋贵家庭\u003c/p\u003e\u003cp data-pid=\"bgoD1xWI\"\u003e没本事是最不足道的缺点，甚至在某种程度上还是优点\u003c/p\u003e\u003cp data-pid=\"gBTCNNsE\"\u003e至于什么皇帝不养闲人，云云，那就是胡扯了\u003c/p\u003e\u003cp data-pid=\"4WYn2epl\"\u003e世爵世职摆明了就是代代恩养，有本事的自然要养着，没本事的养着才体现出皇恩浩荡，才能激励文武大臣为朝廷卖命，才能构建坚实的皇权基础\u003c/p\u003e\u003cp data-pid=\"5a1ZPiJE\"\u003e设若因为子孙平庸，躺平就要剥夺爵位，那么这个世职还有什么意义么？（当然你也不能太傻了，考封都过不了，那就只能丢掉自己的爵位了，在这种情况下，爵位会找最近的亲属承袭）\u003c/p\u003e\u003cp data-pid=\"cdIn5BE9\"\u003e只要你对帝国忠诚，对皇权有帮助，皇帝也不少你这一份钱粮\u003c/p\u003e\u003cp data-pid=\"de8V93A8\"\u003e贾府衰弱的秘密就在贾蓉的履历里面，和参加秦可卿葬礼的来宾名单里面\u003c/p\u003e\u003cp data-pid=\"lFd0_U9h\"\u003e秦可卿去世之后，贾珍给自己的宝贝儿子捐了一个五品官\u003c/p\u003e\u003cp data-pid=\"PFBfUxLp\"\u003e按照当时的惯例，必须要填写父祖曾祖三代履历\u003c/p\u003e\u003cp data-pid=\"I1o2zVfk\"\u003e于是我们就看到了宁国府的传承情况\u003c/p\u003e\u003cp data-pid=\"r0pHUfr4\"\u003e“江南江宁府江宁县监生贾蓉，年二十岁。曾祖，\u003cb\u003e原任京营节度使世袭一等神威将军贾代化\u003c/b\u003e，祖，乙卯科进士贾敬，父，世袭三品爵威烈将军贾珍。”\u003c/p\u003e\u003cp data-pid=\"BeamVon3\"\u003e这里有一个非常奇怪的事情，为什么贾珍的爵位这么低？\u003c/p\u003e\u003cp data-pid=\"ZnOY1vxe\"\u003e在这一回目里面还有参加秦可卿葬礼的勋贵的爵位介绍\u003c/p\u003e\u003cp data-pid=\"WWicyRie\"\u003e那时官客送殡的，有镇国公牛清之孙现袭一等伯牛继宗，理国公柳彪之孙现袭一等子柳芳，\u003cb\u003e齐国公陈翼之孙世袭三品威镇将军陈瑞文，治国公马魁之孙世袭三品威远将军马尚，\u003c/b\u003e修国公侯晓明之孙世袭一等子侯孝康，缮国公诰命亡故，故其孙石光珠守孝不曾来得。这六家与宁荣二家，\u003cb\u003e当日所称“八公”的便是。\u003c/b\u003e余者更有南安郡王之孙，西宁郡王之孙，忠靖侯史鼎，平原侯之孙世袭二等男蒋子宁，定城侯之孙世袭二等男兼京营游击谢鲸，襄阳侯之孙世袭二等男戚建辉，景田侯之孙五城兵马司裘良。余者锦乡伯公子韩奇，神武将军公子冯紫英，陈也俊，卫若兰等诸王孙公子，不可枚数。\u003c/p\u003e\u003cp data-pid=\"DyXKpVFU\"\u003e曹雪芹不是说相声的，这一段肯定是有所用意\u003c/p\u003e\u003cp data-pid=\"2o5pdsiV\"\u003e现在有很多研究红楼梦的人，认为红楼梦的爵位系统很混乱\u003c/p\u003e\u003cp data-pid=\"u4az84I7\"\u003e这就是笑谈了\u003c/p\u003e\u003cp data-pid=\"jAlL-33s\"\u003e曹家是内务府包衣出身，打交道的都是主子们\u003c/p\u003e\u003cp data-pid=\"Wn0nzz4p\"\u003e对于清朝的爵位承袭制度门清儿\u003c/p\u003e\u003cp data-pid=\"DwoACkFm\"\u003e怎么可能写错了。\u003c/p\u003e\u003cp data-pid=\"VM_sf8vk\"\u003e清代制度，在民爵这个层面上，除了嫡长子能够降等袭爵之外，其余的是不准袭爵的\u003c/p\u003e\u003cp data-pid=\"G0oKZiH4\"\u003e所以上面这些人，带袭字的应该都是嫡长子\u003c/p\u003e\u003cp data-pid=\"CuUdMMb3\"\u003e从镇国公牛清之孙承袭了一等伯这个角度来看，祖父公爵，父亲侯爵，孙子伯爵是存在的\u003c/p\u003e\u003cp data-pid=\"n-tO2HeL\"\u003e从子爵和男爵的存在来看，红楼梦宇宙中仍旧是中国的公侯伯子男五等爵位\u003c/p\u003e\u003cp data-pid=\"2XOOMHW7\"\u003e而三品将军这个爵位，就更值得玩味了\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-861a2eeb6479b8dfa0918f854f146dbd_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"492\" data-rawheight=\"484\" data-original-token=\"v2-c643da5620ff6d77fb6f98a1704f25de\" data-default-watermark-src=\"https://pica.zhimg.com/v2-9217e6f7e1d66ccd9004797d613ce2f0_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"492\" data-original=\"https://picx.zhimg.com/v2-861a2eeb6479b8dfa0918f854f146dbd_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"RjLg5m-k\"\u003e因为清朝的民爵，轻车都尉就是三品官的待遇，而且也分三等\u003c/p\u003e\u003cp data-pid=\"tVfj3ggZ\"\u003e而且最有趣的是贾代化的爵位，世袭一等将军，公侯伯子男的爵位，老子辈贾演还是宁国公怎么到了儿子辈就成了将军了呢？？？\u003c/p\u003e\u003cp data-pid=\"dIigCxrX\"\u003e按理说不应该是侯爵么？当不了一等侯，至少也得是二等侯，当不了二等侯，至少也得是一等伯爵吧？怎么一溜烟从侯爵伯爵子爵男爵，一口气撸到一等将军了呢？\u003c/p\u003e\u003cp data-pid=\"RbB0ngmx\"\u003e而且最神奇的事，贾珍是三品将军但是荣国府的贾赦却是一等将军\u003c/p\u003e\u003cp data-pid=\"z0oufq2R\"\u003e“大内兄现袭一等将军，名赦，字恩侯”\u003c/p\u003e\u003cp data-pid=\"o6ZnS-PV\"\u003e理论上当了京营节度使的贾代化的爵位，竟然和色眯眯要讨鸳鸯当小老婆的贾赦一个样子\u003c/p\u003e\u003cp data-pid=\"Tq_vOBS0\"\u003e而且同等情况的，不只是宁国府、荣国府两家\u003c/p\u003e\u003cp data-pid=\"BLxzk4QD\"\u003e八公里面除了牛家，和没有提及的缮国公家，基本上全都是至少连降三级，而齐国公和治国公孙子的爵位，竟然和贾珍是一样的\u003c/p\u003e\u003cp data-pid=\"ZWRq3unB\"\u003e那么答案只有一个\u003c/p\u003e\u003cp data-pid=\"rqwXvIqe\"\u003e除了镇国公牛清家之外，八公家的其余七家，都卷入了不得了的政治纷争之中\u003c/p\u003e\u003cp data-pid=\"DLE4cZM0\"\u003e其中估计是宁国府家挑的头，齐国公和治国公家积极参与，理国公和修国公家是胁从\u003c/p\u003e\u003cp data-pid=\"M9Qcq_b4\"\u003e而镇国公家和缮国公家没参与进来\u003c/p\u003e\u003cp data-pid=\"SOvARcZv\"\u003e他们参与的这个事情，很可能就是让义忠亲王老千岁连棺材都没用上的那个坏事上了\u003c/p\u003e\u003cp data-pid=\"Z4WzMFZA\"\u003e我们木店里有一副板，叫作什么樯木，出在潢海铁网山上，作了棺材，万年不坏。这还是当年先父带来，原系义忠亲王老千岁要的，因他坏了事，就不曾拿去。现在还封在店内，也没有人出价敢买。你若要，就抬来使罢。\u003c/p\u003e\u003cp data-pid=\"vEqmeIX7\"\u003e万年不坏的东西，哪可能是寻常人用得的，义忠亲王老千岁看来绝非寻常人\u003c/p\u003e\u003cp data-pid=\"-bnx4Ryi\"\u003e既然坏了事，那就是被干掉了，成了逆亲王\u003c/p\u003e\u003cp data-pid=\"Dg402GvW\"\u003e但是在这里还叫义忠亲王老千岁，足以见得，薛家是和义忠亲王老千岁站在一条线上的\u003c/p\u003e\u003cp data-pid=\"OhwWBlHm\"\u003e换句话说，贾家人和那些被连降三级承袭爵位的勋贵也都是这根线上的，因为坏事被连累着了\u003c/p\u003e\u003cp data-pid=\"byulMJnB\"\u003e那么这是一个什么样的事情呢\u003c/p\u003e\u003cp data-pid=\"3Az8Bv8d\"\u003e这里有贾母的一段自白\u003c/p\u003e\u003cp data-pid=\"TBUwyBOf\"\u003e“贾母也笑道：“可是，我那里记得什么抱着背着的，提起这些事来，不由我不生气！我进了这门子作重孙子媳妇起，到如今我也有了重孙子媳妇了，连头带尾五十四年，\u003cb\u003e凭着大惊大险千奇百怪的事，也经了些，\u003c/b\u003e从没经过这些事。还不离了我这里呢！”\u003c/p\u003e\u003cp data-pid=\"nVIa60fW\"\u003e所谓的大惊大险，怕是就是让贾代化和贾代善爵位一撸到底\u003c/p\u003e\u003cp data-pid=\"25abrchk\"\u003e从公爵家变成轻车都尉家那件事吧？\u003c/p\u003e\u003cp data-pid=\"AMw8sFwi\"\u003e那么这件事是一个什么样的事情呢？\u003c/p\u003e\u003cp data-pid=\"0I9Q8_OM\"\u003e联想到，凤姐的那句气话，我们有理由相信，是谋反\u003c/p\u003e\u003cp data-pid=\"3jF4MHYd\"\u003e“癞狗扶不上墙的种子。你细细的说给他，\u003cb\u003e便告我们家谋反也没事的\u003c/b\u003e。不过是借他一闹，大家没脸。若告大了，我这里自然能够平息的。”\u003c/p\u003e\u003cp data-pid=\"djYRMiIW\"\u003e考虑到，红楼梦宇宙里面竟然还有一个太上皇，这样一切就说得通了\u003c/p\u003e\u003cp data-pid=\"fxls4eNO\"\u003e大概的可能是这样的，老皇帝因为施政出现了问题，被他的儿子逼迫禅位\u003c/p\u003e\u003cp data-pid=\"6r38XxTU\"\u003e“偏值近年水旱不收，鼠盗蜂起，无非抢田夺地，鼠窃狗偷，民不安生，因此官兵剿捕，难以安身。”\u003c/p\u003e\u003cp data-pid=\"g3SufNy4\"\u003e在这个过程中，老皇帝求助了自己的兄弟义忠亲王老千岁，寻求复辟\u003c/p\u003e\u003cp data-pid=\"LNvyrjZk\"\u003e最后老千岁失败了，成了逆王，而老千岁串联的勋贵，也大都受到了打击。\u003c/p\u003e\u003cp data-pid=\"1YtpqtFj\"\u003e义忠亲王老千岁，义在忠前\u003c/p\u003e\u003cp data-pid=\"etMTa4Yv\"\u003e帮老皇帝复辟当然是讲义气的，但是却对皇帝不忠\u003c/p\u003e\u003cp data-pid=\"HzFgOowE\"\u003e自然受到了严厉打击，连用棺材下葬都不允许了。\u003c/p\u003e\u003cp data-pid=\"-b9Suxey\"\u003e这里面最突兀的是史家，这个家族，爵位不仅没有降低，反而在保龄侯之外又多了一个忠靖侯\u003c/p\u003e\u003cp data-pid=\"ipsvLwjg\"\u003e猜都不用猜，史家肯定是新皇帝的定策功臣\u003c/p\u003e\u003cp data-pid=\"ADCw53pw\"\u003e而里面立了大功的就是忠靖侯，靖是平定压制的意思\u003c/p\u003e\u003cp data-pid=\"Sm9dZd8s\"\u003e压制的是谁呢？老皇帝势力。\u003c/p\u003e\u003cp data-pid=\"UVB7S7UP\"\u003e史鼎这一次来的主要目的是侦查一下敌对势力的情况\u003c/p\u003e\u003cp data-pid=\"7XLFMMEG\"\u003e这位忠靖侯一共出场两次，一次是贾敬的生日，目的是监视贾敬有没有搞政治阴谋，一次是秦可卿出殡，监视八公集团有没有在搞阴谋\u003c/p\u003e\u003cp data-pid=\"nz9G040A\"\u003e反而是贾母过生日的时候，这个最该露面的本家的侄儿却没有露面\u003c/p\u003e\u003cp data-pid=\"FgrG-lkj\"\u003e他对史太君，并没有什么亲情，只是借着这个由头，侦查罢了。\u003c/p\u003e\u003chr/\u003e\u003cp data-pid=\"DgmUmbun\"\u003e在大约二十年前，贾府参与了一场宫廷政治斗争，这场政治斗争很可能是皇帝和太上皇之间的纠纷，应该是儿子造了老子的反，然后儿子还成功了\u003c/p\u003e\u003cp data-pid=\"ILWdlFzt\"\u003e贾家应该是站在了老皇帝一边，一并受到了新皇帝的打击\u003c/p\u003e\u003cp data-pid=\"jx77TevR\"\u003e带头的宁国府侯爷贾代化被一撸到底成了一等将军，而荣国府的贾代善可能也受了连累成了子爵\u003c/p\u003e\u003cp data-pid=\"wq9lPQjj\"\u003e因为已经是新皇朝的罪人了，所以本来前途大好的贾敬也受了连累，只好躲到道观里面装道士\u003c/p\u003e\u003cp data-pid=\"WfF_TxcI\"\u003e否则，我们实在是不能理解，一个能够寒窗苦读十年的人何以竟然一天官都不当，就忽然修道去了\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-883f3c67e51dde08851022d60f7c3c8a_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"480\" data-original-token=\"v2-9646290f1c80c2186e7c2dba81df068a\" data-default-watermark-src=\"https://picx.zhimg.com/v2-2971d7568fb263451d8463cb1cb9c0c5_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic1.zhimg.com/v2-883f3c67e51dde08851022d60f7c3c8a_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"l76r24sp\"\u003e总不能是为了证明自己智商高才考个进士玩玩看吧？\u003c/p\u003e\u003cp data-pid=\"q6TawxD4\"\u003e能够稳下心神念书的勋贵子弟，没有一个不是有野心的\u003c/p\u003e\u003cp data-pid=\"9jCEzy5k\"\u003e只有在为了避祸这种情况下，才有可能假托修道名义去道观修炼\u003c/p\u003e\u003cp data-pid=\"zGxFTjk9\"\u003e新皇帝可能是考虑到政治稳定的问题，只是把贾家调离了关键岗位，并没有赶尽杀绝\u003c/p\u003e\u003cp data-pid=\"XgQvW9Qt\"\u003e毕竟从荣宁国公开始，贾家至少掌握禁军三四十年了，贾家在军队中很有影响力\u003c/p\u003e\u003cp data-pid=\"aPBaSqRy\"\u003e因为宁国府已经成了落魄的贵族，所以贾珍的续弦不过是尤氏，一个继母和继姊妹形同暗娼的女人，而贾蓉的老婆只能找小门小户的秦可卿\u003cbr/\u003e受宁国府连累\u003c/p\u003e\u003cp data-pid=\"af1kEE1Z\"\u003e荣国府的政治地位也空前下降了，明明是荣国公的正派嫡长子的贾赦，只能在一个小院里面居住，家产的大部分，竟然被弟弟掌握\u003c/p\u003e\u003cp data-pid=\"LmZ-tYjx\"\u003e而这个是经过皇帝授意的\u003c/p\u003e\u003cp data-pid=\"-vqwtpGr\"\u003e目的就是利用贾政来渗透、掌握荣国府\u003c/p\u003e\u003cp data-pid=\"i6PUX4go\"\u003e这就是传说中的拉一派打一派\u003c/p\u003e\u003cp data-pid=\"HEOJYusz\"\u003e拉的一派是荣国府，打的一派是宁国府\u003c/p\u003e\u003cp data-pid=\"BFzD7tw1\"\u003e而手段就是联姻，通过把贾敏嫁给林如海，王夫人嫁给贾政，王熙凤嫁给贾琏，李纨嫁给贾珠\u003c/p\u003e\u003cp data-pid=\"SkmDAKPh\"\u003e来争取荣国府的势力\u003c/p\u003e\u003cp data-pid=\"-sWGySYr\"\u003e是的，林如海、王家应该是新皇帝那一派人物\u003c/p\u003e\u003cp data-pid=\"LXcvoYx4\"\u003e通过联姻来实现化敌为友，这也是为什么王熙凤对林黛玉很友好的缘故\u003c/p\u003e\u003cp data-pid=\"BqAziJ6h\"\u003e这里最有趣的是这一句\u003c/p\u003e\u003cp data-pid=\"4S6NAeTC\"\u003e“起初时，只封袭三世，\u003cb\u003e因当今隆恩盛德，远迈前代\u003c/b\u003e，额外加恩，至如海之父，又袭了一代；至如海，便从科第出身。虽系钟鼎之家，却亦是书香之族。”\u003c/p\u003e\u003cp data-pid=\"SWQ3Iqcn\"\u003e别人都是降低爵位，但是到了林如海父亲这里却是加恩多承袭了一代\u003c/p\u003e\u003cp data-pid=\"5r6U_7f4\"\u003e用意是什么？无非就是让林如海和贾敏的联姻不显得那么突兀\u003c/p\u003e\u003cp data-pid=\"a39wZiIF\"\u003e毕竟结婚的时候，林如海大概没中进士\u003c/p\u003e\u003cp data-pid=\"7u8ce15M\"\u003e进士三年一考，考上进士后要在翰林院学习若干年，但是林如海却很快的成了两淮巡盐御史，这个缺几乎掌握了天下盐税的大半，而盐税又是天下财税的三分之一\u003c/p\u003e\u003cp data-pid=\"uDCT9ir1\"\u003e等于天下的税收里面有六分之一在林如海手中掌握着\u003c/p\u003e\u003cp data-pid=\"L4hZnY4a\"\u003e林如海必然是皇帝宠臣无疑\u003c/p\u003e\u003cp data-pid=\"HEJQD-k1\"\u003e至于他推荐贾雨村当官，无非是因为贾雨村是老皇帝革职的\u003c/p\u003e\u003cp data-pid=\"Lsi4zbZ7\"\u003e并且是寒门\u003c/p\u003e\u003cp data-pid=\"XM6Nx6M1\"\u003e林如海认为，贾雨村是可以供皇帝利用的人物\u003c/p\u003e\u003cp data-pid=\"IMeNFRsC\"\u003e如果到了这一步，这一切还没什么，最要命的是，办了一场秦可卿的葬礼\u003c/p\u003e\u003cp data-pid=\"yOurU4JN\"\u003e这场葬礼成立被打倒的王公的大串联，这极大的引发了老皇帝的兴趣和新皇帝的恐慌\u003c/p\u003e\u003cp data-pid=\"Q4gKds-H\"\u003e老皇帝的兴趣是，他那一派人物还能够串联起来\u003c/p\u003e\u003cp data-pid=\"74Icckwu\"\u003e新皇帝恐惧的是，他老子要复辟\u003c/p\u003e\u003cp data-pid=\"N4L7JZA7\"\u003e于是决定启用暗子，也就是贾政，故而让他女儿当了贵妃\u003c/p\u003e\u003cp data-pid=\"AqrKClr4\"\u003e因为贾家和新皇帝本来就不和睦，所以贾母听说有圣旨，格外恐惧\u003c/p\u003e\u003cp data-pid=\"5nfO8P7e\"\u003e\u003cb\u003e贾母等合家人等心中皆惶惶不定，\u003c/b\u003e不住的使人飞马来往报信。有两个时辰工夫，忽见赖大等三四个管家喘吁吁跑进仪门报喜，又说“奉老爷命，速请老太太带领太太等进朝谢恩”等语。那时贾母正心神不定，在大堂廊下伫立，\u003c/p\u003e\u003cp data-pid=\"VSR11tfE\"\u003e老皇帝对此心知肚明，所以在元妃省亲这件事上，处处为难\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-42ef21c0037dab5e728599ee9cec4ac8_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"932\" data-rawheight=\"768\" data-original-token=\"v2-9338506e12b391f18e24e44352a87b1e\" data-default-watermark-src=\"https://pic3.zhimg.com/v2-27e498f145bdd1f789237c232248e256_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"932\" data-original=\"https://pica.zhimg.com/v2-42ef21c0037dab5e728599ee9cec4ac8_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"0nX3pqJV\"\u003e半日，贾妃方忍悲强笑，安慰贾母，王夫人道：“\u003cb\u003e当日既送我到那不得见人的去处\u003c/b\u003e，好容易今日回家娘儿们一会，不说说笑笑，反倒哭起来。一会子我去了，又不知多早晚才来！”说到这句，不禁又哽咽起来。\u003c/p\u003e\u003cp data-pid=\"lg6Y10A9\"\u003e按理说，此时，贾政家族的崛起就在眼前了\u003c/p\u003e\u003cp data-pid=\"nLKoEUq6\"\u003e但是事情，却又生变了，皇帝惊愕的发现，自己的暗哨王家，不可靠了\u003c/p\u003e\u003cp data-pid=\"ERzRvm5a\"\u003e从凤姐借助王子腾的势力胡作非为这件事上，就看得出来，王子腾开始失控，有权臣化的倾向了\u003c/p\u003e\u003cp data-pid=\"eyn_S6Bd\"\u003e而且王子腾和贾雨村还勾结在了一起\u003c/p\u003e\u003cp data-pid=\"QHJJ_2RJ\"\u003e文武勾结，是大忌讳\u003c/p\u003e\u003cp data-pid=\"pWHx54Ej\"\u003e这让皇帝感到了恐惧\u003c/p\u003e\u003cp data-pid=\"O26lSru3\"\u003e于是明升暗降，让贾政离开京师\u003c/p\u003e\u003cp data-pid=\"wI3fsXQZ\"\u003e目的是肃清贾政的政治势力\u003c/p\u003e\u003cp data-pid=\"VugHSYX3\"\u003e对于尾大不掉的王子腾和贾雨村则继续明升暗降\u003c/p\u003e\u003cp data-pid=\"2EBzep9N\"\u003e当下已是腊月，离年日近，王夫人与凤姐治办年事。王子腾升了九省都检点，贾雨村补授了大司马，协理军机参赞朝政，不题。\u003c/p\u003e\u003cp data-pid=\"RCMmrjPI\"\u003e都检点又称都点检，是五代后期设立的最高军事官职，统领禁军及出征各军，看着是要缺\u003c/p\u003e\u003cp data-pid=\"-VIlUnfA\"\u003e但是这种官职，不能直接统领军队了。\u003c/p\u003e\u003cp data-pid=\"qMkXmiPN\"\u003e如此一来，本来是暗子地位的贾政一家，顿时，就没了价值\u003c/p\u003e\u003cp data-pid=\"7WxedjC3\"\u003e这就直接导致了贾母大寿，宾客了了\u003c/p\u003e\u003cp data-pid=\"hoF6qYtF\"\u003e老皇帝一派的人物，认为他是叛徒，新皇帝一派的人物放弃了他们\u003c/p\u003e\u003cp data-pid=\"hvqprXdV\"\u003e在此期间，贾珍和贾赦应该和当初追随老皇帝的勋贵子弟们串联起来了\u003c/p\u003e\u003cp data-pid=\"r1LLFfTp\"\u003e原来贾珍近因居丧，每不得游顽旷荡，又不得观优闻乐作遣。无聊之极，便生了个破闷之法。日间以习射为由，请了各世家弟兄及诸富贵亲友来较射。\u003c/p\u003e\u003cp data-pid=\"sJ6JXV2-\"\u003e他们对于老皇帝能够胜利坚信不疑\u003c/p\u003e\u003cp data-pid=\"TN-NN9Yt\"\u003e所以才有了，中秋夜宴上的怪话\u003c/p\u003e\u003cp data-pid=\"zGMi8A7q\"\u003e“因又拍着贾环的头，笑道：“以后就这么做去，方是咱们的口气，将来这世袭的前程定跑不了你袭呢。”贾政听说，忙劝说：“不过他胡诌如此，那里就论到后事了。”\u003c/p\u003e\u003cp data-pid=\"ixt2gYc1\"\u003e为什么说这句话，他的意思就是，王家完了\u003c/p\u003e\u003cp data-pid=\"2o2GHevx\"\u003e不仅王夫人生的儿子完了，而且就连自己那个找了凤姐当老婆的儿子贾琏也完了\u003c/p\u003e\u003cp data-pid=\"BUzqnFPQ\"\u003e这个爵位，最后只能给非王家出身的贾环承袭了\u003c/p\u003e\u003cp data-pid=\"ppZAHrF5\"\u003e也是这个时间，贾琏和凤姐的关系开始极端恶化，贾琏有了外宅。\u003c/p\u003e\u003cp data-pid=\"PKxqDvPq\"\u003e他哪里知道，胜利的是新皇帝，老皇帝的复辟一准失败\u003c/p\u003e\u003cp data-pid=\"TTc1g6r_\"\u003e而他的弟弟一家也在皇帝那里早就失宠了，贾家是要一块完蛋了\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp\u003e\u003cbr/\u003e \u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":34403,"thumbnails":["https://picx.zhimg.com/50/v2-ee126e5a07132bb18ca0b182e11e18ad_720w.jpg?source=b6762063"],"favorite_count":192,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1919536855063454866}","attached_info":"CpcICNDLncen1eXbsgEQBBoJNzMzMjE1ODQxIOH71cIGKN8CMBRAY0pDChdUU19TT1VSQ0VfVEhFTUVfV0FLRV9VUBIidGhlbWU6ZGV0ZWN0OmNvbnRlbnQ6dGhlbWU6aWQ6MTYyNxgAIAA6AEooCh1UU19TT1VSQ0VfTkVBUkxJTkVfQ09OVEVOVF9WMhIBMBgAIAA6AFoJMTEzNDM2MjYwYiBmM2YyZGY0NmQzYzc2YTMzMzJlNTc5NmQxOTE5YTE1MHITMTkxOTUzNjg1NTA2MzQ1NDg2NooBCzEyMzAyMDQyNjQ1qgEJcmVjb21tZW5kwgEgY2FhMGRhZGZkMGY4OGQ4YWQwNTk2YWVkZTc4NDE2NzXyAQoIDBIGTm9ybWFs8gEoCAoSJGVjMWNhYzQ3LTNhMGMtNGI1ZS1iZjk3LTE5YzgwMmVhYzQ2NvIBBggLEgIxN4ICAIgC+rfvzfoykgIgY2FhMGRhZGZkMGY4OGQ4YWQwNTk2YWVkZTc4NDE2NzWaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIWQWN0aW9uU2hvckludGVyZXN0UnVsZcoCG0ludGVyYWN0aW9uU2hvckludGVyZXN0UnVsZcoCFlJldmlzaXRWYWx1ZVdlaWdodFJ1bGXKAhhQZXJpb2RJbnRlcmVzdFdlaWdodFJ1bGXKAhVVc2VyTGNuRXhpdFdlaWdodFJ1bGXKAhtIaWdoTGV2ZWxDcmVhdG9yV2VpZ2h0UnVsZTTKAhNUaGVtZVdha2VVcFJld2VpZ2h02gIXVFNfU09VUkNFX1RIRU1FX1dBS0VfVVDoAgT6AgtOT1JNQUxfRkxPV4oDIDRiMGE4YmI2ZWMzMjRiOTI5NTEyZjgwNWVjNWNhNTU4mgMNCgJ2MhAAGgVvdGhlcqgD44wC2AMA6gMTVGhlbWVXYWtlVXBSZWNhbGxlcvoDrAESDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFOi0IAhDsAxjkAyIjdjItYzY0M2RhNTYyMGZmNmQ3N2ZiNmY5OGExNzA0ZjI1ZGU6LQgDEIAFGOADIiN2Mi05NjQ2MjkwZjFjODBjMjE4NmU3YzJkYmE4MWRmMDY4YTotCAMQpAcYgAYiI3YyLTkzMzg1MDZlMTJiMzkxZjE4ZTI0ZTQ0MzUyYTg3YjFlgAQAiAQAkgQGTm9ybWFsmgQBNKAEAKgEALAEALoEBm1hbnVhbMIEAzE2MMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAAAPcvD+BBQAAAAAAAAAAiQVPo2Aw+YLSP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AURkAYAoAZoqAYAkgIuCgk3MzMyMTU4NDESEzE5MTk1MzY4NTUwNjM0NTQ4NjYYBCIKSU1BR0VfVEVYVA==","action_card":false},{"id":"100_1750899350.770","type":"feed","offset":100,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1750899350,"updated_time":1750899350,"target":{"id":"1921208808983737702","type":"answer","url":"https://api.zhihu.com/answers/1921208808983737702","author":{"id":"1405ac8f3a7b65857eec792abb9b351c","url":"https://api.zhihu.com/people/1405ac8f3a7b65857eec792abb9b351c","user_type":"people","url_token":"54-26-90-53-4","name":"风静树止","headline":"心若向阳，无惧悲伤，我若大笑，世界敞亮","avatar_url":"https://picx.zhimg.com/50/v2-d6b3ae814ab1dc920fa8e0788d1ce78b_l.jpg?source=b6762063","is_org":false,"gender":0,"followers_count":145,"is_following":false,"is_followed":false},"created_time":1750831874,"updated_time":1750831874,"voteup_count":1,"thanks_count":0,"comment_count":0,"is_copyable":true,"question":{"id":"15667055388","type":"question","url":"https://api.zhihu.com/questions/15667055388","author":{"id":"9290047880039a42750292852cbac477","url":"https://api.zhihu.com/people/9290047880039a42750292852cbac477","user_type":"people","url_token":"nicole-67-74-10","name":"Nicole","headline":"","avatar_url":"https://picx.zhimg.com/50/v2-f7db3548ec6fdc62e7f6eefb4473f840_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":333,"is_following":false,"is_followed":false},"title":"人真的一定要上班吗？如何破解「读书、上班、退休」的人生范式？","created":1742800658,"answer_count":0,"follower_count":0,"comment_count":15,"bound_topic_ids":[2566,212180],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"excerpt":"其实只要还在赚钱的人，其实细想都是这三种模式，不过是时间和工作形式不同而已， 教育是逃脱不了的，因为每个人小时候都是要接受教育，即使不想也没有办法，父母同意你不上学，但是国家也不允许；目前看来只有智力严重有问题的才可以不上学 接着是上班，大部分人是固定时间上班，而有些人是按照自己的时间上班，我认为只要是用时间换取金钱的，都是在上班，比如自己当老板的，自由工作者，也都是在上班。除非你家里很有钱，足够…","excerpt_new":"其实只要还在赚钱的人，其实细想都是这三种模式，不过是时间和工作形式不同而已， 教育是逃脱不了的，因为每个人小时候都是要接受教育，即使不想也没有办法，父母同意你不上学，但是国家也不允许；目前看来只有智力严重有问题的才可以不上学 接着是上班，大部分人是固定时间上班，而有些人是按照自己的时间上班，我认为只要是用时间换取金钱的，都是在上班，比如自己当老板的，自由工作者，也都是在上班。除非你家里很有钱，足够…","preview_type":"default","preview_text":"","reshipment_settings":"allowed","content":"\u003cp data-pid=\"CrF9yjfZ\"\u003e其实只要还在赚钱的人，其实细想都是这三种模式，不过是时间和工作形式不同而已，\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"A4JqGagL\"\u003e教育是逃脱不了的，因为每个人小时候都是要接受教育，即使不想也没有办法，父母同意你不上学，但是国家也不允许；目前看来只有智力严重有问题的才可以不上学\u003c/p\u003e\u003cp data-pid=\"3V3Viwdu\"\u003e接着是上班，大部分人是固定时间上班，而有些人是按照自己的时间上班，我认为只要是用时间换取金钱的，都是在上班，比如自己当老板的，自由工作者，也都是在上班。除非你家里很有钱，足够你用一生，那么可以不用每天赚点劳务费。\u003c/p\u003e\u003cp data-pid=\"AdFRIFA2\"\u003e其次是退休，本人认为，可以称为退休的人是那些开始有工作，后来不工作的人。\u003c/p\u003e\u003cp data-pid=\"QRh3Z917\"\u003e所以教育是不可避免的，有工作模式，伴随着就是退休模式。人总是要接触这些模式\u003c/p\u003e\u003cp data-pid=\"QYaqUFvR\"\u003e但是两种人除外，一种就是智力严重有问题的不接受教育，后来也不工作；然后就不会退休，完美避开这三种模式；\u003c/p\u003e\u003cp data-pid=\"oWxkY1r1\"\u003e而家里有钱的，教育不可能避免，可以不工作，不退休，只能避免后面的两种模式。\u003c/p\u003e\u003cp data-pid=\"gJUDAwBM\"\u003e因此一个正常人的普通人是一个都避免不了的。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"0gCFsHpD\"\u003e，\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":5,"favorite_count":0,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1921208808983737702}","attached_info":"CsMFCNDLncen1eXbsgEQBBoJNzMzOTM3NzcyIIKm7sIGKAEwAEBkSiQKGVRTX1NPVVJDRV9XQVJNX1VQX05PUk1BTDESATAYACAAOgBaCTExNDE0NjQ0MWIgZjNmMmRmNDZkM2M3NmEzMzMyZTU3OTZkMTkxOWExNTByEzE5MjEyMDg4MDg5ODM3Mzc3MDKKAQsxNTY2NzA1NTM4OKoBCXJlY29tbWVuZMIBIDE0MDVhYzhmM2E3YjY1ODU3ZWVjNzkyYWJiOWIzNTFj8gEKCAwSBk5vcm1hbPIBKAgKEiQ3Y2ZlYzliNC0wMTIyLTRlMTItYjg5OC02MzhlYTAwZGJiOWLyAQYICxICMTeCAgCIAvq37836MpICIDE0MDVhYzhmM2E3YjY1ODU3ZWVjNzkyYWJiOWIzNTFjmgIAygIWU2hvckludGVyZXN0V2VpZ2h0UnVsZcoCFVVzZXJMY25FeGl0V2VpZ2h0UnVsZcoCGENvbnRlbnRXYXJtVXBCcmVha0luUnVsZdoCGVRTX1NPVVJDRV9XQVJNX1VQX05PUk1BTDHoAgL6AgtOT1JNQUxfRkxPV4oDIDRiMGE4YmI2ZWMzMjRiOTI5NTEyZjgwNWVjNWNhNTU4mgMNCgJ2MhAAGgVvdGhlcqgDBdgDAOoDH3RleHRfMTJob3VyX3VuaWZpbnNoZWRfcmVjYWxsZXL6Ax8SDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFgAQAiAQAkgQGTm9ybWFsmgQBMqAEAKgEALAEALoEAmFpwgQDNDAwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA8AQA+QQAAADABf+iP4EFAAAAAAAAAACJBU+jYDD5gtI/kgUAmgUDZGZ0ogUDZGZ0sgUBMbkFAAAAAAAAAADQBQDgBQDoBQDwBRGQBgCgBmmoBgGSAi4KCTczMzkzNzc3MhITMTkyMTIwODgwODk4MzczNzcwMhgEIgpJTUFHRV9URVhU","action_card":false},{"id":"101_1750899350.646","type":"feed","offset":101,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1750899350,"updated_time":1750899350,"target":{"id":"1919475100593390099","type":"answer","url":"https://api.zhihu.com/answers/1919475100593390099","author":{"id":"0cabf9a69e4e6a7775a57d48f1f68149","url":"https://api.zhihu.com/people/0cabf9a69e4e6a7775a57d48f1f68149","user_type":"people","url_token":"zr9558","name":"数学人生","headline":"庾信平生最萧瑟，暮年诗赋动江关。","avatar_url":"https://picx.zhimg.com/50/132f5d0d10e0c5ad4079633336b33eb8_l.jpg?source=b6762063","is_org":false,"gender":1,"badge":[{"type":"best_answerer","description":"数学等 4 个话题下的优秀答主","topic_names":["数学","大学","科研","深度学习（Deep Learning）"],"topic_ids":[1291,2029,2232,89794]},{"type":"identity_people","description":"新加坡国立大学 数学博士"}],"followers_count":141346,"is_following":false,"is_followed":false},"created_time":1750418526,"updated_time":1750418526,"voteup_count":8,"thanks_count":0,"comment_count":0,"is_copyable":false,"question":{"id":"659601191","type":"question","url":"https://api.zhihu.com/questions/659601191","author":{"id":"be648c2a0bdb957d2e53996cc13c8150","url":"https://api.zhihu.com/people/be648c2a0bdb957d2e53996cc13c8150","user_type":"people","url_token":"51-34-79-74","name":"辣椒青菜","headline":"","avatar_url":"https://pic1.zhimg.com/50/v2-cbb5f30248d513593b4dcc3e1d6effa1_l.jpg?source=b6762063","is_org":false,"gender":0,"followers_count":9,"is_following":false,"is_followed":false},"title":"什么是有效的时间管理？","created":1719048707,"answer_count":0,"follower_count":0,"comment_count":0,"bound_topic_ids":[230,15477,196839,181594],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"excerpt":"时间管理没有统一公式 这篇文章是数学家陶哲轩（Terence Tao）关于 时间管理的思考与实践，虽然他一再强调这些只是“零散的个人经验”，但实际上其中包含了很多深入、细致、并且对不同类型工作者都颇具启发性的建议。因为一些评论的启发，我终于决定把自己关于时间管理的一些想法系统地整理出来。其实我很早就动笔了，但写着写着就意识到，自己在这个问题上的经验还远未成熟，更谈不上形成一个清晰、统一的理念（你可以看看我那…","excerpt_new":"时间管理没有统一公式 这篇文章是数学家陶哲轩（Terence Tao）关于 时间管理的思考与实践，虽然他一再强调这些只是“零散的个人经验”，但实际上其中包含了很多深入、细致、并且对不同类型工作者都颇具启发性的建议。因为一些评论的启发，我终于决定把自己关于时间管理的一些想法系统地整理出来。其实我很早就动笔了，但写着写着就意识到，自己在这个问题上的经验还远未成熟，更谈不上形成一个清晰、统一的理念（你可以看看我那…","preview_type":"default","preview_text":"","reshipment_settings":"disallowed","content":"\u003ch2\u003e时间管理没有统一公式 \u003c/h2\u003e\u003cp data-pid=\"4GK9P18g\"\u003e这篇文章是数学家陶哲轩（Terence Tao）关于\u003cb\u003e时间管理的思考与实践\u003c/b\u003e，虽然他一再强调这些只是“零散的个人经验”，但实际上其中包含了很多深入、细致、并且对不同类型工作者都颇具启发性的建议。\u003c/p\u003e\u003cp data-pid=\"E-OjDZME\"\u003e因为一些评论的启发，我终于决定把自己关于时间管理的一些想法系统地整理出来。其实我很早就动笔了，但写着写着就意识到，自己在这个问题上的经验还远未成熟，更谈不上形成一个清晰、统一的理念（你可以看看我那篇关于“快速搭建论文框架”的文章，那算是我为数不多的具体建议之一）。此外，我能说的也仅仅是个人经验，不一定适用于所有人，尤其是不同性格和工作环境的差异相当大。不过，也许有读者愿意在评论里分享自己的看法和建议，这样大家可以互相补充。我也得坦率地承认，我自己其实经常做不到这些建议里讲的东西，事后后悔的次数也不少。\u003c/p\u003e\u003cp data-pid=\"epdPxLGs\"\u003e我可以从一些比较随意的感想谈起。首先，我非常幸运，拥有一些优秀的合作者，他们在我们合写的论文中投入了大量心力。事实上，最近博客上发布的几篇论文，有不少都是由合作者主导完成的。一般来说，合写论文的整体周期比独立写作更长，但平均到每位作者身上的实际工作量反而更少，而且写出来的质量通常更高。我还发现，自己可以同时推进多个合写项目，因为常常在等对方推进下一步，或者在等某个关键结果的出现；但对于独立完成的论文，我往往一次只能处理一篇。\u003c/p\u003e\u003cp data-pid=\"KnyU3VhN\"\u003e由于学期安排的关系，很多论文最终都集中在暑假完成，但其实这些项目的准备期往往非常长。比如我们即将发表的一篇合写论文，其实早在三四年前就开始写了；我对波映射整体正则性问题的思考甚至可以追溯到 2000 年左右，虽然其中绝大多数时间都处于搁置状态。所以，即便在某一周内发布了一篇论文，并不意味着那是从零开始、在一周内完成的，而是长期积累的结果，许多过程也未必为外界所见。\u003c/p\u003e\u003cp data-pid=\"REOTGTBR\"\u003e我每天能不能真正做数学研究，其实起伏很大。有时能专心思考某个问题一两个小时，有时只想整理草稿，或者把我和合作者写的初稿输出来；更有时候则完全提不起精神做数学，只想回邮件、处理些杂事，甚至只是散步或小憩。我发现，把任务安排和自己的状态对应起来会很有帮助。如果某个下午刚好有空，而且状态不错，我就会把门关上、断掉网络，专注处理一篇拖延已久的论文；如果状态一般，那就处理邮件、审稿、写博客、准备课件等，选择适合当前精力水平的任务。数学研究中一个幸运之处是，除去教学，大多数任务的时间安排都相对灵活，不必硬性安排在特定时段内。[当然，也正因如此，更要避免等到任务迫在眉睫才开始处理，否则会打乱整体节奏，导致疲于奔命。]\u003c/p\u003e\u003cp data-pid=\"_XhQjb-g\"\u003e准确评估自己某一时间段内的工作能力也十分关键，比如判断今天剩下的时间能完成什么任务。这个评估需要考虑多方面的因素，包括当前的环境、精力、动机、即将到来的安排、可用资源以及可能的干扰。如果过于乐观或悲观地估计自己的能力，都会导致要么接下太多任务、结果无法完成，要么接得太少、效率低下。我在这方面有过教训，两种情况都经历过。\u003c/p\u003e\u003cp data-pid=\"wtbbjp_h\"\u003e尽管我的待办清单里有各类任务，复杂度、难度和时长差异很大，但只要是需要集中注意力的事情，我都会尽量一次只做一件，把其他任务推迟或暂时搁置。我发现自己只有在任务本身不需要太多专注的时候，才可能进行所谓的“多任务处理”。而这通常出现在我对每项任务都提不起太大兴趣的时候。很多任务其实比我想象的更耗时间和精力，所以我学会了寻找合适的暂停点，比如证明了某个关键引理，或者把刚刚想到的一个想法完整记下来。这样可以暂时放下这项任务，也不会在之后重新启动时找不到头绪。最忌讳的是在任务未达“存档点”时就草草中断，那样它很容易被遗忘，或者一直挂在心头，干扰后续工作；即使重新开始，也要从更早的地方重新来过。当然，并不是每项任务都要一次性做完，只要留下清晰的“落脚点”，能继续衔接上就好。比如我偶尔写一些纸质信件，通常是状态不佳、不想做数学的时候，我会先打出来、装信封，然后放到“待寄”文件盘里，不会马上去寄。等到一堆文书工作积攒起来，而我又没有更重要的事情时，就一次性处理完。我发现，电脑重启或无法使用的时候，正是处理这些任务的好时机。\u003c/p\u003e\u003cp data-pid=\"mrjC5hAl\"\u003e通常来说，那些不需要太多注意力的任务适合集中时间批量处理，而需要高度专注的任务则应该单独安排、尽量减少干扰。\u003c/p\u003e\u003cp data-pid=\"_ytBiAkn\"\u003e类似“存档点”的概念，还有一个重要策略是将大型任务拆分成几个相对独立的小模块。每个小模块最好都有清晰的目标和即时的成就感，这会大大提升推进的动力。举个例子，我写庞加莱猜想系列讲义时，一共写了十九篇。如果一开始就打算写成一整篇冗长的论文或专著，我恐怕永远不会动笔。正是因为每篇篇幅不大、可以独立成文，我才有信心逐步完成。此外，我当初也提前公布了这些讲座的计划，相当于“把自己逼到墙角”，一旦开始，就不太容易半途而废。\u003c/p\u003e\u003cp data-pid=\"279YfLe2\"\u003e现代文本编辑器的一个特别好处是可以随时保存草稿，之后慢慢完善。这对写长篇论文尤其重要，因为可以把写作过程拆解成一系列更小的任务，逐步完成。我很佩服那些电脑时代之前的数学家，他们能够手写出高质量的论文甚至整本书——即使有秘书协助，我自己恐怕也做不到。\u003c/p\u003e\u003cp data-pid=\"kj8QLCz8\"\u003e对于未来很可能频繁使用的技能，值得花时间系统学习。比如 LaTeX，如果你打算长期写论文，那就不应该只满足于“能用”，而应该深入掌握表格、插图、数组的排版技巧。最近我也在尝试用一些宏命令来快速输入常用的 LaTeX 模板，比如输入定理环境、证明环境的格式。这种做法单次节省的时间可能不多，但长期积累下来效率还是会明显提高。更重要的是，这种“自己很高效”的感觉会激励士气，尤其在写一篇冗长的论文时，心理上的鼓舞非常重要。\u003c/p\u003e\u003cp data-pid=\"APEmpAQN\"\u003e此外，也要学会策略性地推迟、延后、委托，甚至有意识地“拖延”某些任务，转而先做别的事情。有些任务其实没那么紧迫，或者随着时间推移变得更容易处理。有时等自己掌握了更好的工具，或者外部条件改善了，那件事反而不再棘手，甚至可能不需要再做。比如我现在写的那篇关于波映射的论文，拖了好多年，我自己也觉得很沮丧。但回头看，最初的思路技术细节太复杂，根本写不下去。后来等到相关领域的理论发展成熟了，才终于有可能用更合理的方式处理这个问题。也许，这篇关于时间管理的文章本身就是类似的例子——我博客里还有不少未完成的草稿，当初写的时候觉得还不到火候，只能等待灵感补全它们。并不是每个想法都能顺利成长为一篇像样的文章（可参考我那篇《用好废纸篓》）。\u003c/p\u003e\u003cp data-pid=\"RaJV59Cg\"\u003e最后一个建议是：选一种适合自己的工作体系，并认真执行。一个不走心的体系可能还不如干脆没有体系。[顺带推论：不要试图一口气从零搭建一个非常复杂的系统，否则很难坚持下去。更实际的方法是让体系随时间演进，逐步完善]。我的体系包括一个 PDA，同步到笔记本电脑、邮箱、文件盘，还有办公室里一块专属黑板。这个体系看上去不复杂，但只有我自己知道怎么用，我大概也解释不清楚，但用习惯了，确实很有效。（我也真心希望那块黑板永远不会被擦掉！）不过工作体系是很个性化的，我无法替别人做选择。但我相信，拥有体系之后，大脑可以腾出很多空间来。不需要反复记着某个时间点要做什么任务，也不用时时提醒自己某个项目的各种细节。我就能把注意力更多投入到理解论证、解决难题这些真正需要思考的事情上。而且，我也很享受把一项任务从清单上划掉的感觉，有时候正是这种小满足感让我完成了那些本来没有动力去做的事情。与此同时，也不要过度执着于维护这个体系，我自己的经验是，把 1% 到 5% 的时间用于时间管理就够了，剩下的 95% 到 99% 应该真正花在做事本身。\u003c/p\u003e\u003cp data-pid=\"tQmfnyD5\"\u003e哦，还有一点想补充：有时也要学会打破规则。很多次，我本来打算中午随便吃点、接着工作，结果被同事或访客叫去吃饭。事后才发现，那顿饭不论是从数学角度，还是其他方面，都收获颇多，只不过不是我原计划里的方式而已。（在会议期间错过某场报告，甚至选择不去参会、自己找地方写论文，也是类似的情况。）\u003c/p\u003e\u003cp data-pid=\"lqx67OtI\"\u003e参考链接：\u003cu\u003e\u003ca href=\"https://link.zhihu.com/?target=https%3A//terrytao.wordpress.com/2008/08/07/on-time-management/\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://\u003c/span\u003e\u003cspan class=\"visible\"\u003eterrytao.wordpress.com/\u003c/span\u003e\u003cspan class=\"invisible\"\u003e2008/08/07/on-time-management/\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/u\u003e\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":338,"favorite_count":26,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1919475100593390099}","attached_info":"CvEFCNDLncen1eXbsgEQBBoJNzMzMTg3MTI5IN6I1cIGKAgwAEBlSkEKLFRTX1NPVVJDRV9UV09UT1dFUl9TSE9SVElOVEVSRVNUX1JFQ0FMTF9URVhUEgEwGAAgADoKeyJyYXciOiIifVoJMTA4ODU1ODk4YiBmM2YyZGY0NmQzYzc2YTMzMzJlNTc5NmQxOTE5YTE1MHITMTkxOTQ3NTEwMDU5MzM5MDA5OYoBCTY1OTYwMTE5MaoBCXJlY29tbWVuZMIBIDBjYWJmOWE2OWU0ZTZhNzc3NWE1N2Q0OGYxZjY4MTQ58gEKCAwSBk5vcm1hbPIBKAgKEiRkNTdmYTNlMC0zNDRhLTQzZTYtYTNmMi04YzRkOWRiNGIwNzPyAQYICxICMTeCAgCIAvq37836MpICIDBjYWJmOWE2OWU0ZTZhNzc3NWE1N2Q0OGYxZjY4MTQ5mgIAygIWU2hvckludGVyZXN0V2VpZ2h0UnVsZcoCFVVzZXJMY25FeGl0V2VpZ2h0UnVsZcoCHEJheWVzRmlyc3RMZXZlbElzb2xhdGlvblJ1bGXaAixUU19TT1VSQ0VfVFdPVE9XRVJfU0hPUlRJTlRFUkVTVF9SRUNBTExfVEVYVOgCBPoCC05PUk1BTF9GTE9XigMgNGIwYThiYjZlYzMyNGI5Mjk1MTJmODA1ZWM1Y2E1NTiaAw0KAnYyEAAaBW90aGVyqAPSAtgDAOoDGmZlZWRfYXR0bV90d290b3dlcl92Ml90ZXh0+gMfEgxVTktOT1dOX01PREUgACoNTk9fSU1BR0VfTU9ERYAEAIgEAJIEBk5vcm1hbJoEATSgBACoBACwBAC6BAJhacIEAzQwMMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAwPsipD+BBQAAAAAAAAAAiQVPo2Aw+YLSP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AURkAYAoAZqqAYAkgIuCgk3MzMxODcxMjkSEzE5MTk0NzUxMDA1OTMzOTAwOTkYBCIKSU1BR0VfVEVYVA==","action_card":false}],"paging":{"is_end":false,"is_start":false,"next":"https://www.zhihu.com/api/v3/feed/topstory/recommend?action=down\u0026ad_interval=-10\u0026after_id=101\u0026desktop=true\u0026end_offset=106\u0026page_number=18\u0026session_token=f3f2df46d3c76a3332e5796d1919a150","previous":"https://www.zhihu.com/api/v3/feed/topstory/recommend?action=pull\u0026ad_interval=-10\u0026before_id=101\u0026desktop=true\u0026end_offset=106\u0026page_number=18\u0026session_token=f3f2df46d3c76a3332e5796d1919a150","totals":0},"fresh_text":"推荐已更新"}
