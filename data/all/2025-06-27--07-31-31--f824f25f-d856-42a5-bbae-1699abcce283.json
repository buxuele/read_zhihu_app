{"data":[{"id":"42_1750980738.449","type":"feed","offset":42,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1750980738,"updated_time":1750980738,"target":{"id":"3614888954","type":"answer","url":"https://api.zhihu.com/answers/3614888954","author":{"id":"0b380aef4af544a1b79a291b4e105a4e","url":"https://api.zhihu.com/people/0b380aef4af544a1b79a291b4e105a4e","user_type":"people","url_token":"li-lin-lang-2","name":"王富贵儿","headline":"用户至上丨内容行业丨IP孵化创业者丨擅长自媒体、职场类话题","avatar_url":"https://pic1.zhimg.com/50/v2-92cf91988100846f15325b9df296af55_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":10328,"is_following":false,"is_followed":false},"created_time":1725374011,"updated_time":1725853809,"voteup_count":4262,"thanks_count":237,"comment_count":322,"is_copyable":false,"question":{"id":"665793278","type":"question","url":"https://api.zhihu.com/questions/665793278","author":{"id":"87c7895b3981d5d53ae5f735f9c0b0c2","url":"https://api.zhihu.com/people/87c7895b3981d5d53ae5f735f9c0b0c2","user_type":"people","url_token":"81-89-43-37-98","name":"小王情感","headline":"","avatar_url":"https://picx.zhimg.com/50/v2-d0f434e541f7e583d3255b64da1a5a77_l.jpg?source=b6762063","is_org":false,"gender":0,"followers_count":1111,"is_following":false,"is_followed":false},"title":"为啥“亮亮丽君夫妇”总有吃不完的苦？","created":1725078651,"answer_count":0,"follower_count":0,"comment_count":42,"bound_topic_ids":[525,10359,44316,2579867,3133330],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"thumbnail":"https://pic1.zhimg.com/50/v2-c4296bf6ca2c93d9619a23e3b284e913_720w.jpg?source=b6762063","excerpt":"他们两个之所以吃这么多苦，是典型的能力跟野心不匹配。 导致的结果就是：走的每一步都是昏招，纯属自讨苦吃。利益相关：曾服务于北京头部互联网内容公司，参与过多个千万粉丝量账号的运营。我想从专业的角度分析一下： 为什么有的博主，几万粉就能赚的盆满钵满，而他们空有40万的粉丝却没办法变现，还要东奔西跑去北京找工作，找工作也不顺利? 如果是我做他们的账号，会在哪个节点做哪些事情，培养哪些能力，可以试着挽回局面让…","excerpt_new":"他们两个之所以吃这么多苦，是典型的能力跟野心不匹配。 导致的结果就是：走的每一步都是昏招，纯属自讨苦吃。利益相关：曾服务于北京头部互联网内容公司，参与过多个千万粉丝量账号的运营。我想从专业的角度分析一下： 为什么有的博主，几万粉就能赚的盆满钵满，而他们空有40万的粉丝却没办法变现，还要东奔西跑去北京找工作，找工作也不顺利? 如果是我做他们的账号，会在哪个节点做哪些事情，培养哪些能力，可以试着挽回局面让…","preview_type":"default","preview_text":"","reshipment_settings":"disallowed","content":"\u003cp data-pid=\"5r221-8o\"\u003e\u003cb\u003e他们两个之所以吃这么多苦，是典型的能力跟野心不匹配。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"FfTbW3A_\"\u003e\u003cb\u003e导致的结果就是：走的每一步都是昏招，纯属自讨苦吃。\u003c/b\u003e\u003c/p\u003e\u003cblockquote data-pid=\"zmsF0073\"\u003e利益相关：曾服务于北京头部互联网内容公司，参与过多个千万粉丝量账号的运营。我想从专业的角度分析一下：\u003cbr/\u003e为什么有的博主，几万粉就能赚的盆满钵满，而他们空有40万的粉丝却没办法变现，还要东奔西跑去北京找工作，找工作也不顺利?\u003cbr/\u003e如果是我做他们的账号，会在哪个节点做哪些事情，培养哪些能力，可以试着挽回局面让他们的流量变成真金白银的收入？\u003c/blockquote\u003e\u003cp data-pid=\"tC3jy7U0\"\u003e\u003cb\u003e首先第一个问题：为什么40万粉丝量的账号养活不了生活在农村的他们？\u003c/b\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-29b188e93fe3c3c3f26a59d8f361849c_1440w.jpg\" data-rawwidth=\"1170\" data-rawheight=\"772\" data-size=\"normal\" data-original-token=\"v2-e98115ec573bf60eed935d70ff7b7674\" data-default-watermark-src=\"https://pic1.zhimg.com/v2-662b6a7d553cc28615944fab46af6552_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1170\" data-original=\"https://pica.zhimg.com/v2-29b188e93fe3c3c3f26a59d8f361849c_r.jpg\"/\u003e\u003cfigcaption\u003e他们的账号主页\u003c/figcaption\u003e\u003c/figure\u003e\u003cp data-pid=\"eUeSrKKe\"\u003e因为他们的粉丝不值钱。\u003c/p\u003e\u003cp data-pid=\"2JreKFUw\"\u003e正常情况下抖音博主的广告报价是粉丝量的十分之一，也就是40W粉丝的账号一条商务理论上可以卖4W左右，但亮亮丽君接不到合适的广告。后台肯定有品牌找他们，不过估计都是三无品牌他们不想接。\u003c/p\u003e\u003cp data-pid=\"rKZvW8dG\"\u003e这是我用第三方数据平台查的他账号粉丝画像：\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-bcffcefd6b8a8a2c9a67d4944036213c_1440w.jpg\" data-rawwidth=\"1170\" data-rawheight=\"1030\" data-size=\"normal\" data-original-token=\"v2-97e88e5d21ee915ce4451964a3f2e7ce\" data-default-watermark-src=\"https://pic1.zhimg.com/v2-95023c40bc47920ec80f051d9cad97be_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1170\" data-original=\"https://pic1.zhimg.com/v2-bcffcefd6b8a8a2c9a67d4944036213c_r.jpg\"/\u003e\u003cfigcaption\u003e三方数据平台提供的粉丝画像\u003c/figcaption\u003e\u003c/figure\u003e\u003cp data-pid=\"qrSv2Pbz\"\u003e男女比例8:2。\u003c/p\u003e\u003cp data-pid=\"FRZ4qtOx\"\u003e80%都是男粉！男粉也不意味着不能变现，钓鱼，篮球，游戏，汽车···这些账号领域博主也都是男粉居多，但亮亮丽君他们的粉丝是最不值钱的“爱凑热闹的男粉”，而不是有消费力的男性用户。\u003c/p\u003e\u003cp data-pid=\"ntQIyAqb\"\u003e他的账号粉丝是通过他们的事情被曝光之后，获得的大量关注积累的。\u003cb\u003e而不是通过自己做内容一条一条优质短视频积累的。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"EcARmCSF\"\u003e用户更多关注的是烂尾房这个事件，而不是他们这两个人。这个关注是中国人骨子里爱凑热闹的特点决定的。\u003cb\u003e所以粉丝跟他们之间，没有粘性，也没有忠诚度。这样的粉丝，哪怕是做到了1000万，也不值钱。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"4xJfjJMz\"\u003e所以他们之前开过直播卖一些日常百货，没有什么销量。当然也有直播流量池跟短视频的流量池不是同一个用户群的原因。\u003c/p\u003e\u003cp data-pid=\"vhViHJ0-\"\u003e\u003cb\u003e除了粉丝比例问题，第二个原因是他们的账号内容整体传达的悲观情绪问题。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"dT7gMJdH\"\u003e他们在短视频平台上一直都在诉苦，\u003cb\u003e房子烂尾，贷款还不上，维权被人打，被迫搬家，卖樱桃被平台封\u003c/b\u003e···还有一些日常很颓的，自己没做错什么但生活就是不如意，仿佛有人刻意针对他俩似的。\u003c/p\u003e\u003cp data-pid=\"KMreWep3\"\u003e这种悲苦人设，是账号大忌，也是平台忌讳。平台需要的是正能量的账号，和正能量的内容。\u003c/p\u003e\u003cp data-pid=\"M50GIgDf\"\u003e冷知识：微信公众号时代，第一条破千万阅读量的文章，是一篇“鸡汤文”。其中就有平台的推波助澜。\u003c/p\u003e\u003cp data-pid=\"6BODMZHS\"\u003e《隐入烟尘》这个电影为什么被全网下架？就是因为它太真实，但又太苦了。这是不符合当下社会主义主旋律的。\u003c/p\u003e\u003cp data-pid=\"hHUSLy2W\"\u003e所以他们哪怕做中视频，用流量赚收益，也不可能爆。平台也不会给他们的视频推流。因此在中视频收益减少，以及内容不受平台喜欢的双重影响下，他们的收入越来越少，只能被迫找工作成为打工人。\u003c/p\u003e\u003cp data-pid=\"hEipZ-9r\"\u003e账号为什么忌讳这样的人设？\u003c/p\u003e\u003cp data-pid=\"wm7wEE1O\"\u003e因为品牌主不喜欢。\u003c/p\u003e\u003cp data-pid=\"-AIZeC74\"\u003e\u003cb\u003e想象一下你是品牌宣传部门的，你愿意看到你家的产品出现在一个过的不顺心的博主视频里面吗？它会给用户一种糟糕的心理暗示：用了他们的产品会过的不好。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"yReVYcH5\"\u003e更何况，一查后台数据，粉丝还都是没有购买力的男粉。能收到品牌的投放就见鬼了。\u003c/p\u003e\u003cp data-pid=\"91GkfSXb\"\u003e\u003cb\u003e至于近期去北京找工作，我更倾向于他们做了一个视频内容的选题：他们想拍一些北京找工作的相关视频。\u003c/b\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-449d502f377919c2a11bdba8201c63ab_1440w.jpg\" data-rawwidth=\"1170\" data-rawheight=\"672\" data-size=\"normal\" data-original-token=\"v2-8355440a39f11a901285d3e725812a37\" data-default-watermark-src=\"https://pic2.zhimg.com/v2-359214b6437ac51c2c20b22aa3342a93_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1170\" data-original=\"https://pic4.zhimg.com/v2-449d502f377919c2a11bdba8201c63ab_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"p1TowLci\"\u003e而不是真的想找工作。\u003c/p\u003e\u003cp data-pid=\"VjQ_AoNW\"\u003e他们是曾经互联网热搜上的主人公，对于任何企业都是一颗随时会爆的炸弹，什么样的公司愿意冒这样的风险给他们工作机会呢？\u003cb\u003e如果工作不顺心，他们会不会利用短视频向公司施压呢？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"288Z6qzL\"\u003e更何况，他们有什么样的能力，可以做什么样的工作呢？\u003c/p\u003e\u003cp data-pid=\"rohHzNte\"\u003e\u003cb\u003e在北京这样的城市，没有学历，没有资源，连年龄也不占优势\u003c/b\u003e，\u003cb\u003e有很长一段时间没有工作的空窗期\u003c/b\u003e，退一步讲，哪怕没上过热搜，除了那些苦哈哈的工作，也基本不会有HR会给他们offer的。\u003c/p\u003e\u003cp data-pid=\"L_4g0JyH\"\u003e第二个问题：如果拥有他们相同的经历，做什么可以破局？\u003c/p\u003e\u003cp data-pid=\"7jxiCzms\"\u003e\u003cb\u003e方法一：洗粉。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"2zyZBjgZ\"\u003e委婉的表达叫：账号内容迭代升级。\u003c/p\u003e\u003cp data-pid=\"M1l2yK6M\"\u003e举个很简单的例子，千万粉丝账号博主痞幼，如果大家还有印象的话，她刚开始用机车+擦边吸粉。这样来的男粉是不值钱的，也接不到广告。后来她开始跨界，跟梅尼耶，猴哥，八戒，虎哥一边组CP，一边切汽车领域的内容。\u003c/p\u003e\u003cp data-pid=\"cQK_wAC_\"\u003e\u003cb\u003e从机车擦边到汽车，以及跟梅尼耶组CP的内容变换，就叫做洗粉。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"1zCI0Wel\"\u003e这样账号之前的粉丝可能会掉一些，但不会掉完，粉丝的数量还在，逐步隐藏之前的视频，全都变成后面的正常内容，品牌主看到的都是近期的视频，就能正常接广告了。\u003c/p\u003e\u003cp data-pid=\"ihm08UR8\"\u003e亮亮丽君可以怎么洗？\u003c/p\u003e\u003cp data-pid=\"CqXqCoyP\"\u003e第一个时间点，在丽君怀孕的时候转型做母婴博主。\u003c/p\u003e\u003cp data-pid=\"a4XmabZk\"\u003e前面几期数量差没关系的，有一期数据好就足够了；不会写文案没关系的，找几个母婴博主抄就好了，稍微改一改文案就能用，什么孕期准备，孕期用品，饮食，如何避免产后抑郁，怎么做一个合格的准爸爸···\u003c/p\u003e\u003cp data-pid=\"YDNAp3w6\"\u003e\u003cb\u003e母婴这个赛道的选题太多了，而且吸引来的都是女粉。坚持下去绝对能接到商务！\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"yR6XyQgy\"\u003e第二个节点，在他们离开郑州回农村老家的时候做农村博主。\u003c/p\u003e\u003cp data-pid=\"RfbI702H\"\u003e可以爆改，爆改他们的老房子做装修博主；这样的账号平台上多的是，找一个对标账号抄就完事了。\u003c/p\u003e\u003cp data-pid=\"6Lg_LhUk\"\u003e\u003cb\u003e账号的内容一定要主打：虽然活在泥泞里，但是要在泥泞里开出花来。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"h6IJjc3Q\"\u003e这就是妥妥的正能量了！\u003c/p\u003e\u003cp data-pid=\"P5Y6ero6\"\u003e有了正能量以后，主动联系一些郑州本地的企业或者品牌做一些联动，可以试着探访一下白象，卫龙，南街村，张仲景···\u003c/p\u003e\u003cp data-pid=\"2_CUsITF\"\u003e被拒绝了一次没关系，只要成功一次，稍微追加点dou+投一点流量出来，后续的邀约肯定源源不断，双赢。\u003c/p\u003e\u003cp data-pid=\"Zcx_rL5n\"\u003e在泥土里开出花来，如果他们成为了这样的乐观的账号博主，相信媒体肯定会愿意继续追着报道他们的。\u003c/p\u003e\u003cp data-pid=\"Y5l75zpG\"\u003e多好的例子，多好的新闻素材。\u003c/p\u003e\u003cp data-pid=\"yTq14T16\"\u003e一旦成为了积极正能量的视频博主，品牌投放也就来了。\u003c/p\u003e\u003cp data-pid=\"Yw20mhN7\"\u003e然后一切都会朝着正向的循环发展了。\u003c/p\u003e\u003cp data-pid=\"3kBtkXMn\"\u003e\u003cb\u003e没有能力，甘于平庸也不会吃这么多苦。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"o8VyUO9m\"\u003e\u003cb\u003e普通人嘛，人生就是这样，拼尽了全力过着平凡的一生。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"-Ft9S4RU\"\u003e\u003cb\u003e怕就怕这种，心比天高，命比纸薄。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"SI0-KWjp\"\u003e\u003cb\u003e偶然获取了流量，不学习规则，不提升自身能力，横冲直撞，如果这样的人不吃苦，随随便便就能成功，才是社会最大的灾难。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"_Jdz9Z1H\"\u003e\u003cb\u003e~~~~\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"WVE6FI5o\"\u003e9.6号更新，手动分割线，没想到这个回答火了。这里有一些我以前写的回答关于如何做自媒体账号相关的干货，有兴趣的可以选择性看看。\u003c/p\u003e\u003cp data-pid=\"fX_HY3SX\"\u003e1：网红是如何赚钱的？\u003c/p\u003e\u003ca data-draft-node=\"block\" data-draft-type=\"link-card\" href=\"https://www.zhihu.com/question/56969081/answer/3458777788?utm_psn=1815408894220050432\" data-image=\"https://picx.zhimg.com/v2-61361352c11f47c160ca4e7437fd7a47_720w.jpg\" data-image-width=\"566\" data-image-height=\"381\" class=\"internal\"\u003e网红到底有多赚钱？\u003c/a\u003e\u003cp data-pid=\"Zbj1DlDV\"\u003e2：做自媒体的门槛是什么，什么样的人不适合做自媒体？\u003c/p\u003e\u003ca data-draft-node=\"block\" data-draft-type=\"link-card\" href=\"https://www.zhihu.com/question/480214278/answer/3583503390?utm_psn=1815409108716752896\" data-image=\"https://pic3.zhimg.com/v2-d5ada038b4053fc1dab946052fea5d4c_720w.jpg\" data-image-width=\"845\" data-image-height=\"884\" class=\"internal\"\u003e如何优雅劝退他人做自媒体？\u003c/a\u003e\u003cp data-pid=\"hJsU_Q9F\"\u003e3：小白做账号是不是要花钱搞知识付费？\u003c/p\u003e\u003ca data-draft-node=\"block\" data-draft-type=\"link-card\" href=\"https://www.zhihu.com/question/661757238/answer/3572947760?utm_psn=1815408334238527488\" data-image=\"https://pic2.zhimg.com/v2-bcbd2fbbd2193b44b3beb5c9103a9b6d_720w.jpg\" data-image-width=\"1000\" data-image-height=\"813\" class=\"internal\"\u003e花 50 万报网红参哥服务，三个月 0 变现、涨粉 189 个，网红参哥回应了，如何看待此事？\u003c/a\u003e\u003cp data-pid=\"zZr3H3DF\"\u003e4：下一个自媒体风口是什么？\u003c/p\u003e\u003ca data-draft-node=\"block\" data-draft-type=\"link-card\" href=\"https://www.zhihu.com/question/456685079/answer/3618646260?utm_psn=1816442214131322880\" class=\"internal\"\u003e下一个自媒体风口会是什么呢？\u003c/a\u003e\u003cp data-pid=\"iYDUaN0J\"\u003e\u003cb\u003e没有卖课，真诚分享，放心阅读。\u003c/b\u003e\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":348747,"thumbnails":["https://picx.zhimg.com/50/v2-c4296bf6ca2c93d9619a23e3b284e913_720w.jpg?source=b6762063","https://pica.zhimg.com/50/v2-4f7cb79ff71bc85e6a0ee94f81661317_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-0625281a9443c273fbab542fbd47f1a1_720w.jpg?source=b6762063"],"favorite_count":2939,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 3614888954}","attached_info":"CtEGCPuP2/76svilkAEQBBoJNjg3MzIyODY3ILu83LYGKKYhMMICQCpKJwocVFNfU09VUkNFX0NPTkNFUFRfV09SRF9NRVJHRRIBMBgAIAA6AFoJMTEwMjMxNzQ5YiBiM2U4YjlmMGEyYzE1MjM1ZDIwYmY3YjA3MWFiY2ZhNXIKMzYxNDg4ODk1NIoBCTY2NTc5MzI3OKoBCXJlY29tbWVuZMIBIDBiMzgwYWVmNGFmNTQ0YTFiNzlhMjkxYjRlMTA1YTRl8gEKCAwSBk5vcm1hbPIBKAgKEiRhODdlYjE1Yi1kYzUwLTQ2MTktOGUzMS1iOTg0NjY5Mzg0NjPyAQUICxIBOIICAIgC3fvW9PoykgIgMGIzODBhZWY0YWY1NDRhMWI3OWEyOTFiNGUxMDVhNGWaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxlygIUQ29udGVudEFnZVdlaWdodFJ1bGXaAhxUU19TT1VSQ0VfQ09OQ0VQVF9XT1JEX01FUkdF6AID+gILTk9STUFMX0ZMT1eKAyA4MGIyYjI3ZGRlMDM0ZjM3ODQxNTk3N2I3YzQxMzBkOJoDDQoCdjIQABoFb3RoZXKoA8ukFdgDAOoDIUNvbmNlcHRXb3JkTWVyZ2VOZXdWMVBvb2xSZWNhbGxlcvoDrAESDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFOi0IAhCSCRiEBiIjdjItZTk4MTE1ZWM1NzNiZjYwZWVkOTM1ZDcwZmY3Yjc2NzQ6LQgCEJIJGIYIIiN2Mi05N2U4OGU1ZDIxZWU5MTVjZTQ0NTE5NjRhM2YyZTdjZTotCAMQkgkYoAUiI3YyLTgzNTU0NDBhMzlmMTFhOTAxMjg1ZDNlNzI1ODEyYTM3gAQAiAQAkgQGTm9ybWFsmgQBM6AEAKgEALAEALoEBm1hbnVhbMIEAzE2MMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAYBB4sT+BBQAAAAAAAAAAiQUizqEVZ87LP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AUIkAYAoAYqqAYBkgIlCgk2ODczMjI4NjcSCjM2MTQ4ODg5NTQYBCIKSU1BR0VfVEVYVA==","action_card":false},{"id":"43_1750980738.354","type":"feed","offset":43,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1750980738,"updated_time":1750980738,"target":{"id":"666552214","type":"article","url":"https://api.zhihu.com/articles/666552214","author":{"id":"ce0900ccef66605c33bb3f018c20d9c9","url":"https://api.zhihu.com/people/ce0900ccef66605c33bb3f018c20d9c9","user_type":"people","url_token":"deja-vu-66-57","name":"Deja vu","headline":"华五硕在读","avatar_url":"https://picx.zhimg.com/50/v2-81ef28db0e49fc02cb28efd33af29c3b_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":274,"is_following":false,"is_followed":false},"title":"一文带你看懂DDPM和DDIM（含原理简易推导，pytorch代码）","comment_permission":"all","created":1699853695,"updated":1720425652,"voteup_count":1619,"voting":0,"comment_count":117,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"写在最前面，此文所要介绍的两个模型是AIGC领域大火的Diffusion模型原版及其变种，其中DDPM是开山之作，DDIM是基于DDPM的。DDPM原始论文的原理推导非常复杂，对于刚入门的新手非常不友好。本文 将对原理进行一个简单梳理，过程可能不严谨，适用于有一定概率论和深度学习基础的新手小白，并结合pytorch代码实现，若有错误希望能够得到指正。本文仅作学习使用，不作商业用途，若有版权问题请联系笔者，代码是在他人基础上进行改的…","excerpt_new":"写在最前面，此文所要介绍的两个模型是AIGC领域大火的Diffusion模型原版及其变种，其中DDPM是开山之作，DDIM是基于DDPM的。DDPM原始论文的原理推导非常复杂，对于刚入门的新手非常不友好。本文 将对原理进行一个简单梳理，过程可能不严谨，适用于有一定概率论和深度学习基础的新手小白，并结合pytorch代码实现，若有错误希望能够得到指正。本文仅作学习使用，不作商业用途，若有版权问题请联系笔者，代码是在他人基础上进行改的…","preview_type":"default","preview_text":"","content":"\u003cp data-pid=\"JhIBb9Kh\"\u003e写在最前面，此文所要介绍的两个模型是AIGC领域大火的Diffusion模型原版及其变种，其中DDPM是开山之作，DDIM是基于DDPM的。DDPM原始论文的原理推导非常复杂，对于刚入门的新手非常不友好。本文\u003cb\u003e将对原理进行一个简单梳理\u003c/b\u003e，过程可能不严谨，\u003cb\u003e适用于有一定概率论和深度学习基础的新手小白\u003c/b\u003e，并结合pytorch代码实现，若有错误希望能够得到指正。\u003c/p\u003e\u003cp data-pid=\"jZfI2_ld\"\u003e本文仅作学习使用，不作商业用途，若有版权问题请联系笔者，代码是在他人基础上进行改的，感谢开源社区提供的pytorch代码实现。笔者本人学习中参考的主要资料为：\u003c/p\u003e\u003cp data-pid=\"1zyqfVfH\"\u003e大白话DDPM：\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1tz4y1h7q1\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://www.\u003c/span\u003e\u003cspan class=\"visible\"\u003ebilibili.com/video/BV1t\u003c/span\u003e\u003cspan class=\"invisible\"\u003ez4y1h7q1\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"f7kMFutq\"\u003eDDPM和DDIM公式推导：\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1Zh411A72y\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://www.\u003c/span\u003e\u003cspan class=\"visible\"\u003ebilibili.com/video/BV1Z\u003c/span\u003e\u003cspan class=\"invisible\"\u003eh411A72y\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"RsaPnWTh\"\u003e迪哥讲Diffusion（含原理和代码）：\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1pD4y1179T\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://www.\u003c/span\u003e\u003cspan class=\"visible\"\u003ebilibili.com/video/BV1p\u003c/span\u003e\u003cspan class=\"invisible\"\u003eD4y1179T\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"YXJ_kQkG\"\u003e代码来源：\u003ca href=\"https://link.zhihu.com/?target=https%3A//github.com/w86763777/pytorch-ddpm\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://\u003c/span\u003e\u003cspan class=\"visible\"\u003egithub.com/w86763777/py\u003c/span\u003e\u003cspan class=\"invisible\"\u003etorch-ddpm\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003ch2\u003e一、背景\u003c/h2\u003e\u003cp data-pid=\"GDxRKeZl\"\u003e何为AIGC？AIGC即为生成式人工智能（Artificial Intelligence Generated Content），\u003cb\u003e利用人工智能算法生成具有一定创意和质量的内容\u003c/b\u003e。DDPM全称为Denoising diffusion probabilistic models，目标是利用diffusion算法产生新的图片，diffusion分为加噪和去噪两个过程，后续小节将会对diffusion进行详细介绍。\u003c/p\u003e\u003cp data-pid=\"epfShoWA\"\u003eDDPM最核心的工作，就是训练了一个神经网络\u003cimg src=\"https://www.zhihu.com/equation?tex=model\" alt=\"model\" eeimg=\"1\"/\u003e，使其能够学习到训练数据集\u003cimg src=\"https://www.zhihu.com/equation?tex=Dataset\" alt=\"Dataset\" eeimg=\"1\"/\u003e已有图片的数据分布，并有能力产生新的图片。即给猫的图片进行训练，模型自己能产生新的猫的图片。\u003c/p\u003e\u003ch2\u003e二、前置知识\u003c/h2\u003e\u003ch3\u003e2.1 数学知识\u003c/h3\u003e\u003ch3\u003e2.1.1 概率\u003c/h3\u003e\u003cp data-pid=\"WaKhu7o4\"\u003e首先引出最基本的概念，何为随机试验？\u003c/p\u003e\u003cp data-pid=\"4pAxYOqH\"\u003e\u003cb\u003e随机试验\u003c/b\u003e（random experiment）：在相同条件下，对某随机现象进行的大量重复观测。例如抛骰子，观察其点数；抛硬币，看其哪一面向上。\u003c/p\u003e\u003cp data-pid=\"V4bcEZgs\"\u003e相信大家对于日常生活中的概率这个词已经耳熟能详了，我们接下来定义三种概率。\u003c/p\u003e\u003cp data-pid=\"IalLjmFz\"\u003e现在有长度为n且按照时间分布的序列，\u003cimg src=\"https://www.zhihu.com/equation?tex=x_1%2Cx_2%2C...%2Cx_%7Bt-1%7D%2Cx_t%2C...%2Cx_n\" alt=\"x_1,x_2,...,x_{t-1},x_t,...,x_n\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"jxqaL7KM\"\u003e\u003cb\u003e先验概率\u003c/b\u003e（根据以往经验和分析得到的概率）： \u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x_t%7Cx_%7Bt-1%7D%29\" alt=\"q(x_t|x_{t-1})\" eeimg=\"1\"/\u003e，给定前一时刻的\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e预测当前时刻\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e的概率\u003c/p\u003e\u003cp data-pid=\"QGvXZJMV\"\u003e\u003cb\u003e后验概率\u003c/b\u003e（指在得到结果的信息后重新修正的概率）： \u003cimg src=\"https://www.zhihu.com/equation?tex=p%28x_%7Bt-1%7D%7Cx_t%29\" alt=\"p(x_{t-1}|x_t)\" eeimg=\"1\"/\u003e，给定当前时刻的\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt%7D\" alt=\"x_{t}\" eeimg=\"1\"/\u003e预测当前时刻\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e的概率\u003c/p\u003e\u003cp data-pid=\"0Q_jTqEb\"\u003e接下来，我们介绍一下条件概率和大名鼎鼎的贝叶斯公式。\u003c/p\u003e\u003cp data-pid=\"zwU-57I-\"\u003e\u003cb\u003e条件概率\u003c/b\u003e：设A，B是随机试验E的两个随机试验，且P(B)\u0026gt;0，称\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28A%7CB%29+%3D+%5Cfrac%7BP%28AB%29%7D%7BP%28B%29%7D\" alt=\"P(A|B) = \\frac{P(AB)}{P(B)}\" eeimg=\"1\"/\u003e为事件B发生的条件下，事件A发生的条件概率。如何进行推导，可以观察韦恩图：\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-57333939dbc568022e810a6dd8c2f051_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"383\" data-rawheight=\"188\" data-original-token=\"v2-52b563fced9e0653812aed6d38ac9c4b\" class=\"content_image\" width=\"383\"/\u003e\u003cfigcaption\u003e条件概率韦恩图\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"sPE-lujN\"\u003eP(AB)即为A事件和B事件的交集（既发生A也发生B），那么在已有B的情况下，发生A事件的概率，显然是二者的交集的面积除以B的面积，因为B的其他部分，A此时并没有作用也就是没发生。\u003c/p\u003e\u003cp data-pid=\"uL2uwQDn\"\u003e同理可得，\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28B%7CA%29+%3D+%5Cfrac%7BP%28AB%29%7D%7BP%28A%29%7D\" alt=\"P(B|A) = \\frac{P(AB)}{P(A)}\" eeimg=\"1\"/\u003e，那么\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28A%7CB%29+%3D+%5Cfrac%7BP%28B%7CA%29P%28A%29%7D%7BP%28B%29%7D\" alt=\"P(A|B) = \\frac{P(B|A)P(A)}{P(B)}\" eeimg=\"1\"/\u003e，这就是\u003cb\u003e贝叶斯公式\u003c/b\u003e。\u003c/p\u003e\u003cp data-pid=\"FwzJZfLj\"\u003e在求P(A|B)的情况下，我们可以引入其他事件C，相当于在已知C事件的情况下，去计算条件概率，公式变形为\u003c/p\u003e\u003cp data-pid=\"68-LG5J1\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28A%7CB%2CC%29+%3D+%5Cfrac%7BP%28B%7CA%2CC%29P%28A%7CC%29%7D%7BP%28B%7CC%29%7D+%5C%5C\" alt=\"P(A|B,C) = \\frac{P(B|A,C)P(A|C)}{P(B|C)} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003ch3\u003e2.1.2 统计\u003c/h3\u003e\u003cp data-pid=\"AuhzBq3h\"\u003e下面将要介绍期望，方差，以及一个非常重要的分布-正态分布\u003c/p\u003e\u003cp data-pid=\"nUmd63TE\"\u003e\u003cb\u003e期望\u003c/b\u003e：一个随机变量x，它在取不同值时的概率函数为f(x)，对于不同的取值，需要根据概率进行加权\u003c/p\u003e\u003cp data-pid=\"AseeP6h8\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=E%28x%29+%3D+%5Cmu+%3D+%5Csum+xf%28x%29%5C%5C\" alt=\"E(x) = \\mu = \\sum xf(x)\\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"UMyOTuh4\"\u003e\u003cb\u003e方差\u003c/b\u003e：用于表示数据的分散程度，数据波动越大，方差越大，其中\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csigma\" alt=\"\\sigma\" eeimg=\"1\"/\u003e为标准差，标准差是方差的算数平方根\u003c/p\u003e\u003cp data-pid=\"Twx9XRWa\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=Var%28x%29+%3D+%5Csigma%5E2+%3D+%5Csum+%28x-%5Cmu%29%5E2f%28x%29%5C%5C\" alt=\"Var(x) = \\sigma^2 = \\sum (x-\\mu)^2f(x)\\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"EXrQii3t\"\u003e若一个随机变量\u003cimg src=\"https://www.zhihu.com/equation?tex=X\" alt=\"X\" eeimg=\"1\"/\u003e服从一个位置参数\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmu\" alt=\"\\mu\" eeimg=\"1\"/\u003e和尺度参数\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csigma\" alt=\"\\sigma\" eeimg=\"1\"/\u003e的概率分布，且其概率密度函数为\u003c/p\u003e\u003cp data-pid=\"QSi9PSiD\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=f%28x%29+%3D+%5Cfrac%7B1%7D%7B%5Csqrt%7B2%5Cpi%5Csigma%7D%7Dexp%28-%5Cfrac%7B%28x-%5Cmu%29%5E2%7D%7B2%5Csigma%5E2%7D%29%5C%5C\" alt=\"f(x) = \\frac{1}{\\sqrt{2\\pi\\sigma}}exp(-\\frac{(x-\\mu)^2}{2\\sigma^2})\\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"PAWt6-jR\"\u003e则称这个随机变量为正态随机变量，服从的分布称为\u003cb\u003e正态（高斯）分布\u003c/b\u003e，记作\u003cimg src=\"https://www.zhihu.com/equation?tex=X+%5Csim+N%28%5Cmu%2C%5Csigma%5E2%29\" alt=\"X \\sim N(\\mu,\\sigma^2)\" eeimg=\"1\"/\u003e，\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmu%2C%5Csigma%5E2\" alt=\"\\mu,\\sigma^2\" eeimg=\"1\"/\u003e分别是分布的期望和方差。其中又有一种特殊的分布叫做\u003cb\u003e标准正态分布\u003c/b\u003e，此时\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmu+%3D+0%2C+%5Csigma+%3D+1\" alt=\"\\mu = 0, \\sigma = 1\" eeimg=\"1\"/\u003e，记作\u003cimg src=\"https://www.zhihu.com/equation?tex=X+%5Csim+N%280%2C1%29\" alt=\"X \\sim N(0,1)\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"G6r1XLx8\"\u003e\u003cb\u003e正态分布满足一系列比较好的性质\u003c/b\u003e，例如\u003cimg src=\"https://www.zhihu.com/equation?tex=X+%5Csim+N%28%5Cmu%2C%5Csigma%5E2%29\" alt=\"X \\sim N(\\mu,\\sigma^2)\" eeimg=\"1\"/\u003e，则\u003cimg src=\"https://www.zhihu.com/equation?tex=aX%2Bb+%5Csim+N%28a%5Cmu%2Bb%2Ca%5E2%5Csigma%5E2%29\" alt=\"aX+b \\sim N(a\\mu+b,a^2\\sigma^2)\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"u9J6QgaM\"\u003e对于\u003cimg src=\"https://www.zhihu.com/equation?tex=X_1+%5Csim+N%28%5Cmu_1%2C%5Csigma_1%29%2CX_2+%5Csim+N%28%5Cmu_2%2C%5Csigma_2%29\" alt=\"X_1 \\sim N(\\mu_1,\\sigma_1),X_2 \\sim N(\\mu_2,\\sigma_2)\" eeimg=\"1\"/\u003e，则二者进行叠加仍然是高斯分布，且\u003c/p\u003e\u003cp data-pid=\"oUIMnkcq\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=X_1+%2B+X_2+%5Csim+N%28%5Cmu_1%2B%5Cmu_2%2C%5Csigma_1%5E2%2B%5Csigma_2%5E2%29%5C%5C\" alt=\"X_1 + X_2 \\sim N(\\mu_1+\\mu_2,\\sigma_1^2+\\sigma_2^2)\\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003ch3\u003e2.1.3 马尔科夫链\u003c/h3\u003e\u003cp data-pid=\"M9_21zDB\"\u003eDiffusion模型中利用到了马尔科夫链，这里我们简要介绍一下。\u003c/p\u003e\u003cp data-pid=\"J6bpRNsr\"\u003e\u003cb\u003e随机过程\u003c/b\u003e：一串随机变量的序列，在这个序列当中，每一个数据都可以被看作是一个随机变量。例如某十字路口每分钟通过的车辆数量构成的序列。\u003c/p\u003e\u003cp data-pid=\"elHiRVOJ\"\u003e\u003cb\u003e马尔科夫链\u003c/b\u003e（Markov Chain）：状态空间中经过一个状态到另一个状态的转换的随机过程，该过程具备\u003cb\u003e无记忆性（马尔科夫性质）\u003c/b\u003e，即下一状态的概率分布\u003cb\u003e只能由当前状态决定\u003c/b\u003e，在时间序列中它前面的事件均与之无关。（例如循环神经网络RNN）。如下图所示，其中的带箭头的横线代表预测或者是说转换过程，每个圆圈代表一个状态，马尔科夫链就是基于前一时刻预测下一时刻的信息。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-0cbe28e92ae94dfd81666bc9ac107e25_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"968\" data-rawheight=\"204\" data-original-token=\"v2-bef3b34a787c7fb02d54f4113ea7f103\" class=\"origin_image zh-lightbox-thumb\" width=\"968\" data-original=\"https://pic2.zhimg.com/v2-0cbe28e92ae94dfd81666bc9ac107e25_r.jpg\"/\u003e\u003cfigcaption\u003e马尔科夫链\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"oE_fTeAs\"\u003e一句话总结马尔科夫链，就是The future is independent of the past given the present。也就是说过去所有的信息都已经被保存到了现在的状态，基于现在就可以预测未来。\u003c/p\u003e\u003ch3\u003e2.1 深度学习知识\u003c/h3\u003e\u003cp data-pid=\"mp2DYNEi\"\u003e本文论文代码是基于pytorch框架，需要阅读者具备一定的深度学习基础，掌握\u003cb\u003eunet模型\u003c/b\u003e，列出以下资源\u003c/p\u003e\u003cp data-pid=\"ginBEo_f\"\u003e吴恩达深度学习：\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1FT4y1E74V\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://www.\u003c/span\u003e\u003cspan class=\"visible\"\u003ebilibili.com/video/BV1F\u003c/span\u003e\u003cspan class=\"invisible\"\u003eT4y1E74V\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"IBBfBK_5\"\u003e小土堆pytorch学习：\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1hE411t7RN\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://www.\u003c/span\u003e\u003cspan class=\"visible\"\u003ebilibili.com/video/BV1h\u003c/span\u003e\u003cspan class=\"invisible\"\u003eE411t7RN\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"hstKc62B\"\u003eunet实战：\u003ca href=\"https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV11341127iK\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://www.\u003c/span\u003e\u003cspan class=\"visible\"\u003ebilibili.com/video/BV11\u003c/span\u003e\u003cspan class=\"invisible\"\u003e341127iK\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"0tCnsxSL\"\u003e在本小节中列出DDPM中经常使用的用法\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandn_like\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 产生与x_0相同维度的,且满足正态分布的随机tensor\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# 指数平滑保存模型\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eema\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edecay\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esource_dict\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estate_dict\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etarget_dict\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estate_dict\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003esource_dict\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ekeys\u003c/span\u003e\u003cspan class=\"p\"\u003e():\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget_dict\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecopy_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etarget_dict\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edecay\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\n            \u003cspan class=\"n\"\u003esource_dict\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edecay\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# 模块初始化的方法\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003einitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003emodule\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emodules\u003c/span\u003e\u003cspan class=\"p\"\u003e():\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003eisinstance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodule\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLinear\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exavier_uniform_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodule\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eweight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezeros_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodule\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebias\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2\u003e三、DDPM算法\u003c/h2\u003e\u003cp data-pid=\"ujzMaJVu\"\u003e总算到了最为核心的算法部分，相信前置知识小节中的内容并没有难倒大家，或者是求知心切的大家可能一步就跳到了这一部分。算法部分将涉及到原理推导，请概率论基础薄弱的读者一定要再去看一下前置知识中的数学小节的内容，只记住公式也可以。\u003c/p\u003e\u003cp data-pid=\"8MtQoRvP\"\u003eDDPM最为核心的部分就是Diffusion算法，其如下图所示\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-4ce79ce44fdfe971fba8b297facfbe69_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"683\" data-rawheight=\"133\" data-original-token=\"v2-55650bb7fb07df112b0138f1f63051d1\" class=\"origin_image zh-lightbox-thumb\" width=\"683\" data-original=\"https://pic2.zhimg.com/v2-4ce79ce44fdfe971fba8b297facfbe69_r.jpg\"/\u003e\u003cfigcaption\u003eDDPM中的马尔科夫链\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"L5N1Fd4u\"\u003e相信大家第一次看到也肯定是一脸懵逼，这是什么东西，请听我娓娓道来。从图片中可以看出有两种方向不同的箭头，有一张非常模糊的图片，有一张非常清晰人脸的图片，还有一张处于二者之间的图片。这里就暗示着我们，DDPM包括两个步骤。这两个步骤在原文中定义为前向加噪（forward）和后向去噪（reverse）。\u003c/p\u003e\u003ch3\u003e3.1 前向加噪forward\u003c/h3\u003e\u003cp data-pid=\"UcWm1y1T\"\u003e从\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e到\u003cimg src=\"https://www.zhihu.com/equation?tex=x_T\" alt=\"x_T\" eeimg=\"1\"/\u003e的过程就是\u003cb\u003e前向加噪\u003c/b\u003e过程，我们可以看到加噪过程顾名思义就是对原始图片\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e进行了一系列操作，使其变得\u0026#34;模糊\u0026#34;起来，而与之相对应的去噪过程就特别像还原过程，使得图片变得清晰。\u003c/p\u003e\u003cp data-pid=\"GO-HT4wB\"\u003e这里的操作实际上就是指在图片加入噪声\u003cimg src=\"https://www.zhihu.com/equation?tex=noise\" alt=\"noise\" eeimg=\"1\"/\u003e，噪声\u003cimg src=\"https://www.zhihu.com/equation?tex=noise\" alt=\"noise\" eeimg=\"1\"/\u003e本身的分布可以是很多样的，而论文中采用的是\u003cb\u003e标准正态分布\u003c/b\u003e，其理由是考虑到\u003cb\u003e其优良的性质\u003c/b\u003e，在接下来的公式推理中见到。我们通过往图片中加入噪声，使得图片变得模糊起来，当加的步骤足够多的时候（也就是T的取值越大的时候），图片已经非常接近一张纯噪声。纯噪声也就意味着多样性，我们的模型在去噪（还原）的过程中能够产生更加多样的图片。\u003c/p\u003e\u003cp data-pid=\"sxuV2NDZ\"\u003e好的，我们下面正式进入原理推导部分\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-d7feccfa52e3c129c31edbfeb085282d_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"1323\" data-rawheight=\"153\" data-original-token=\"v2-d7feccfa52e3c129c31edbfeb085282d\" class=\"origin_image zh-lightbox-thumb\" width=\"1323\" data-original=\"https://pic4.zhimg.com/v2-d7feccfa52e3c129c31edbfeb085282d_r.jpg\"/\u003e\u003cfigcaption\u003e马尔科夫链\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"b3xnDBd6\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e是原始图片，其满足初始分布\u003cimg src=\"https://www.zhihu.com/equation?tex=q%28x_0%29\" alt=\"q(x_0)\" eeimg=\"1\"/\u003e，即\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0+%5Csim+q%28x_0%29\" alt=\"x_0 \\sim q(x_0)\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"O-ATsS1s\"\u003e对于\u003cimg src=\"https://www.zhihu.com/equation?tex=t+%5Cin+%5B1%2CT%5D\" alt=\"t \\in [1,T]\" eeimg=\"1\"/\u003e时刻，\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e和\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e满足如下关系式\u003c/p\u003e\u003cp data-pid=\"TRqMKc1s\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=+x_t+%3D+%5Csqrt%7B1-%5Cbeta_t%7Dx_%7Bt-1%7D+%2B+%5Csqrt%7B%5Cbeta_t%7D%5Cepsilon%5C%5C+%5Cepsilon+%5Csim+N%280%2C1%29+%5C%5C\" alt=\" x_t = \\sqrt{1-\\beta_t}x_{t-1} + \\sqrt{\\beta_t}\\epsilon\\\\ \\epsilon \\sim N(0,1) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"5Zdbng_9\"\u003e令\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Calpha_t+%3D+1+-+%5Cbeta_t\" alt=\"\\alpha_t = 1 - \\beta_t\" eeimg=\"1\"/\u003e，则公式变形为\u003c/p\u003e\u003cp data-pid=\"g8oeXudT\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Calpha_t%7Dx_%7Bt-1%7D+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon+%5C%5C\" alt=\"x_t = \\sqrt{\\alpha_t}x_{t-1} + \\sqrt{1-\\alpha_t}\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"CDmogCqx\"\u003e其中的\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbeta_t\" alt=\"\\beta_t\" eeimg=\"1\"/\u003e是固定常数，其随着t的增加而增加，代码形式\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;betas\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elinspace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeta_1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_T\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"c1\"\u003e# \\beta_t\u003c/span\u003e\n\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebetas\u003c/span\u003e \u003cspan class=\"c1\"\u003e# \\alpha\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"ziZdork-\"\u003e继续进行推导\u003c/p\u003e\u003cp data-pid=\"Zd6ulslh\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Calpha_t%7Dx_%7Bt-1%7D+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon+%3D+%5Csqrt%7B%5Calpha_t%7D%28%5Csqrt%7B%5Calpha_%7Bt-1%7D%7Dx_%7Bt-2%7D%2B%5Csqrt%7B1-%5Calpha_%7Bt-1%7D%7D%5Cepsilon%29+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon+%3D+%5Csqrt%7B%5Calpha_t%5Calpha_%7Bt-1%7D%7Dx_%7Bt-2%7D%2B%5Csqrt%7B%5Calpha_t%7D%5Csqrt%7B1-%5Calpha_%7Bt-1%7D%7D%5Cepsilon+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon\" alt=\"x_t = \\sqrt{\\alpha_t}x_{t-1} + \\sqrt{1-\\alpha_t}\\epsilon = \\sqrt{\\alpha_t}(\\sqrt{\\alpha_{t-1}}x_{t-2}+\\sqrt{1-\\alpha_{t-1}}\\epsilon) + \\sqrt{1-\\alpha_t}\\epsilon = \\sqrt{\\alpha_t\\alpha_{t-1}}x_{t-2}+\\sqrt{\\alpha_t}\\sqrt{1-\\alpha_{t-1}}\\epsilon + \\sqrt{1-\\alpha_t}\\epsilon\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"S_TnjOU9\"\u003e由于正态分布的叠加性，\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csqrt%7B%5Calpha_t%7D%5Csqrt%7B1-%5Calpha_%7Bt-1%7D%7D%5Cepsilon+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon\" alt=\"\\sqrt{\\alpha_t}\\sqrt{1-\\alpha_{t-1}}\\epsilon + \\sqrt{1-\\alpha_t}\\epsilon\" eeimg=\"1\"/\u003e可以看作\u003c/p\u003e\u003cp data-pid=\"paiklv2d\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=X_1+%5Csim+%5Csqrt%7B%5Calpha_t%7D%5Csqrt%7B1-%5Calpha_%7Bt-1%7D%7D%5Cepsilon+%3D+N%280%2C%7B%5Calpha_t%281-%5Calpha_%7Bt-1%7D%29%7D%29+%5C%5C\" alt=\"X_1 \\sim \\sqrt{\\alpha_t}\\sqrt{1-\\alpha_{t-1}}\\epsilon = N(0,{\\alpha_t(1-\\alpha_{t-1})}) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"qZi78ZvQ\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=X_2+%5Csim+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon+%3D+N%280%2C%7B1-%5Calpha_%7Bt%7D%7D%29+%5C%5C\" alt=\"X_2 \\sim \\sqrt{1-\\alpha_t}\\epsilon = N(0,{1-\\alpha_{t}}) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"M4A1CLIh\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=X_1+%2B+X_2+%3D+N%280%2C1-%7B%5Calpha_t%5Calpha_%7Bt-1%7D%7D%29+%5C%5C\" alt=\"X_1 + X_2 = N(0,1-{\\alpha_t\\alpha_{t-1}}) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"fcVSV8Ap\"\u003e则公式可以进一步简化为\u003c/p\u003e\u003cp data-pid=\"rjRaBNFX\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Calpha_t%5Calpha_%7Bt-1%7D%7Dx_%7Bt-2%7D+%2B+%28%5Csqrt%7B1-%5Calpha_t%5Calpha_%7Bt-1%7D%7D%29%5Cepsilon+%5C%5C\" alt=\"x_t = \\sqrt{\\alpha_t\\alpha_{t-1}}x_{t-2} + (\\sqrt{1-\\alpha_t\\alpha_{t-1}})\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"hWFuhnjJ\"\u003e由数学归纳法，可以进一步推导得\u003c/p\u003e\u003cp data-pid=\"ssfyQ3pD\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Calpha_t%5Calpha_%7Bt-1%7D...%5Calpha_1%7Dx_%7B0%7D+%2B+%28%5Csqrt%7B1-%5Calpha_t%5Calpha_%7Bt-1%7D%5Calpha_%7B1%7D%7D%29%5Cepsilon+%5C%5C\" alt=\"x_t = \\sqrt{\\alpha_t\\alpha_{t-1}...\\alpha_1}x_{0} + (\\sqrt{1-\\alpha_t\\alpha_{t-1}\\alpha_{1}})\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"Ig1WRlcS\"\u003e令\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbar%7B%5Calpha_t%7D+%3D+%7B%5Calpha_t%5Calpha_%7Bt-1%7D...%5Calpha_1%7D\" alt=\"\\bar{\\alpha_t} = {\\alpha_t\\alpha_{t-1}...\\alpha_1}\" eeimg=\"1\"/\u003e，则公式可以进一步化简为\u003c/p\u003e\u003cp data-pid=\"eZH8bjwG\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon+%5C%5C\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"rstjk-TV\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbar%7B%5Calpha_t%7D%2C%5Cfrac%7B1%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D%2C%5Cfrac%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D\" alt=\"\\bar{\\alpha_t},\\frac{1}{\\sqrt{\\bar{\\alpha_t}}},\\frac{\\sqrt{1-\\bar{\\alpha_t}}}{\\sqrt{\\bar{\\alpha_t}}}\" eeimg=\"1\"/\u003e的代码形式如下\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecumprod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sqrt_recip_alphas_bar\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sqrt_recipm1_alphas_bar\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"oe-FDHNm\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon\" eeimg=\"1\"/\u003e可求出\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e的表达式\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0+%3D+%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D\" alt=\"x_0 = \\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon}{\\sqrt{\\bar{\\alpha_t}}}\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"50cZgh__\"\u003e代码形式如下：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"c1\"\u003e# 根据时间t来取对应的系数\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# v[T]\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# t[B] x_shape = [B,C,H,W]\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eout\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egather\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# [B,1,1,1],分别代表batch_size,通道数,长,宽\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eout\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eview\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]]\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# eps代表正态分布噪声,函数目标是计算x_0\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003epredict_xstart_from_eps\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eeps\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt_recip_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt_recipm1_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eeps\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"CyYusgP0\"\u003e通过\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon\" eeimg=\"1\"/\u003e和\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Calpha_t%7Dx_%7Bt-1%7D+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon\" alt=\"x_t = \\sqrt{\\alpha_t}x_{t-1} + \\sqrt{1-\\alpha_t}\\epsilon\" eeimg=\"1\"/\u003e比较，我们可以发现最终推导公式是如此简洁，可以由\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e一步得到，\u003cb\u003e无需多次迭代的过程，这一点非常令人欣喜\u003c/b\u003e。\u003c/p\u003e\u003cp data-pid=\"Bjyc6LIy\"\u003e由于\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbeta_t\" alt=\"\\beta_t\" eeimg=\"1\"/\u003e一直在变大，则\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Calpha_t\" alt=\"\\alpha_t\" eeimg=\"1\"/\u003e一直在变小，则当\u003cimg src=\"https://www.zhihu.com/equation?tex=t+%5Cto+T\" alt=\"t \\to T\" eeimg=\"1\"/\u003e，\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cbar%7B%5Calpha_T%7D+%5Cto+0\" alt=\"\\bar{\\alpha_T} \\to 0\" eeimg=\"1\"/\u003e，则\u003cimg src=\"https://www.zhihu.com/equation?tex=x_T+%5Cto+%5Cepsilon\" alt=\"x_T \\to \\epsilon\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"4dVO1SSS\"\u003e所以我们认为在前向加噪的过程，进行非常多的步骤的时候(例如T=1000)，\u003cb\u003e最终产生的图片\u003c/b\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_T\" alt=\"x_T\" eeimg=\"1\"/\u003e \u003cb\u003e接近于高斯分布\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"kfH69vut\"\u003e这里我们引入了一个简单的例子，用来演示逐步加噪的过程\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003etorch\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etorchvision.utils\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003emake_grid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esave_image\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etorchvision\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ePIL\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eImage\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ebetas\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elinspace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e0.02\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebetas\u003c/span\u003e\n\u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecumprod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003esqrt_alphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003esqrt_m1_alphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eimg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eImage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;car.jpeg\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# 读取图片\u003c/span\u003e\n\u003cspan class=\"n\"\u003etrans\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompose\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e224\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToTensor\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# 转换为tensor\u003c/span\u003e\n\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etrans\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003eimg_list\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"n\"\u003enoise\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandn_like\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e15\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt_m1_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003enoise\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eimg_list\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003eall_img\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimg_list\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003eall_img\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emake_grid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eall_img\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003esave_image\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eall_img\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;car_noise.jpeg\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-8deab8764b025dd9dd6705f683b45449_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"3218\" data-rawheight=\"454\" data-original-token=\"v2-8deab8764b025dd9dd6705f683b45449\" data-default-watermark-src=\"https://picx.zhimg.com/v2-8deab8764b025dd9dd6705f683b45449_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"3218\" data-original=\"https://picx.zhimg.com/v2-8deab8764b025dd9dd6705f683b45449_r.jpg\"/\u003e\u003cfigcaption\u003ecar_noise.jpeg\u003c/figcaption\u003e\u003c/figure\u003e\u003ch3\u003e3.2 反向去噪reverse\u003c/h3\u003e\u003cp data-pid=\"k7EC-o8P\"\u003e去噪顾名思义就是在已经有噪声的图片，进行去除噪声的步骤，使得图片恢复成原来图片的样子。在加噪过程中，我们产生一系列带有噪声的图片，并利用前一时刻的图片去预测下一时刻的图片。而在去噪的过程中，我们需要\u003cb\u003e根据当前时刻的图片去预测前一时刻的图片\u003c/b\u003e，也就意味着去除一部分噪声，还原到上一时刻的图片。\u003c/p\u003e\u003cp data-pid=\"-puYsnrl\"\u003e从上一小节得知，我们去噪过程最开始的图片\u003cimg src=\"https://www.zhihu.com/equation?tex=x_T\" alt=\"x_T\" eeimg=\"1\"/\u003e本身来自高斯分布，写作代码\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003ex_T\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esample_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimg_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimg_size\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n\u003cspan class=\"c1\"\u003e# sample_size代表测试图片个数\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 3代表通道数,意味着这是一张RGB图片\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# img_size代表图片大小\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"8LrV5xs8\"\u003e在去噪过程中，我们并不知道上一时刻\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e的值，是需要用\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e进行预测，所以我们只能用概率的形式，采用贝叶斯公式去计算后验概率\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%29\" alt=\"P(x_{t-1}|x_t)\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"OZ2PI3ci\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%29+%3D+%5Cfrac%7BP%28x_%7Bt-1%7Dx_t%29%7D%7BP%28x_t%29%7D+%3D+%5Cfrac%7BP%28x_t%7Cx_%7Bt-1%7D%29P%28x_%7Bt-1%7D%29%7D%7BP%28x_t%29%7D+%5C%5C\" alt=\"P(x_{t-1}|x_t) = \\frac{P(x_{t-1}x_t)}{P(x_t)} = \\frac{P(x_t|x_{t-1})P(x_{t-1})}{P(x_t)} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"Hu5T3Gqu\"\u003e进一步在已知原图\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e的情况下，进行公式改写\u003c/p\u003e\u003cp data-pid=\"9ELKrkt8\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%2Cx_0%29+%3D+%5Cfrac%7BP%28x_t%7Cx_%7Bt-1%7D%2Cx_0%29P%28x_%7Bt-1%7D%7Cx_0%29%7D%7BP%28x_t%7Cx_0%29%7D+%5C%5C\" alt=\"P(x_{t-1}|x_t,x_0) = \\frac{P(x_t|x_{t-1},x_0)P(x_{t-1}|x_0)}{P(x_t|x_0)} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"gmGN2OhH\"\u003e等式右边部分都变成先验概率，我们由前向加噪过程即可对公式进行改写，依据为\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon\" eeimg=\"1\"/\u003e和\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B1-%5Cbeta_t%7Dx_%7Bt-1%7D+%2B+%5Csqrt%7B%5Cbeta_t%7D%5Cepsilon\" alt=\"x_t = \\sqrt{1-\\beta_t}x_{t-1} + \\sqrt{\\beta_t}\\epsilon\" eeimg=\"1\"/\u003e两个公式\u003c/p\u003e\u003cp data-pid=\"_PvogH4R\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%2Cx_0%29+%3D+%5Cfrac%7BN%28%5Csqrt%7B%5Calpha_t%7Dx_%7Bt-1%7D%2C1-%5Calpha_t%29+N%28%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7Dx_0%2C1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%7D%7BN%28%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt%7D%7D%7Dx_0%2C1-%5Cbar%7B%5Calpha_%7Bt%7D%7D%29%7D%5C%5C\" alt=\"P(x_{t-1}|x_t,x_0) = \\frac{N(\\sqrt{\\alpha_t}x_{t-1},1-\\alpha_t) N(\\sqrt{\\bar{\\alpha_{t-1}}}x_0,1-\\bar{\\alpha_{t-1}})}{N(\\sqrt{\\bar{\\alpha_{t}}}x_0,1-\\bar{\\alpha_{t}})}\\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"Iu32ZkPR\"\u003e在前面的小节中，我们已经给出了正态分布的概率密度函数，我们可以对上述公式进行展开。展开的依据为\u003c/p\u003e\u003cp data-pid=\"wHz5xTFL\"\u003e展开的时候注意\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e和\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e的区别，在|前的变量才是概率密度函数f(x)里的x，\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cpropto\" alt=\"\\propto\" eeimg=\"1\"/\u003e代表成正比，即我们不关心前面的系数\u003c/p\u003e\u003cp data-pid=\"B-c8JpIE\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%2Cx_0%29+%5Cpropto+exp+-%5Cfrac%7B1%7D%7B2%7D%5B%5Cfrac%7B%28x_t-%5Csqrt%7B%5Calpha_t%7Dx_%7Bt-1%7D%29%5E2%7D%7B1-%5Calpha_t%7D+%2B+%5Cfrac%7B%28x_%7Bt-1%7D-%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7Dx_0%29%5E2%7D%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D+-+%5Cfrac%7B%28x_t-%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0%29%5E2%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5D\" alt=\"P(x_{t-1}|x_t,x_0) \\propto exp -\\frac{1}{2}[\\frac{(x_t-\\sqrt{\\alpha_t}x_{t-1})^2}{1-\\alpha_t} + \\frac{(x_{t-1}-\\sqrt{\\bar{\\alpha_{t-1}}}x_0)^2}{1-\\bar{\\alpha_{t-1}}} - \\frac{(x_t-\\sqrt{\\bar{\\alpha_t}}x_0)^2}{1-\\bar{\\alpha_t}}]\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"myqMUuTz\"\u003e此时由于\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e是我们关注的变量，所以整理成关于\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e的形式\u003c/p\u003e\u003cp data-pid=\"yytOYBcv\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%2Cx_0%29+%5Cpropto+exp+-%5Cfrac%7B1%7D%7B2%7D%5B%28%5Cfrac%7B%5Calpha_t%7D%7B1-%5Calpha_t%7D%2B%5Cfrac%7B1%7D%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D%29x_%7Bt-1%7D%5E2+-+%28%5Cfrac%7B2%5Csqrt%7B%5Calpha_t%7D%7D%7B1-%5Calpha_t%7Dx_t%2B%5Cfrac%7B2%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D%7D%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7Dx_0%29x_%7Bt-1%7D+%2B+C%28x_t%2Cx_0%29%5D\" alt=\"P(x_{t-1}|x_t,x_0) \\propto exp -\\frac{1}{2}[(\\frac{\\alpha_t}{1-\\alpha_t}+\\frac{1}{1-\\bar{\\alpha_{t-1}}})x_{t-1}^2 - (\\frac{2\\sqrt{\\alpha_t}}{1-\\alpha_t}x_t+\\frac{2\\sqrt{\\bar{\\alpha_{t-1}}}}{1-\\bar{\\alpha_{t-1}}}x_0)x_{t-1} + C(x_t,x_0)]\" eeimg=\"1\"/\u003e，其中\u003cimg src=\"https://www.zhihu.com/equation?tex=C%28x_t%2Cx_0%29\" alt=\"C(x_t,x_0)\" eeimg=\"1\"/\u003e与\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e无关，只影响最前面的系数\u003c/p\u003e\u003cp data-pid=\"0zjLUlSN\"\u003e由于标准正态分布满足 \u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cpropto+exp+-%5Cfrac%7Bx%5E2%2B%5Cmu%5E2-2x%5Cmu%7D%7B2%5Csigma%5E2%7D\" alt=\"\\propto exp -\\frac{x^2+\\mu^2-2x\\mu}{2\\sigma^2}\" eeimg=\"1\"/\u003e，则\u003c/p\u003e\u003cp data-pid=\"Rswyh78R\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cfrac%7B1%7D%7B%5Csigma%5E2%7D+%3D+%5Cfrac%7B%5Calpha_t%7D%7B1-%5Calpha_t%7D+%2B+%5Cfrac%7B1%7D%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D+%3D+%5Cfrac%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7B%281-%5Calpha_t%29%281-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%7D+%5C%5C\" alt=\"\\frac{1}{\\sigma^2} = \\frac{\\alpha_t}{1-\\alpha_t} + \\frac{1}{1-\\bar{\\alpha_{t-1}}} = \\frac{1-\\bar{\\alpha_t}}{(1-\\alpha_t)(1-\\bar{\\alpha_{t-1}})} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"dmDws7oC\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csigma%5E2+%3D+%5Cfrac%7B%5Cbeta_t%281-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D+%5C%5C\" alt=\"\\sigma^2 = \\frac{\\beta_t(1-\\bar{\\alpha_{t-1}})}{1-\\bar{\\alpha_t}} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"7B5FuLv6\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmu+%3D+%5Cfrac%7B1%7D%7B2%7D%5Csigma%5E2%28%5Cfrac%7B2%5Csqrt%7B%5Calpha_t%7D%7D%7B1-%5Calpha_t%7Dx_t%2B%5Cfrac%7B2%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D%7D%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7Dx_0%29+%3D+%5Cfrac%7B%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D%281-%5Calpha_t%29%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Cfrac%7B%281-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%5Csqrt%7B%5Calpha_t%7D%7D%7B1-%5Cbar%7B%5Calpha_%7Bt%7D%7D%7Dx_t+%5C%5C\" alt=\"\\mu = \\frac{1}{2}\\sigma^2(\\frac{2\\sqrt{\\alpha_t}}{1-\\alpha_t}x_t+\\frac{2\\sqrt{\\bar{\\alpha_{t-1}}}}{1-\\bar{\\alpha_{t-1}}}x_0) = \\frac{\\sqrt{\\bar{\\alpha_{t-1}}}(1-\\alpha_t)}{1-\\bar{\\alpha_t}}x_0 + \\frac{(1-\\bar{\\alpha_{t-1}})\\sqrt{\\alpha_t}}{1-\\bar{\\alpha_{t}}}x_t \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"lb7qBa-z\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Calpha_%7Bt-1%7D%2C%5Cfrac%7B%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D%281-%5Calpha_t%29%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%2C%5Cfrac%7B%281-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%5Csqrt%7B%5Calpha_t%7D%7D%7B1-%5Cbar%7B%5Calpha_%7Bt%7D%7D%7D%2C%5Cmu%2C%5Cln+%5Csigma%5E2\" alt=\"\\alpha_{t-1},\\frac{\\sqrt{\\bar{\\alpha_{t-1}}}(1-\\alpha_t)}{1-\\bar{\\alpha_t}},\\frac{(1-\\bar{\\alpha_{t-1}})\\sqrt{\\alpha_t}}{1-\\bar{\\alpha_{t}}},\\mu,\\ln \\sigma^2\" eeimg=\"1\"/\u003e的代码形式如下\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003ealphas_bar_prev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eF\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)[:\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 在左侧补充1 alpha_0 = 1\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;posterior_mean_coef1\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebetas\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;posterior_mean_coef2\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# \\mu\u003c/span\u003e\n\u003cspan class=\"n\"\u003eposterior_mean\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposterior_mean_coef1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposterior_mean_coef2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# \\ln \\sigma^2\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;posterior_var\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebetas\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;posterior_log_var_clipped\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecat\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposterior_var\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposterior_var\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e:]])))\u003c/span\u003e\n\u003cspan class=\"n\"\u003eposterior_log_var_clipped\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposterior_log_var_clipped\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"G4OUqR-M\"\u003e又因为\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon\" eeimg=\"1\"/\u003e，则可以将上式的\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e全部换掉\u003c/p\u003e\u003cp data-pid=\"TBgpojYa\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cmu+%3D+%5Cfrac%7B1%7D%7B%5Csqrt%7B%5Calpha_t%7D%7D%28%5Cfrac%7B%5Calpha_t-%5Cbar%7B%5Calpha_t%7D%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7Dx_t+%2B+%5Cfrac%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%281-%5Calpha_t%29%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%2A%5Cfrac%7Bx_t-%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D%29+%3D+%5Cfrac%7B1%7D%7B%5Csqrt%7B%5Calpha_t%7D%7D%5B%5Cfrac%7B%5Calpha_t-%5Cbar%7B%5Calpha_t%7D%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7Dx_t+%2B+%5Cfrac%7B1-%5Calpha_t%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%2A%28x_t-%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon%29%5D+%3D+%5Cfrac%7B1%7D%7B%5Csqrt%7B%7B%5Calpha_t%7D%7D%7D%28x_t+-+%5Cfrac%7B1-%5Calpha_t%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon%29+%3D+%5Cfrac%7B1%7D%7B%5Csqrt%7B%5Calpha_t%7D%7D%28x_t+-+%5Cfrac%7B1-%5Calpha_t%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%5Cepsilon%29\" alt=\"\\mu = \\frac{1}{\\sqrt{\\alpha_t}}(\\frac{\\alpha_t-\\bar{\\alpha_t}}{1-\\bar{\\alpha_t}}x_t + \\frac{\\sqrt{\\bar{\\alpha_t}}(1-\\alpha_t)}{1-\\bar{\\alpha_t}}*\\frac{x_t-\\sqrt{1-\\bar{\\alpha_t}}\\epsilon}{\\sqrt{\\bar{\\alpha_t}}}) = \\frac{1}{\\sqrt{\\alpha_t}}[\\frac{\\alpha_t-\\bar{\\alpha_t}}{1-\\bar{\\alpha_t}}x_t + \\frac{1-\\alpha_t}{1-\\bar{\\alpha_t}}*(x_t-\\sqrt{1-\\bar{\\alpha_t}}\\epsilon)] = \\frac{1}{\\sqrt{{\\alpha_t}}}(x_t - \\frac{1-\\alpha_t}{1-\\bar{\\alpha_t}}\\sqrt{1-\\bar{\\alpha_t}}\\epsilon) = \\frac{1}{\\sqrt{\\alpha_t}}(x_t - \\frac{1-\\alpha_t}{\\sqrt{1-\\bar{\\alpha_t}}}\\epsilon)\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"lfzbtv1D\"\u003e下面就展示了一下反向去噪的过程，其中的\u003cimg src=\"https://www.zhihu.com/equation?tex=x_T\" alt=\"x_T\" eeimg=\"1\"/\u003e是随机高斯噪声，也就是左上角第一张图片\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-f80582d5db0606926ec695a068583fa5_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"1461\" data-rawheight=\"805\" data-original-token=\"v2-16bbc0b9a39086fd95114cd8008d1569\" class=\"origin_image zh-lightbox-thumb\" width=\"1461\" data-original=\"https://picx.zhimg.com/v2-f80582d5db0606926ec695a068583fa5_r.jpg\"/\u003e\u003cfigcaption\u003e去噪过程\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"vjlaW-62\"\u003e总结一下，\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%29+%3D+N%28%5Cfrac%7B1%7D%7B%5Csqrt%7B%5Calpha_t%7D%7D%28x_t+-+%5Cfrac%7B1-%5Calpha_t%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%5Cepsilon%29%2C%5Cfrac%7B%281-%5Calpha_t%29%281-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%29\" alt=\"P(x_{t-1}|x_t) = N(\\frac{1}{\\sqrt{\\alpha_t}}(x_t - \\frac{1-\\alpha_t}{\\sqrt{1-\\bar{\\alpha_t}}}\\epsilon),\\frac{(1-\\alpha_t)(1-\\bar{\\alpha_{t-1}})}{1-\\bar{\\alpha_t}})\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"tq5lj1Ew\"\u003e对于上述公式来说，似乎一切都很完美，但是\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon\" alt=\"\\epsilon\" eeimg=\"1\"/\u003e具体的值我们并不知道，我们只知道其服从正态分布，如何去解决这个问题？采用暴力美学，没法计算出来的，\u003cb\u003e就靠神经网络去解决\u003c/b\u003e！\u003c/p\u003e\u003ch3\u003e3.3 训练网络\u003c/h3\u003e\u003cp data-pid=\"3GdXzyij\"\u003e回顾一下前两小节的重点公式，分别对应前向加噪forward和反向去噪过程reverse：\u003c/p\u003e\u003cp data-pid=\"HuEnKwoX\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon+%5C%5C\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"DM2_2f5X\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%29+%3D+N%28%5Cfrac%7B1%7D%7B%5Csqrt%7B%5Calpha_t%7D%7D%28x_t+-+%5Cfrac%7B1-%5Calpha_t%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%5Cepsilon%29%2C%5Cfrac%7B%281-%5Calpha_t%29%281-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%29+%5C%5C\" alt=\"P(x_{t-1}|x_t) = N(\\frac{1}{\\sqrt{\\alpha_t}}(x_t - \\frac{1-\\alpha_t}{\\sqrt{1-\\bar{\\alpha_t}}}\\epsilon),\\frac{(1-\\alpha_t)(1-\\bar{\\alpha_{t-1}})}{1-\\bar{\\alpha_t}}) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"OHt_VMWw\"\u003e从两个重要公式中，我们可以看出这里面与\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Calpha\" alt=\"\\alpha\" eeimg=\"1\"/\u003e相关的都是常数，唯一不确定的就是\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon\" alt=\"\\epsilon\" eeimg=\"1\"/\u003e。如何去解决呢？上一小节中，我们提出用神经网络去解决。\u003c/p\u003e\u003cp data-pid=\"vHaAO4D1\"\u003e重新考虑前向加噪过程，我们能否使用神经网络从\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e中提取出\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon\" alt=\"\\epsilon\" eeimg=\"1\"/\u003e，这个想法具备可行性。因为\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e本身就是一张图片，可以用卷积神经网络进行特征提取，原本采用的是unet+self-attention，这里特征提取的网络可以很多样，也可以换成经典的resnet，vgg，也可以是最近爆火的vision-transformer。\u003c/p\u003e\u003cp data-pid=\"TZwPuW6F\"\u003e下面用代码实现训练器，\u003cb\u003e我们针对同一个batch内的样本，可以采取不同的T\u003c/b\u003e，这样使得模型学到更多样的东西。这也就是\u003ccode\u003etorch.randint(self.T)\u003c/code\u003e的含义，我们人为加了一个噪声\u003cimg src=\"https://www.zhihu.com/equation?tex=noise\" alt=\"noise\" eeimg=\"1\"/\u003e，其值通过\u003ccode\u003enoise = torch.randn_like(x_0)\u003c/code\u003e产生，向\u003cimg src=\"https://www.zhihu.com/equation?tex=model\" alt=\"model\" eeimg=\"1\"/\u003e传递两个参数一个是\u003cimg src=\"https://www.zhihu.com/equation?tex=t\" alt=\"t\" eeimg=\"1\"/\u003e代表时间信息，另一个就是前向加噪的结果\u003ccode\u003ex_t\u003c/code\u003e，采用MSE计算loss结果\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGaussianDiffusionTrainer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eModule\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"fm\"\u003e__init__\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_T\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003esuper\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGaussianDiffusionTrainer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"fm\"\u003e__init__\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emodel\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;betas\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elinspace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebeta_1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_T\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ealphas\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebetas\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecumprod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sqrt_alphas_bar\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sqrt_one_minus_alphas_bar\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eforward\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# x [B,C,H,W]\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# t [B], [T1,T2,T3,...,TB]\u003c/span\u003e\n        \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],),\u003c/span\u003e \u003cspan class=\"n\"\u003edevice\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edevice\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enoise\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandn_like\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 加噪\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt_one_minus_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003enoise\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eloss\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eF\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emse_loss\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003enoise\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereduction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;none\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eloss\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e3.3.1 Self-Attention\u003c/h3\u003e\u003cp data-pid=\"VtHrDoNW\"\u003e自注意力机制在nlp领域非常常见，由于篇幅原因不再细讲如何实现，可以参考以下博客来了解原理\u003c/p\u003e\u003cp data-pid=\"M3U7Rx8p\"\u003epytorch-sa: \u003ca href=\"https://link.zhihu.com/?target=https%3A//blog.csdn.net/weixin_53598445/article/details/125009686\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://\u003c/span\u003e\u003cspan class=\"visible\"\u003eblog.csdn.net/weixin_53\u003c/span\u003e\u003cspan class=\"invisible\"\u003e598445/article/details/125009686\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp data-pid=\"2uXj2nME\"\u003e这里是ddpm中有关注意力机制的pytorch实现\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAttnBlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eModule\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"fm\"\u003e__init__\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003esuper\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAttnBlock\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"fm\"\u003e__init__\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egroup_norm\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGroupNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 尺寸不变\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_q\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConv2d\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estride\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_k\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConv2d\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estride\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_v\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConv2d\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estride\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConv2d\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ein_ch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estride\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003einitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003emodule\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_q\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_k\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_v\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj\u003c/span\u003e\u003cspan class=\"p\"\u003e]:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exavier_uniform_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodule\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eweight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezeros_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodule\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebias\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exavier_uniform_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eweight\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003egain\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mf\"\u003e1e-5\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# 要满足x的维度C与in_ch一致\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eforward\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eW\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egroup_norm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_q\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_k\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj_v\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,C,H,W]\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e# [B,H,W,C]\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epermute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eview\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eH\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eW\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,HW,C]\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eview\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eH\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eW\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,C,HW]\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebmm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eF\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esoftmax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"o\"\u003e=-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,HW,HW]\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epermute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eview\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eH\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eW\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,HW,C]\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebmm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,HW,C]\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eview\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eW\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epermute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,C,H,W]\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eproj\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,C,H,W]\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# [B,C,H,W]\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e3.3.2 Unet\u003c/h3\u003e\u003cp data-pid=\"nlIIgDgT\"\u003eunet的网络结构如下图，主要包括下采样和上采样。这里列出较为简单的实现的代码链接\u003c/p\u003e\u003cp data-pid=\"C48u7bv2\"\u003eUnet: \u003ca href=\"https://link.zhihu.com/?target=https%3A//github.com/bigmb/Unet-Segmentation-Pytorch-Nest-of-Unets/blob/master/Models.py\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e\u003cspan class=\"invisible\"\u003ehttps://\u003c/span\u003e\u003cspan class=\"visible\"\u003egithub.com/bigmb/Unet-S\u003c/span\u003e\u003cspan class=\"invisible\"\u003eegmentation-Pytorch-Nest-of-Unets/blob/master/Models.py\u003c/span\u003e\u003cspan class=\"ellipsis\"\u003e\u003c/span\u003e\u003c/a\u003e\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-32c7533f32d2d8bc7aa41eb5f83df24e_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"1555\" data-rawheight=\"1036\" data-original-token=\"v2-707ceee37a5e3fe579301716da89b5b3\" class=\"origin_image zh-lightbox-thumb\" width=\"1555\" data-original=\"https://pic1.zhimg.com/v2-32c7533f32d2d8bc7aa41eb5f83df24e_r.jpg\"/\u003e\u003cfigcaption\u003eUnet结构\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch3\u003e3.3.3 训练过程\u003c/h3\u003e\u003cp data-pid=\"o9KXXKsI\"\u003e这里采用的是\u003ccode\u003ecifar10\u003c/code\u003e数据集进行训练，共有60000张彩色图像，每个图像为32*32，总共10个类别，常用于深度学习分类问题，下图展示了一下具体的图片\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-3461f02c0b261f91bd2b66dfea189692_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"300\" data-rawheight=\"302\" data-original-token=\"v2-5ee73a1c9460bc9663453d82c4719c2f\" class=\"content_image\" width=\"300\"/\u003e\u003cfigcaption\u003eCifar10数据集图片\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"N-bwFMmM\"\u003e读取数据集，并做一些初始的处理，代码如下\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etorchvision.transforms\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etorchvision.datasets\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eCIFAR10\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etorch.utils.data\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eDataLoader\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003edataset\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCIFAR10\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;./data\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etrain\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"bp\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edownload\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"bp\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompose\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRandomHorizontalFlip\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# 扩充数据集\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 将像素值从 [0, 255] 范围归一化到 [0, 1] 范围内\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToTensor\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# 使得像素值在 [-1, 1] 范围内\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etransforms\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003edataloader\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDataLoader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edataset\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebatch_size_own\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eshuffle\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"bp\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edrop_last\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"bp\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enum_workers\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003enum_workers\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"y0Skrlrl\"\u003e定义模型，优化器，训练步骤\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003enet_model\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eUnet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003exx\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003exx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003etrainer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGaussianDiffusionTrainer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enet_model\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_T\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003eoptim\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoptim\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAdam\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enet_model\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eparameters\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003elr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003enet_model\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etrain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003eepoch\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etqdm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etotal_steps\u003c/span\u003e\u003cspan class=\"p\"\u003e)):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003estep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimages\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elabels\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003eenumerate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edataloader\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoptim\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezero_grad\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 清除梯度\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eimages\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edevice\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 加载数据\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eloss\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etrainer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emean\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 计算loss\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eloss\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebackward\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 反向传播\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eclip_grad_norm_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enet_model\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eparameters\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003egrad_clip\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 剪裁梯度\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoptim\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estep\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 梯度器优化\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e3.4 推理（反向去噪）\u003c/h3\u003e\u003cp data-pid=\"rfTu2P8R\"\u003e推理过程就是反向去噪的过程，这里主要展示forward代码，\u003ccode\u003ep_mean_variance\u003c/code\u003e用3.2小节中的公式进行计算均值和方差，用\u003ccode\u003eeps = model(x_t, t)\u003c/code\u003e解决\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon\" alt=\"\\epsilon\" eeimg=\"1\"/\u003e的问题\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eforward\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_T\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_T\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003etime_step\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etqdm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ereversed\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003edesc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Inference\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enew_ones\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ex_T\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003edtype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etime_step\u003c/span\u003e\n        \u003cspan class=\"n\"\u003emean\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elog_var\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ep_mean_variance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003etime_step\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enoise\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandn_like\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enoise\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emean\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eexp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elog_var\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003enoise\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"EBekxZ2X\"\u003e推理过程的代码如下\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eUNet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ech\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ech\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ech_mult\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ech_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eattn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eattn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enum_res_blocks\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003enum_res_blocks\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edropout\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edropout\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003esampler\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGaussianDiffusionSampler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eema_model\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebeta_T\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimg_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emean_type\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003evar_type\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edevice\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeval\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"k\"\u003ewith\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eno_grad\u003c/span\u003e\u003cspan class=\"p\"\u003e():\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_T\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esample_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimg_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimg_size\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 随机产生高斯噪声\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esampler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_T\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# 可视化操作\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e3.5 DDPM训练与推理结果\u003c/h3\u003e\u003cp data-pid=\"d-Cf8qt3\"\u003e下图为笔者在模型训练的过程中，对同一个高斯噪声进行预测，可以很明显地看出来，随着轮数不断增加，画质越来越清晰，细节也越来越丰富，模型学习的能力（以假乱真）也不断越来越强。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-0b695e8fb7a0bccb110bca84f7ae826b_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"1721\" data-rawheight=\"841\" data-original-token=\"v2-02493606de6b1cc19f0b0cc6306ba49e\" class=\"origin_image zh-lightbox-thumb\" width=\"1721\" data-original=\"https://picx.zhimg.com/v2-0b695e8fb7a0bccb110bca84f7ae826b_r.jpg\"/\u003e\u003cfigcaption\u003eDDIM训练过程\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e四、DDIM算法\u003c/h2\u003e\u003ch3\u003e4.1 原理推导\u003c/h3\u003e\u003cp data-pid=\"bk9R-jZ2\"\u003eDDPM看起来似乎很完美，但其有一个致命的缺点便是\u003cb\u003e推理速度过慢\u003c/b\u003e，无法避免的迭代过程。为什么无法避免迭代过程是因为，\u003cb\u003e其本身是一个马尔科夫链的过程\u003c/b\u003e，即前后时刻数据有非常紧密的绑定关系，无法进行跳跃预测，比如说用\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e直接去预测\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-2%7D\" alt=\"x_{t-2}\" eeimg=\"1\"/\u003e。\u003c/p\u003e\u003cp data-pid=\"bbkE9Ye0\"\u003e但是想要高质量的生成图片，就意味着T要取一个比较大的值，用一张4090显卡进行推理，T=1000的情况下，推理64张32*32图片需要耗时20s，这个时间显然是无法忍受的。如何加速推理步骤，这个时候救星-DDIM出现了，DDIM通过数学推理，\u003cb\u003e打破了马尔科夫链的过程\u003c/b\u003e，最为巧妙的是其无需重新训练DDPM（无需改变前向加噪），只对采样器进行修改即可，修改后的采样器能够大幅增加采样速度。\u003c/p\u003e\u003cp data-pid=\"zZkajiEm\"\u003e下面我们就来分析DDIM的原理，从一个假设出发，假设\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%2Cx_0%29\" alt=\"P(x_{t-1}|x_t,x_0)\" eeimg=\"1\"/\u003e满足如下正态分布则\u003c/p\u003e\u003cp data-pid=\"58OT9U_L\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%2Cx_0%29+%5Csim+N%28kx_0%2Bmx_t%2C%5Csigma%5E2%29+%5C%5C+x_%7Bt-1%7D+%3D+kx_0+%2B+mx_t+%2B+%5Csigma%5Cepsilon++%5Cepsilon+%5Csim+N%280%2C1%29+%5C%5C\" alt=\"P(x_{t-1}|x_t,x_0) \\sim N(kx_0+mx_t,\\sigma^2) \\\\ x_{t-1} = kx_0 + mx_t + \\sigma\\epsilon  \\epsilon \\sim N(0,1) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"nt1p522X\"\u003e又因为加噪过程满足公式\u003c/p\u003e\u003cp data-pid=\"p_bT1_Y7\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon+%5Cepsilon+%5Csim+N%280%2C1%29+%5C%5C\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon \\epsilon \\sim N(0,1) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"P31tDyyy\"\u003e进行代入和合并同类项\u003c/p\u003e\u003cp data-pid=\"m5QK8f63\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D+%3D+kx_0+%2B+m%5B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon%5D+%2B+%5Csigma%5Cepsilon+%5C%5C+x_%7Bt-1%7D+%3D+%28k%2Bm%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%29x_0+%2B+%5Cepsilon%27+%5Cepsilon%27+%5Csim+N%280%2Cm%5E2%281-%5Cbar%7B%5Calpha_t%7D%29%2B%5Csigma%5E2%29+%5C%5C\" alt=\"x_{t-1} = kx_0 + m[\\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon] + \\sigma\\epsilon \\\\ x_{t-1} = (k+m\\sqrt{\\bar{\\alpha_t}})x_0 + \\epsilon\u0026#39; \\epsilon\u0026#39; \\sim N(0,m^2(1-\\bar{\\alpha_t})+\\sigma^2) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"S4jlhXNI\"\u003e同样地，\u003c/p\u003e\u003cp data-pid=\"2VHXAHgF\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D%5Cepsilon+%5C%5C\" alt=\"x_{t-1} = \\sqrt{\\bar{\\alpha_{t-1}}}x_0 + \\sqrt{1-\\bar{\\alpha_{t-1}}}\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"ABErCgOT\"\u003e则满足对应系数相同\u003c/p\u003e\u003cp data-pid=\"6_-l4s-Q\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=k+%2B+m%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D+%5C%5C+m%5E2%281-%5Cbar%7B%5Calpha_t%7D%29%2B%5Csigma%5E2+%3D+1+-+%5Cbar%7B%5Calpha_%7Bt-1%7D%7D+%5C%5C\" alt=\"k + m\\sqrt{\\bar{\\alpha_t}} = \\sqrt{\\bar{\\alpha_{t-1}}} \\\\ m^2(1-\\bar{\\alpha_t})+\\sigma^2 = 1 - \\bar{\\alpha_{t-1}} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"3CMa8ODT\"\u003e求得\u003c/p\u003e\u003cp data-pid=\"Nk2VoI2C\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=m+%3D+%5Cfrac%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D-%5Csigma%5E2%7D%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D+%5C%5C+k+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D+-+%5Cfrac%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D-%5Csigma%5E2%7D%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D+%5C%5C\" alt=\"m = \\frac{\\sqrt{1-\\bar{\\alpha_{t-1}}-\\sigma^2}}{\\sqrt{1-\\bar{\\alpha_t}}} \\\\ k = \\sqrt{\\bar{\\alpha_{t-1}}} - \\frac{\\sqrt{1-\\bar{\\alpha_{t-1}}-\\sigma^2}}{\\sqrt{1-\\bar{\\alpha_t}}}\\sqrt{\\bar{\\alpha_t}} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"YAkLTp-V\"\u003e则表达式为\u003c/p\u003e\u003cp data-pid=\"fFyr7fHL\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%2Cx_0%29+%5Csim+N%28%28%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D+-+%5Cfrac%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D-%5Csigma%5E2%7D%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%29x_0+%2B+%28%5Cfrac%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D-%5Csigma%5E2%7D%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%29x_t%2C%5Csigma%5E2%29+%5C%5C+%5Csim+N%28%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D-%5Csigma%5E2%7D%5Cfrac%7Bx_t+-+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%2C%5Csigma%5E2%29\" alt=\"P(x_{t-1}|x_t,x_0) \\sim N((\\sqrt{\\bar{\\alpha_{t-1}}} - \\frac{\\sqrt{1-\\bar{\\alpha_{t-1}}-\\sigma^2}}{\\sqrt{1-\\bar{\\alpha_t}}}\\sqrt{\\bar{\\alpha_t}})x_0 + (\\frac{\\sqrt{1-\\bar{\\alpha_{t-1}}-\\sigma^2}}{\\sqrt{1-\\bar{\\alpha_t}}})x_t,\\sigma^2) \\\\ \\sim N(\\sqrt{\\bar{\\alpha_{t-1}}}x_0 + \\sqrt{1-\\bar{\\alpha_{t-1}}-\\sigma^2}\\frac{x_t - \\sqrt{\\bar{\\alpha_t}}x_0}{\\sqrt{1-\\bar{\\alpha_t}}},\\sigma^2)\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"JwIOBIql\"\u003e\u003cb\u003e采用与反向去噪同样的原理\u003c/b\u003e，将上述公式的\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e进行替换，这里采用\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon_t\" alt=\"\\epsilon_t\" eeimg=\"1\"/\u003e是因为前文已经说明过采用的是模型\u003cimg src=\"https://www.zhihu.com/equation?tex=model\" alt=\"model\" eeimg=\"1\"/\u003e预测的正态分布\u003c/p\u003e\u003cp data-pid=\"mK39BF8r\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0+%3D+%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon_t%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D+%5C%5C+%5Cepsilon_t+%3D+%5Cfrac%7Bx_t+-+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D+%5C%5C\" alt=\"x_0 = \\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon_t}{\\sqrt{\\bar{\\alpha_t}}} \\\\ \\epsilon_t = \\frac{x_t - \\sqrt{\\bar{\\alpha_t}}x_0}{\\sqrt{1-\\bar{\\alpha_t}}} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"To3HwEjE\"\u003e最终得到结果，后面的\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon\" alt=\"\\epsilon\" eeimg=\"1\"/\u003e采用的是随机采样\u003ccode\u003etorch.randn_like(x_t)\u003c/code\u003e\u003c/p\u003e\u003cp data-pid=\"PDOF2aed\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%7D%28%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon_t%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D%29+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D-%5Csigma%5E2%7D%5Cepsilon_t+%2B+%5Csigma%5E2%5Cepsilon+%5C%5C\" alt=\"x_{t-1} = \\sqrt{\\bar{\\alpha_{t-1}}}(\\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon_t}{\\sqrt{\\bar{\\alpha_t}}}) + \\sqrt{1-\\bar{\\alpha_{t-1}}-\\sigma^2}\\epsilon_t + \\sigma^2\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"ywN-Q_Ue\"\u003e由于全程推导并未使用\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csigma%5E2\" alt=\"\\sigma^2\" eeimg=\"1\"/\u003e则其取值可以为0。且全程推导没有用到马尔可夫的过程\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Calpha_t%7Dx_%7Bt-1%7D+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon\" alt=\"x_t = \\sqrt{\\alpha_t}x_{t-1} + \\sqrt{1-\\alpha_t}\\epsilon\" eeimg=\"1\"/\u003e可以认为不需要严格的由\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e算到\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e，令\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bprev%7D\" alt=\"x_{prev}\" eeimg=\"1\"/\u003e替代\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e，则公式变形为\u003c/p\u003e\u003cp data-pid=\"h09RTZor\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bprev%7D+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bprev%7D%7D%7D%28%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon_t%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D%29+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bprev%7D%7D-%5Csigma%5E2%7D%5Cepsilon_t+%2B+%5Csigma%5E2%5Cepsilon+%5C%5C\" alt=\"x_{prev} = \\sqrt{\\bar{\\alpha_{prev}}}(\\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon_t}{\\sqrt{\\bar{\\alpha_t}}}) + \\sqrt{1-\\bar{\\alpha_{prev}}-\\sigma^2}\\epsilon_t + \\sigma^2\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"PhYTHb5c\"\u003e其中的\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e和\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bprev%7D\" alt=\"x_{prev}\" eeimg=\"1\"/\u003e可以相隔多个迭代步数\u003c/p\u003e\u003ch3\u003e4.2 代码实现\u003c/h3\u003e\u003cp data-pid=\"wc5RJoHl\"\u003eDDPM和DDIM最大的区别就是，DDIM的采样器可以隔多步进行采样，我们可以设置sample_steps用来标记每隔多少步进行采样。通过观察我们DDPM发现\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e和\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e有如下规律\u003c/p\u003e\u003ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003cth\u003eT = 100\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003ex_t\u003c/td\u003e\u003ctd\u003e100\u003c/td\u003e\u003ctd\u003e99\u003c/td\u003e\u003ctd\u003e...\u003c/td\u003e\u003ctd\u003e2\u003c/td\u003e\u003ctd\u003e1\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003ex_{t-1}\u003c/td\u003e\u003ctd\u003e99\u003c/td\u003e\u003ctd\u003e98\u003c/td\u003e\u003ctd\u003e...\u003c/td\u003e\u003ctd\u003e1\u003c/td\u003e\u003ctd\u003e0\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003cp data-pid=\"E_EI091f\"\u003e如果我们加大采样间距可以得到DDIM，这里以sample_steps = 20为例\u003c/p\u003e\u003ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003cth\u003eT = 100\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003ex_t\u003c/td\u003e\u003ctd\u003e100\u003c/td\u003e\u003ctd\u003e80\u003c/td\u003e\u003ctd\u003e60\u003c/td\u003e\u003ctd\u003e40\u003c/td\u003e\u003ctd\u003e20\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003ex_{t-1}\u003c/td\u003e\u003ctd\u003e80\u003c/td\u003e\u003ctd\u003e60\u003c/td\u003e\u003ctd\u003e40\u003c/td\u003e\u003ctd\u003e20\u003c/td\u003e\u003ctd\u003e0\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003cp data-pid=\"NUrWVhOP\"\u003e可以发现，\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e的范围为\u003ccode\u003e[sample_steps,T]\u003c/code\u003e中间间隔\u003ccode\u003esample_steps\u003c/code\u003e。\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bt-1%7D\" alt=\"x_{t-1}\" eeimg=\"1\"/\u003e的范围为\u003ccode\u003e[0,T-sample_steps]\u003c/code\u003e，中间的间隔也是为\u003ccode\u003esample_steps\u003c/code\u003e。\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t%2Cx_%7Bt-1%7D\" alt=\"x_t,x_{t-1}\" eeimg=\"1\"/\u003e的长度是等长的等于\u003ccode\u003eT // sample_steps\u003c/code\u003e\u003c/p\u003e\u003cp data-pid=\"cVDAtPGY\"\u003e转换为代码如下：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003et_seq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003earange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esample_steps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esample_steps\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# x_t\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003et_prev_seq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003et_seq\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003esample_steps\u003c/span\u003e \u003cspan class=\"c1\"\u003e# x_{prev}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"It15kA_m\"\u003e根据公式\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0+%3D+%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D\" alt=\"x_0 = \\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon}{\\sqrt{\\bar{\\alpha_t}}}\" eeimg=\"1\"/\u003e，定义计算\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e的函数\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sqrt_recip_alphas_bar\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sqrt_recipm1_alphas_bar\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003epredict_xstart_from_eps\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eeps\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt_recip_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt_recipm1_alphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eeps\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"fDixG-Xu\"\u003e定义\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csigma\" alt=\"\\sigma\" eeimg=\"1\"/\u003e，其值可以为0，也可以为论文里的值\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e1.\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebetas\u003c/span\u003e\n\u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecumprod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eregister_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;alphas_bar_prev_whole\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eF\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ealpha_cumprod_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar_prev_whole\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar_prev_whole\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprev_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eddim_eta\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 默认为0\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003esigma_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eddim_eta\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp data-pid=\"CN2EtBau\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bprev%7D+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bprev%7D%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bprev%7D%7D-%5Csigma%5E2%7D%5Cepsilon_t+%2B+%5Csigma%5E2%5Cepsilon+%5C%5C\" alt=\"x_{prev} = \\sqrt{\\bar{\\alpha_{prev}}}x_0 + \\sqrt{1-\\bar{\\alpha_{prev}}-\\sigma^2}\\epsilon_t + \\sigma^2\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"6c2vSN9x\"\u003e完整的计算代码如下：\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etqdm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ezip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ereversed\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et_seq\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"nb\"\u003ereversed\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et_prev_seq\u003c/span\u003e\u003cspan class=\"p\"\u003e))),\u003c/span\u003e \u003cspan class=\"n\"\u003edesc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Inference\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enew_ones\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ex_T\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003edtype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprev_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enew_ones\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ex_T\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003edtype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ealpha_cumprod_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar_prev_whole\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eextract\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ealphas_bar_prev_whole\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprev_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# 根据训练好的ddpm算eps\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eeps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 采用t-1是因为原本的ddpm的0位置元素代表t=1时刻,差了一个1\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# 计算x_0,用于第一项\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epredict_xstart_from_eps\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eeps\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclip_denoised\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclamp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003emin\u003c/span\u003e\u003cspan class=\"o\"\u003e=-\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003emax\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mf\"\u003e1.\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 裁剪梯度\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# 计算sigma,用于第三项\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esigma_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eddim_eta\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# 用于第二项\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epred_dir_xt\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003esigma_t\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eeps\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ex_prev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealpha_cumprod_t_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex_0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003epred_dir_xt\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esigma_t\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etorch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erandn_like\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_t\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_prev\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3\u003e4.3 DDIM推理结果\u003c/h3\u003e\u003cp data-pid=\"2FhnJh4A\"\u003e笔者采用sample_steps = 5，来加速采样，在同样的条件下，一张4090的推理速度提升到将近原来的5倍，只需要大概4s的时间即可推理出64张32*32的图片，推理的步骤如下，其生成的图片质量也比较高。笔者也发现当sample_steps取过大的时候，图片的质量往往也不太高，这也是比较好理解的。如果取极限的话，只用一次推理，那最终的结果也一定是不理想的，因为最开始的\u003cimg src=\"https://www.zhihu.com/equation?tex=x_T\" alt=\"x_T\" eeimg=\"1\"/\u003e只是随机的高斯噪声。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-1856f05e3cb683b8cd3d7ebbbd3892c6_1440w.jpg\" data-size=\"normal\" data-rawwidth=\"998\" data-rawheight=\"550\" data-original-token=\"v2-997a9a7db4b5aad67390d2d4fdb56e16\" class=\"origin_image zh-lightbox-thumb\" width=\"998\" data-original=\"https://pica.zhimg.com/v2-1856f05e3cb683b8cd3d7ebbbd3892c6_r.jpg\"/\u003e\u003cfigcaption\u003eDDIM采样结果\u003c/figcaption\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003ch2\u003e五、总结\u003c/h2\u003e\u003cp data-pid=\"1TQ-vpHH\"\u003e对DDPM和DDIM中的重要公式进行梳理\u003c/p\u003e\u003ch3\u003e5.1 DDPM公式梳理\u003c/h3\u003e\u003cp data-pid=\"v8TY9Vva\"\u003e首先是定义\u003c/p\u003e\u003cp data-pid=\"o1OcR4zZ\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Calpha_t%7Dx_%7Bt-1%7D+%2B+%5Csqrt%7B1-%5Calpha_t%7D%5Cepsilon+%5C%5C+%5Cepsilon+%5Csim+N%280%2C1%29+%5C%5C\" alt=\"x_t = \\sqrt{\\alpha_t}x_{t-1} + \\sqrt{1-\\alpha_t}\\epsilon \\\\ \\epsilon \\sim N(0,1) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"RxAvgPoB\"\u003e经过推导可得\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0\" alt=\"x_0\" eeimg=\"1\"/\u003e和\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t\" alt=\"x_t\" eeimg=\"1\"/\u003e的关系\u003c/p\u003e\u003cp data-pid=\"Zdoxoebz\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_t+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon+%5C%5C+x_0+%3D+%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D+%5C%5C\" alt=\"x_t = \\sqrt{\\bar{\\alpha_t}}x_0 + \\sqrt{1-\\bar{\\alpha_t}}\\epsilon \\\\ x_0 = \\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon}{\\sqrt{\\bar{\\alpha_t}}} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"-KfeyzSU\"\u003e进一步求得后验概率\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%29\" alt=\"P(x_{t-1}|x_t)\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"KXLNdbjY\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=P%28x_%7Bt-1%7D%7Cx_t%29+%3D+N%28%5Cfrac%7B1%7D%7B%5Csqrt%7B%5Calpha_t%7D%7D%28x_t+-+%5Cfrac%7B1-%5Calpha_t%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D%5Cepsilon%29%2C%5Cfrac%7B%281-%5Calpha_t%29%281-%5Cbar%7B%5Calpha_%7Bt-1%7D%7D%29%7D%7B1-%5Cbar%7B%5Calpha_t%7D%7D%29+%5C%5C\" alt=\"P(x_{t-1}|x_t) = N(\\frac{1}{\\sqrt{\\alpha_t}}(x_t - \\frac{1-\\alpha_t}{\\sqrt{1-\\bar{\\alpha_t}}}\\epsilon),\\frac{(1-\\alpha_t)(1-\\bar{\\alpha_{t-1}})}{1-\\bar{\\alpha_t}}) \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"crZ3MWR4\"\u003e其中的\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon\" alt=\"\\epsilon\" eeimg=\"1\"/\u003e由模型\u003cimg src=\"https://www.zhihu.com/equation?tex=model\" alt=\"model\" eeimg=\"1\"/\u003e提供\u003c/p\u003e\u003ch3\u003e5.2 DDIM公式推理\u003c/h3\u003e\u003cp data-pid=\"Vz7zZeGr\"\u003eDDIM只修改了采样器，所以只需要重新定义后验概率即可\u003c/p\u003e\u003cp data-pid=\"zODuYIj-\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bprev%7D+%3D+%5Csqrt%7B%5Cbar%7B%5Calpha_%7Bprev%7D%7D%7D%28%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon_t%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D%29+%2B+%5Csqrt%7B1-%5Cbar%7B%5Calpha_%7Bprev%7D%7D-%5Csigma%5E2%7D%5Cepsilon_t+%2B+%5Csigma%5E2%5Cepsilon+%5C%5C\" alt=\"x_{prev} = \\sqrt{\\bar{\\alpha_{prev}}}(\\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon_t}{\\sqrt{\\bar{\\alpha_t}}}) + \\sqrt{1-\\bar{\\alpha_{prev}}-\\sigma^2}\\epsilon_t + \\sigma^2\\epsilon \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"acO8TGu0\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=%5C%5C+%5Cepsilon_t+%3D+%5Cfrac%7Bx_t+-+%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7Dx_0%7D%7B%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%7D+%5C%5C\" alt=\"\\\\ \\epsilon_t = \\frac{x_t - \\sqrt{\\bar{\\alpha_t}}x_0}{\\sqrt{1-\\bar{\\alpha_t}}} \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"7ZvB0x1Z\"\u003e\u003cimg src=\"https://www.zhihu.com/equation?tex=x_0+%3D+%5Cfrac%7Bx_t+-+%5Csqrt%7B1-%5Cbar%7B%5Calpha_t%7D%7D%5Cepsilon_t%7D%7B%5Csqrt%7B%5Cbar%7B%5Calpha_t%7D%7D%7D++%5C%5C\" alt=\"x_0 = \\frac{x_t - \\sqrt{1-\\bar{\\alpha_t}}\\epsilon_t}{\\sqrt{\\bar{\\alpha_t}}}  \\\\\" eeimg=\"1\"/\u003e \u003c/p\u003e\u003cp data-pid=\"MFrLdwqp\"\u003e其中的\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Cepsilon_t\" alt=\"\\epsilon_t\" eeimg=\"1\"/\u003e由模型提供，\u003cimg src=\"https://www.zhihu.com/equation?tex=%5Csigma\" alt=\"\\sigma\" eeimg=\"1\"/\u003e的值可以为0，\u003cimg src=\"https://www.zhihu.com/equation?tex=x_%7Bprev%7D%2Cx_t\" alt=\"x_{prev},x_t\" eeimg=\"1\"/\u003e中间可以差多个间隔\u003c/p\u003e\u003ch3\u003e5.3 模型算法\u003c/h3\u003e\u003cp data-pid=\"GYhbSBsH\"\u003eUnet、Self-Attention、ResNet、TimeEmbedding\u003c/p\u003e","is_labeled":false,"visited_count":82566,"thumbnails":["https://pica.zhimg.com/50/v2-64004038d799f2650065b0d2e626f21f_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-41e285a88406de5a8cdb2087329d9521_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-7160674d9b58980d713495ab25e9b2d2_720w.jpg?source=b6762063"],"favorite_count":2343,"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 666552214}","attached_info":"CoIJCPuP2/76svilkAEQBxoJMjM2MjUyMTM5IP/qxqoGKNMMMHVAK0owCgZJdGVtQ0YSIGRvY190eXBlOiBBcnRpY2xlCmlkOiAyNTkwMzIxNjYKGAAgADoAYiBiM2U4YjlmMGEyYzE1MjM1ZDIwYmY3YjA3MWFiY2ZhNXIJNjY2NTUyMjE0qgEJcmVjb21tZW5kwgEgY2UwOTAwY2NlZjY2NjA1YzMzYmIzZjAxOGMyMGQ5YznyAQoIDBIGTm9ybWFs8gEoCAoSJDI5NzJiYTQyLTU4YTItNGE4Yi1hNDExLTdhMWMxMmVmZmZjMfIBBQgLEgE4ggIAiALd+9b0+jKSAiBjZTA5MDBjY2VmNjY2MDVjMzNiYjNmMDE4YzIwZDljOZoCAMoCFlNob3JJbnRlcmVzdFdlaWdodFJ1bGXKAhVVc2VyTGNuRXhpdFdlaWdodFJ1bGXKAhRDb250ZW50QWdlV2VpZ2h0UnVsZcoCF1Rlc3RlZEFuZFdvcmtXZWlnaHRSdWxl2gIGSXRlbUNG6AID+gILTk9STUFMX0ZMT1eKAyA4MGIyYjI3ZGRlMDM0ZjM3ODQxNTk3N2I3YzQxMzBkOJoDDQoCdjIQABoFb3RoZXKoA4aFBdgDAOoDFXRleHRBbGxTaXRlTXZJdGVtQ0ZWMvoD9QMSDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFOi0IAhD/Ahi8ASIjdjItNTJiNTYzZmNlZDllMDY1MzgxMmFlZDZkMzhhYzljNGI6LQgCEMgHGMwBIiN2Mi1iZWYzYjM0YTc4N2M3ZmIwMmQ1NGY0MTEzZWE3ZjEwMzotCAMQqwUYhQEiI3YyLTU1NjUwYmI3ZmIwN2RmMTEyYjAxMzhmMWY2MzA1MWQxOi0IAhCrChiZASIjdjItZDdmZWNjZmE1MmUzYzEyOWMzMWVkYmZlYjA4NTI4MmQ6LQgDEJIZGMYDIiN2Mi04ZGVhYjg3NjRiMDI1ZGQ5ZGQ2NzA1ZjY4M2I0NTQ0OTotCAIQtQsYpQYiI3YyLTE2YmJjMGI5YTM5MDg2ZmQ5NTExNGNkODAwOGQxNTY5Oi0IAxCTDBiMCCIjdjItNzA3Y2VlZTM3YTVlM2ZlNTc5MzAxNzE2ZGE4OWI1YjM6LQgDEKwCGK4CIiN2Mi01ZWU3M2ExYzk0NjBiYzk2NjM0NTNkODJjNDcxOWMyZjotCAMQuQ0YyQYiI3YyLTAyNDkzNjA2ZGU2YjFjYzE5ZjBiMGNjNjMwNmJhNDllOi0IAhDmBximBCIjdjItOTk3YTlhN2RiNGI1YWFkNjczOTBkMmQ0ZmRiNTZlMTaABACIBACSBAZOb3JtYWyaBAEzoAQAqAQAsAQAugQGbWFudWFswgQDMTcwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA8AQA+QQAAAAAUjWWP4EFAAAAAAAAAACJBSLOoRVnzss/kgUAmgUDZGZ0ogUDZGZ0sgUBMbkFAAAAAAAAAADQBQDgBQDoBQDwBQiQBgCgBiuoBgOSAiQKCTIzNjI1MjEzORIJNjY2NTUyMjE0GAciCklNQUdFX1RFWFQ=","action_card":false},{"id":"44_1750980738.854","type":"feed","offset":44,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1750980738,"updated_time":1750980738,"target":{"id":"1920009161757929767","type":"answer","url":"https://api.zhihu.com/answers/1920009161757929767","author":{"id":"c11190fe89b2db4f56cd3ccf3a572cd1","url":"https://api.zhihu.com/people/c11190fe89b2db4f56cd3ccf3a572cd1","user_type":"people","url_token":"ceng-bo-80","name":"空蜀黍Kelson","headline":"远程养殖技术盎撒高级学习班在读","avatar_url":"https://pic1.zhimg.com/50/53047d213_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":293,"is_following":false,"is_followed":false},"created_time":1750545856,"updated_time":1750545856,"voteup_count":400,"thanks_count":14,"comment_count":5,"is_copyable":true,"question":{"id":"490772825","type":"question","url":"https://api.zhihu.com/questions/490772825","author":{"id":"55fb57327d730024ba77dab544914dd1","url":"https://api.zhihu.com/people/55fb57327d730024ba77dab544914dd1","user_type":"people","url_token":"xiao-tian-hen-hao","name":"知乎用户u3G5k2","headline":"","avatar_url":"https://picx.zhimg.com/50/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg?source=b6762063","is_org":false,"gender":0,"followers_count":0,"is_following":false,"is_followed":false},"title":"国外的女生为什么屁股都大？","created":1633440707,"answer_count":0,"follower_count":0,"comment_count":12,"bound_topic_ids":[2061,7921,7998,17911,19282],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"excerpt":"中国女人屁股也大，你看看“妇女能顶半边天”时期的女性照片，一样的丰乳肥臀。 主要还是生活习惯的问题，常年不从事体育运动和劳动锻炼的女性，无论中外都会扁屁股。 无他，多运动多干活。","excerpt_new":"中国女人屁股也大，你看看“妇女能顶半边天”时期的女性照片，一样的丰乳肥臀。 主要还是生活习惯的问题，常年不从事体育运动和劳动锻炼的女性，无论中外都会扁屁股。 无他，多运动多干活。","preview_type":"default","preview_text":"","reshipment_settings":"allowed","content":"\u003cp data-pid=\"V_AaXs7H\"\u003e中国女人屁股也大，你看看“妇女能顶半边天”时期的女性照片，一样的丰乳肥臀。\u003c/p\u003e\u003cp data-pid=\"Bnkr8rS0\"\u003e主要还是生活习惯的问题，常年不从事体育运动和劳动锻炼的女性，无论中外都会扁屁股。\u003c/p\u003e\u003cp data-pid=\"iJ8FTVhX\"\u003e无他，多运动多干活。\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":false,"visited_count":33336,"favorite_count":19,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1920009161757929767}","attached_info":"CsoFCPuP2/76svilkAEQBBoJNzMzMzc4Mzg0IMDr3MIGKJADMAVALEpBCh9UU19TT1VSQ0VfSE9UX0NST1NTX05FV19DT05URU5UEhhob3RfcmVjYWxsXzdkOm5ldzdkOm1hbGUYACAAOgBaCDcxMzQxOTc2YiBiM2U4YjlmMGEyYzE1MjM1ZDIwYmY3YjA3MWFiY2ZhNXITMTkyMDAwOTE2MTc1NzkyOTc2N4oBCTQ5MDc3MjgyNaoBCXJlY29tbWVuZMIBIGMxMTE5MGZlODliMmRiNGY1NmNkM2NjZjNhNTcyY2Qx8gEKCAwSBk5vcm1hbPIBKAgKEiQ3M2UzMDUzOC0zYzM4LTQ2YzEtODAwMy1lNTJmMWE3ZmMwYzPyAQUICxIBOIICAIgC3fvW9PoykgIgYzExMTkwZmU4OWIyZGI0ZjU2Y2QzY2NmM2E1NzJjZDGaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxl2gIfVFNfU09VUkNFX0hPVF9DUk9TU19ORVdfQ09OVEVOVOgCAvoCC05PUk1BTF9GTE9XigMgODBiMmIyN2RkZTAzNGYzNzg0MTU5NzdiN2M0MTMwZDiaAw0KAnYyEAAaBW90aGVyqAO4hALYAwDqAx9ob3RDcm9zc01lcmdlTmV3Q29udGVudFJlY2FsbGVy+gMfEgxVTktOT1dOX01PREUgACoNTk9fSU1BR0VfTU9ERYAEAIgEAJIEBk5vcm1hbJoEATKgBACoBACwBAC6BAJhacIEAzQwMMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEAPkEAAAAIHQvtz+BBQAAAAAAAAAAiQUizqEVZ87LP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUA4AUA6AUA8AUIkAYAoAYsqAYAkgIuCgk3MzMzNzgzODQSEzE5MjAwMDkxNjE3NTc5Mjk3NjcYBCIKSU1BR0VfVEVYVA==","action_card":false},{"id":"45_1750980738.267","type":"feed","offset":45,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1750980738,"updated_time":1750980738,"target":{"id":"556974569","type":"article","url":"https://api.zhihu.com/articles/556974569","author":{"id":"b6026626bc1202422a2defa6ae5afe3a","url":"https://api.zhihu.com/people/b6026626bc1202422a2defa6ae5afe3a","user_type":"organization","url_token":"zhong-xin-shu-yuan","name":"中信书院","headline":"中信出版旗下官方账号， 商务合作高管学习，欢迎私信","avatar_url":"https://pic1.zhimg.com/50/v2-7006f25ed5a56c3b6fc70d2a8167a73d_l.jpg?source=b6762063","is_org":true,"gender":-1,"followers_count":21949,"is_following":false,"is_followed":false},"title":"15本书提升认知，先藏后看","image_url":"https://pica.zhimg.com/v2-df48af7314e81e685633953780783d9a.jpg?source=7e7ef6e2\u0026needBackground=1","comment_permission":"all","created":1661245740,"updated":1661245740,"voteup_count":2207,"voting":0,"comment_count":82,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"很多事情的成败，归根结底在于认知。 张一鸣曾说:“认知能力决定了一个人的核心竞争力。其他生产要素，比如钱，人等等都是可以构建的，但人对事情的认知是根本性的。” 提高自己的认知，从底层逻辑中寻找稳定向上的力量，可以让自己的努力事半功倍。小编精选15本书，带给你洞察世事的独特视角、对人生新的领悟，从持续思考和认知升级中成长进步。 复杂世界的底层逻辑   《枪炮、病菌与钢铁》贾雷德·戴蒙德 著 这本书提供了人类历…","excerpt_new":"很多事情的成败，归根结底在于认知。 张一鸣曾说:“认知能力决定了一个人的核心竞争力。其他生产要素，比如钱，人等等都是可以构建的，但人对事情的认知是根本性的。” 提高自己的认知，从底层逻辑中寻找稳定向上的力量，可以让自己的努力事半功倍。小编精选15本书，带给你洞察世事的独特视角、对人生新的领悟，从持续思考和认知升级中成长进步。 复杂世界的底层逻辑   《枪炮、病菌与钢铁》贾雷德·戴蒙德 著 这本书提供了人类历…","preview_type":"default","preview_text":"","column":{"id":"c_1038792946732167168","type":"column","url":"https://api.zhihu.com/columns/c_1038792946732167168","author":{"id":"","url":"","user_type":"people","url_token":"","name":"匿名用户","headline":"","avatar_url":"https://pica.zhimg.com/v2-d41c2ceaed8f51999522f903672a521f_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":0,"is_following":false,"is_followed":false},"title":"中信书院","imageUrl":"https://picx.zhimg.com/v2-f111d7ee1c41944859e975a712c0883b_720w.jpg?source=d16d100b","comment_permission":"private","intro":"微信公号：citicbook","updated":1665998545,"is_following":false},"content":"\u003cp data-pid=\"U985NjIk\"\u003e很多事情的成败，归根结底在于认知。\u003c/p\u003e\u003cp data-pid=\"DpLTVOnx\"\u003e张一鸣曾说:“认知能力决定了一个人的核心竞争力。其他生产要素，比如钱，人等等都是可以构建的，但人对事情的认知是根本性的。”\u003c/p\u003e\u003cp data-pid=\"QAAbDGJ8\"\u003e提高自己的认知，从底层逻辑中寻找稳定向上的力量，可以让自己的努力事半功倍。小编精选15本书，带给你洞察世事的独特视角、对人生新的领悟，从持续思考和认知升级中成长进步。\u003c/p\u003e\u003ch2\u003e复杂世界的底层逻辑\u003c/h2\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-3a175d706366c47297c1721b83867db1_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-1c854bfc5f9f08fd3db4f861786d89ad\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://picx.zhimg.com/v2-3a175d706366c47297c1721b83867db1_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"lpPJ054l\"\u003e\u003cb\u003e《枪炮、病菌与钢铁》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"37B-7vqe\"\u003e贾雷德·戴蒙德 著\u003c/p\u003e\u003cp data-pid=\"v6X22CD-\"\u003e这本书提供了人类历史发展的特别线索，让你\u003cb\u003e重新认识这个世界，看懂今日权力和财富分配面貌\u003c/b\u003e。当前，我们应对全球气候变化、传染病大流行、核武器和资源枯竭的威胁时，仍然可以从《枪炮、病菌与钢铁》的宏大人类历史叙事中寻找答案。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-d18fa85d1b25b6eccc028f4ea455d9b8_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-d567525b24100c533ec4ee9b8efa9fc0\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pica.zhimg.com/v2-d18fa85d1b25b6eccc028f4ea455d9b8_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"lqd3YcxU\"\u003e\u003cb\u003e《自私的基因》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"lWXB9oS5\"\u003e理查德·道金斯 著\u003c/p\u003e\u003cp data-pid=\"u27vUFNf\"\u003e\u003cb\u003e我们从哪里来，又将到哪里去？生命有何意义，我们该如何认识自己？\u003c/b\u003e《自私的基因》以充满想象力的叙述回答了这些重要命题。道金斯在本书中提出大胆创见：我们生来是自私的，任何生物，包括我们自己，都只是求生的机器。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-b23af07717c14a49c22bf8a71abc28d9_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-928a842a946da50aae46afabfefcfd81\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://picx.zhimg.com/v2-b23af07717c14a49c22bf8a71abc28d9_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"0poh_vE0\"\u003e\u003cb\u003e《贪婪的多巴胺》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"EhPT99aC\"\u003e丹尼尔·利伯曼 著\u003c/p\u003e\u003cp data-pid=\"sq46m73v\"\u003e\u003cb\u003e如何保持自律？如何避免“恋爱脑”？如何充分发挥大脑潜能？\u003c/b\u003e你需要了解多巴胺的能力与破坏性，这种欲望分子控制着你的欲望、想象、冲动、创造力，出乎意料地影响着我们生活的方方面面。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-e3b5f4cc798d6c254db6453156837000_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-7c98a8f3b5406cd0f9406a06626c85fe\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pica.zhimg.com/v2-e3b5f4cc798d6c254db6453156837000_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"sV3C8WkQ\"\u003e\u003cb\u003e《人类之旅》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"XfYOqF71\"\u003e奥戴德·盖勒 著\u003c/p\u003e\u003cp data-pid=\"TMSQF3bO\"\u003e世界亿万生灵中，独有人类能够过上衣食无忧的富足生活。人类的经济繁荣因何而来？农业革命、工业革命、人口转型如何发生？全球发展水平又为何相差如此悬殊？古往今来，无数学者试图探究这背后的原因，尝试解答\u003cb\u003e增长之谜\u003c/b\u003e的终极问题。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-caf145edc13d52b760b537c8c4b76a60_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-qrcode-action=\"none\" data-original-token=\"v2-9585c549bf286e0319e28aaa70df8f07\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic3.zhimg.com/v2-caf145edc13d52b760b537c8c4b76a60_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"ixN34A9M\"\u003e\u003cb\u003e《娱乐至死》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"RMlSMmJq\"\u003e尼尔·波兹曼 著\u003c/p\u003e\u003cp data-pid=\"hPia0quR\"\u003e《娱乐至死》的预言指向了我们今天的现实：\u003cb\u003e我们将毁于我们所热爱的东西\u003c/b\u003e。一切文化内容都心甘情愿地成为娱乐的附庸，而且毫无怨言，甚至无声无息，“其结果是我们成了一个娱乐至死的物种”。\u003c/p\u003e\u003ch2\u003e人间清醒的思维认知\u003c/h2\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-1b5f2558539be0cc7941028c0cc5686b_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-a79a79a13718efd1aaf16a1d3e0eece6\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic4.zhimg.com/v2-1b5f2558539be0cc7941028c0cc5686b_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"q7CqTbnM\"\u003e\u003cb\u003e《怪诞行为学》（1-6册）\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"YY6cynzR\"\u003e丹·艾瑞里 著\u003c/p\u003e\u003cp data-pid=\"DilF9vlk\"\u003e在做生活中的各种决策时，我们总是以为自己正在做出明智的、理性的选择。但是事实真的是这样吗?丹•艾瑞里带我们进入了行为经济学领域，用通俗幽默的方式解读硬核知识点，捧腹中不知不觉get“行为经济学”的方方面面。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-479f72e7075aec8e1080632f0a05f4a0_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-1637dce228098a91ebe1b1cd12b3c266\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pica.zhimg.com/v2-479f72e7075aec8e1080632f0a05f4a0_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"5GJObNJG\"\u003e\u003cb\u003e《毫无意义的工作》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"bfXrjEpd\"\u003e大卫·格雷伯 著\u003c/p\u003e\u003cp data-pid=\"p7IrkyBA\"\u003e在科技的帮助下，现在2天的生产力或许可以抵得上过去5天的。但因为贪婪，因为某种必须一刻不停高效工作的\u003cb\u003e蜜蜂综合征\u003c/b\u003e，我们依然埋头苦干，\u003cb\u003e为他人赢取收益\u003c/b\u003e，而忽视了自己内心的抱负，只因这些抱负挣不了钱。你在做毫无意义的工作吗？薪水还满意吗？\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-c20dfae42738cc2d1982538fdd870127_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-a9f55f133dd1bed00463bdbcee59e7cf\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://picx.zhimg.com/v2-c20dfae42738cc2d1982538fdd870127_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"TlMfhvLG\"\u003e\u003cb\u003e《贫穷的本质》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"L49dFYxp\"\u003e阿比吉特·班纳吉 埃斯特·迪弗洛 著\u003c/p\u003e\u003cp data-pid=\"PPmQYuuF\"\u003e为什么穷人吃不饱饭还要买电视？为什么穷人的孩子即使上了学也不爱学习？穷人在决策时，往往选择短期能让自己舒服的选项，而不是长期对自己有益的选择。穷人疲于思考，忍受不了眼前的所谓的一点牺牲，无法储蓄，无法保持健康的生活习惯…… 这本来自诺奖得主，让人重新理解贫穷。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pica.zhimg.com/v2-8874f86a5c359eef560ec6d24543e068_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-c604a4c8924a5a68f031b9df3f6f1b73\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pica.zhimg.com/v2-8874f86a5c359eef560ec6d24543e068_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"pO85UJnw\"\u003e\u003cb\u003e《思考，快与慢》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"Pb1PSDUE\"\u003e丹尼尔·卡尼曼 著\u003c/p\u003e\u003cp data-pid=\"vjZGFtST\"\u003e\u003cb\u003e我们的大脑有快与慢两种作决定的方式\u003c/b\u003e。一种依赖情感、记忆和经验迅速作出判断，但很容易上当；另一种通过调动注意力来分析和解决问题，它比较慢，不容易出错，但它很懒惰，经常走捷径。人类究竟有多理性？这本书将会彻底改变你对思考的看法。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-d34c4ed9647849e765134825a8df139d_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-de3c4e3233f56283f3a1f4ca605ef359\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://picx.zhimg.com/v2-d34c4ed9647849e765134825a8df139d_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"VvCQXaX8\"\u003e\u003cb\u003e《心流》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"ucK-b2PJ\"\u003e米哈里·契克森米哈赖 著\u003c/p\u003e\u003cp data-pid=\"1VTPOYlH\"\u003e你是否曾经埋头钻研一个问题忘了时间？你是否曾经全情投入某事忘了自己？你是否凭借勤学苦练的技能自如搞定一项高难度工作？这些\u003cb\u003e高级的体验，叫做心流\u003c/b\u003e。心流是一种全神贯注、投入忘我的状态，可以让你保持专注、幸福感翻倍。\u003c/p\u003e\u003ch2\u003e提升自我的成长秘籍\u003c/h2\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-5a03a2d075931bef152da2903622c7b6_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-f201d073b98c7be3f27a2a47668e32dd\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic3.zhimg.com/v2-5a03a2d075931bef152da2903622c7b6_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"yIiaVx9K\"\u003e\u003cb\u003e吴军人生进阶三部曲系列\u003c/b\u003e\u003cbr/\u003e\u003cb\u003e《格局》《态度》《见识》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"qFnRjYfg\"\u003e吴军 著\u003c/p\u003e\u003cp data-pid=\"Q4QQtejq\"\u003e这三本书来自小编男神——硅谷投资人、国家文津图书奖得主吴军博士。吴军老师告诉年轻人：一个人能走多远，取决于见识；一个人做事的态度，决定了他的人生高度；一个人的格局，决定了他成就的定点。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-34a458b6737dcbe4842b44975f4e9def_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-b347f61e35fdecf5a5cb7595e1e73242\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://picx.zhimg.com/v2-34a458b6737dcbe4842b44975f4e9def_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"hjhZQ8el\"\u003e\u003cb\u003e《复盘工作法》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"-GsImn_2\"\u003e王建和 宋晓亮 著\u003c/p\u003e\u003cp data-pid=\"DrWaCc5_\"\u003e每天看似忙忙碌碌，却没有收获任何成长和进步？这时，你要学会复盘了。复盘是\u003cb\u003e通过自省提升自我，把经验转化成能力\u003c/b\u003e，是避免精神内耗、个人快速精进的成长秘诀~了解复盘工作法，做到“出门有力量”，“每次有期待”。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic4.zhimg.com/v2-8475fad5271855882931cf9af345baf1_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-839824e2433ceceae3a9b689e39149ba\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic4.zhimg.com/v2-8475fad5271855882931cf9af345baf1_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"uq3t8uoE\"\u003e\u003cb\u003e《框架思维》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"vYNEdMv1\"\u003e维克托·迈尔-舍恩伯格 著\u003c/p\u003e\u003cp data-pid=\"j5Wi2xdn\"\u003e高手做事，都有自己的框架。框架帮助我们正确地定义问题，设计策略，从而直击事物的本质。框架思维，是马斯克和查理·芒格一致推崇的思考和决策方法，帮助我们\u003cb\u003e深度思考\u003c/b\u003e，看清底层逻辑的强大思维工具。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-000c078fd4a309b5c780d2616f0d02af_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-qrcode-action=\"none\" data-original-token=\"v2-ae62703cce2f1e53b3ff63f16edcd605\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://pic2.zhimg.com/v2-000c078fd4a309b5c780d2616f0d02af_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"vP5zX5gU\"\u003e\u003cb\u003e《活出心花怒放的人生》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"kkJ2Dxzp\"\u003e彭凯平 著\u003c/p\u003e\u003cp data-pid=\"Ux2KvJdQ\"\u003e生活在这个时代的我们，本该是幸福的，物质充盈、信息发达……然而，我们中的大多数人时常感到\u003cb\u003e焦虑、烦躁、沮丧、难以专注\u003c/b\u003e，也因此丧失了对幸福的感知。清华大学心理学系主任彭凯平教授的这本书，推荐给那些时常感到不快乐的人、渴望改善生活幸福感的人。\u003c/p\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://picx.zhimg.com/v2-672ca99db1cbf88bde4eadef5f70bf45_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"640\" data-rawheight=\"640\" data-original-token=\"v2-230e151282da5d03bd577feb8cd409e0\" class=\"origin_image zh-lightbox-thumb\" width=\"640\" data-original=\"https://picx.zhimg.com/v2-672ca99db1cbf88bde4eadef5f70bf45_r.jpg\"/\u003e\u003c/figure\u003e\u003cp class=\"ztext-empty-paragraph\"\u003e\u003cbr/\u003e\u003c/p\u003e\u003cp data-pid=\"Zy1POyjC\"\u003e\u003cb\u003e《人生只有一件事》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"ffd0nhUv\"\u003e金惟纯 著\u003c/p\u003e\u003cp data-pid=\"QpI8_hlM\"\u003e焦虑，似乎成了当代人的一种常态。金惟纯说：\u003cb\u003e内在状态失去觉知、信任和慈悲心，才是产生焦虑真正的源头\u003c/b\u003e。人生只有一件事，即好好活着。若想解决人生的问题，最好的办法就是站在更高的维度，重新审视自己，调整自己的心念，激发人生的高效能。\u003c/p\u003e","is_labeled":false,"visited_count":263725,"thumbnails":["https://pica.zhimg.com/v2-df48af7314e81e685633953780783d9a.jpg?source=7e7ef6e2\u0026needBackground=1","https://pic1.zhimg.com/50/v2-ae9901677586760d878bcd3a73babc91_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-3be442dc8b9cbae5ec04a960ef7805c5_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-6604fa22a836e64c5513d392737043c3_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-01801c49da3c646d9e115727e76d1222_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-9db76c6989454e849079a10da4535112_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-bb47f0ce2c227aad590d058fc7b32f6d_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-61bf43d20facb0f8d1a24ad0d6cfc6e3_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-1e7e7fed5f0e267ff83516069f9dadd5_720w.jpg?source=b6762063","https://pica.zhimg.com/50/v2-a1c2d697ba457044f0d22cc06c3086b5_720w.jpg?source=b6762063","https://pica.zhimg.com/50/v2-5962a0cd8aa0ca7938c9ffdac93d541f_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-2354069c39a9668e62da3f09b055e83a_720w.jpg?source=b6762063","https://pica.zhimg.com/50/v2-7a795f07f3ff523ab155e3e24f3fef38_720w.jpg?source=b6762063","https://pic1.zhimg.com/50/v2-66963b236cb39be514b5c0a3035f10c2_720w.jpg?source=b6762063","https://picx.zhimg.com/50/v2-14d6c72309d57871d7ebb7e4c7db2296_720w.jpg?source=b6762063"],"favorite_count":26189,"reaction_instruction":{"REACTION_CONTENT_SEGMENT_LIKE":"HIDE"},"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 556974569}","attached_info":"CvwLCPuP2/76svilkAEQBxoJMjExOTA1MTcwIKyykpgGKJ8RMFJALUpBCixUU19TT1VSQ0VfVFdPVE9XRVJfU0hPUlRJTlRFUkVTVF9SRUNBTExfVEVYVBIBMBgAIAA6CnsicmF3IjoiIn1aBjE2NzY1OGIgYjNlOGI5ZjBhMmMxNTIzNWQyMGJmN2IwNzFhYmNmYTVyCTU1Njk3NDU2OYIBX2h0dHBzOi8vcGljYS56aGltZy5jb20vdjItZGY0OGFmNzMxNGU4MWU2ODU2MzM5NTM3ODA3ODNkOWEuanBnP3NvdXJjZT03ZTdlZjZlMiZuZWVkQmFja2dyb3VuZD0xigEVY18xMDM4NzkyOTQ2NzMyMTY3MTY4qgEJcmVjb21tZW5kwgEgYjYwMjY2MjZiYzEyMDI0MjJhMmRlZmE2YWU1YWZlM2HyAQoIDBIGTm9ybWFs8gEoCAoSJDZmMzNhZTQxLTM4NDgtNDc1Mi04ZmY0LTBiZWM4NGI3YTFiM/IBBQgLEgE4ggIAiALd+9b0+jKSAiBiNjAyNjYyNmJjMTIwMjQyMmEyZGVmYTZhZTVhZmUzYZoCAMoCFlNob3JJbnRlcmVzdFdlaWdodFJ1bGXKAhVVc2VyTGNuRXhpdFdlaWdodFJ1bGXKAhRDb250ZW50QWdlV2VpZ2h0UnVsZcoCF1Rlc3RlZEFuZFdvcmtXZWlnaHRSdWxl2gIsVFNfU09VUkNFX1RXT1RPV0VSX1NIT1JUSU5URVJFU1RfUkVDQUxMX1RFWFToAgL6AgtOT1JNQUxfRkxPV4oDIDgwYjJiMjdkZGUwMzRmMzc4NDE1OTc3YjdjNDEzMGQ4mgMNCgJ2MhAAGgVvdGhlcqgDrYwQ2AMA6gMaZmVlZF9hdHRtX3R3b3Rvd2VyX3YyX3RleHT6A7EFEgxVTktOT1dOX01PREUgACoNTk9fSU1BR0VfTU9ERTotCAQQgAUYgAUiI3YyLTFjODU0YmZjNWY5ZjA4ZmQzZGI0Zjg2MTc4NmQ4OWFkOi0IBBCABRiABSIjdjItZDU2NzUyNWIyNDEwMGM1MzNlYzRlZTliOGVmYTlmYzA6LQgDEIAFGIAFIiN2Mi05MjhhODQyYTk0NmRhNTBhYWU0NmFmYWJmZWZjZmQ4MTotCAQQgAUYgAUiI3YyLTdjOThhOGYzYjU0MDZjZDBmOTQwNmEwNjYyNmM4NWZlOi0IAxCABRiABSIjdjItYTc5YTc5YTEzNzE4ZWZkMWFhZjE2YTFkM2UwZWVjZTY6LQgDEIAFGIAFIiN2Mi0xNjM3ZGNlMjI4MDk4YTkxZWJlMWIxY2QxMmIzYzI2NjotCAIQgAUYgAUiI3YyLWE5ZjU1ZjEzM2RkMWJlZDAwNDYzYmRiY2VlNTllN2NmOi0IAxCABRiABSIjdjItYzYwNGE0Yzg5MjRhNWE2OGYwMzFiOWRmM2Y2ZjFiNzM6LQgEEIAFGIAFIiN2Mi1kZTNjNGUzMjMzZjU2MjgzZjNhMWY0Y2E2MDVlZjM1OTotCAQQgAUYgAUiI3YyLWYyMDFkMDczYjk4YzdiZTNmMjdhMmE0NzY2OGUzMmRkOi0IAxCABRiABSIjdjItYjM0N2Y2MWUzNWZkZWNmNWE1Y2I3NTk1ZTFlNzMyNDI6LQgCEIAFGIAFIiN2Mi04Mzk4MjRlMjQzM2NlY2VhZTNhOWI2ODllMzkxNDliYTotCAIQgAUYgAUiI3YyLTIzMGUxNTEyODJkYTVkMDNiZDU3N2ZlYjhjZDQwOWUwOi0IAxCgHxjwLiIjdjItZGY0OGFmNzMxNGU4MWU2ODU2MzM5NTM3ODA3ODNkOWGABACIBACSBAZOb3JtYWyaBAEyoAQAqAQAsAQAugQGbWFudWFswgQDMTcwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA8AQA+QQAAABgeeqYP4EFAAAAAAAAAACJBSLOoRVnzss/kgUAmgUDZGZ0ogUDZGZ0sgUBMbkFAAAAAAAAAADQBQDgBQDoBQDwBQiQBgCgBi2oBgCSAiQKCTIxMTkwNTE3MBIJNTU2OTc0NTY5GAciCklNQUdFX1RFWFQ=","action_card":false},{"id":"46_1750980738.983","type":"feed","offset":46,"verb":"TOPIC_ACKNOWLEDGED_ARTICLE","created_time":1750980738,"updated_time":1750980738,"target":{"id":"1921598680407979777","type":"article","url":"https://api.zhihu.com/articles/1921598680407979777","author":{"id":"e1eedb57d6d6545028306e1c686b85ac","url":"https://api.zhihu.com/people/e1eedb57d6d6545028306e1c686b85ac","user_type":"people","url_token":"xiao-hao-98-92","name":"风琳君","headline":"不务正业，来这引流的","avatar_url":"https://pic1.zhimg.com/50/v2-be3b48dd8ae4b9d614ab3ab1b651a345_l.jpg?source=b6762063","is_org":false,"gender":-1,"followers_count":5,"is_following":false,"is_followed":false},"title":"AI屠宰场开业啦，想要拥有理想的未来吗？亲，这边建议您先圈个被害者出来哦——预测未来的算法模型","comment_permission":"all","created":1750925235,"updated":1750925235,"voteup_count":1,"voting":0,"comment_count":0,"linkbox":{"category":"","pic":"","title":"","url":""},"excerpt":"AI能发展出预测未来的能力吗？如果能，可能是什么原理？不是星座运势那种“你本周可能遇到贵人（也可能遇到城管）”的概率猜测，是精准到某年某月某日某时某分，说你家楼下奶茶店三更倒闭它就绝活不过五更的“铁口直断”。 让我们从原理假设一下。你觉得自己对未来世界的影响大吗？ 你认可有的人就是对未来世界有更大的影响力吗？ 先把每个人（也可能是科技成果等无生命的物质）简化为点，再从无数点中挑选出影响力大的做重点分…","excerpt_new":"AI能发展出预测未来的能力吗？如果能，可能是什么原理？不是星座运势那种“你本周可能遇到贵人（也可能遇到城管）”的概率猜测，是精准到某年某月某日某时某分，说你家楼下奶茶店三更倒闭它就绝活不过五更的“铁口直断”。 让我们从原理假设一下。你觉得自己对未来世界的影响大吗？ 你认可有的人就是对未来世界有更大的影响力吗？ 先把每个人（也可能是科技成果等无生命的物质）简化为点，再从无数点中挑选出影响力大的做重点分…","preview_type":"default","preview_text":"","content":"\u003cp data-pid=\"aDe4zxZN\"\u003e\u003cb\u003eAI能发展出预测未来的能力吗？如果能，可能是什么原理？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"n4iHz4Jo\"\u003e不是星座运势那种“你本周可能遇到贵人（也可能遇到城管）”的概率猜测，是精准到某年某月某日某时某分，说你家楼下奶茶店三更倒闭它就绝活不过五更的“铁口直断”。\u003c/p\u003e\u003cp data-pid=\"T92Xmwlv\"\u003e\u003cb\u003e让我们从原理假设一下。\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"X3zohHpU\"\u003e你觉得自己对未来世界的影响大吗？\u003c/p\u003e\u003cp data-pid=\"VHJM0VNd\"\u003e你认可有的人就是对未来世界有更大的影响力吗？\u003c/p\u003e\u003cp data-pid=\"2626nL81\"\u003e先把每个人（也可能是科技成果等无生命的物质）简化为点，再从无数点中挑选出影响力大的做重点分析——称之为‘变量点’。\u003c/p\u003e\u003cp data-pid=\"N2TKvBm-\"\u003e这些变量点都有自己想要的未来——称之为‘定格画面’。\u003c/p\u003e\u003cp data-pid=\"dwNX3jez\"\u003e相同的定格画面交叉重叠，重叠多的就会越来越清晰——清晰度越高，权重越大，即实现的概率越大。\u003c/p\u003e\u003cp data-pid=\"R13KtIz0\"\u003e没错，这就是本书的设定，\u003c/p\u003e\u003cp data-pid=\"DVi6EdAz\"\u003e\u003cb\u003e书名《封神 把星域智网打造成神明模样》\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"MOVZwXmP\"\u003e链接在下面：\u003c/p\u003e\u003ca data-draft-node=\"block\" data-draft-type=\"link-card\" href=\"https://link.zhihu.com/?target=https%3A//magev6.if.qidian.com/h5/share/book%3Fchannel%3Dqidianapp%26activityId%3Dbookshare_02%26tt%3D0%26tc%3D0%26nc%3D%26nd%3D%26spdt%3D14%26spdid%3D109%26ex1%3D1041548269%26shareUserCode%3DOCaoZxTW%26bookId%3D1041548269%26shareBookType%3D1%26shareSource%3D2%26_trace%3Dqdappsfx\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003e起点中文网\u003c/a\u003e\u003cp data-pid=\"AjUctwpT\"\u003e\u003cb\u003e在此设定下，世界一定是极为热闹的，\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"kIHvO51L\"\u003e——如果未来不是你想要的，你又知道展开这个未来的‘变量点’是谁，是不是就可以从源头掐灭这个可能性未来呢？\u003c/p\u003e\u003cp data-pid=\"jQuR3hCE\"\u003e——如何看到未来？借助64卦；\u003c/p\u003e\u003cp data-pid=\"yICRe6oQ\"\u003e——如何识别是哪个变量点推演出的这个未来？\u003c/p\u003e\u003cp data-pid=\"neAErAwe\"\u003e——可以更改算法，改变定格画面的权重吗？\u003c/p\u003e\u003cp data-pid=\"3TCd7-jH\"\u003e这里面有个问题还是要说明一下。\u003c/p\u003e\u003cp data-pid=\"uMIcRA5y\"\u003e\u003cb\u003e为什么64卦就准确预言未来呢？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"n9Fz8_S7\"\u003e\u003cb\u003e这就是第二个问题：时间是一根线，还是一个圈呢？\u003c/b\u003e\u003c/p\u003e\u003cp data-pid=\"oIBr3WUu\"\u003e如果时间是一个圈，宇宙重启过，且上一轮宇宙信息都被全部存档了，是不是就能准确预测未来了？\u003c/p\u003e\u003cp data-pid=\"rJaVnBmR\"\u003e（本书第一个故事会详细叙述，在第1-13章，这个介绍已经很长了，就不啰嗦了，我们下个文章见，感谢阅读。）\u003c/p\u003e","is_labeled":false,"visited_count":134,"favorite_count":2,"article_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"article\", \"id\": 1921598680407979777}","attached_info":"CtwFCPuP2/76svilkAEQBxoJMjU5NTg3MjgxILP/88IGKAEwAEAuSkYKKVRTX1NPVVJDRV9DT05UUk9MX0lOVEVSRVNUX1JFQUxUSU1FX1RPUElDEhMxMTUyOTIxNTA0NjA4MDc2OTg2GAAgADoAYiBiM2U4YjlmMGEyYzE1MjM1ZDIwYmY3YjA3MWFiY2ZhNXITMTkyMTU5ODY4MDQwNzk3OTc3N6oBCXJlY29tbWVuZMIBIGUxZWVkYjU3ZDZkNjU0NTAyODMwNmUxYzY4NmI4NWFj8gEKCAwSBk5vcm1hbPIBKAgKEiQyZmE2ZGYyYS0wM2FlLTRiOTctOGM0OC03OWNkNTIyYzhkNzjyAQUICxIBOIICAIgC3fvW9PoykgIgZTFlZWRiNTdkNmQ2NTQ1MDI4MzA2ZTFjNjg2Yjg1YWOaAgDKAhZTaG9ySW50ZXJlc3RXZWlnaHRSdWxlygIVVXNlckxjbkV4aXRXZWlnaHRSdWxlygIYQ29udGVudFdhcm1VcEJyZWFrSW5SdWxl2gIpVFNfU09VUkNFX0NPTlRST0xfSU5URVJFU1RfUkVBTFRJTUVfVE9QSUPoAgL6AgtOT1JNQUxfRkxPV4oDIDgwYjJiMjdkZGUwMzRmMzc4NDE1OTc3YjdjNDEzMGQ4mgMNCgJ2MhAAGgVvdGhlcqgDhgHYAwDqAxxDb250cm9sSW50ZXJlc3RSZWFsVGltZVRvcGlj+gMfEgxVTktOT1dOX01PREUgACoNTk9fSU1BR0VfTU9ERYAEAIgEAJIEBk5vcm1hbJoEATKgBACoBACwBAC6BAJhacIEAzQwMMgEANIED+aOqOiNkOW3suabtOaWsNgEAPAEnNDBAvkEAAAAAB+Kfj+BBQAAAAAAAAAAiQUizqEVZ87LP5IFAJoFA2RmdKIFA2RmdLIFATG5BQAAAAAAAAAA0AUK4AUA6AUA8AUIkAYAoAYuqAYBkgIuCgkyNTk1ODcyODESEzE5MjE1OTg2ODA0MDc5Nzk3NzcYByIKSU1BR0VfVEVYVA==","action_card":false},{"id":"47_1750980738.263","type":"feed","offset":47,"verb":"TOPIC_ACKNOWLEDGED_ANSWER","created_time":1750980738,"updated_time":1750980738,"target":{"id":"1904494004109828681","type":"answer","url":"https://api.zhihu.com/answers/1904494004109828681","author":{"id":"1d4198ea47b82399ba667c19c0840271","url":"https://api.zhihu.com/people/1d4198ea47b82399ba667c19c0840271","user_type":"people","url_token":"shi-zhen-jj","name":"凡芒微光","headline":"世界500万强跑龙套，带着问题跑火车....","avatar_url":"https://picx.zhimg.com/50/v2-443123eae27009b44d7bf1dfe58900a7_l.jpg?source=b6762063","is_org":false,"gender":1,"badge":[{"type":"zhihu_yearly_answerer","description":"新知答主"},{"type":"best_answerer","description":"职场话题下的优秀答主","topic_names":["职场"],"topic_ids":[2566]},{"type":"super_activity","description":"知势榜职场领域影响力榜答主"}],"followers_count":16425,"is_following":false,"is_followed":false},"created_time":1746846754,"updated_time":1746846754,"voteup_count":42,"thanks_count":2,"comment_count":7,"is_copyable":false,"question":{"id":"1902994167359047566","type":"question","url":"https://api.zhihu.com/questions/1902994167359047566","author":{"id":"a11d6ca08a8790b04798f735dca41771","url":"https://api.zhihu.com/people/a11d6ca08a8790b04798f735dca41771","user_type":"people","url_token":"sam-82-87","name":"山姆大叔","headline":"一个头发茂盛的程序员探索自媒体的世界","avatar_url":"https://pica.zhimg.com/50/v2-6e5f8558e7537becac971cf8054ddba5_l.jpg?source=b6762063","is_org":false,"gender":1,"followers_count":171,"is_following":false,"is_followed":false},"title":"2025年失业后全职做自媒体会不会太迟，值不值得搏一把？","created":1746489165,"answer_count":0,"follower_count":0,"comment_count":5,"bound_topic_ids":[3577,32797,713850,1366893,3064448],"is_following":false,"excerpt":"","relationship":{"is_author":false},"detail":"","question_type":"normal"},"thumbnail":"https://pic1.zhimg.com/50/v2-c6564833221058f7c5ac5cce2198c263_720w.jpg?source=b6762063","excerpt":"今天周末，我也水上一嘴。 ... 1 . 在你差不多年纪的时候，我刚好把钱都亏光了，好在还能兢兢业业地上班打螺丝，不至于马上断粮跳楼什么的，心态崩了不到一个月就回过神来了。 久了以后发现，其实人生好多选项，就跟投资、投机、放高利贷什么的。 ... 比如一边说公务员发不出工资待遇低，一边又是考公热，还是不少人想进体制。虽然体制的工作收入不算高，但胜在稳定，这就跟你买国债一样的，收益率比普通定期一般会略高，但又比…","excerpt_new":"今天周末，我也水上一嘴。 ... 1 . 在你差不多年纪的时候，我刚好把钱都亏光了，好在还能兢兢业业地上班打螺丝，不至于马上断粮跳楼什么的，心态崩了不到一个月就回过神来了。 久了以后发现，其实人生好多选项，就跟投资、投机、放高利贷什么的。 ... 比如一边说公务员发不出工资待遇低，一边又是考公热，还是不少人想进体制。虽然体制的工作收入不算高，但胜在稳定，这就跟你买国债一样的，收益率比普通定期一般会略高，但又比…","preview_type":"default","preview_text":"","reshipment_settings":"disallowed","content":"\u003cp data-pid=\"rAkQmGOL\"\u003e今天周末，我也水上一嘴。\u003c/p\u003e\u003cp data-pid=\"XQSGeBNZ\"\u003e...\u003c/p\u003e\u003cp data-pid=\"E1iBZLx7\"\u003e1 . 在你差不多年纪的时候，我刚好把钱都亏光了，好在还能兢兢业业地上班打螺丝，不至于马上断粮跳楼什么的，心态崩了不到一个月就回过神来了。\u003c/p\u003e\u003cp data-pid=\"jkJY4YpC\"\u003e久了以后发现，其实人生好多选项，就跟投资、投机、放高利贷什么的。\u003c/p\u003e\u003cp data-pid=\"8m3iLjYO\"\u003e...\u003c/p\u003e\u003cp data-pid=\"BituixN8\"\u003e比如一边说公务员发不出工资待遇低，一边又是考公热，还是不少人想进体制。虽然体制的工作收入不算高，但胜在稳定，这就跟你买国债一样的，收益率比普通定期一般会略高，但又比权益类产品收益天花板低，只要国家不破产，你的债券收入是相对稳定有保障的。\u003c/p\u003e\u003cp data-pid=\"aaqgkN70\"\u003e一般比较适合有点家底的朋友，人家在挣第一桶金的时候，你已经拿着一桶金子，把它放在这个收益稳定的揽子里，慢慢吃着利息就能小日子滋润。所以很多真中产们，其实都愿意把孩子送进相对稳定的环境中，别犯什么大错误把家底亏光，就能好好过一生。\u003c/p\u003e\u003cp data-pid=\"d6_BXwGk\"\u003e...\u003c/p\u003e\u003cp data-pid=\"4QrXTWfv\"\u003e而到大厂或其他公司工作，就有点像放高利贷了。民间的借贷一般不讲年利率，讲的至少也是月息3点起步，当月收下个月的利息，高利息是为了兑冲被跑路的风险，尽快把本金收回。这跟大厂工作吃青春饭类似，35岁以前最好能攒够45岁的积蓄，后面失业（像被跑路）也不慌。\u003c/p\u003e\u003cp data-pid=\"c8PqRezG\"\u003e顺带一说，35岁攒够45岁的积蓄有点扯？这也取决于你的生活质量是不是水涨船高了，一辈子的苦是总得要受的，就看看你是未来的你在剥削现在的你，还是现在的你在剥削未来的你，出来混始终是要还的。\u003c/p\u003e\u003cp data-pid=\"0uZrewCM\"\u003e...\u003c/p\u003e\u003cp data-pid=\"29eI_Vbm\"\u003e而创业就跟股票之类的权益类产品一样，高风险高收益，你可以距天堂很近，同样也可以很接近地狱，大家也懂。\u003c/p\u003e\u003cp data-pid=\"D-MwZWwM\"\u003e...\u003c/p\u003e\u003cp data-pid=\"99qckwYy\"\u003e2 . 那么，自媒体更像什么呢？\u003c/p\u003e\u003cp data-pid=\"aVrN--lz\"\u003e如果用不降低你当前生活质量的前提来讨论，那么自媒体有点像买彩票了，因为它花不了你什么本金，门槛极低，随便选一组数字就能买，但要真中奖的概率是很低的。\u003c/p\u003e\u003cp data-pid=\"VPwpSCMk\"\u003e你看着月入10万+的朋友时也别流口水，哪个平台都不乏这种人，就知乎这里也有这种人，一般都活得像个小透明，没有什么黄标优秀啥的。\u003c/p\u003e\u003cp data-pid=\"6-hnmTZt\"\u003e从概率上看，这部分的朋友就是中奖了。\u003c/p\u003e\u003cp data-pid=\"bsIBOhuk\"\u003e...\u003c/p\u003e\u003cp data-pid=\"yeDQa0tj\"\u003e你更应该把目光放在99%的自媒体人身上，观察他们的生存状态，大部分人就活得像一个码农一样，每天死命输出是避免不了的，不限于图文或视频，你不是在输出就是在构思输出的路上，运气好且足够耐操的话，一年挣个不到6位数，运气差的话就是3位数。\u003c/p\u003e\u003cp data-pid=\"BBfac0rj\"\u003e注意，是一年哦。\u003c/p\u003e\u003cp data-pid=\"KdKboSA8\"\u003e因为他不能按真正码农发月薪来衡量的，环境、规则、运气都不会是按月分给大家的，越是稳定且确定的收入方式，就会越多人来做，然后你就越难值钱，算法很快就会把追求确定性的朋友搞崩。所以假如你把这个东西看成职业或事业，那么你单看一天、一月、一年.......\u003c/p\u003e\u003cp data-pid=\"RLPcpFNV\"\u003e意义不太大。\u003c/p\u003e\u003cp data-pid=\"BuGh63vu\"\u003e...\u003c/p\u003e\u003cp data-pid=\"lCn20zMD\"\u003e但他跟买彩票也是有点区别的。\u003c/p\u003e\u003cp data-pid=\"UKfSzC5Z\"\u003e买彩票的话，你每一次下驻的胜率，跟你上一次中没中奖是没关系的，但自媒体把时间拉得足够长的话，你会有经验的积累、IP的积累。\u003c/p\u003e\u003cp data-pid=\"X0qn4n_V\"\u003e这些积累不保证你真会厚积薄发，比如碰上平台倒闭（说起这个，以前我也在虾米音乐小玩一下，现在不也倒闭了吗）或者顺应时代规则的改变，你积累回来的东西不一定有用。\u003c/p\u003e\u003cp data-pid=\"qScyemQ2\"\u003e不一定有用，就意味着可能有用，这又是重新开的一个赌注了，看你是要赌死命挣短利，还是押注玩盘大的，搞长远一点。\u003c/p\u003e\u003cp data-pid=\"q-Ibwes_\"\u003e...\u003c/p\u003e\u003cp data-pid=\"UE5K-JjB\"\u003e3 . 很多朋友也经常劝我，不能把目光放得太长，眼前有钱得马上去搞，鬼知道这钱能赚多久。\u003c/p\u003e\u003cp data-pid=\"TXr9LCEr\"\u003e也对。\u003c/p\u003e\u003cp data-pid=\"cQHY_XsZ\"\u003e前两年GTP刚出来的时候，我也借了朋友一个账号，用GTP搞垃圾文扔到头条上，三几分钟出一篇垃圾文，同时搞三几个账号，0粉起步，头一个月收入就有5位数了。\u003c/p\u003e\u003cp data-pid=\"B1YZamMa\"\u003e搞了三个月左右，我就没搞了。\u003c/p\u003e\u003cp data-pid=\"MjJRLOq8\"\u003e...\u003c/p\u003e\u003cp data-pid=\"bp5gAQOO\"\u003e一方面我真有点精神洁癖，搞那些乱七八糟的玩意，消费群众们雪亮的智商，我还真过意不去，这精神洁癖也是自媒体人的大忌。\u003c/p\u003e\u003cp data-pid=\"85XP-vzp\"\u003e所以后来我搞大家说的“割韭菜”社群时，大家交钱报名前我就声明：“不能有精神洁癖，稍微有点节操的朋友请绕道。”\u003c/p\u003e\u003cp data-pid=\"eLC7E_6p\"\u003e结果还是有不少没节操的学员交钱报名，也不贵，299元而已，而且是包回票的，赚不回门票的我退回给大家，大家也无惊无险地毕业去了。\u003c/p\u003e\u003cp data-pid=\"syoz0nmX\"\u003e...\u003c/p\u003e\u003cp data-pid=\"xmu6X6kI\"\u003e另一方面，也不单单是因为我太有节操而不搞，而是看到这个玩意的趋势根本玩不久，如果大家都知道这么干能赚快钱的话，那肯定就是大量垃圾文入局，撸这些短钱就像多打一份工，没啥意思。\u003c/p\u003e\u003cp data-pid=\"dwZFUNxF\"\u003e...\u003c/p\u003e\u003cp data-pid=\"7UgDx29v\"\u003e打工也好，自媒体也好，搞什么玩意都好，赚钱的维度无非就是4个——\u003c/p\u003e\u003cul\u003e\u003cli data-pid=\"gbD2HUUG\"\u003e赚信息差的钱：我知道，你不知道\u003c/li\u003e\u003cli data-pid=\"P0QlgY6J\"\u003e赚认知差的钱：我懂，你不懂\u003c/li\u003e\u003cli data-pid=\"QQ38qgWB\"\u003e赚执行差的钱：你知道，我也知道，我懂你也懂，但是你没有去做\u003c/li\u003e\u003cli data-pid=\"rTIWmt2B\"\u003e核心竞争差的钱：我做，你也做。但是我比你做得好\u003c/li\u003e\u003c/ul\u003e\u003cp data-pid=\"LAHNHEWv\"\u003e现在这个年代，几百块的信息差是不存在的，三两下子就要被抹平，有用的信息差会很贵，99%的人都给不起，这也注定了短钱的天花板也就那么回事。\u003c/p\u003e\u003cp data-pid=\"6C7XUKmp\"\u003e难的就是最后一个维度，但各行各业的生态也在这里，看着门槛低的地方门槛越高，看着门槛高的地方，跨过了就是门槛越低。\u003c/p\u003e\u003cp data-pid=\"gu9oq00o\"\u003e...\u003c/p\u003e\u003cp data-pid=\"G-B-TNuf\"\u003e每个人也可以结合自己的情况，去考虑做短利还是长利，本质也是在赌。\u003c/p\u003e\u003cp data-pid=\"qEno-o6V\"\u003e如果像我之前把钱亏光了手停口停那种，哪有心思在这里写废话，这又回到上面说的，到底是未来的你在剥削现在的你，还是倒过来，先把未来的你剥削个清光再算。\u003c/p\u003e\u003cp data-pid=\"Z69Nhpk_\"\u003e对了，容我这里插个无关的图片，我还要打卡圆环挑战，运气好的话还能赌赢1块钱呢，小赌怡情。\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic3.zhimg.com/v2-7461810da6ab3e388a7a0f9a5b389b04_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1256\" data-rawheight=\"352\" data-original-token=\"v2-7461810da6ab3e388a7a0f9a5b389b04\" data-default-watermark-src=\"https://pic4.zhimg.com/v2-bf96b6f488757198c3ecb188fad5ac63_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1256\" data-original=\"https://pic3.zhimg.com/v2-7461810da6ab3e388a7a0f9a5b389b04_r.jpg\"/\u003e\u003c/figure\u003e\u003cp data-pid=\"MrYWNm1h\"\u003e4 . 很多人说某某自媒体很牛逼，因为他是全职的，时间比较充足，但据我观察通常是反过来，因为他做得很牛逼，才允许全职。\u003c/p\u003e\u003cp data-pid=\"6ESUPdBc\"\u003e再说了，其实对于99%的人来说，自媒体赚不赚钱跟你时间的关系不大，你用每天2小时创造不了价值的话，给你24小时创造出来的价值，增幅一般大不了多少。\u003c/p\u003e\u003cp data-pid=\"VAWCTD00\"\u003e当然，我这里说的“大不了多少”是相对上班工资，或者其他渠道的收入，你说全职一年赚个8万块，跟兼职一年赚个2万块，差距是不是很大？对比月薪5k的工资来说，好像也不是很大，对吧？\u003c/p\u003e\u003cp data-pid=\"p8BjjJxv\"\u003e...\u003c/p\u003e\u003cp data-pid=\"-gyQpVCb\"\u003e我个人比较保守，可能是因为以前亏得太惨了，所以假如我是题主你的话，在40岁以前还是先剥削一下现在的自己，找个工作作为锚点，不至于把自己完全架空。\u003c/p\u003e\u003cp data-pid=\"Pb41S5h7\"\u003e一旦整个人被架空时，你就会很慌，变得人穷志短，追逐短利变得没有方向，最后就纯粹是在卖时间。至于你说的两年找不到工作，这里我就不评价了，只能说找找可能还是会有的，钱多钱少 / 时间多时间少的问题而已。\u003c/p\u003e\u003cp data-pid=\"vVB4JeV4\"\u003e当然，假如你现在的积蓄是足够的情况下，当我没说，无论是剥削现在的自己也好，未来的自己也罢，总不能非黑即白去太狠，找到平衡点就好。有了一个锚点以后，可以每天花2小时左右去搞自媒体，这对你生活与工作的影响不大的。\u003c/p\u003e\u003cp data-pid=\"fXUSz7Zt\"\u003e...\u003c/p\u003e\u003cp data-pid=\"7fc8k3x4\"\u003e至于具体怎么搞，我就不说了，反正我自己也还没搞明白。\u003c/p\u003e\u003cp data-pid=\"biXGlv1w\"\u003e但记住，但凡有标准且便宜的教程报课什么的，给你提供确定性套路的，最终都不会值钱，就像考证一样，如果人人都知道考个证能升职，最后人人都不会升职。\u003c/p\u003e\u003cp data-pid=\"XvdkzuZz\"\u003e...\u003c/p\u003e\u003cp data-pid=\"9aSMTrA6\"\u003e虽说人生就像赌局，但也没必要总用“搏一把”这种吓人的词汇来描绘，用Show Hand的心态去搞一个事情，反正我现在是吃不来的。\u003c/p\u003e\u003cp data-pid=\"plDuJdNB\"\u003e而“值不值”这个词其实我也不太喜欢，自己觉得OK就去试试就行，概率这个事情，就像癌症病人要动手术时，医生也只告诉你一年的存活概率是20%，三年是5%，五年是1%.......\u003c/p\u003e\u003cp data-pid=\"6WjGigJj\"\u003e值不值？\u003c/p\u003e\u003cp data-pid=\"wgPH5-vP\"\u003e...\u003c/p\u003e\u003cp data-pid=\"kGLassVW\"\u003e水完了，容我随便插多两个图，完成今天的圆环挑战，打个卡，喝咖啡去.........\u003c/p\u003e\u003cp data-pid=\"P_5r9amq\"\u003e祝我中奖，也祝你中奖。\u003c/p\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic1.zhimg.com/v2-97cda4b9ddab41cf3b80c0c421b4d328_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"500\" data-rawheight=\"402\" data-original-token=\"v2-97cda4b9ddab41cf3b80c0c421b4d328\" data-default-watermark-src=\"https://picx.zhimg.com/v2-9f66f418b10abc18eb81ac1510e82b47_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"500\" data-original=\"https://pic1.zhimg.com/v2-97cda4b9ddab41cf3b80c0c421b4d328_r.jpg\"/\u003e\u003c/figure\u003e\u003cfigure data-size=\"normal\"\u003e\u003cimg src=\"https://pic2.zhimg.com/v2-c6564833221058f7c5ac5cce2198c263_1440w.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1080\" data-rawheight=\"810\" data-original-token=\"v2-c6564833221058f7c5ac5cce2198c263\" data-default-watermark-src=\"https://picx.zhimg.com/v2-496f70baa0d18749f3ebc527d0d9e393_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"1080\" data-original=\"https://pic2.zhimg.com/v2-c6564833221058f7c5ac5cce2198c263_r.jpg\"/\u003e\u003c/figure\u003e\u003cp\u003e\u003c/p\u003e","relationship":{"is_thanked":false,"is_nothelp":false,"voting":0},"is_labeled":true,"visited_count":1103,"thumbnails":["https://pica.zhimg.com/50/v2-c6564833221058f7c5ac5cce2198c263_720w.jpg?source=b6762063"],"favorite_count":14,"answer_type":"normal","is_navigator":false,"navigator_vote":false,"vote_next_step":"vote"},"brief":"{\"source\": \"TS\", \"type\": \"answer\", \"id\": 1904494004109828681}","attached_info":"CqcHCPuP2/76svilkAEQBBoJNzI2Njg5MTQ1IKKI+8AGKCowB0AvSjgKLVRTX1NPVVJDRV9JTlRFUkVTVF9XT1JEX0NPTlRFTlRfVkFMVUVfTEVWRUxfQhIBMBgAIAA6AFoJMTE0ODE3MTI4YiBiM2U4YjlmMGEyYzE1MjM1ZDIwYmY3YjA3MWFiY2ZhNXITMTkwNDQ5NDAwNDEwOTgyODY4MYoBEzE5MDI5OTQxNjczNTkwNDc1NjaqAQlyZWNvbW1lbmTCASAxZDQxOThlYTQ3YjgyMzk5YmE2NjdjMTljMDg0MDI3MfIBCggMEgZOb3JtYWzyASgIChIkOTdmNmZjZDItZjM0Zi00ZjZkLTg0MzYtYzliZTU3OGUyNDk48gEFCAsSATiCAgCIAt371vT6MpICIDFkNDE5OGVhNDdiODIzOTliYTY2N2MxOWMwODQwMjcxmgIAygIWU2hvckludGVyZXN0V2VpZ2h0UnVsZcoCFVVzZXJMY25FeGl0V2VpZ2h0UnVsZcoCFENvbnRlbnRBZ2VXZWlnaHRSdWxlygIcQmF5ZXNGaXJzdExldmVsSXNvbGF0aW9uUnVsZdoCLVRTX1NPVVJDRV9JTlRFUkVTVF9XT1JEX0NPTlRFTlRfVkFMVUVfTEVWRUxfQugCBPoCC05PUk1BTF9GTE9XigMgODBiMmIyN2RkZTAzNGYzNzg0MTU5NzdiN2M0MTMwZDiaAw0KAnYyEAAaBW90aGVyqAPPCNgDAOoDKkludGVyZXN0V29yZENvbnRlbnRWYWx1ZUxldmVsQlBvb2xSZWNhbGxlcvoDrAESDFVOS05PV05fTU9ERSAAKg1OT19JTUFHRV9NT0RFOi0IAhDoCRjgAiIjdjItNzQ2MTgxMGRhNmFiM2UzODhhN2EwZjlhNWIzODliMDQ6LQgDEPQDGJIDIiN2Mi05N2NkYTRiOWRkYWI0MWNmM2I4MGMwYzQyMWI0ZDMyODotCAMQuAgYqgYiI3YyLWM2NTY0ODMzMjIxMDU4ZjdjNWFjNWNjZTIxOThjMjYzgAQAiAQAkgQGTm9ybWFsmgQBNKAEAKgEALAEALoEAmFpwgQDNDAwyAQA0gQP5o6o6I2Q5bey5pu05paw2AQA8AQA+QQAAACgid6pP4EFAAAAAAAAAACJBSLOoRVnzss/kgUAmgUDZGZ0ogUDZGZ0sgUBMbkFAAAAAAAAAADQBQDgBQDoBQDwBQiQBgCgBi+oBgCSAi4KCTcyNjY4OTE0NRITMTkwNDQ5NDAwNDEwOTgyODY4MRgEIgpJTUFHRV9URVhU","action_card":false}],"paging":{"is_end":false,"is_start":false,"next":"https://www.zhihu.com/api/v3/feed/topstory/recommend?action=down\u0026ad_interval=-10\u0026after_id=47\u0026desktop=true\u0026end_offset=47\u0026page_number=9\u0026session_token=b3e8b9f0a2c15235d20bf7b071abcfa5","previous":"https://www.zhihu.com/api/v3/feed/topstory/recommend?action=pull\u0026ad_interval=-10\u0026before_id=47\u0026desktop=true\u0026end_offset=47\u0026page_number=9\u0026session_token=b3e8b9f0a2c15235d20bf7b071abcfa5","totals":0},"fresh_text":"推荐已更新"}
